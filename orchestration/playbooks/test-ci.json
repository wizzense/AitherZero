{
  "name": "test-ci",
  "description": "Continuous Integration test suite optimized for CI/CD pipelines",
  "version": "1.0.0",
  "author": "AitherZero CI/CD",
  "tags": ["testing", "ci", "automation", "pipeline"],
  "requirements": {
    "modules": ["Pester", "PSScriptAnalyzer"],
    "minimumVersion": "7.0",
    "estimatedDuration": "15-20 minutes",
    "platforms": ["Windows", "Linux", "macOS"]
  },
  "variables": {
    "testPath": "./tests",
    "outputPath": "./tests/results",
    "artifactsPath": "./artifacts",
    "minimumCoverage": 80,
    "failFast": true,
    "generateArtifacts": true,
    "ciMode": true
  },
  "environment": {
    "CI": "true",
    "AITHERZERO_TEST_MODE": "CI",
    "AITHERZERO_NO_INTERACTIVE": "true",
    "AITHERZERO_LOG_LEVEL": "Information"
  },
  "stages": [
    {
      "name": "CI Environment Info",
      "description": "Log CI environment details",
      "sequence": [],
      "preScript": "Write-Host \"CI Environment: $($env:GITHUB_ACTIONS ? 'GitHub Actions' : $env:AZURE_PIPELINES ? 'Azure Pipelines' : 'Unknown')\"; Write-Host \"OS: $($PSVersionTable.OS)\"; Write-Host \"PowerShell: $($PSVersionTable.PSVersion)\""
    },
    {
      "name": "Install Dependencies",
      "description": "Ensure testing tools are available",
      "sequence": ["0400"],
      "variables": {
        "Force": true
      },
      "continueOnError": false,
      "timeout": 300
    },
    {
      "name": "Syntax Validation",
      "description": "Fast syntax check as gate",
      "sequence": ["0405"],
      "variables": {
        "CheckSyntax": true,
        "CheckParameters": false,
        "CheckCommands": false,
        "CheckModuleDependencies": false
      },
      "continueOnError": false,
      "failFast": true
    },
    {
      "name": "Unit Tests",
      "description": "Run unit tests with coverage",
      "sequence": ["0402"],
      "variables": {
        "NoCoverage": false,
        "OutputPath": "./artifacts/test-results"
      },
      "continueOnError": false,
      "timeout": 600
    },
    {
      "name": "Integration Tests",
      "description": "Run integration tests",
      "sequence": ["0403"],
      "variables": {
        "IncludeE2E": false,
        "OutputPath": "./artifacts/test-results"
      },
      "continueOnError": true,
      "timeout": 900
    },
    {
      "name": "Static Analysis",
      "description": "PSScriptAnalyzer with CI rules",
      "sequence": ["0404"],
      "variables": {
        "OutputPath": "./artifacts/analysis",
        "ExcludePaths": ["tests", "legacy-to-migrate", "examples", ".github"]
      },
      "continueOnError": true
    },
    {
      "name": "Coverage Report",
      "description": "Generate coverage reports for CI",
      "sequence": ["0406"],
      "variables": {
        "Format": "All",
        "OutputPath": "./artifacts/coverage",
        "RunTests": false
      },
      "continueOnError": false
    }
  ],
  "artifacts": {
    "paths": [
      "./artifacts/test-results/*.xml",
      "./artifacts/coverage/*",
      "./artifacts/analysis/*",
      "./tests/results/*-Summary.json"
    ],
    "retentionDays": 30,
    "compress": true
  },
  "reporting": {
    "enabled": true,
    "formats": ["JUnit", "Cobertura", "SARIF"],
    "publishTestResults": true,
    "publishCodeCoverage": true,
    "commentOnPR": true
  },
  "qualityGates": {
    "enabled": true,
    "rules": [
      {
        "name": "Minimum Coverage",
        "type": "coverage",
        "threshold": 80,
        "failBuild": true
      },
      {
        "name": "No Test Failures",
        "type": "tests",
        "condition": "Failed == 0",
        "failBuild": true
      },
      {
        "name": "No PSScriptAnalyzer Errors",
        "type": "analysis",
        "severity": "Error",
        "threshold": 0,
        "failBuild": true
      }
    ]
  },
  "notifications": {
    "channels": ["console", "file"],
    "onStart": {
      "message": "üöÄ Starting CI test suite for AitherZero",
      "includeEnvironment": true
    },
    "onSuccess": {
      "message": "‚úÖ CI tests passed! Build is ready.",
      "includeMetrics": true,
      "includeDuration": true
    },
    "onFailure": {
      "message": "‚ùå CI tests failed. Check the logs for details.",
      "includeFailures": true,
      "includeArtifactLinks": true
    }
  },
  "integrations": {
    "github": {
      "enabled": true,
      "checkRuns": true,
      "statusChecks": ["tests", "coverage", "analysis"],
      "prComments": true
    },
    "codecov": {
      "enabled": false,
      "token": "${CODECOV_TOKEN}",
      "flags": ["unittests", "integration"]
    }
  },
  "postActions": [
    {
      "description": "Create test summary",
      "type": "script",
      "inline": "@{Status = if ((Get-ChildItem './artifacts/test-results/*.xml' | Select-String '<failure').Count -eq 0) {'Passed'} else {'Failed'}; Timestamp = Get-Date; Duration = [System.Diagnostics.Stopwatch]::StartNew()} | ConvertTo-Json | Set-Content './artifacts/ci-summary.json'"
    },
    {
      "description": "Set CI output variables",
      "type": "conditional",
      "condition": "$env:GITHUB_ACTIONS -eq 'true'",
      "action": {
        "type": "script",
        "inline": "$coverage = Get-Content './artifacts/coverage/coverage-summary.json' | ConvertFrom-Json; Write-Host \"::set-output name=coverage::$($coverage.CoveragePercent)%\"; Write-Host \"::set-output name=tests-passed::$($coverage.Passed)\""
      }
    }
  ]
}