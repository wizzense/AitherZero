name: üîç PR Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

jobs:
  validate:
    name: Validate PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PowerShell
        uses: PowerShell/powershell-installer@v1
        with:
          powershell-version: "7.4.0"

      - name: Install dependencies
        shell: pwsh
        run: |
          Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
          Install-Module -Name PSScriptAnalyzer -Force
          Install-Module -Name Pester -MinimumVersion 5.0 -Force

      - name: Lint PowerShell code
        shell: pwsh
        run: |
          Invoke-ScriptAnalyzer -Path ./aither-core -Recurse -Severity Error

      - name: Run Unit Tests
        shell: pwsh
        run: |
          if (Test-Path ./tests/Run-BulletproofValidation.ps1) {
            Write-Host 'Running bulletproof validation (quick)...'
            ./tests/Run-BulletproofValidation.ps1 -ValidationLevel Quick
          } elseif (Test-Path ./tests/Run-Tests.ps1) {
            Write-Host 'Running legacy unit tests...'
            ./tests/Run-Tests.ps1 -Type Unit -FailFast
          } else {
            Write-Error 'No test runner found!'
            exit 1
          }

      - name: Check for common issues
        shell: pwsh
        run: |
          # Check for required files
          if (-not (Test-Path 'aither-core/modules/PatchManager')) {
            Write-Error 'PatchManager module missing'
            exit 1
          }
          if (-not (Test-Path 'VERSION')) {
            Write-Error 'VERSION file missing'
            exit 1
          }
          Write-Host '‚úÖ Basic structure validation passed'
