---
name: âœ… PR Validation

# Fast, essential PR validation - runs before main CI
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write
  # Explicitly deny dangerous permissions
  actions: none
  security-events: none

# Cost-optimized concurrency
concurrency:
  group: pr-validation-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true

jobs:
  # Safe analysis for fork PRs - no code execution
  fork-pr-analysis:
    name: ğŸ”’ Fork PR Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft && github.event.pull_request.head.repo.full_name != github.repository

    steps:
      - name: ğŸ”’ Post Fork PR Security Notice
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prAuthor = context.payload.pull_request.user.login;
            const forkRepo = context.payload.pull_request.head.repo.full_name;

            const comment = `## ğŸ”’ Fork PR Security Notice

            **PR #${prNumber} from Fork Repository** â€¢ **Author:** @${prAuthor} â€¢ **Fork:** \`${forkRepo}\`

            ### ğŸ›¡ï¸ Security Policy

            For security reasons, automated validation is **limited** for fork PRs:

            | Check | Status | Reason |
            |-------|--------|--------|
            | ğŸ“ Static Analysis | âœ… Enabled | Safe to run without code execution |
            | ğŸ” Change Review | âœ… Enabled | Analyzes diff without running code |
            | ğŸ§ª Test Execution | âŒ Disabled | Requires maintainer approval |
            | ğŸš€ Full CI Pipeline | â¸ï¸ Waiting | Runs after maintainer review |

            ### ğŸš€ Next Steps

            1. ğŸ‘€ **Maintainer Review** - A maintainer will review your changes
            2. âœ… **Approval** - If approved, full CI will run automatically
            3. ğŸ”’ **Security Check** - All changes reviewed for security concerns
            4. ğŸ‰ **Merge** - Once all checks pass, your PR can be merged!

            ### ğŸ“‹ While You Wait

            - ğŸ“– Review [Contributing Guidelines](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)
            - âœ… Ensure your changes follow project standards
            - ğŸ§ª Add tests for new functionality
            - ğŸ“ Update documentation if needed

            ---
            *ğŸ¤– Automated security notice for fork contributions â€¢ This helps keep the project secure!*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

  pr-analysis:
    name: ğŸ” Analyze PR Changes
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' && !github.event.pull_request.draft && github.event.pull_request.head.repo.full_name == github.repository
    outputs:
      has-powershell: ${{ steps.analyze.outputs.has-powershell }}
      has-workflows: ${{ steps.analyze.outputs.has-workflows }}
      change-summary: ${{ steps.analyze.outputs.change-summary }}

    steps:
      - name: ğŸ“¥ Checkout Base Branch (Safe)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          # Always checkout base branch for security - never checkout fork PR code
          ref: ${{ github.event.pull_request.base.ref }}

      - name: ğŸ” Analyze Changes
        id: analyze
        shell: pwsh
        run: |
          Write-Host "ğŸ” Analyzing PR changes..." -ForegroundColor Cyan

          # Get changed files using GitHub API (safe for forks)
          $prNumber = "${{ github.event.pull_request.number }}"
          $apiUrl = "https://api.github.com/repos/${{ github.repository }}/pulls/$prNumber/files"

          try {
            $response = Invoke-RestMethod -Uri $apiUrl -Headers @{ 'Accept' = 'application/vnd.github.v3+json' }
            $changedFiles = $response | ForEach-Object { $_.filename }
          } catch {
            Write-Host "âš ï¸ Could not fetch PR files via API, using local diff" -ForegroundColor Yellow
            $changedFiles = @()  # Empty array for safety
          }

          # Categorize files
          $psFiles = $changedFiles | Where-Object { $_ -match '\.(ps1|psm1|psd1)$' }
          $yamlFiles = $changedFiles | Where-Object { $_ -match '\.github/workflows/.*\.(yml|yaml)$' }
          $testFiles = $changedFiles | Where-Object { $_ -match '\.Tests\.ps1$' }
          $configFiles = $changedFiles | Where-Object { $_ -match '\.(json|psd1)$' -and $_ -notmatch '\.Tests\.' }

          # Create analysis
          $analysis = @{
            TotalFiles = $changedFiles.Count
            PowerShellFiles = $psFiles.Count
            WorkflowFiles = $yamlFiles.Count
            TestFiles = $testFiles.Count
            ConfigFiles = $configFiles.Count
            ChangedFiles = $changedFiles
            Recommendations = @()
          }

          # Generate recommendations
          if ($psFiles.Count -gt 0 -and $testFiles.Count -eq 0) {
            $analysis.Recommendations += "âš ï¸ PowerShell files changed but no test files updated"
          }

          if ($yamlFiles.Count -gt 0) {
            $analysis.Recommendations += "ğŸ” Workflow files changed - ensure YAML validation passes"
          }

          if ($analysis.TotalFiles -gt 15) {
            $analysis.Recommendations += "ğŸ“‹ Large PR ($($analysis.TotalFiles) files) - consider smaller increments"
          }

          if ($psFiles.Count -gt 0) {
            $analysis.Recommendations += "ğŸ§ª Run local tests: ./az.ps1 0402"
          }

          # Set outputs
          echo "has-powershell=$($psFiles.Count -gt 0)" >> $env:GITHUB_OUTPUT
          echo "has-workflows=$($yamlFiles.Count -gt 0)" >> $env:GITHUB_OUTPUT
          echo "change-summary=$($analysis.TotalFiles) files: PS=$($psFiles.Count), Workflows=$($yamlFiles.Count), Tests=$($testFiles.Count)" >> $env:GITHUB_OUTPUT

          # Save for comment
          $analysis | ConvertTo-Json -Depth 3 | Set-Content "./pr-analysis.json"

          Write-Host "ğŸ“Š Analysis complete:" -ForegroundColor Green
          Write-Host "   Total files: $($analysis.TotalFiles)" -ForegroundColor White
          Write-Host "   PowerShell files: $($psFiles.Count)" -ForegroundColor White
          Write-Host "   Workflow files: $($yamlFiles.Count)" -ForegroundColor White

      - name: ğŸ” Quick Validation (Trusted PRs Only)
        if: steps.analyze.outputs.has-powershell == 'true' && github.event.pull_request.head.repo.full_name == github.repository
        shell: pwsh
        run: |
          Write-Host "ğŸ” Running quick validation for PowerShell changes..." -ForegroundColor Yellow

          # Security check
          if ("${{ github.event.pull_request.head.repo.full_name }}" -ne "${{ github.repository }}") {
            Write-Host "âš ï¸ Skipping validation for fork PR for security" -ForegroundColor Yellow
            echo "SYNTAX_STATUS=â­ï¸ SKIPPED (Fork PR)" >> $env:GITHUB_ENV
            exit 0
          }

          # Minimal bootstrap for validation
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal

          # Test syntax with -All switch to validate all PowerShell files
          try {
            Write-Host "Running syntax validation on all PowerShell files..." -ForegroundColor Cyan
            $output = & "./automation-scripts/0407_Validate-Syntax.ps1" -All 2>&1

            if ($LASTEXITCODE -eq 0) {
              Write-Host "âœ… Syntax validation passed" -ForegroundColor Green
              echo "SYNTAX_STATUS=âœ… PASSED" >> $env:GITHUB_ENV
              echo "SYNTAX_DETAILS<<EOF" >> $env:GITHUB_ENV
              echo "$output" >> $env:GITHUB_ENV
              echo "EOF" >> $env:GITHUB_ENV
            } else {
              Write-Host "âŒ Syntax validation failed" -ForegroundColor Red
              Write-Host "$output" -ForegroundColor Yellow
              echo "SYNTAX_STATUS=âŒ FAILED" >> $env:GITHUB_ENV
              echo "SYNTAX_ERROR<<EOF" >> $env:GITHUB_ENV
              echo "$output" >> $env:GITHUB_ENV
              echo "EOF" >> $env:GITHUB_ENV
            }
          } catch {
            Write-Host "âš ï¸ Error running syntax validation: $_" -ForegroundColor Red
            echo "SYNTAX_STATUS=âŒ FAILED" >> $env:GITHUB_ENV
            echo "SYNTAX_ERROR<<EOF" >> $env:GITHUB_ENV
            echo "Error executing syntax validation script: $_" >> $env:GITHUB_ENV
            echo "EOF" >> $env:GITHUB_ENV
          }

      - name: ğŸ’¬ Post Modern PR Validation Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read analysis
            let analysis = { Recommendations: [], TotalFiles: 0, PowerShellFiles: 0, WorkflowFiles: 0, TestFiles: 0 };
            try {
              analysis = JSON.parse(fs.readFileSync('./pr-analysis.json', 'utf8'));
            } catch (e) {
              console.log('No analysis file found');
            }

            const syntaxStatus = process.env.SYNTAX_STATUS || 'Not checked';
            const syntaxError = process.env.SYNTAX_ERROR || '';
            const syntaxDetails = process.env.SYNTAX_DETAILS || '';
            const changeSummary = "${{ steps.analyze.outputs.change-summary }}";

            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const prAuthor = context.payload.pull_request.user.login;

            // Status indicators
            const statusIcon = syntaxStatus.includes('PASSED') ? 'âœ…' : syntaxStatus.includes('FAILED') ? 'âŒ' : 'â­ï¸';
            const statusBadge = syntaxStatus.includes('PASSED') ? 'ğŸŸ¢ READY' : syntaxStatus.includes('FAILED') ? 'ğŸ”´ NEEDS FIX' : 'ğŸŸ¡ PENDING';

            let comment = `## âœ… PR Validation Results\n\n`;
            comment += `### ${statusIcon} Quick Validation: ${statusBadge}\n\n`;
            comment += `**PR #${prNumber}:** ${prTitle}\n`;
            comment += `**Author:** @${prAuthor}\n`;
            comment += `**Changes:** ${changeSummary}\n\n`;

            comment += `### ğŸ“Š File Analysis\n\n`;
            comment += `| Type | Count | Visual |\n`;
            comment += `|------|-------|--------|\n`;
            comment += `| Total Files | ${analysis.TotalFiles} | ${'ğŸ“„'.repeat(Math.min(analysis.TotalFiles, 10))} |\n`;
            comment += `| PowerShell | ${analysis.PowerShellFiles} | ${'âš¡'.repeat(Math.min(analysis.PowerShellFiles, 10))} |\n`;
            comment += `| Workflows | ${analysis.WorkflowFiles} | ${'ğŸ”„'.repeat(Math.min(analysis.WorkflowFiles, 5))} |\n`;
            comment += `| Tests | ${analysis.TestFiles} | ${'ğŸ§ª'.repeat(Math.min(analysis.TestFiles, 10))} |\n\n`;

            comment += `### ğŸ” Validation Checks\n\n`;
            comment += `| Check | Status | Next Step |\n`;
            comment += `|-------|--------|------------|\n`;
            comment += `| âœ… Syntax Check | ${syntaxStatus} | ${syntaxStatus.includes('PASSED') ? 'Complete' : 'Review errors below'} |\n`;
            comment += `| ğŸ§ª Main CI Tests | â³ Queued | Will run automatically |\n`;
            comment += `| ğŸ“Š Quality Check | â³ Queued | Runs with main CI |\n\n`;

            if (syntaxError) {
              comment += `### âŒ Action Required: Fix Syntax Errors\n\n`;
              comment += `PowerShell syntax errors were detected. Please fix them before merging.\n\n`;
              comment += `<details>\n`;
              comment += `<summary>ğŸ“‹ View Error Details</summary>\n\n`;
              comment += `\`\`\`\n${syntaxError}\n\`\`\`\n\n`;
              comment += `</details>\n\n`;
              comment += `#### ğŸ”§ How to Fix\n\n`;
              comment += `1. ğŸ“ Review the error messages above\n`;
              comment += `2. ğŸ” Identify and fix syntax errors in the affected files\n`;
              comment += `3. ğŸ§ª Test locally: \`./automation-scripts/0407_Validate-Syntax.ps1 -All\`\n`;
              comment += `4. ğŸš€ Push changes to trigger re-validation\n\n`;
            } else if (syntaxDetails && syntaxStatus.includes('PASSED')) {
              comment += `### âœ… All Syntax Checks Passed!\n\n`;
              comment += `Great work! All PowerShell files have valid syntax. ğŸ‰\n\n`;
              if (syntaxDetails.length > 0 && syntaxDetails.length < 500) {
                comment += `<details>\n`;
                comment += `<summary>ğŸ“‹ View Validation Details</summary>\n\n`;
                comment += `\`\`\`\n${syntaxDetails}\n\`\`\`\n\n`;
                comment += `</details>\n\n`;
              }
            }

            if (analysis.Recommendations && analysis.Recommendations.length > 0) {
              comment += `### ğŸ’¡ Recommendations\n\n`;
              for (const rec of analysis.Recommendations) {
                comment += `- ${rec}\n`;
              }
              comment += `\n`;
            }

            comment += `### ğŸš€ What Happens Next?\n\n`;
            if (syntaxStatus.includes('FAILED')) {
              comment += `1. â— **Fix the syntax errors** listed above\n`;
              comment += `2. ğŸ§ª **Test locally** using: \`./automation-scripts/0407_Validate-Syntax.ps1 -All\`\n`;
              comment += `3. ğŸš€ **Push your changes** - validation will re-run automatically\n`;
              comment += `4. âœ… Once validation passes, **comprehensive CI tests** will run\n`;
            } else {
              comment += `1. âœ… **Quick validation passed** - syntax is good!\n`;
              comment += `2. ğŸ”„ **Comprehensive CI is running** - check the [workflows](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions)\n`;
              comment += `3. ğŸ“Š **Quality checks** will provide detailed feedback\n`;
              comment += `4. ğŸ‰ Once all checks pass, you're **ready to merge**!\n\n`;
              comment += `#### ğŸ§ª Optional: Test Locally\n\n`;
              comment += `\`\`\`bash\n`;
              comment += `# Run syntax validation\n`;
              comment += `./automation-scripts/0407_Validate-Syntax.ps1 -All\n\n`;
              comment += `# Run unit tests\n`;
              comment += `./automation-scripts/0402_Run-UnitTests.ps1\n\n`;
              comment += `# Full test suite\n`;
              comment += `./Start-AitherZero.ps1 -Mode Orchestrate -Playbook "test-orchestrated" -PlaybookProfile quick\n`;
              comment += `\`\`\`\n`;
            }

            comment += `\n---\n`;
            comment += `*ğŸ¤– Automated PR Validation â€¢ Fast syntax check before main CI â€¢ [View Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;

            // Find and update existing comment or create new
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('âœ… PR Validation Results')
            );

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

