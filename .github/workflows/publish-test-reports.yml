---
name: ğŸ“Š Publish Test Reports to GitHub Pages

# Publish comprehensive test reports and dashboards to GitHub Pages
on:
  workflow_run:
    workflows: ["Intelligent CI Orchestrator", "Quality Validation", "ğŸ¯ Unified Testing Orchestration", "âš¡ Parallel Testing (High Performance)"]
    types: [completed]
  push:
    branches: [main, dev, develop, dev-staging, ring-0, ring-0-integrations, ring-1, ring-1-integrations, ring-2]
    paths:
      - 'library/reports/**'
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish even if no changes detected'
        type: boolean
        default: true

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "pages-publish"
  cancel-in-progress: false

jobs:
  collect-reports:
    name: ğŸ“¥ Collect Test Reports and Artifacts
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          # Always checkout from the base repository, not from PR/fork
          # This is safe because we only publish reports from trusted CI runs
          ref: ${{ github.event.repository.default_branch }}

      - name: ğŸ“Š Download Workflow Artifacts
        if: github.event.workflow_run
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}
          path: ./downloaded-artifacts
          workflow: ${{ github.event.workflow_run.workflow_id }}
        continue-on-error: true

      - name: ğŸ“¦ Organize Reports
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Organizing test reports..." -ForegroundColor Cyan

          # Create reports directory if it doesn't exist
          $reportsDir = "./reports"
          if (-not (Test-Path $reportsDir)) {
            New-Item -ItemType Directory -Path $reportsDir -Force | Out-Null
          }

          # Copy downloaded artifacts to reports directory
          if (Test-Path "./downloaded-artifacts") {
            Write-Host "Copying downloaded artifacts..." -ForegroundColor Yellow
            Get-ChildItem "./downloaded-artifacts" -Recurse -File | ForEach-Object {
              $destPath = Join-Path $reportsDir $_.Name
              Copy-Item $_.FullName -Destination $destPath -Force
              Write-Host "  Copied: $($_.Name)" -ForegroundColor Green
            }
          }

          # Run quality validation to generate quality metrics for dashboard
          Write-Host "Running quality validation for key domains..." -ForegroundColor Cyan
          $domainPaths = @(
            "./domains/utilities",
            "./domains/configuration",
            "./domains/security",
            "./domains/experience"
          )

          foreach ($domainPath in $domainPaths) {
            if (Test-Path $domainPath) {
              Write-Host "  Validating: $domainPath" -ForegroundColor Yellow
              try {
                ./library/automation-scripts/0420_Validate-ComponentQuality.ps1 -Path $domainPath -Recursive -ErrorAction Continue
              } catch {
                Write-Host "  âš ï¸ Quality validation for $domainPath had issues (continuing): $_" -ForegroundColor Yellow
              }
            }
          }

          # Also validate key automation scripts
          Write-Host "Validating automation scripts..." -ForegroundColor Cyan
          $criticalScripts = @(
            "./library/automation-scripts/0402_Run-UnitTests.ps1",
            "./library/automation-scripts/0404_Run-PSScriptAnalyzer.ps1",
            "./library/automation-scripts/0512_Generate-Dashboard.ps1"
          )

          foreach ($scriptPath in $criticalScripts) {
            if (Test-Path $scriptPath) {
              Write-Host "  Validating: $(Split-Path $scriptPath -Leaf)" -ForegroundColor Yellow
              try {
                ./library/automation-scripts/0420_Validate-ComponentQuality.ps1 -Path $scriptPath -ErrorAction Continue
              } catch {
                Write-Host "  âš ï¸ Quality validation for $(Split-Path $scriptPath -Leaf) had issues (continuing): $_" -ForegroundColor Yellow
              }
            }
          }

          Write-Host "âœ… Quality validation completed" -ForegroundColor Green

          # Generate FULL COMPREHENSIVE dashboard (0512 does all the heavy lifting)
          Write-Host "Generating comprehensive dashboard with all metrics..." -ForegroundColor Cyan
          ./library/automation-scripts/0512_Generate-Dashboard.ps1 -Format All

          # Create beginner-friendly LANDING PAGE that guides to the detailed dashboard
          $reportFiles = Get-ChildItem $reportsDir -File | Sort-Object LastWriteTime -Descending
          $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'

          # Check if comprehensive dashboard exists
          $dashboardHTML = Join-Path $reportsDir "dashboard.html"
          $hasDashboard = Test-Path $dashboardHTML

          $indexContent = "# ğŸ¯ AitherZero Project Dashboard - Landing Page`n`n"

          if ($hasDashboard) {
            $indexContent += "## ğŸš€ [VIEW COMPREHENSIVE DASHBOARD â†’](docs/reports/dashboard.html)`n`n"
            $indexContent += "> Click above for the full interactive dashboard with all metrics, charts, and detailed analysis`n`n"
            $indexContent += "---`n`n"
          }

          $indexContent += "## ğŸ“Š Quick Navigation`n`n"
          $indexContent += "### For Non-Technical Users`n"
          $indexContent += "Start here if you're new to coding projects or need a high-level overview:`n`n"
          $indexContent += "1. **[Dashboard](docs/reports/dashboard.html)** - Visual overview with health scores and trends`n"
          $indexContent += "2. **What does it mean?** - Health scores tell you if things are working (0-100, higher is better)`n"
          $indexContent += "3. **What should I do?** - Look for red items in the dashboard - those need attention first`n`n"
          $indexContent += "### For Technical Users`n"
          $indexContent += "Direct access to detailed reports and raw data:`n`n"

          foreach ($file in $reportFiles) {
            $relativePath = "library/reports/$($file.Name)"
            $fileTime = Get-Date $file.LastWriteTime -Format 'yyyy-MM-dd HH:mm:ss'
            $indexContent += "- [$($file.Name)]($relativePath) - $fileTime`n"
          }

          $indexContent += "`n---`n`n"
          $indexContent += "## ğŸ“ Quick Reference Guide`n`n"
          $indexContent += "### Health Scores Explained`n"
          $indexContent += "- **90-100**: ğŸŸ¢ Excellent`n"
          $indexContent += "- **70-89**: ğŸŸ¡ Good`n"
          $indexContent += "- **50-69**: ğŸŸ  Needs Work`n"
          $indexContent += "- **0-49**: ğŸ”´ Urgent`n`n"
          $indexContent += "### Priority Guide`n"
          $indexContent += "1. Fix anything marked 'Critical' or 'Error'`n"
          $indexContent += "2. Address failing tests`n"
          $indexContent += "3. Review warnings`n"
          $indexContent += "4. Plan for features`n`n"
          $indexContent += "---`n`n"
          $indexContent += "Generated: $timestamp`n"

          $indexContent | Out-File -FilePath "./reports-index.md" -Encoding UTF8

          Write-Host "âœ… Reports organized successfully" -ForegroundColor Green
          Write-Host "Total reports: $($reportFiles.Count)" -ForegroundColor Cyan
          if ($hasDashboard) {
            Write-Host "âœ… Comprehensive dashboard available at library/reports/dashboard.html" -ForegroundColor Green
          }

      - name: ğŸ’¾ Commit Updated Persisted Reports
        if: github.event_name != 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add only the persisted reports that should be tracked
          git add reports/dashboard.html reports/dashboard.md reports/dashboard.json
          git add reports/psscriptanalyzer-fast-results.json
          git add reports/README.md reports/index.md
          git add reports/metrics-history/*.json
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "chore: update persisted reports - $(date -u +"%Y-%m-%d %H:%M UTC") [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… Persisted reports committed and pushed"
          else
            echo "â„¹ï¸ No changes to persisted reports"
          fi

      - name: ğŸ“¤ Upload Combined Reports
        uses: actions/upload-artifact@v4
        with:
          name: combined-reports
          path: |
            library/reports/
            reports-index.md
            index.md
            _config.yml
          retention-days: 30

  publish-to-pages:
    name: ğŸš€ Publish to GitHub Pages
    runs-on: ubuntu-latest
    needs: collect-reports

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š Download Combined Reports
        uses: actions/download-artifact@v4
        with:
          name: combined-reports
          path: ./

      - name: ğŸ”§ Setup Pages
        uses: actions/configure-pages@v5

      - name: ğŸ—ï¸ Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: ğŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ğŸ“‹ Report Deployment
        shell: pwsh
        run: |
          Write-Host "âœ… Successfully deployed to GitHub Pages!" -ForegroundColor Green
          Write-Host "ğŸ”— URL: ${{ steps.deployment.outputs.page_url }}" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ğŸ“Š Available Reports:" -ForegroundColor Yellow
          Write-Host "  - Dashboard: ${{ steps.deployment.outputs.page_url }}docs/reports/dashboard.html"
          Write-Host "  - Reports Index: ${{ steps.deployment.outputs.page_url }}reports-index.html"
          Write-Host "  - All Reports: ${{ steps.deployment.outputs.page_url }}docs/reports/"
