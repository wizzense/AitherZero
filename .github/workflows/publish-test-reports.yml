---
name: ðŸ“Š Publish Test Reports & Dashboard to GitHub Pages

# Publish comprehensive test reports, dashboards, and PR-specific status to GitHub Pages
# Integrates with test-execution.yml and generates navigable reports for each PR
on:
  workflow_run:
    workflows: ["ðŸ§ª Test Execution (Complete Suite)", "âœ… PR Validation (v2 - CLI)", "ðŸ” Quality Validation (v2 - CLI)"]
    types: [completed]
  push:
    branches: [main, dev, develop, dev-staging, ring-0, ring-0-integrations, ring-1, ring-1-integrations, ring-2]
    paths:
      - 'library/reports/**'
      - 'library/tests/results/**'
      - 'library/tests/coverage/**'
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish even if no changes detected'
        type: boolean
        default: true
      pr_number:
        description: 'PR number for PR-specific publishing (leave empty for main)'
        type: string
        required: false

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "pages-publish"
  cancel-in-progress: false

jobs:
  collect-reports:
    name: ðŸ“¥ Collect Test Reports and Generate Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.event.repository.default_branch }}
          fetch-depth: 0

      - name: ðŸ”§ Bootstrap Environment
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Bootstrapping AitherZero environment..." -ForegroundColor Cyan
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal

      - name: ðŸ“Š Download Test Artifacts from test-execution.yml
        if: github.event.workflow_run
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}
          path: ./downloaded-artifacts
          workflow: test-execution.yml
        continue-on-error: true

      - name: ðŸ“¦ Organize Test Results
        shell: pwsh
        run: |
          Write-Host "ðŸ“¦ Organizing test results from new test structure..." -ForegroundColor Cyan
          
          # Ensure directories exist
          New-Item -ItemType Directory -Path "library/tests/results" -Force | Out-Null
          New-Item -ItemType Directory -Path "library/tests/coverage" -Force | Out-Null
          New-Item -ItemType Directory -Path "library/reports" -Force | Out-Null
          
          # Copy downloaded artifacts to test results
          if (Test-Path "./downloaded-artifacts") {
            Write-Host "Copying test artifacts from test-execution.yml..." -ForegroundColor Yellow
            
            Get-ChildItem "./downloaded-artifacts" -Recurse -Filter "*.xml" | ForEach-Object {
              $destPath = Join-Path "library/tests/results" $_.Name
              Copy-Item $_.FullName -Destination $destPath -Force
              Write-Host "  âœ“ Test Result: $($_.Name)" -ForegroundColor Green
            }
            
            Get-ChildItem "./downloaded-artifacts" -Recurse -Filter "*.json" | ForEach-Object {
              $destPath = Join-Path "library/tests/results" $_.Name
              Copy-Item $_.FullName -Destination $destPath -Force
              Write-Host "  âœ“ Test Data: $($_.Name)" -ForegroundColor Green
            }
            
            # Copy coverage data
            Get-ChildItem "./downloaded-artifacts" -Recurse -Include "coverage*" | ForEach-Object {
              if ($_.PSIsContainer) {
                Copy-Item $_.FullName -Destination "library/tests/coverage" -Recurse -Force
              } else {
                Copy-Item $_.FullName -Destination "library/tests/coverage" -Force
              }
              Write-Host "  âœ“ Coverage: $($_.Name)" -ForegroundColor Green
            }
          }
          
          Write-Host "âœ… Test results organized" -ForegroundColor Green

      - name: ðŸŽ¯ Run Comprehensive Tests for Dashboard
        shell: pwsh
        run: |
          Write-Host "ðŸ§ª Running tests to generate fresh metrics..." -ForegroundColor Cyan
          
          # Run quick validation to get current metrics
          if (Test-Path "./library/automation-scripts/0404_Run-PSScriptAnalyzer.ps1") {
            Write-Host "Running PSScriptAnalyzer for quality metrics..." -ForegroundColor Yellow
            ./library/automation-scripts/0404_Run-PSScriptAnalyzer.ps1 -Fast -ErrorAction Continue
          }
          
          # Run unit tests for test metrics
          if (Test-Path "./library/automation-scripts/0402_Run-UnitTests.ps1") {
            Write-Host "Running unit tests for coverage metrics..." -ForegroundColor Yellow
            ./library/automation-scripts/0402_Run-UnitTests.ps1 -NoCoverage -ErrorAction Continue
          }
          
          Write-Host "âœ… Test execution completed" -ForegroundColor Green

      - name: ðŸ“Š Generate Comprehensive Dashboard
        shell: pwsh
        run: |
          Write-Host "ðŸ“Š Generating comprehensive project dashboard..." -ForegroundColor Cyan
          
          # Generate main dashboard with all metrics
          ./library/automation-scripts/0512_Generate-Dashboard.ps1 -Format All
          
          # Generate project report
          if (Test-Path "./library/automation-scripts/0510_Generate-ProjectReport.ps1") {
            ./library/automation-scripts/0510_Generate-ProjectReport.ps1 -ErrorAction Continue
          }
          
          Write-Host "âœ… Dashboard generated successfully" -ForegroundColor Green

      - name: ðŸ·ï¸ Generate PR-Specific Dashboard
        if: github.event.pull_request
        shell: pwsh
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_BASE: ${{ github.event.pull_request.base.ref }}
        run: |
          Write-Host "ðŸ·ï¸ Generating PR-specific dashboard for PR #$env:PR_NUMBER..." -ForegroundColor Cyan
          
          $prDir = "library/reports/pr-$env:PR_NUMBER"
          New-Item -ItemType Directory -Path $prDir -Force | Out-Null
          
          # Copy main dashboard to PR-specific location
          if (Test-Path "library/reports/dashboard.html") {
            Copy-Item "library/reports/dashboard.html" "$prDir/dashboard.html" -Force
            Copy-Item "library/reports/dashboard.json" "$prDir/dashboard.json" -Force -ErrorAction SilentlyContinue
          }
          
          # Create PR-specific index
          $prIndexContent = @"
# ðŸŽ¯ PR #$env:PR_NUMBER Dashboard

**Title:** $env:PR_TITLE  
**Branch:** ``$env:PR_BRANCH`` â†’ ``$env:PR_BASE``  
**Status:** ${{ github.event.pull_request.state }}  
**Updated:** $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')

## ðŸ“Š Quick Links

- [View Dashboard](dashboard.html) - Comprehensive metrics and status
- [Back to Main Dashboard](../dashboard.html)
- [All PRs](/prs/)

## ðŸ“ˆ Latest Test Results

"@
          
          # Add test result summary if available
          $testResults = Get-ChildItem "library/tests/results" -Filter "*.xml" -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($testResults) {
            try {
              [xml]$testXml = Get-Content $testResults.FullName
              $total = [int]$testXml.'test-results'.total
              $failures = [int]$testXml.'test-results'.failures
              $errors = [int]$testXml.'test-results'.errors
              $passed = $total - $failures - $errors
              
              $prIndexContent += @"

### Test Summary
- âœ… **Passed:** $passed
- âŒ **Failed:** $($failures + $errors)
- ðŸ“Š **Total:** $total
- ðŸŽ¯ **Success Rate:** $([math]::Round(($passed / $total) * 100, 1))%

"@
            } catch {
              Write-Host "âš ï¸ Could not parse test results: $_" -ForegroundColor Yellow
            }
          }
          
          $prIndexContent | Out-File -FilePath "$prDir/index.md" -Encoding UTF8
          
          Write-Host "âœ… PR #$env:PR_NUMBER dashboard created at $prDir" -ForegroundColor Green

      - name: ðŸ“‘ Create Main Navigation Index
        shell: pwsh
        run: |
          Write-Host "ðŸ“‘ Creating main navigation index..." -ForegroundColor Cyan
          
          $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'
          
          # Get all PR dashboards
          $prDirs = Get-ChildItem "library/reports" -Directory -Filter "pr-*" -ErrorAction SilentlyContinue | Sort-Object Name -Descending
          
          $indexContent = @"
# ðŸŽ¯ AitherZero Project Dashboard

**Last Updated:** $timestamp

## ðŸš€ Main Dashboard

ðŸ“Š [**View Comprehensive Dashboard**](library/reports/dashboard.html) - Real-time project metrics, test results, and code quality

---

## ðŸ“‹ Pull Request Dashboards

"@
          
          if ($prDirs.Count -gt 0) {
            foreach ($prDir in $prDirs) {
              $prNum = $prDir.Name -replace 'pr-', ''
              $prIndexPath = Join-Path $prDir.FullName "index.md"
              
              if (Test-Path $prIndexPath) {
                $prContent = Get-Content $prIndexPath -Raw
                if ($prContent -match 'Title:\*\* (.+)') {
                  $prTitle = $matches[1].Trim()
                } else {
                  $prTitle = "PR #$prNum"
                }
              } else {
                $prTitle = "PR #$prNum"
              }
              
              $indexContent += "- [PR #$prNum - $prTitle](library/reports/$($prDir.Name)/)`n"
            }
          } else {
            $indexContent += "*No open PRs with dashboards*`n"
          }
          
          $indexContent += @"

---

## ðŸ“š Additional Resources

- [Test Reports](library/tests/results/) - Raw test execution data
- [Coverage Reports](library/tests/coverage/) - Code coverage analysis
- [Quality Metrics](library/reports/psscriptanalyzer-fast-results.json) - PSScriptAnalyzer results
- [Project Reports](library/reports/) - All generated reports

## ðŸŽ“ Dashboard Guide

### Health Scores
- ðŸŸ¢ **90-100**: Excellent
- ðŸŸ¡ **70-89**: Good  
- ðŸŸ  **50-69**: Needs Work
- ðŸ”´ **0-49**: Urgent

### Priority Actions
1. Fix Critical/Error items
2. Address failing tests
3. Review warnings
4. Plan new features

---

*Generated: $timestamp*
"@
          
          $indexContent | Out-File -FilePath "index.md" -Encoding UTF8
          
          Write-Host "âœ… Navigation index created" -ForegroundColor Green
          Write-Host "  - PRs tracked: $($prDirs.Count)" -ForegroundColor Cyan

      - name: ðŸ’¾ Commit Updated Reports
        if: github.event_name != 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add reports and dashboards
          git add library/reports/dashboard.* library/reports/psscriptanalyzer-fast-results.json
          git add library/reports/pr-*/
          git add library/reports/README.md library/reports/index.md
          git add library/reports/metrics-history/*.json
          git add index.md
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "chore: update dashboards and reports - $(date -u +"%Y-%m-%d %H:%M UTC") [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… Reports committed and pushed"
          else
            echo "â„¹ï¸ No changes to reports"
          fi

      - name: ðŸ“¤ Upload Combined Reports
        uses: actions/upload-artifact@v4
        with:
          name: combined-reports
          path: |
            library/reports/
            library/tests/results/
            library/tests/coverage/
            index.md
            _config.yml
          retention-days: 30

  publish-to-pages:
    name: ðŸš€ Publish to GitHub Pages
    runs-on: ubuntu-latest
    needs: collect-reports
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“Š Download Combined Reports
        uses: actions/download-artifact@v4
        with:
          name: combined-reports
          path: ./

      - name: ðŸ”§ Setup Pages
        uses: actions/configure-pages@v5

      - name: ðŸ—ï¸ Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: ðŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ðŸ“‹ Report Deployment
        shell: pwsh
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          Write-Host "âœ… Successfully deployed to GitHub Pages!" -ForegroundColor Green
          Write-Host "ðŸ”— Main URL: $env:PAGE_URL" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ðŸ“Š Available Dashboards:" -ForegroundColor Yellow
          Write-Host "  - Main Dashboard: ${env:PAGE_URL}library/reports/dashboard.html"
          Write-Host "  - Navigation Index: ${env:PAGE_URL}index.html"
          
          if ($env:PR_NUMBER) {
            Write-Host "  - PR #$env:PR_NUMBER Dashboard: ${env:PAGE_URL}library/reports/pr-$env:PR_NUMBER/"
          }
          
          Write-Host ""
          Write-Host "ðŸ“‚ All Reports: ${env:PAGE_URL}library/reports/"
          Write-Host "ðŸ§ª Test Results: ${env:PAGE_URL}library/tests/results/"
          Write-Host "ðŸ“ˆ Coverage: ${env:PAGE_URL}library/tests/coverage/"

      - name: ðŸ’¬ Comment on PR with Dashboard Link
        if: github.event.pull_request
        uses: actions/github-script@v7
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          script: |
            const pageUrl = process.env.PAGE_URL;
            const prNumber = process.env.PR_NUMBER;
            
            const comment = `## ðŸ“Š Dashboard Published

Your PR-specific dashboard has been published to GitHub Pages!

### ðŸ”— Quick Links
- **[View PR Dashboard](${pageUrl}library/reports/pr-${prNumber}/)** - Your PR's current status
- **[Main Project Dashboard](${pageUrl}library/reports/dashboard.html)** - Overall project health
- **[All Test Results](${pageUrl}library/tests/results/)** - Detailed test data

### ðŸ“ˆ What's Included
- âœ… Test execution results
- ðŸ“Š Code coverage metrics
- ðŸ” Quality analysis
- ðŸ“‹ Project status

---
*ðŸ¤– Auto-generated by publish-test-reports workflow*`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes('Dashboard Published')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
