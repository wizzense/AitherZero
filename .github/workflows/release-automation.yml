---
name: Release Automation

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.2.3)'
        required: true
        type: string
      prerelease:
        description: 'Mark as pre-release'
        type: boolean
        default: false
      run_full_tests:
        description: 'Run comprehensive tests before release'
        type: boolean
        default: true

permissions:
  contents: write
  pages: write
  id-token: write
  packages: write

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true

jobs:
  pre-release-validation:
    name: Pre-Release Validation
    runs-on: ubuntu-latest
    if: github.event.inputs.run_full_tests == 'true' || github.event_name == 'push'
    timeout-minutes: 15
    outputs:
      validation-status: ${{ steps.validation.outputs.status }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Bootstrap Environment
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Preparing release validation environment..." -ForegroundColor Magenta
          ./bootstrap.ps1 -Mode New -InstallProfile Standard

      - name: ğŸ“¦ Install Release Dependencies
        shell: pwsh
        run: |
          $modules = @('Pester', 'PSScriptAnalyzer')
          foreach ($module in $modules) {
            Write-Host "Installing $module..." -ForegroundColor Yellow
            Install-Module -Name $module -Force -SkipPublisherCheck -Scope CurrentUser
          }

      - name: ğŸ” Comprehensive Validation
        id: validation
        shell: pwsh
        run: |
          Write-Host "ğŸ” Running comprehensive pre-release validation..." -ForegroundColor Yellow
          $errors = @()

          # Syntax validation
          try {
            Write-Host "  ğŸ“ Syntax validation..." -ForegroundColor Cyan
            & "./library/automation-scripts/0407_*.ps1"
            Write-Host "  âœ… Syntax validation passed" -ForegroundColor Green
          } catch {
            $errors += "Syntax validation failed: $_"
            Write-Host "  âŒ Syntax validation failed" -ForegroundColor Red
          }

          # Module loading test
          try {
            Write-Host "  ğŸ“¦ Module loading test..." -ForegroundColor Cyan
            Import-Module ./AitherZero.psd1 -Force
            $moduleInfo = Get-Module AitherZero
            Write-Host "  âœ… Module loaded: $($moduleInfo.ExportedCommands.Count) commands" -ForegroundColor Green
          } catch {
            $errors += "Module loading failed: $_"
            Write-Host "  âŒ Module loading failed" -ForegroundColor Red
          }

          # Core tests
          try {
            Write-Host "  ğŸ§ª Core functionality tests..." -ForegroundColor Cyan
            & "./library/automation-scripts/0402_*.ps1"
            Write-Host "  âœ… Core tests passed" -ForegroundColor Green
          } catch {
            Write-Host "  âš ï¸ Core tests had issues (not blocking): $_" -ForegroundColor Yellow
          }

          # Code analysis
          try {
            Write-Host "  ğŸ”¬ Code quality analysis..." -ForegroundColor Cyan
            & "./library/automation-scripts/0404_*.ps1"
            Write-Host "  âœ… Code analysis passed" -ForegroundColor Green
          } catch {
            Write-Host "  âš ï¸ Code analysis had issues (not blocking): $_" -ForegroundColor Yellow
          }

          if ($errors.Count -gt 0) {
            Write-Host "âŒ Critical validation errors found:" -ForegroundColor Red
            $errors | ForEach-Object { Write-Host "  - $_" -ForegroundColor Red }
            echo "status=failed" >> $env:GITHUB_OUTPUT
            exit 1
          } else {
            Write-Host "âœ… All critical validations passed" -ForegroundColor Green
            echo "status=success" >> $env:GITHUB_OUTPUT
          }

  create-release:
    name: Create Release Package
    runs-on: ubuntu-latest
    needs: [pre-release-validation]
    if: always() && (needs.pre-release-validation.result == 'success' || needs.pre-release-validation.result == 'skipped')
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ“‹ Prepare Release Info
        shell: pwsh
        run: |
          # Determine version
          if ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $version = "${{ github.ref_name }}" -replace '^v', ''
          }

          Write-Host "ğŸ·ï¸ Preparing release for version: $version" -ForegroundColor Magenta

          # Update VERSION file
          $version | Set-Content ./VERSION -NoNewline

          # Update module manifest version
          $manifestPath = "./AitherZero.psd1"
          $manifestContent = Get-Content $manifestPath -Raw
          $manifestContent = $manifestContent -replace "ModuleVersion\s*=\s*'[\d\.]+[^']*'", "ModuleVersion = '$version'"
          $manifestContent | Set-Content $manifestPath -NoNewline

          # Verify version update
          $updatedVersion = Get-Content ./VERSION -Raw
          Write-Host "âœ… Version updated to: $updatedVersion" -ForegroundColor Green

          echo "RELEASE_VERSION=$version" >> $env:GITHUB_ENV

      - name: ğŸ“¦ Build Release Package
        shell: pwsh
        run: |
          $version = $env:RELEASE_VERSION
          $packageName = "AitherZero-v$version"
          $isPrerelease = "${{ github.event.inputs.prerelease }}" -eq "true"

          # Create comprehensive build info
          $buildInfo = @{
            Version = $version
            BuildNumber = "${{ github.run_number }}"
            Commit = "${{ github.sha }}"
            CommitShort = "${{ github.sha }}".Substring(0, 8)
            Branch = "${{ github.ref_name }}"
            BuildTime = (Get-Date -Format "yyyy-MM-dd HH:mm:ss UTC")
            BuildDate = (Get-Date -Format "yyyy-MM-dd")
            Platform = "Multi-Platform"
            ReleaseType = if ($isPrerelease) { "Pre-Release" } else { "Release" }
            Workflow = "release-automation"
            PowerShellVersion = $PSVersionTable.PSVersion.ToString()
            BuildEnvironment = "GitHub Actions"
          }

          $buildInfo | ConvertTo-Json -Depth 2 | Set-Content "./build-info.json"

          Write-Host "ğŸ“¦ Creating release package: $packageName" -ForegroundColor Yellow
          New-Item -ItemType Directory -Path "./$packageName" -Force | Out-Null

          # Runtime-only file list for clean releases
          # Users get what they need to run AitherZero, not development files
          $releaseFiles = @(
            # Core module manifest and loader
            "AitherZero.psd1", "AitherZero.psm1",
            # Essential startup scripts
            "Start-AitherZero.ps1", "az.ps1",
            # Bootstrap for installation
            "bootstrap.ps1", "bootstrap.sh",
            # Container support
            "Dockerfile", "docker-compose.yml", "docker-entrypoint.ps1",
            "docker-start.ps1", "container-welcome.ps1",
            # Documentation (user-facing only)
            "README.md", "LICENSE", "VERSION",
            "QUICKSTART-AUTOMATED-REPORTS.md", "README-ModernCLI.md",
            "FUNCTIONALITY-INDEX.md", "DOCKER.md",
            # Essential directories - Runtime modules only
            "aithercore",
            "library/automation-scripts",
            # Configuration templates (examples only)
            "config.example.psd1", ".env.example",
            # Build metadata
            "build-info.json"
          )

          Write-Host "ğŸ“¦ Creating clean runtime package (no dev/test files)..." -ForegroundColor Cyan

          foreach ($pattern in $releaseFiles) {
            if (Test-Path $pattern) {
              Copy-Item -Path $pattern -Destination "./$packageName" -Recurse -Force
              Write-Host "  âœ… Added: $pattern" -ForegroundColor Green
            } else {
              Write-Host "  âš ï¸ Not found: $pattern" -ForegroundColor Yellow
            }
          }

          # Exclude development/internal files from domains and scripts
          Write-Host "ğŸ§¹ Cleaning development files from package..." -ForegroundColor Cyan

          # Remove test files if they exist
          if (Test-Path "./$packageName/aithercore/*/tests") {
            Remove-Item "./$packageName/aithercore/*/tests" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "  âœ… Removed domain test files" -ForegroundColor Green
          }

          # Remove any .git directories
          if (Test-Path "./$packageName/.git*") {
            Remove-Item "./$packageName/.git*" -Recurse -Force -ErrorAction SilentlyContinue
            Write-Host "  âœ… Removed git metadata" -ForegroundColor Green
          }

          Write-Host "âœ… Package contains only runtime essentials" -ForegroundColor Green

          # Create multiple archive formats
          Write-Host "ğŸ“ Creating archive formats..." -ForegroundColor Cyan

          # ZIP for Windows compatibility - compress contents, not the directory itself
          Compress-Archive -Path "./$packageName/*" -DestinationPath "./$packageName.zip" -Force
          Write-Host "  âœ… Created: $packageName.zip" -ForegroundColor Green

          # TAR.GZ for Unix systems - use -C to change directory and avoid nested structure
          if (Get-Command tar -ErrorAction SilentlyContinue) {
            tar -czf "./$packageName.tar.gz" -C "./$packageName" .
            Write-Host "  âœ… Created: $packageName.tar.gz" -ForegroundColor Green
          }

          # Display package info
          Write-Host "ğŸ“Š Package Summary:" -ForegroundColor Magenta
          Get-ChildItem -Filter "AitherZero-v*" | ForEach-Object {
            $sizeMB = [math]::Round($_.Length / 1MB, 2)
            Write-Host "  $($_.Name): ${sizeMB} MB" -ForegroundColor White
          }

      - name: ğŸ“ Generate Release Notes
        shell: pwsh
        run: |
          $version = $env:RELEASE_VERSION
          $buildInfo = Get-Content "./build-info.json" | ConvertFrom-Json
          $isPrerelease = "${{ github.event.inputs.prerelease }}" -eq "true"

          # Get commit messages since last tag for changelog
          $lastTag = ""
          try {
            $lastTag = git describe --tags --abbrev=0 HEAD~1 2>$null
          } catch {
            $lastTag = "Initial release"
          }

          $releaseNotes = @"
          # AitherZero v$version

          $(if ($isPrerelease) { "ğŸš§ **Pre-Release** - Use with caution in production environments" } else { "ğŸš€ **Stable Release**" })

          ## ğŸ“‹ Build Information
          - **Version:** $($buildInfo.Version)
          - **Build:** #$($buildInfo.BuildNumber)
          - **Commit:** [$($buildInfo.CommitShort)](${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }})
          - **Build Date:** $($buildInfo.BuildDate)
          - **Environment:** $($buildInfo.BuildEnvironment)

          ## âœ¨ AitherZero Features
          - **Cross-Platform:** Windows, Linux, and macOS support
          - **Number-Based Orchestration:** Systematic script execution (0000-9999)
          - **Domain Architecture:** Modular design with specialized domains
          - **CI/CD Integration:** GitHub Actions workflows for automation
          - **Infrastructure as Code:** OpenTofu/Terraform support
          - **Comprehensive Testing:** Automated validation and reporting
          - **MCP Server:** AI assistant integration via Model Context Protocol
          - **Container Support:** Docker images for isolated environments

          ## ğŸ“¦ What's Included

          ### AitherZero Platform
          - Complete PowerShell module with all domains
          - 100+ automation scripts organized by number ranges
          - Cross-platform bootstrap and setup scripts
          - Comprehensive test suite and validation tools
          - Documentation and examples
          - CI/CD workflow templates

          ### MCP Server Package
          - Model Context Protocol server for AI assistants (Claude, GitHub Copilot, etc.)
          - Execute automation scripts via natural language
          - Infrastructure management through conversational AI
          - Package: \`@aitherzero/mcp-server@$($version -replace '^v','')\`

          ### Docker Image
          - Pre-configured container with AitherZero installed
          - Multi-platform support (amd64, arm64)
          - Non-root user for security
          - Image: \`ghcr.io/${{ github.repository }}:$($version -replace '^v','')\`

          ## ğŸš€ Quick Installation

          ### Platform (One-Line Install)
          ```powershell
          # PowerShell 5.1+ (auto-upgrades to PowerShell 7)
          iwr -useb https://raw.githubusercontent.com/wizzense/AitherZero/main/bootstrap.ps1 | iex
          ```

          ### MCP Server
          ```bash
          # Install from GitHub Packages
          npm install @aitherzero/mcp-server@$($version -replace '^v','')

          # Or use the tarball from release assets
          curl -L https://github.com/${{ github.repository }}/releases/download/v$($version)/aitherzero-mcp-server-$($version -replace '^v','').tgz -o mcp-server.tgz
          npm install mcp-server.tgz
          ```

          ### Docker Container
          ```bash
          # Pull the image
          docker pull ghcr.io/${{ github.repository }}:$($version -replace '^v','')

          # Run interactively
          docker run -it --rm ghcr.io/${{ github.repository }}:$($version -replace '^v','')

          # Run with docker-compose
          docker-compose up -d
          ```

          ### Manual Installation
          1. Download and extract `AitherZero-v$version.zip`
          2. Open PowerShell in the extracted directory
          3. Run: `./bootstrap.ps1 -Mode New`

          ### Verification
          ```powershell
          # Verify installation
          ./az.ps1 0407          # Syntax validation
          ./Start-AitherZero.ps1  # Interactive mode
          ```

          ## ğŸ¯ Quick Start Commands
          ```powershell
          # Environment and validation
          ./az.ps1 0407          # Validate PowerShell syntax
          ./az.ps1 0402          # Run unit tests
          ./az.ps1 0404          # Code quality analysis

          # System setup (Windows)
          # Note: PowerShell 7 is ensured by bootstrap.ps1
          ./az.ps1 0105          # Install Hyper-V
          ./az.ps1 0106          # Install WSL2

          # Development tools
          ./az.ps1 0207          # Install Git
          ./az.ps1 0208          # Install Docker
          ./az.ps1 0210          # Install VS Code

          # Reporting and monitoring
          ./az.ps1 0510          # Generate project report
          ./az.ps1 0511          # Show project dashboard
          ```

          ## ğŸ¤– MCP Server Usage

          Add to your AI assistant configuration:

          ### Claude Desktop
          ```json
          {
            "mcpServers": {
              "aitherzero": {
                "command": "npx",
                "args": ["@aitherzero/mcp-server@$($version -replace '^v','')"]
              }
            }
          }
          ```

          ### VS Code / GitHub Copilot
          Add to `.github/mcp-servers.json`:
          ```json
          {
            "mcpServers": {
              "aitherzero": {
                "command": "npx",
                "args": ["@aitherzero/mcp-server@$($version -replace '^v','')"],
                "description": "AitherZero infrastructure automation"
              }
            }
          }
          ```

          ## ğŸ“‹ System Requirements
          - **PowerShell:** 7.0+ (5.1+ supported with auto-upgrade)
          - **Operating System:** Windows 10/11, Ubuntu 20.04+, macOS 11.0+
          - **Memory:** 2GB RAM minimum, 4GB recommended
          - **Storage:** 1GB free space
          - **Network:** Internet connection for initial setup and updates
          - **Node.js:** 18+ (for MCP server only)
          - **Docker:** 20.10+ (for container deployment only)

          ## ğŸ“š Documentation
          - [Getting Started Guide](https://github.com/wizzense/AitherZero#getting-started)
          - [Function Reference](https://github.com/wizzense/AitherZero/blob/main/FUNCTIONALITY-INDEX.md)
          - [Automation Scripts](https://github.com/wizzense/AitherZero/tree/main/automation-scripts)
          - [Domain Architecture](https://github.com/wizzense/AitherZero/tree/main/domains)
          - [MCP Server Documentation](https://github.com/wizzense/AitherZero/tree/main/mcp-server#readme)
          - [Docker Documentation](https://github.com/wizzense/AitherZero/blob/main/DOCKER.md)

          ## ğŸ”„ Updates and Migration
          ```powershell
          # Update existing installation
          ./bootstrap.ps1 -Mode Update

          # Clean install (removes old version)
          ./bootstrap.ps1 -Mode Clean
          ```

          ---

          **Full Changelog:** [Compare v$lastTag...v$version](${{ github.server_url }}/${{ github.repository }}/compare/$lastTag...v$version)

          **Support:** [Create an issue](${{ github.server_url }}/${{ github.repository }}/issues/new) for questions or problems

          **Container Registry:** [View Docker images](https://github.com/${{ github.repository }}/pkgs/container/aitherzero)

          **Package Registry:** [View MCP server package](https://github.com/${{ github.repository }}/pkgs/npm/%40aitherzero%2Fmcp-server)
          "@

          $releaseNotes | Set-Content ./release-notes.md
          Write-Host "ğŸ“ Release notes generated for v$version" -ForegroundColor Green

      - name: ğŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          name: AitherZero v${{ env.RELEASE_VERSION }}
          body_path: ./release-notes.md
          draft: false
          prerelease: ${{ github.event.inputs.prerelease == 'true' }}
          files: |
            AitherZero-v*.zip
            AitherZero-v*.tar.gz
            build-info.json
          make_latest: ${{ github.event.inputs.prerelease != 'true' }}

      - name: ğŸ·ï¸ Update Latest Tag
        if: github.event.inputs.prerelease != 'true'
        shell: pwsh
        run: |
          Write-Host "ğŸ·ï¸ Updating 'latest' tag..." -ForegroundColor Yellow
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Force update latest tag
          git tag -f latest
          git push -f origin latest

          Write-Host "âœ… Latest tag updated to v${{ env.RELEASE_VERSION }}" -ForegroundColor Green

  build-mcp-server:
    name: Build and Publish MCP Server
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always() && (needs.create-release.result == 'success')
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          registry-url: 'https://npm.pkg.github.com'
          scope: '@aitherzero'

      - name: ğŸ“‹ Update MCP Server Version
        shell: bash
        working-directory: mcp-server
        run: |
          VERSION="${{ env.RELEASE_VERSION }}"
          VERSION_NUMBER="${VERSION#v}"

          echo "ğŸ“ Updating MCP server version to $VERSION_NUMBER"

          # Update version in package.json
          npm version $VERSION_NUMBER --no-git-tag-version --allow-same-version

          echo "âœ… MCP server version updated"

      - name: ğŸ“¦ Install Dependencies
        working-directory: mcp-server
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed"

      - name: ğŸ”¨ Build MCP Server
        working-directory: mcp-server
        run: |
          echo "ğŸ”¨ Building MCP server..."
          npm run build
          echo "âœ… Build complete"

      - name: ğŸ§ª Test MCP Server
        working-directory: mcp-server
        run: |
          echo "ğŸ§ª Testing MCP server..."
          npm test

          TEST_EXIT_CODE=$?
          if [ $TEST_EXIT_CODE -ne 0 ]; then
            echo "::warning::âš ï¸ MCP server tests failed with exit code: $TEST_EXIT_CODE"
            echo "::warning::Tests are non-blocking, but should be investigated before release"
          else
            echo "âœ… All tests passed"
          fi

          # Don't fail the workflow, but warn prominently
          exit 0

      - name: ğŸ“¦ Create Package Archive
        working-directory: mcp-server
        run: |
          VERSION="${{ env.RELEASE_VERSION }}"

          echo "ğŸ“¦ Creating package archive..."
          npm pack

          PACKAGE_FILE="aitherzero-mcp-server-${VERSION#v}.tgz"
          mv *.tgz "../${PACKAGE_FILE}"

          echo "âœ… Package created: ${PACKAGE_FILE}"
          ls -lh "../${PACKAGE_FILE}"

      - name: ğŸ“¤ Upload Package to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ env.RELEASE_VERSION }}
          files: |
            aitherzero-mcp-server-*.tgz

      - name: ğŸ“¢ Publish to GitHub Packages
        working-directory: mcp-server
        env:
          NODE_AUTH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "ğŸ“¢ Publishing to GitHub Packages..."

          # First, validate the package with dry-run
          npm publish --dry-run
          DRY_RUN_EXIT=$?

          if [ $DRY_RUN_EXIT -ne 0 ]; then
            echo "::error::Package validation failed - dry-run detected issues"
            exit 1
          fi

          # Attempt to publish and capture output
          PUBLISH_OUTPUT=$(npm publish --access public 2>&1)
          PUBLISH_EXIT=$?

          if [ $PUBLISH_EXIT -eq 0 ]; then
            echo "âœ… Successfully published to GitHub Packages"
          elif grep -q "Cannot publish over existing version" <<< "$PUBLISH_OUTPUT"; then
            echo "::warning::âš ï¸ Version already exists in registry - this is expected for re-runs"
          else
            echo "::error::âŒ Publishing failed with unexpected error (exit code: $PUBLISH_EXIT)"
            echo "$PUBLISH_OUTPUT"
            exit 1
          fi

      - name: ğŸ“Š MCP Server Build Summary
        shell: bash
        run: |
          VERSION="${{ env.RELEASE_VERSION }}"
          VERSION_NUMBER="${VERSION#v}"

          echo "## ğŸ“¦ MCP Server Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Package Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Package:** @aitherzero/mcp-server" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** $VERSION_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Installation" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Install from GitHub Packages" >> $GITHUB_STEP_SUMMARY
          echo "npm install @aitherzero/mcp-server@$VERSION_NUMBER" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Or download the release asset" >> $GITHUB_STEP_SUMMARY
          echo "curl -L https://github.com/${{ github.repository }}/releases/download/v${{ env.RELEASE_VERSION }}/aitherzero-mcp-server-$VERSION_NUMBER.tgz -o mcp-server.tgz" >> $GITHUB_STEP_SUMMARY
          echo "tar -xzf mcp-server.tgz" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  publish-docker-image:
    name: Build and Publish Docker Image
    runs-on: ubuntu-latest
    needs: [create-release]
    if: always() && (needs.create-release.result == 'success')
    timeout-minutes: 30

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“‹ Generate Enhanced Release Tags
        id: generate-tags
        shell: bash
        run: |
          VERSION="${{ env.RELEASE_VERSION }}"
          VERSION_NUMBER="${VERSION#v}"
          IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
          COMMIT_SHORT="${{ github.sha }}"
          COMMIT_SHORT="${COMMIT_SHORT:0:8}"
          BUILD_TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          
          echo "version-number=${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          echo "commit-short=${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          echo "build-timestamp=${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          
          # Generate comprehensive release tags
          # Format: Semantic versioning + descriptive metadata
          # Use type=raw,value= format for docker/metadata-action
          
          echo "tags<<EOF" >> $GITHUB_OUTPUT
          echo "type=raw,value=${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          echo "type=raw,value=v${VERSION_NUMBER}" >> $GITHUB_OUTPUT
          
          # Add major.minor tag (e.g., 2.0)
          MAJOR_MINOR=$(echo ${VERSION_NUMBER} | cut -d. -f1,2)
          echo "type=raw,value=${MAJOR_MINOR}" >> $GITHUB_OUTPUT
          
          # Add major tag (e.g., 2)
          MAJOR=$(echo ${VERSION_NUMBER} | cut -d. -f1)
          echo "type=raw,value=${MAJOR}" >> $GITHUB_OUTPUT
          
          # Add 'latest' tag only for non-prerelease versions
          if [ "$IS_PRERELEASE" != "true" ]; then
            echo "type=raw,value=latest" >> $GITHUB_OUTPUT
            echo "type=raw,value=stable" >> $GITHUB_OUTPUT
          else
            echo "type=raw,value=prerelease" >> $GITHUB_OUTPUT
          fi
          
          # Add commit SHA tag for traceability
          echo "type=raw,value=sha-${COMMIT_SHORT}" >> $GITHUB_OUTPUT
          
          # Add timestamp tag for temporal organization
          echo "type=raw,value=release-${BUILD_TIMESTAMP}" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "âœ… Generated release tags for version ${VERSION_NUMBER}"

      - name: ğŸ”¤ Set Lowercase Repository Name
        id: repo-name
        run: |
          # Convert repository name to lowercase for Docker compatibility
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo-lower=${REPO_LOWER}" >> $GITHUB_OUTPUT
          echo "Using lowercase repository name: ${REPO_LOWER}"

      - name: ğŸ“‹ Extract Docker Metadata with Enhanced Labels
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ steps.repo-name.outputs.repo-lower }}
          tags: ${{ steps.generate-tags.outputs.tags }}
          labels: |
            org.opencontainers.image.title=AitherZero
            org.opencontainers.image.description=Infrastructure automation platform
            org.opencontainers.image.vendor=wizzense
            org.opencontainers.image.version=${{ steps.generate-tags.outputs.version-number }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.generate-tags.outputs.build-timestamp }}
            com.aitherzero.release.version=${{ env.RELEASE_VERSION }}
            com.aitherzero.release.prerelease=${{ github.event.inputs.prerelease }}
            com.aitherzero.build.timestamp=${{ steps.generate-tags.outputs.build-timestamp }}
            com.aitherzero.commit.short=${{ steps.generate-tags.outputs.commit-short }}

      - name: ğŸ”¨ Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=${{ env.RELEASE_VERSION }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}

      - name: ğŸ§ª Test Docker Image
        shell: bash
        run: |
          echo "ğŸ§ª Testing Docker image..."

          IMAGE_TAG="ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:${{ env.RELEASE_VERSION }}"

          docker run --rm ${IMAGE_TAG} pwsh -NoProfile -Command "
            Write-Host 'âœ… Container started' -ForegroundColor Green;
            if (Test-Path /opt/aitherzero/AitherZero.psd1) {
              Write-Host 'âœ… Module manifest found' -ForegroundColor Green;
            } else {
              Write-Error 'âŒ Module manifest not found';
              exit 1;
            }
          "

          echo "âœ… Docker image test passed"

      - name: ğŸ“Š Docker Build Summary
        shell: bash
        run: |
          echo "## ğŸ³ Docker Image Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** GitHub Container Registry" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** ghcr.io/${{ steps.repo-name.outputs.repo-lower }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ env.RELEASE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms:** linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Usage" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Pull the image" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:${{ env.RELEASE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Run interactively" >> $GITHUB_STEP_SUMMARY
          echo "docker run -it --rm ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:${{ env.RELEASE_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [create-release, build-mcp-server, publish-docker-image]
    if: always() && (needs.create-release.result == 'success')

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”¤ Set Lowercase Repository Name
        id: repo-name
        run: |
          # Convert repository name to lowercase for Docker compatibility
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo-lower=${REPO_LOWER}" >> $GITHUB_OUTPUT
          echo "Using lowercase repository name: ${REPO_LOWER}"

      - name: ğŸ“Š Release Summary
        shell: pwsh
        run: |
          $version = "${{ env.RELEASE_VERSION }}"

          Write-Host ""
          Write-Host "ğŸ‰ Release v$version Completed Successfully!" -ForegroundColor Green
          Write-Host "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Green
          Write-Host ""
          Write-Host "ğŸ“¦ **Release Assets Created:**" -ForegroundColor Cyan
          Write-Host "   â€¢ AitherZero-v$version.zip (Windows compatible)" -ForegroundColor White
          Write-Host "   â€¢ AitherZero-v$version.tar.gz (Unix compatible)" -ForegroundColor White
          Write-Host "   â€¢ aitherzero-mcp-server-$($version -replace '^v','').tgz (MCP Server)" -ForegroundColor White
          Write-Host "   â€¢ build-info.json (Build metadata)" -ForegroundColor White
          Write-Host ""
          Write-Host "ğŸ³ **Docker Image:**" -ForegroundColor Cyan
          Write-Host "   â€¢ ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:$($version -replace '^v','')" -ForegroundColor White
          if ('${{ github.event.inputs.prerelease }}' -ne 'true') {
            Write-Host "   â€¢ ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:latest" -ForegroundColor White
          }
          Write-Host ""
          Write-Host "ğŸ“¦ **MCP Server Package:**" -ForegroundColor Cyan
          Write-Host "   â€¢ @aitherzero/mcp-server@$($version -replace '^v','')" -ForegroundColor White
          Write-Host "   â€¢ Published to GitHub Packages" -ForegroundColor White
          Write-Host ""
          Write-Host "ğŸš€ **Installation Commands:**" -ForegroundColor Cyan
          Write-Host "   # AitherZero Platform" -ForegroundColor Gray
          Write-Host "   iwr -useb https://raw.githubusercontent.com/wizzense/AitherZero/main/bootstrap.ps1 | iex" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "   # Docker" -ForegroundColor Gray
          Write-Host "   docker pull ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:$($version -replace '^v','')" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "   # MCP Server" -ForegroundColor Gray
          Write-Host "   npm install @aitherzero/mcp-server@$($version -replace '^v','')" -ForegroundColor Yellow
          Write-Host ""
          Write-Host "ğŸ“‹ **Release Information:**" -ForegroundColor Cyan
          Write-Host "   â€¢ Repository: ${{ github.repository }}" -ForegroundColor White
          Write-Host "   â€¢ Version: v$version" -ForegroundColor White
          Write-Host "   â€¢ Build: #${{ github.run_number }}" -ForegroundColor White
          Write-Host "   â€¢ Commit: ${{ github.sha }}" -ForegroundColor White
          Write-Host ""
          Write-Host "ğŸ”— **Links:**" -ForegroundColor Cyan
          Write-Host "   â€¢ Release Page: ${{ github.server_url }}/${{ github.repository }}/releases/tag/v$version" -ForegroundColor Blue
          Write-Host "   â€¢ Docker Image: https://github.com/${{ github.repository }}/pkgs/container/aitherzero" -ForegroundColor Blue
          Write-Host "   â€¢ MCP Server: https://github.com/${{ github.repository }}/pkgs/npm/%40aitherzero%2Fmcp-server" -ForegroundColor Blue
          Write-Host "   â€¢ Documentation: ${{ github.server_url }}/${{ github.repository }}#readme" -ForegroundColor Blue
          Write-Host "   â€¢ Issues: ${{ github.server_url }}/${{ github.repository }}/issues" -ForegroundColor Blue
          Write-Host ""
