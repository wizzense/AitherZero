---
name: üîÑ Ring Status Dashboard

# Generate comprehensive status dashboard for ring-based branching strategy
on:
  push:
    branches: [main, develop, dev, dev-staging, ring-0, ring-0-integrations, ring-1, ring-1-integrations, ring-2]
  pull_request:
    branches: [main, develop, dev, dev-staging, ring-0, ring-0-integrations, ring-1, ring-1-integrations, ring-2]
  schedule:
    # Update dashboard every hour
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      force_update:
        description: 'Force dashboard update'
        type: boolean
        default: true

permissions:
  contents: write
  pull-requests: read
  checks: read
  actions: read

concurrency:
  group: ring-status-dashboard-${{ github.ref }}
  cancel-in-progress: true

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true

jobs:
  generate-ring-status:
    name: üìä Generate Ring Status Dashboard
    # Skip if triggered by bot to prevent loops
    if: github.actor != 'github-actions[bot]'
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for branch comparison

      - name: üîß Bootstrap Environment
        shell: pwsh
        run: |
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal

      - name: üìä Generate Ring Status Data
        id: generate-status
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Define ring structure
            const rings = [
              { name: 'main', displayName: 'Main (Production)', color: '#28a745', description: 'Production-ready code' },
              { name: 'develop', displayName: 'Develop (Pre-Release)', color: '#0366d6', description: 'Release candidate' },
              { name: 'dev', displayName: 'Dev (Integration)', color: '#6f42c1', description: 'Development integration' },
              { name: 'ring-0', displayName: 'Ring 0 (Core Foundation)', color: '#d73a49', description: 'Core infrastructure changes' },
              { name: 'ring-0-integrations', displayName: 'Ring 0 Integrations', color: '#e36209', description: 'Core feature integration' },
              { name: 'ring-1', displayName: 'Ring 1 (Features)', color: '#0366d6', description: 'New feature development' },
              { name: 'ring-1-integrations', displayName: 'Ring 1 Integrations', color: '#0969da', description: 'Feature integration testing' },
              { name: 'ring-2', displayName: 'Ring 2 (Experimental)', color: '#8b949e', description: 'Experimental features' }
            ];

            const statusData = {
              timestamp: new Date().toISOString(),
              rings: []
            };

            // Fetch data for each ring
            for (const ring of rings) {
              console.log(`Fetching data for ${ring.name}...`);

              let branchData = null;
              let commits = [];
              let prs = [];
              let checks = [];

              try {
                // Get branch info
                try {
                  const { data: branch } = await github.rest.repos.getBranch({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    branch: ring.name
                  });
                  branchData = branch;
                } catch (error) {
                  console.log(`Branch ${ring.name} not found or inaccessible`);
                }

                // Get recent commits (last 10)
                if (branchData) {
                  const { data: commitData } = await github.rest.repos.listCommits({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    sha: ring.name,
                    per_page: 10
                  });
                  commits = commitData.map(c => ({
                    sha: c.sha.substring(0, 7),
                    message: c.commit.message.split('\n')[0],
                    author: c.commit.author.name,
                    date: c.commit.author.date
                  }));
                }

                // Get open PRs targeting this branch
                const { data: prData } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  state: 'open',
                  base: ring.name,
                  per_page: 50
                });
                
                prs = await Promise.all(prData.map(async pr => {
                  // Get detailed PR info including files changed
                  let filesChanged = [];
                  let additions = 0;
                  let deletions = 0;
                  
                  try {
                    const { data: files } = await github.rest.pulls.listFiles({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: pr.number,
                      per_page: 100
                    });
                    
                    filesChanged = files.map(f => ({
                      filename: f.filename,
                      status: f.status,
                      additions: f.additions,
                      deletions: f.deletions,
                      changes: f.changes,
                      patch: f.patch ? f.patch.substring(0, 500) : null // First 500 chars of diff
                    }));
                    
                    additions = files.reduce((sum, f) => sum + f.additions, 0);
                    deletions = files.reduce((sum, f) => sum + f.deletions, 0);
                  } catch (error) {
                    console.log(`Could not fetch files for PR #${pr.number}: ${error.message}`);
                  }
                  
                  // Get PR reviews
                  let reviews = [];
                  try {
                    const { data: reviewData } = await github.rest.pulls.listReviews({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: pr.number
                    });
                    
                    reviews = reviewData.map(r => ({
                      user: r.user.login,
                      state: r.state,
                      submitted_at: r.submitted_at
                    }));
                  } catch (error) {
                    console.log(`Could not fetch reviews for PR #${pr.number}: ${error.message}`);
                  }
                  
                  return {
                    number: pr.number,
                    title: pr.title,
                    author: pr.user.login,
                    created: pr.created_at,
                    updated: pr.updated_at,
                    url: pr.html_url,
                    draft: pr.draft,
                    mergeable: pr.mergeable_state,
                    head: {
                      ref: pr.head.ref,
                      sha: pr.head.sha.substring(0, 7),
                      label: pr.head.label
                    },
                    base: {
                      ref: pr.base.ref,
                      sha: pr.base.sha.substring(0, 7)
                    },
                    filesChanged: filesChanged.length,
                    additions: additions,
                    deletions: deletions,
                    files: filesChanged,
                    reviews: reviews,
                    labels: pr.labels.map(l => l.name),
                    comments: pr.comments,
                    reviewComments: pr.review_comments,
                    commits: pr.commits
                  };
                }));

                // Get check runs for the latest commit
                if (branchData) {
                  try {
                    const { data: checkData } = await github.rest.checks.listForRef({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      ref: branchData.commit.sha,
                      per_page: 100
                    });
                    
                    checks = checkData.check_runs.map(check => ({
                      name: check.name,
                      status: check.status,
                      conclusion: check.conclusion,
                      url: check.html_url
                    }));
                  } catch (error) {
                    console.log(`Could not fetch checks for ${ring.name}: ${error.message}`);
                  }
                }

              } catch (error) {
                console.error(`Error fetching data for ${ring.name}:`, error.message);
              }

              // Calculate health score
              let healthScore = 100;
              const failedChecks = checks.filter(c => c.conclusion === 'failure').length;
              const successChecks = checks.filter(c => c.conclusion === 'success').length;
              
              if (checks.length > 0) {
                healthScore = Math.round((successChecks / checks.length) * 100);
              }

              // Determine status
              let status = 'healthy';
              if (!branchData) {
                status = 'missing';
                healthScore = 0;
              } else if (failedChecks > 0) {
                status = 'failing';
              } else if (checks.length === 0) {
                status = 'unknown';
                healthScore = 50;
              }

              statusData.rings.push({
                ...ring,
                exists: !!branchData,
                lastCommit: branchData ? {
                  sha: branchData.commit.sha.substring(0, 7),
                  message: branchData.commit.commit.message.split('\n')[0],
                  author: branchData.commit.commit.author.name,
                  date: branchData.commit.commit.author.date
                } : null,
                commits: commits,
                openPRs: prs.length,
                prs: prs,
                checks: {
                  total: checks.length,
                  success: successChecks,
                  failed: failedChecks,
                  pending: checks.filter(c => c.status === 'in_progress').length,
                  details: checks
                },
                healthScore: healthScore,
                status: status
              });
            }

            // Save to file
            const outputDir = './reports/ring-status';
            if (!fs.existsSync(outputDir)) {
              fs.mkdirSync(outputDir, { recursive: true });
            }

            const dataPath = path.join(outputDir, 'ring-status-data.json');
            fs.writeFileSync(dataPath, JSON.stringify(statusData, null, 2));

            console.log(`‚úÖ Generated ring status data: ${dataPath}`);
            return statusData;

      - name: üìä Generate HTML Dashboard
        shell: pwsh
        run: |
          $dataPath = "./reports/ring-status/ring-status-data.json"
          $data = Get-Content $dataPath | ConvertFrom-Json

          $html = @"
          <!DOCTYPE html>
          <html lang="en">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>AitherZero - Ring Status Dashboard</title>
              <style>
                  * {
                      margin: 0;
                      padding: 0;
                      box-sizing: border-box;
                  }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      padding: 20px;
                      min-height: 100vh;
                  }
                  .container {
                      max-width: 1400px;
                      margin: 0 auto;
                  }
                  .header {
                      text-align: center;
                      color: white;
                      margin-bottom: 40px;
                  }
                  .header h1 {
                      font-size: 3em;
                      margin-bottom: 10px;
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                  }
                  .header .subtitle {
                      font-size: 1.2em;
                      opacity: 0.9;
                  }
                  .header .timestamp {
                      margin-top: 10px;
                      font-size: 0.9em;
                      opacity: 0.8;
                  }
                  .ring-grid {
                      display: grid;
                      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
                      gap: 20px;
                      margin-bottom: 40px;
                  }
                  .ring-card {
                      background: white;
                      border-radius: 12px;
                      padding: 20px;
                      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                      transition: transform 0.2s;
                  }
                  .ring-card:hover {
                      transform: translateY(-5px);
                      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
                  }
                  .ring-header {
                      display: flex;
                      justify-content: space-between;
                      align-items: center;
                      margin-bottom: 15px;
                      padding-bottom: 15px;
                      border-bottom: 3px solid;
                  }
                  .ring-name {
                      font-size: 1.4em;
                      font-weight: bold;
                  }
                  .ring-description {
                      font-size: 0.9em;
                      color: #666;
                      margin-bottom: 15px;
                  }
                  .health-badge {
                      display: inline-block;
                      padding: 5px 15px;
                      border-radius: 20px;
                      font-size: 0.85em;
                      font-weight: bold;
                      color: white;
                  }
                  .status-healthy { background: #28a745; }
                  .status-failing { background: #dc3545; }
                  .status-unknown { background: #ffc107; color: #333; }
                  .status-missing { background: #6c757d; }
                  .health-bar {
                      width: 100%;
                      height: 8px;
                      background: #e9ecef;
                      border-radius: 4px;
                      overflow: hidden;
                      margin: 10px 0;
                  }
                  .health-fill {
                      height: 100%;
                      transition: width 0.3s;
                  }
                  .stat-row {
                      display: flex;
                      justify-content: space-between;
                      padding: 8px 0;
                      border-bottom: 1px solid #e9ecef;
                  }
                  .stat-label {
                      color: #666;
                      font-size: 0.9em;
                  }
                  .stat-value {
                      font-weight: bold;
                  }
                  .commit-info {
                      background: #f8f9fa;
                      padding: 10px;
                      border-radius: 6px;
                      margin: 10px 0;
                      font-size: 0.85em;
                  }
                  .commit-sha {
                      font-family: 'Courier New', monospace;
                      color: #0366d6;
                      font-weight: bold;
                  }
                  .pr-list {
                      margin-top: 10px;
                  }
                  .pr-item {
                      padding: 8px;
                      background: #f8f9fa;
                      border-left: 3px solid #0366d6;
                      margin: 5px 0;
                      border-radius: 3px;
                      font-size: 0.85em;
                  }
                  .pr-number {
                      font-weight: bold;
                      color: #0366d6;
                  }
                  .pr-flow {
                      display: flex;
                      align-items: center;
                      gap: 8px;
                      margin: 5px 0;
                      font-size: 0.85em;
                  }
                  .pr-branch {
                      padding: 4px 8px;
                      background: #e1f5ff;
                      border: 1px solid #0366d6;
                      border-radius: 4px;
                      font-family: 'Courier New', monospace;
                      font-size: 0.9em;
                  }
                  .pr-arrow {
                      color: #0366d6;
                      font-size: 1.5em;
                  }
                  .pr-stats {
                      display: flex;
                      gap: 10px;
                      margin: 5px 0;
                      font-size: 0.8em;
                  }
                  .pr-stat {
                      display: flex;
                      align-items: center;
                      gap: 4px;
                  }
                  .pr-additions {
                      color: #28a745;
                      font-weight: bold;
                  }
                  .pr-deletions {
                      color: #dc3545;
                      font-weight: bold;
                  }
                  .pr-files {
                      color: #6c757d;
                  }
                  .pr-details {
                      margin-top: 5px;
                      padding: 8px;
                      background: #fff;
                      border-radius: 4px;
                      border: 1px solid #e1e4e8;
                  }
                  .pr-label {
                      display: inline-block;
                      padding: 2px 6px;
                      background: #e1e4e8;
                      border-radius: 10px;
                      font-size: 0.75em;
                      margin-right: 4px;
                      margin-top: 2px;
                  }
                  .pr-review-status {
                      display: inline-block;
                      padding: 2px 8px;
                      border-radius: 10px;
                      font-size: 0.75em;
                      margin-left: 8px;
                  }
                  .review-approved { background: #d4edda; color: #155724; }
                  .review-changes-requested { background: #f8d7da; color: #721c24; }
                  .review-commented { background: #fff3cd; color: #856404; }
                  .all-prs-section {
                      background: white;
                      border-radius: 12px;
                      padding: 20px;
                      margin-bottom: 20px;
                  }
                  .pr-flow-diagram {
                      margin: 20px 0;
                      padding: 15px;
                      background: #f8f9fa;
                      border-radius: 8px;
                  }
                  .pr-card-full {
                      background: white;
                      border: 1px solid #e1e4e8;
                      border-radius: 8px;
                      padding: 15px;
                      margin: 10px 0;
                      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
                  }
                  .pr-card-full:hover {
                      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
                  }
                  .file-list {
                      margin-top: 10px;
                      max-height: 200px;
                      overflow-y: auto;
                  }
                  .file-item {
                      padding: 4px 8px;
                      background: #f6f8fa;
                      margin: 2px 0;
                      border-radius: 3px;
                      font-family: 'Courier New', monospace;
                      font-size: 0.8em;
                  }
                  .file-status-modified { border-left: 3px solid #ffc107; }
                  .file-status-added { border-left: 3px solid #28a745; }
                  .file-status-removed { border-left: 3px solid #dc3545; }
                  .diff-preview {
                      margin-top: 5px;
                      padding: 8px;
                      background: #f6f8fa;
                      border-radius: 4px;
                      font-family: 'Courier New', monospace;
                      font-size: 0.75em;
                      white-space: pre-wrap;
                      max-height: 150px;
                      overflow-y: auto;
                  }
                  .check-summary {
                      display: flex;
                      gap: 10px;
                      margin-top: 10px;
                  }
                  .check-badge {
                      flex: 1;
                      text-align: center;
                      padding: 8px;
                      border-radius: 6px;
                      font-size: 0.85em;
                  }
                  .check-success { background: #d4edda; color: #155724; }
                  .check-failed { background: #f8d7da; color: #721c24; }
                  .check-pending { background: #fff3cd; color: #856404; }
                  .legend {
                      background: white;
                      border-radius: 12px;
                      padding: 20px;
                      margin-top: 20px;
                  }
                  .legend h3 {
                      margin-bottom: 15px;
                  }
                  .legend-item {
                      display: inline-block;
                      margin-right: 20px;
                      margin-bottom: 10px;
                  }
                  .legend-color {
                      display: inline-block;
                      width: 20px;
                      height: 20px;
                      border-radius: 4px;
                      margin-right: 8px;
                      vertical-align: middle;
                  }
                  @media (max-width: 768px) {
                      .ring-grid {
                          grid-template-columns: 1fr;
                      }
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <div class="header">
                      <h1>üîÑ AitherZero Ring Status Dashboard</h1>
                      <div class="subtitle">Real-time branch and integration status</div>
                      <div class="timestamp">Last Updated: $($data.timestamp)</div>
                  </div>

                  <div class="ring-grid">
          "@

          foreach ($ring in $data.rings) {
              $statusClass = "status-$($ring.status)"
              $healthColor = if ($ring.healthScore -ge 80) { '#28a745' } 
                             elseif ($ring.healthScore -ge 50) { '#ffc107' } 
                             else { '#dc3545' }

              $html += @"
                      <div class="ring-card">
                          <div class="ring-header" style="border-color: $($ring.color);">
                              <div>
                                  <div class="ring-name" style="color: $($ring.color);">$($ring.displayName)</div>
                              </div>
                              <span class="health-badge $statusClass">$($ring.status.ToUpper())</span>
                          </div>
                          <div class="ring-description">$($ring.description)</div>
                          
                          <div class="health-bar">
                              <div class="health-fill" style="width: $($ring.healthScore)%; background: $healthColor;"></div>
                          </div>
                          <div style="text-align: center; font-size: 0.9em; color: #666; margin-bottom: 15px;">
                              Health Score: $($ring.healthScore)%
                          </div>

                          <div class="stat-row">
                              <span class="stat-label">Branch Status</span>
                              <span class="stat-value">$(if ($ring.exists) { '‚úÖ Active' } else { '‚ùå Missing' })</span>
                          </div>
                          <div class="stat-row">
                              <span class="stat-label">Open PRs</span>
                              <span class="stat-value">$($ring.openPRs)</span>
                          </div>
                          <div class="stat-row">
                              <span class="stat-label">Recent Commits</span>
                              <span class="stat-value">$($ring.commits.Count)</span>
                          </div>

          "@

              if ($ring.lastCommit) {
                  $html += @"
                          <div class="commit-info">
                              <strong>Latest Commit:</strong><br>
                              <span class="commit-sha">$($ring.lastCommit.sha)</span> - $($ring.lastCommit.message -replace '<', '&lt;' -replace '>', '&gt;')<br>
                              <small>by $($ring.lastCommit.author) on $(([datetime]$ring.lastCommit.date).ToString('yyyy-MM-dd HH:mm'))</small>
                          </div>
          "@
              }

              if ($ring.checks.total -gt 0) {
                  $html += @"
                          <div class="check-summary">
                              <div class="check-badge check-success">
                                  ‚úÖ $($ring.checks.success) Passed
                              </div>
                              <div class="check-badge check-failed">
                                  ‚ùå $($ring.checks.failed) Failed
                              </div>
                              <div class="check-badge check-pending">
                                  ‚è≥ $($ring.checks.pending) Pending
                              </div>
                          </div>
          "@
              }

              if ($ring.prs.Count -gt 0) {
                  $html += "<div class='pr-list'><strong>Open PRs ($($ring.prs.Count)):</strong>"
                  
                  foreach ($pr in $ring.prs | Select-Object -First 10) {
                      $prStatus = if ($pr.draft) { 'üìù Draft' } else { 'üîÑ Open' }
                      $mergeStatus = switch ($pr.mergeable) {
                          'clean' { '‚úÖ Ready' }
                          'unstable' { '‚ö†Ô∏è Checks' }
                          'dirty' { '‚ùå Conflict' }
                          default { '‚ùì Unknown' }
                      }
                      
                      # Determine review status
                      $reviewStatus = ''
                      if ($pr.reviews.Count -gt 0) {
                          $approved = ($pr.reviews | Where-Object { $_.state -eq 'APPROVED' }).Count
                          $changesRequested = ($pr.reviews | Where-Object { $_.state -eq 'CHANGES_REQUESTED' }).Count
                          
                          if ($changesRequested -gt 0) {
                              $reviewStatus = "<span class='pr-review-status review-changes-requested'>‚õî Changes Requested</span>"
                          } elseif ($approved -gt 0) {
                              $reviewStatus = "<span class='pr-review-status review-approved'>‚úÖ Approved</span>"
                          } else {
                              $reviewStatus = "<span class='pr-review-status review-commented'>üí¨ Commented</span>"
                          }
                      }
                      
                      $html += @"
                              <div class="pr-item">
                                  <div style="display: flex; justify-content: space-between; align-items: center;">
                                      <span class="pr-number">#$($pr.number)</span>
                                      <span>$prStatus | $mergeStatus $reviewStatus</span>
                                  </div>
                                  <div style="font-weight: bold; margin: 5px 0;">$($pr.title -replace '<', '&lt;' -replace '>', '&gt;')</div>
                                  
                                  <div class="pr-flow">
                                      <span class="pr-branch">$($pr.head.ref)</span>
                                      <span class="pr-arrow">‚Üí</span>
                                      <span class="pr-branch">$($pr.base.ref)</span>
                                  </div>
                                  
                                  <div class="pr-stats">
                                      <span class="pr-stat">
                                          <span>üìÅ</span>
                                          <span class="pr-files">$($pr.filesChanged) files</span>
                                      </span>
                                      <span class="pr-stat">
                                          <span>+</span>
                                          <span class="pr-additions">$($pr.additions)</span>
                                      </span>
                                      <span class="pr-stat">
                                          <span>-</span>
                                          <span class="pr-deletions">$($pr.deletions)</span>
                                      </span>
                                      <span class="pr-stat">
                                          <span>üí¨</span>
                                          <span>$($pr.comments) comments</span>
                                      </span>
                                      <span class="pr-stat">
                                          <span>üìù</span>
                                          <span>$($pr.commits) commits</span>
                                      </span>
                                  </div>
                                  
                                  <div class="pr-details">
                                      <small>by <strong>$($pr.author)</strong> ‚Ä¢ Updated $(([datetime]$pr.updated).ToString('yyyy-MM-dd HH:mm'))</small>
          "@
                      
                      # Show labels if any
                      if ($pr.labels.Count -gt 0) {
                          $html += "<div style='margin-top: 5px;'>"
                          foreach ($label in $pr.labels) {
                              $html += "<span class='pr-label'>$($label -replace '<', '&lt;' -replace '>', '&gt;')</span>"
                          }
                          $html += "</div>"
                      }
                      
                      # Show top changed files
                      if ($pr.files.Count -gt 0) {
                          $html += "<details style='margin-top: 8px;'><summary style='cursor: pointer; color: #0366d6;'><strong>üìÇ Changed Files ($($pr.files.Count))</strong></summary>"
                          $html += "<div class='file-list'>"
                          
                          foreach ($file in $pr.files | Select-Object -First 10) {
                              $statusClass = "file-status-$($file.status)"
                              $statusIcon = switch ($file.status) {
                                  'added' { '‚ú®' }
                                  'modified' { 'üìù' }
                                  'removed' { 'üóëÔ∏è' }
                                  'renamed' { 'üìã' }
                                  default { 'üìÑ' }
                              }
                              
                              $html += @"
                                  <div class="file-item $statusClass">
                                      $statusIcon $($file.filename -replace '<', '&lt;' -replace '>', '&gt;')
                                      <span style="float: right;">
                                          <span style="color: #28a745;">+$($file.additions)</span>
                                          <span style="color: #dc3545;">-$($file.deletions)</span>
                                      </span>
                                  </div>
          "@
                          }
                          
                          if ($pr.files.Count -gt 10) {
                              $html += "<div style='text-align: center; padding: 8px; color: #666;'>... and $($pr.files.Count - 10) more files</div>"
                          }
                          
                          $html += "</div></details>"
                      }
                      
                      $html += @"
                                      <div style="margin-top: 8px;">
                                          <a href="$($pr.url)" target="_blank" style="color: #0366d6; text-decoration: none;">View on GitHub ‚Üí</a>
                                      </div>
                                  </div>
                              </div>
          "@
                  }
                  
                  if ($ring.prs.Count -gt 10) {
                      $html += "<div style='text-align: center; padding: 10px; color: #666; font-style: italic;'>... and $($ring.prs.Count - 10) more PRs</div>"
                  }
                  
                  $html += "</div>"
              }

              $html += @"
                      </div>
          "@
          }

          $html += @"
                  </div>

                  <div class="legend">
                      <h3>üìã Branch Strategy Legend</h3>
                      <div class="legend-item">
                          <span class="legend-color" style="background: #28a745;"></span>
                          <strong>Main:</strong> Production-ready releases
                      </div>
                      <div class="legend-item">
                          <span class="legend-color" style="background: #0366d6;"></span>
                          <strong>Develop:</strong> Release candidates
                      </div>
                      <div class="legend-item">
                          <span class="legend-color" style="background: #d73a49;"></span>
                          <strong>Ring 0:</strong> Core infrastructure
                      </div>
                      <div class="legend-item">
                          <span class="legend-color" style="background: #0366d6;"></span>
                          <strong>Ring 1:</strong> Feature development
                      </div>
                      <div class="legend-item">
                          <span class="legend-color" style="background: #8b949e;"></span>
                          <strong>Ring 2:</strong> Experimental
                      </div>
                  </div>
              </div>
          </body>
          </html>
          "@

          $htmlPath = "./reports/ring-status/index.html"
          $html | Out-File -FilePath $htmlPath -Encoding UTF8
          Write-Host "‚úÖ Generated HTML dashboard: $htmlPath" -ForegroundColor Green

      - name: üì§ Copy to Reports Directory for Jekyll
        shell: pwsh
        run: |
          Write-Host "üì§ Copying ring status to reports directory..." -ForegroundColor Cyan
          
          # Ensure reports directory exists
          $reportsDir = "./reports"
          if (-not (Test-Path $reportsDir)) {
            New-Item -ItemType Directory -Path $reportsDir -Force | Out-Null
          }
          
          # Copy ring status HTML and JSON
          Copy-Item "./reports/ring-status/index.html" "$reportsDir/ring-status.html" -Force
          Copy-Item "./reports/ring-status/ring-status-data.json" "$reportsDir/ring-status-data.json" -Force
          
          Write-Host "‚úÖ Copied to reports/ for Jekyll deployment" -ForegroundColor Green
          
          # Update main dashboard.json to include ring status link
          $dashboardPath = "$reportsDir/dashboard.json"
          if (Test-Path $dashboardPath) {
            try {
              $dashboard = Get-Content $dashboardPath -Raw | ConvertFrom-Json
              
              # Add ring status section if it doesn't exist
              if (-not $dashboard.PSObject.Properties['RingStatus']) {
                $dashboard | Add-Member -NotePropertyName 'RingStatus' -NotePropertyValue @{
                  DashboardUrl = 'ring-status.html'
                  DataUrl = 'ring-status-data.json'
                  LastUpdated = (Get-Date).ToString('yyyy-MM-ddTHH:mm:ss.fffZ')
                } -Force
                
                $dashboard | ConvertTo-Json -Depth 10 | Out-File -FilePath $dashboardPath -Encoding UTF8
                Write-Host "‚úÖ Updated dashboard.json with ring status links" -ForegroundColor Green
              }
            } catch {
              Write-Host "‚ö†Ô∏è Could not update dashboard.json: $_" -ForegroundColor Yellow
            }
          }

      - name: üîó Update Index Page with Ring Status Link
        shell: pwsh
        run: |
          Write-Host "üîó Adding ring status link to index.md..." -ForegroundColor Cyan
          
          $indexPath = "./index.md"
          if (Test-Path $indexPath) {
            $content = Get-Content $indexPath -Raw
            
            # Check if ring status link already exists
            if ($content -notmatch 'ring-status\.html') {
              # Load ring status link template
              $templatePath = "./library/_templates/ring-status-link.md"
              if (Test-Path $templatePath) {
                $ringStatusLink = Get-Content $templatePath -Raw
              } else {
                # Fallback if template not found
                $ringStatusLink = "`n## üîÑ Ring Status Dashboard`n`nView real-time status across all development rings.`n"
              }
              
              # Insert after the main dashboard link or at the end
              if ($content -match '## .* Dashboard') {
                $content = $content -replace '(## .* Dashboard.*?\n\n)', "`$1$ringStatusLink"
              } else {
                $content += $ringStatusLink
              }
              
              $content | Out-File -FilePath $indexPath -Encoding UTF8
              Write-Host "‚úÖ Added ring status link to index.md" -ForegroundColor Green
            } else {
              Write-Host "‚ÑπÔ∏è Ring status link already exists in index.md" -ForegroundColor Cyan
            }
          }

      - name: üìä Commit Changes to Repository
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/ring-0-integrations'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add reports/ring-status.html reports/ring-status-data.json reports/dashboard.json index.md
          git commit -m "Update ring status dashboard - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push origin HEAD:${{ github.ref_name }}

      - name: üìä Upload Dashboard Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ring-status-dashboard
          path: |
            reports/ring-status/*.html
            reports/ring-status/*.json
          retention-days: 30
