name: ISO Customization Tests

on:
  push:
    branches: [ main, develop, 'copilot/**' ]
    paths:
      - 'domains/infrastructure/ISOManager.psm1'
      - 'domains/infrastructure/ISOCustomizer.psm1'
      - 'tests/domains/infrastructure/ISOManager.Tests.ps1'
      - 'tests/domains/infrastructure/ISOCustomizer.Tests.ps1'
      - '.github/workflows/iso-customization-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'domains/infrastructure/ISOManager.psm1'
      - 'domains/infrastructure/ISOCustomizer.psm1'
      - 'tests/domains/infrastructure/ISOManager.Tests.ps1'
      - 'tests/domains/infrastructure/ISOCustomizer.Tests.ps1'
      - '.github/workflows/iso-customization-tests.yml'
  workflow_dispatch:

jobs:
  test-iso-modules:
    name: Test ISO Modules (TDD)
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup PowerShell 7
        shell: pwsh
        run: |
          Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)"
          Write-Host "OS: $($PSVersionTable.OS)"
          
      - name: Install Pester
        shell: pwsh
        run: |
          if (-not (Get-Module -ListAvailable -Name Pester)) {
              Install-Module -Name Pester -Force -SkipPublisherCheck -MinimumVersion 5.0
          }
          Import-Module Pester -MinimumVersion 5.0
          (Get-Module Pester).Version
          
      - name: Run ISOManager Tests
        id: iso-manager-tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './tests/domains/infrastructure/ISOManager.Tests.ps1'
          $config.Output.Verbosity = 'Detailed'
          $config.Run.PassThru = $true
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = './test-results-isomanager.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          
          $result = Invoke-Pester -Configuration $config
          
          Write-Host ""
          Write-Host "ISOManager Test Summary:" -ForegroundColor Cyan
          Write-Host "  Total: $($result.TotalCount)"
          Write-Host "  Passed: $($result.PassedCount)" -ForegroundColor Green
          Write-Host "  Failed: $($result.FailedCount)" -ForegroundColor $(if ($result.FailedCount -eq 0) { 'Green' } else { 'Red' })
          Write-Host "  Skipped: $($result.SkippedCount)"
          
          if ($result.FailedCount -gt 0) {
              Write-Host ""
              Write-Host "Failed Tests:" -ForegroundColor Red
              $result.Failed | ForEach-Object {
                  Write-Host "  - $($_.Name)"
              }
              exit 1
          }
          
      - name: Run ISOCustomizer Tests
        id: iso-customizer-tests
        shell: pwsh
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = './tests/domains/infrastructure/ISOCustomizer.Tests.ps1'
          $config.Output.Verbosity = 'Detailed'
          $config.Run.PassThru = $true
          $config.TestResult.Enabled = $true
          $config.TestResult.OutputPath = './test-results-isocustomizer.xml'
          $config.TestResult.OutputFormat = 'NUnitXml'
          
          $result = Invoke-Pester -Configuration $config
          
          Write-Host ""
          Write-Host "ISOCustomizer Test Summary:" -ForegroundColor Cyan
          Write-Host "  Total: $($result.TotalCount)"
          Write-Host "  Passed: $($result.PassedCount)" -ForegroundColor Green
          Write-Host "  Failed: $($result.FailedCount)" -ForegroundColor $(if ($result.FailedCount -eq 0) { 'Green' } else { 'Red' })
          Write-Host "  Skipped: $($result.SkippedCount)"
          
          if ($result.FailedCount -gt 0) {
              Write-Host ""
              Write-Host "Failed Tests:" -ForegroundColor Red
              $result.Failed | ForEach-Object {
                  Write-Host "  - $($_.Name)"
              }
              exit 1
          }
          
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: ./test-results-*.xml
          retention-days: 30
          
      - name: Publish Test Report
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: ISO Tests (${{ matrix.os }})
          path: ./test-results-*.xml
          reporter: java-junit
          fail-on-error: true
          
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: test-iso-modules
    if: always()
    
    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          path: ./all-test-results
          
      - name: Generate Summary
        shell: pwsh
        run: |
          Write-Host "# ISO Customization Test Summary" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "## TDD Phase Status" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "- ✅ **Phase 1**: Core ISO extraction (ISOManager)" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "- ✅ **Phase 2**: Windows ISO customization (ISOCustomizer)" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "- ⏳ **Phase 3**: ISO repackaging (next)" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "- ⏳ **Phase 4**: CI/CD integration (this workflow)" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "## Test Execution" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "Tests executed on multiple platforms:" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "- Ubuntu (Linux)" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "- Windows" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "- macOS" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "" >> $env:GITHUB_STEP_SUMMARY
          Write-Host "All test results uploaded as artifacts for review." >> $env:GITHUB_STEP_SUMMARY
