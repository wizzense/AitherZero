name: Build and Release

on:
  release:
    types: [published]
  push:
    tags: ['v*']
    branches: [main, master]
  pull_request:
    branches: [main, master]
    types: [closed]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release Type'
        required: true
        default: 'patch'
        type: choice
        options:
          - major
          - minor
          - patch
          - prerelease
      create_release:
        description: 'Create GitHub Release'
        required: true
        default: true
        type: boolean

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  version:
    name: Determine Version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      should-build: ${{ steps.check.outputs.should-build }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Version
        id: version
        shell: pwsh
        run: |
          Write-Host "Determining release version..." -ForegroundColor Cyan

          $version = ""

          if ("${{ github.ref_type }}" -eq "tag") {
            $tagName = "${{ github.ref_name }}"
            if ($tagName -match '^v?(.+)$') {
              $version = $matches[1]
              Write-Host "Using tag version: $version" -ForegroundColor Green
            }
          }

          if ([string]::IsNullOrEmpty($version) -and "${{ github.event.inputs.release_type }}" -ne "") {
            $latestTag = git describe --tags --abbrev=0 2>$null
            if ($latestTag) {
              $currentVersion = $latestTag -replace '^v', ''
              Write-Host "Current version from git: $currentVersion" -ForegroundColor Yellow

              if ($currentVersion -match '^(\d+)\.(\d+)\.(\d+)') {
                $major = [int]$matches[1]
                $minor = [int]$matches[2]
                $patch = [int]$matches[3]

                switch ("${{ github.event.inputs.release_type }}") {
                  "major" { $version = "$($major + 1).0.0" }
                  "minor" { $version = "$major.$($minor + 1).0" }
                  "patch" { $version = "$major.$minor.$($patch + 1)" }
                  "prerelease" { $version = "$major.$minor.$($patch + 1)-pre.$([DateTimeOffset]::UtcNow.ToUnixTimeSeconds())" }
                }
              }
            } else {
              $version = "1.0.0"
            }
            Write-Host "Calculated new version: $version" -ForegroundColor Green
          }

          if ([string]::IsNullOrEmpty($version) -and "${{ github.event.release.tag_name }}" -ne "") {
            $releaseTag = "${{ github.event.release.tag_name }}"
            if ($releaseTag -match '^v?(.+)$') {
              $version = $matches[1]
              Write-Host "Using release version: $version" -ForegroundColor Green
            }
          }

          if ([string]::IsNullOrEmpty($version) -and
              "${{ github.event_name }}" -eq "pull_request" -and
              "${{ github.event.pull_request.merged }}" -eq "true" -and
              ("${{ github.event.pull_request.base.ref }}" -eq "main" -or "${{ github.event.pull_request.base.ref }}" -eq "master")) {

            $latestTag = git describe --tags --abbrev=0 2>$null
            if ($latestTag) {
              $currentVersion = $latestTag -replace '^v', ''
              if ($currentVersion -match '^(\d+)\.(\d+)\.(\d+)') {
                $major = [int]$matches[1]
                $minor = [int]$matches[2]
                $patch = [int]$matches[3]
                $version = "$major.$minor.$($patch + 1)"
                Write-Host "Auto-incrementing patch version for merged PR: $version" -ForegroundColor Green
              }
            } else {
              $version = "1.0.0"
            }
          }

          if ([string]::IsNullOrEmpty($version) -and
              "${{ github.event_name }}" -eq "push" -and
              ("${{ github.ref }}" -eq "refs/heads/main" -or "${{ github.ref }}" -eq "refs/heads/master")) {

            $latestTag = git describe --tags --abbrev=0 2>$null
            if ($latestTag) {
              $currentVersion = $latestTag -replace '^v', ''
              if ($currentVersion -match '^(\d+)\.(\d+)\.(\d+)') {
                $major = [int]$matches[1]
                $minor = [int]$matches[2]
                $patch = [int]$matches[3]
                $version = "$major.$minor.$($patch + 1)"
                Write-Host "Auto-incrementing patch version for main branch push: $version" -ForegroundColor Green
              }
            } else {
              $version = "1.0.0"
            }
          }

          if ([string]::IsNullOrEmpty($version)) {
            $timestamp = Get-Date -Format "yyyy.MM.dd.HHmm"
            $version = "0.0.$timestamp"
            Write-Host "Using fallback timestamp version: $version" -ForegroundColor Yellow
          }

          Write-Host "Final version determined: $version" -ForegroundColor Green
          echo "version=$version" >> $env:GITHUB_OUTPUT

      - name: Check if build should proceed
        id: check
        shell: pwsh
        run: |
          $shouldBuild = $false

          if ("${{ github.event_name }}" -eq "release") {
            $shouldBuild = $true
            Write-Host "✓ Release event - proceeding with build" -ForegroundColor Green
          } elseif ("${{ github.event_name }}" -eq "push" -and "${{ github.ref_type }}" -eq "tag") {
            $shouldBuild = $true
            Write-Host "✓ Tag push - proceeding with build" -ForegroundColor Green
          } elseif ("${{ github.event_name }}" -eq "workflow_dispatch") {
            $shouldBuild = $true
            Write-Host "✓ Manual dispatch - proceeding with build" -ForegroundColor Green
          } elseif ("${{ github.event_name }}" -eq "pull_request" -and
                    "${{ github.event.pull_request.merged }}" -eq "true" -and
                    ("${{ github.event.pull_request.base.ref }}" -eq "main" -or "${{ github.event.pull_request.base.ref }}" -eq "master")) {
            $shouldBuild = $true
            Write-Host "✓ PR merged to main/master - proceeding with build" -ForegroundColor Green
          } elseif ("${{ github.event_name }}" -eq "push" -and
                    ("${{ github.ref }}" -eq "refs/heads/main" -or "${{ github.ref }}" -eq "refs/heads/master")) {
            $shouldBuild = $true
            Write-Host "✓ Push to main/master - proceeding with build" -ForegroundColor Green
          } else {
            Write-Host "✗ Event does not trigger build: ${{ github.event_name }}" -ForegroundColor Yellow
          }

          Write-Host "Should build: $shouldBuild" -ForegroundColor Cyan
          echo "should-build=$shouldBuild" >> $env:GITHUB_OUTPUT

  validate:
    name: Pre-Build Validation (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: version
    if: needs.version.outputs.should-build == 'true'

    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
      fail-fast: false

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup PowerShell Environment
        shell: pwsh
        run: |
          Write-Host "Setting up PowerShell environment on ${{ matrix.os }}..." -ForegroundColor Cyan
          echo "POWERSHELL_TELEMETRY_OPTOUT=1" >> $env:GITHUB_ENV
          echo "PROJECT_ROOT=$PWD" >> $env:GITHUB_ENV

          if ($IsWindows) {
            $env:PATH_SEPARATOR = ";"
          } else {
            $env:PATH_SEPARATOR = ":"
          }

          Write-Host "✓ Environment initialized for ${{ matrix.os }}" -ForegroundColor Green

      - name: Run Cross-Platform Validation
        shell: pwsh
        run: |
          Write-Host "Running pre-build validation on ${{ matrix.os }}..." -ForegroundColor Cyan

          $ErrorActionPreference = 'Stop'

          try {
            if (Test-Path './tests/Run-BulletproofValidation.ps1') {
              Write-Host "Running bulletproof validation..." -ForegroundColor Yellow
              pwsh -File './tests/Run-BulletproofValidation.ps1' -ValidationLevel 'Quick' -CI -FailFast
            } else {
              Write-Host "No bulletproof validation found, running basic checks" -ForegroundColor Yellow

              if (Test-Path './aither-core/modules') {
                $modules = Get-ChildItem -Path './aither-core/modules' -Directory
                foreach ($module in $modules) {
                  try {
                    if (-not $module.FullName) {
                      throw "Module $($module.Name) does not have a valid path (FullName is null)"
                    }
                    Write-Host "Testing module: $($module.Name)" -ForegroundColor Cyan
                    Import-Module $module.FullName -Force -ErrorAction Stop
                    Write-Host "✓ Module $($module.Name) imports successfully" -ForegroundColor Green
                  } catch {
                    Write-Error "Module $($module.Name) failed to import: $($_.Exception.Message)"
                    exit 1
                  }
                }
              }
            }

            Write-Host "✓ Pre-build validation completed successfully on ${{ matrix.os }}" -ForegroundColor Green

          } catch {
            Write-Error "Pre-build validation failed on ${{ matrix.os }}: $($_.Exception.Message)"
            exit 1
          }

  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    needs: [version, validate]
    if: needs.version.outputs.should-build == 'true'

    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux
            artifact_extension: tar.gz
          - os: windows-latest
            platform: windows
            artifact_extension: zip
          - os: macos-latest
            platform: macos
            artifact_extension: tar.gz

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Build Environment
        shell: pwsh
        run: |
          Write-Host "Setting up build environment for ${{ matrix.platform }}..." -ForegroundColor Cyan

          $version = "${{ needs.version.outputs.version }}"
          echo "BUILD_VERSION=$version" >> $env:GITHUB_ENV
          echo "PROJECT_ROOT=$PWD" >> $env:GITHUB_ENV

          Write-Host "✓ Environment configured for ${{ matrix.platform }}" -ForegroundColor Green

      - name: Build AitherZero Package
        shell: pwsh
        run: |
          Write-Host "Building AitherZero package for ${{ matrix.platform }}..." -ForegroundColor Cyan

          $ErrorActionPreference = 'Stop'
          $version = "${{ needs.version.outputs.version }}"

          try {
            $buildDir = "build-output/${{ matrix.platform }}"
            New-Item -Path $buildDir -ItemType Directory -Force | Out-Null

            $packageName = "AitherZero-$version-${{ matrix.platform }}"
            $packageDir = "$buildDir/$packageName"
            New-Item -Path $packageDir -ItemType Directory -Force | Out-Null

            Write-Host "Creating package: $packageName" -ForegroundColor Yellow

            $coreItems = @(
              'aither-core',
              'build',
              'configs',
              'templates',
              'README.md',
              'LICENSE'
            )

            foreach ($item in $coreItems) {
              if (Test-Path $item) {
                $destinationPath = Join-Path $packageDir $item
                Copy-Item -Path $item -Destination $destinationPath -Recurse -Force
                Write-Host "✓ Copied: $item" -ForegroundColor Green
              } else {
                Write-Warning "Item not found: $item"
              }
            }

            if ("${{ matrix.platform }}" -eq "windows") {
              $startupScript = "@echo off`necho Starting AitherZero v$version...`npwsh -File `"aither-core/aither-core.ps1`" %*`npause"
              Set-Content -Path "$packageDir/AitherZero.bat" -Value $startupScript -Encoding UTF8
              Write-Host "✓ Created Windows startup script" -ForegroundColor Green
            } else {
              $startupScript = "#!/bin/bash`necho `"Starting AitherZero v$version...`"`npwsh -File `"aither-core/aither-core.ps1`" `$@"
              Set-Content -Path "$packageDir/aitherzero.sh" -Value $startupScript -Encoding UTF8

              if (-not $IsWindows) {
                chmod +x "$packageDir/aitherzero.sh"
              }
              Write-Host "✓ Created Unix startup script" -ForegroundColor Green
            }

            Write-Host "✓ Package creation completed for ${{ matrix.platform }}" -ForegroundColor Green

          } catch {
            Write-Error "Build failed for ${{ matrix.platform }}: $($_.Exception.Message)"
            exit 1
          }

      - name: Create Platform Archive
        shell: pwsh
        run: |
          Write-Host "Creating archive for ${{ matrix.platform }}..." -ForegroundColor Cyan

          $version = "${{ needs.version.outputs.version }}"
          $buildDir = "build-output/${{ matrix.platform }}"
          $packageName = "AitherZero-$version-${{ matrix.platform }}"
          $archiveName = "$packageName.${{ matrix.artifact_extension }}"

          if (Test-Path "$buildDir/$packageName") {
            if ("${{ matrix.artifact_extension }}" -eq "zip") {
              Compress-Archive -Path "$buildDir/$packageName/*" -DestinationPath $archiveName -Force
            } else {
              Set-Location $buildDir
              tar -czf "../$archiveName" $packageName
              Set-Location ".."
            }

            $hash = Get-FileHash $archiveName -Algorithm SHA256
            Set-Content -Path "$archiveName.sha256" -Value "$($hash.Hash.ToLower())  $archiveName"

            Write-Host "✓ Archive created: $archiveName" -ForegroundColor Green

            if (Test-Path $archiveName) {
              $size = (Get-Item $archiveName).Length
              Write-Host "Archive size: $([math]::Round($size / 1MB, 2)) MB" -ForegroundColor Cyan
            }
          } else {
            Write-Error "Package directory not found: $buildDir/$packageName"
            exit 1
          }

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: AitherZero-${{ needs.version.outputs.version }}-${{ matrix.platform }}
          path: |
            AitherZero-${{ needs.version.outputs.version }}-${{ matrix.platform }}.${{ matrix.artifact_extension }}
            AitherZero-${{ needs.version.outputs.version }}-${{ matrix.platform }}.${{ matrix.artifact_extension }}.sha256
          retention-days: 30

  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [version, build]
    if: |
      needs.version.outputs.should-build == 'true' &&
      (github.event_name == 'workflow_dispatch' ||
       github.event_name == 'push' && startsWith(github.ref, 'refs/tags/') ||
       github.event_name == 'release' ||
       (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
       (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')))

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts

      - name: Prepare Release Assets
        shell: pwsh
        run: |
          Write-Host "Preparing release assets..." -ForegroundColor Cyan

          New-Item -ItemType Directory -Path "release" -Force | Out-Null

          Get-ChildItem -Path "release-artifacts" -Recurse -File | ForEach-Object {
            $destPath = "release/$($_.Name)"
            Copy-Item -Path $_.FullName -Destination $destPath -Force
            Write-Host "✓ Prepared: $($_.Name)" -ForegroundColor Green
          }

          $version = "${{ needs.version.outputs.version }}"
          $checksumFile = "release/AitherZero-$version-checksums.txt"
          $checksumContent = @()

          Get-ChildItem -Path "release" -Filter "*.sha256" | ForEach-Object {
            $content = Get-Content $_.FullName -Raw
            $checksumContent += $content.Trim()
          }

          if ($checksumContent.Count -gt 0) {
            Set-Content -Path $checksumFile -Value $checksumContent
            Write-Host "✓ Created comprehensive checksums file" -ForegroundColor Green
          }

          Write-Host "Release assets prepared:" -ForegroundColor Yellow
          Get-ChildItem -Path "release" | ForEach-Object {
            $size = [math]::Round($_.Length / 1MB, 2)
            Write-Host "  $($_.Name) ($size MB)" -ForegroundColor Cyan
          }

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.version.outputs.version }}
          name: AitherZero v${{ needs.version.outputs.version }}
          body: |
            # AitherZero v${{ needs.version.outputs.version }}

            Cross-Platform Infrastructure Automation Framework

            This release includes pre-built packages for Windows, Linux, and macOS.

            ## Installation

            Download the package for your platform:
            - Windows: AitherZero-${{ needs.version.outputs.version }}-windows.zip
            - Linux: AitherZero-${{ needs.version.outputs.version }}-linux.tar.gz
            - macOS: AitherZero-${{ needs.version.outputs.version }}-macos.tar.gz

            ## Requirements

            - PowerShell 7.0 or later
            - Git (for repository operations)
            - OpenTofu/Terraform (for infrastructure automation)

            ## Features

            - Cross-platform PowerShell-based automation
            - OpenTofu/Terraform integration
            - Parallel execution capabilities
            - Comprehensive testing framework
            - Advanced patch management system
            - Enterprise-grade logging and error handling
          files: release/*
          draft: false
          prerelease: ${{ contains(needs.version.outputs.version, 'pre') || contains(needs.version.outputs.version, 'alpha') || contains(needs.version.outputs.version, 'beta') }}

  validate-release:
    name: Validate Release
    runs-on: ubuntu-latest
    needs: [version, release]
    if: always() && needs.release.result == 'success' && needs.version.outputs.version != ''

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Validate Release Assets
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Validating release v${{ needs.version.outputs.version }}..." -ForegroundColor Cyan

          $version = "${{ needs.version.outputs.version }}"
          if ([string]::IsNullOrEmpty($version)) {
            Write-Error "Version is empty or null. Cannot validate release."
            exit 1
          }

          try {
            $release = gh release view "v$version" --json tagName,assets,draft 2>$null

            if ($release) {
              $releaseData = $release | ConvertFrom-Json
              Write-Host "✓ Release found: $($releaseData.tagName)" -ForegroundColor Green

              Write-Host "Assets found: $($releaseData.assets.Count)" -ForegroundColor Cyan
              foreach ($asset in $releaseData.assets) {
                $sizeInMB = [math]::Round($asset.size / 1MB, 2)
                Write-Host "  - $($asset.name) ($sizeInMB MB)" -ForegroundColor White
              }

              $expectedAssets = @(
                "AitherZero-$version-windows.zip",
                "AitherZero-$version-windows.zip.sha256",
                "AitherZero-$version-linux.tar.gz",
                "AitherZero-$version-linux.tar.gz.sha256",
                "AitherZero-$version-macos.tar.gz",
                "AitherZero-$version-macos.tar.gz.sha256",
                "AitherZero-$version-checksums.txt"
              )

              $allAssetsPresent = $true
              $missingAssets = @()

              foreach ($expectedAsset in $expectedAssets) {
                $found = $releaseData.assets | Where-Object { $_.name -eq $expectedAsset }
                if ($found) {
                  Write-Host "✓ Asset found: $expectedAsset" -ForegroundColor Green
                } else {
                  Write-Host "✗ Asset missing: $expectedAsset" -ForegroundColor Red
                  $missingAssets += $expectedAsset
                  $allAssetsPresent = $false
                }
              }

              if ($allAssetsPresent) {
                Write-Host "✅ All expected assets are present!" -ForegroundColor Green
              } else {
                Write-Warning "Missing assets:"
                foreach ($missing in $missingAssets) {
                  Write-Warning "  - $missing"
                }
                Write-Error "Release validation failed: missing assets"
                exit 1
              }

              if ($releaseData.draft) {
                Write-Host "ℹ️ Release is marked as draft" -ForegroundColor Yellow
              } else {
                Write-Host "✓ Release is published" -ForegroundColor Green
              }

            } else {
              Write-Error "Release v$version not found"
              exit 1
            }

          } catch {
            Write-Error "Failed to validate release: $($_.Exception.Message)"
            exit 1
          }

      - name: Test Download and Basic Validation
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "Testing release download and basic validation..." -ForegroundColor Cyan

          $version = "${{ needs.version.outputs.version }}"

          try {
            $assetName = "AitherZero-$version-linux.tar.gz"

            Write-Host "Downloading $assetName..." -ForegroundColor Yellow
            gh release download "v$version" --pattern $assetName

            if (Test-Path $assetName) {
              Write-Host "✓ Asset downloaded successfully" -ForegroundColor Green

              Write-Host "Archive contents (first 10 entries):" -ForegroundColor Cyan
              tar -tzf $assetName | Select-Object -First 10 | ForEach-Object {
                Write-Host "  $($_)" -ForegroundColor White
              }

              Remove-Item $assetName -Force
              Write-Host "✓ Basic validation completed" -ForegroundColor Green

            } else {
              Write-Error "Failed to download asset: $assetName"
              exit 1
            }

          } catch {
            Write-Error "Download validation failed: $($_.Exception.Message)"
            exit 1
          }

          Write-Host "🎉 Release validation completed successfully!" -ForegroundColor Green
