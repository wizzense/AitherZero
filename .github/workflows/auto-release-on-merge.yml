name: 🚀 Auto-Release on Merge
run-name: 🚀 Auto-Release - ${{ github.event.pull_request.title }}

on:
  pull_request:
    types: [closed]
    branches: [main]

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1
  PR_TITLE: ${{ github.event.pull_request.title }}
  PR_NUMBER: ${{ github.event.pull_request.number }}
  PR_AUTHOR: ${{ github.event.pull_request.user.login }}
  PR_BODY: ${{ github.event.pull_request.body }}

jobs:
  check-and-release:
    name: 🎯 Check and Create Release
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true
    permissions:
      contents: write
      
    steps:
      - name: 🔍 Smart Release Detection
        id: check-label
        run: |
          echo "Starting smart release detection..."
          LABELS='${{ toJson(github.event.pull_request.labels.*.name) }}'
          echo "PR Labels: $LABELS"
          echo "PR Title: $PR_TITLE"
          
          # Check for explicit no-release label first
          if echo "$LABELS" | grep -q "no-release"; then
            echo "has_release_label=false" >> $GITHUB_OUTPUT
            echo "❌ No-release label found - skipping release"
            exit 0
          fi
          
          # Check for explicit release labels
          if echo "$LABELS" | grep -q "release:major"; then
            echo "release_type=major" >> $GITHUB_OUTPUT
            echo "has_release_label=true" >> $GITHUB_OUTPUT
            echo "🏷️ Explicit major release label found"
          elif echo "$LABELS" | grep -q "release:minor"; then
            echo "release_type=minor" >> $GITHUB_OUTPUT
            echo "has_release_label=true" >> $GITHUB_OUTPUT
            echo "🏷️ Explicit minor release label found"
          elif echo "$LABELS" | grep -q "release:patch"; then
            echo "release_type=patch" >> $GITHUB_OUTPUT
            echo "has_release_label=true" >> $GITHUB_OUTPUT
            echo "🏷️ Explicit patch release label found"
          else
            # Smart auto-detection based on PR title and content
            echo "🤖 No explicit release label - performing smart detection..."
            
            # Check for breaking changes (major release)
            if echo "$PR_TITLE" | grep -qi "BREAKING\|breaking change\|major"; then
              echo "release_type=major" >> $GITHUB_OUTPUT
              echo "🚨 Breaking change detected in title - major release"
            # Check for features (minor release)
            elif echo "$PR_TITLE" | grep -qi "feat\|feature\|add\|new\|enhance"; then
              echo "release_type=minor" >> $GITHUB_OUTPUT
              echo "✨ Feature detected in title - minor release"
            # Check for documentation/cleanup only (skip release)
            elif echo "$PR_TITLE" | grep -qi "docs\|documentation\|readme\|typo\|cleanup\|refactor"; then
              # Check if this is a substantial change that should still trigger a patch
              if echo "$PR_TITLE" | grep -qi "simplify\|clean up.*script\|installation"; then
                echo "release_type=patch" >> $GITHUB_OUTPUT
                echo "🔧 Substantial cleanup/improvement - patch release"
              else
                echo "has_release_label=false" >> $GITHUB_OUTPUT
                echo "📝 Documentation-only change - skipping release"
                exit 0
              fi
            # Default to patch release for any other changes
            else
              echo "release_type=patch" >> $GITHUB_OUTPUT
              echo "🔄 Default to patch release for merged PR"
            fi
            
            echo "has_release_label=true" >> $GITHUB_OUTPUT
          fi
          
      - name: 📥 Checkout Repository
        if: steps.check-label.outputs.has_release_label == 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: 🔧 Configure Git
        if: steps.check-label.outputs.has_release_label == 'true'
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
      - name: 📊 Calculate Version
        if: steps.check-label.outputs.has_release_label == 'true'
        id: version
        run: |
          # Read current version
          CURRENT_VERSION=$(cat VERSION | tr -d '[:space:]')
          echo "Current version: $CURRENT_VERSION"
          
          # Parse version components
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          
          # Calculate new version based on release type
          case "${{ steps.check-label.outputs.release_type }}" in
            "major")
              NEW_VERSION="$((MAJOR + 1)).0.0"
              ;;
            "minor")
              NEW_VERSION="$MAJOR.$((MINOR + 1)).0"
              ;;
            "patch")
              NEW_VERSION="$MAJOR.$MINOR.$((PATCH + 1))"
              ;;
          esac
          
          echo "New version: $NEW_VERSION"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          
      - name: 📝 Update VERSION File
        if: steps.check-label.outputs.has_release_label == 'true'
        run: |
          echo "${{ steps.version.outputs.new_version }}" > VERSION
          git add VERSION
          git commit -m "Bump version to ${{ steps.version.outputs.new_version }} [skip ci]

          Automated version bump triggered by PR #$PR_NUMBER
          Release type: ${{ steps.check-label.outputs.release_type }}
          PR: $PR_TITLE"
          
      - name: 🏷️ Create and Push Tag
        if: steps.check-label.outputs.has_release_label == 'true'
        run: |
          # Create annotated tag
          TAG_NAME="v${{ steps.version.outputs.new_version }}"
          
          # Check if tag already exists
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "⚠️ Tag $TAG_NAME already exists locally, deleting it first..."
            git tag -d "$TAG_NAME"
          fi
          
          # Check if tag exists on remote
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "⚠️ Tag $TAG_NAME already exists on remote, will force update..."
            FORCE_PUSH="--force"
          else
            FORCE_PUSH=""
          fi
          
          TAG_MESSAGE="Release $TAG_NAME

          Triggered by: PR #$PR_NUMBER
          Title: $PR_TITLE
          Author: $PR_AUTHOR
          Release Type: ${{ steps.check-label.outputs.release_type }}

          Changes included:
          $PR_BODY"
          
          git tag -a "$TAG_NAME" -m "$TAG_MESSAGE"
          
          # Push changes and tag
          git push origin main
          git push origin "$TAG_NAME" $FORCE_PUSH
          
          echo "✅ Created and pushed tag: $TAG_NAME"
          
      - name: 📋 Summary
        if: always()
        run: |
          if [ "${{ steps.check-label.outputs.has_release_label }}" == "true" ]; then
            echo "## 🚀 Auto-Release Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**PR**: #$PR_NUMBER - $PR_TITLE" >> $GITHUB_STEP_SUMMARY
            echo "**Release Type**: ${{ steps.check-label.outputs.release_type }}" >> $GITHUB_STEP_SUMMARY
            echo "**Version**: ${{ steps.version.outputs.current_version }} → ${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "**Tag**: v${{ steps.version.outputs.new_version }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The build & release pipeline will now automatically create release artifacts." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ℹ️ No Release Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "PR #$PR_NUMBER was determined to not require a release." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Smart Detection Results:**" >> $GITHUB_STEP_SUMMARY
            echo "- Documentation-only or no-release label detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Manual Override Options:**" >> $GITHUB_STEP_SUMMARY
            echo "- Add \`release:patch\`, \`release:minor\`, or \`release:major\` label" >> $GITHUB_STEP_SUMMARY
            echo "- Add \`no-release\` label to explicitly skip releases" >> $GITHUB_STEP_SUMMARY
          fi