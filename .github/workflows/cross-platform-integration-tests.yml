name: Cross-Platform Integration Tests

on:
  push:
    branches: [ main, develop, 'feature/**' ]
    paths:
      - 'domains/utilities/EnvironmentConfig.psm1'
      - 'domains/infrastructure/DeploymentArtifacts.psm1'
      - 'config.windows.psd1'
      - 'config.linux.psd1'
      - 'config.macos.psd1'
      - 'automation-scripts/0001_Configure-Environment.ps1'
      - 'automation-scripts/021*.ps1'
      - 'automation-scripts/022*.ps1'
      - 'automation-scripts/085*.ps1'
      - 'orchestration/playbooks/dev-environment-setup.psd1'
      - 'orchestration/playbooks/deployment-environment.psd1'
      - 'orchestration/playbooks/self-hosted-runner-setup.psd1'
      - 'tests/integration/ProfileBasedSetup.Integration.Tests.ps1'
      - '.github/workflows/cross-platform-integration-tests.yml'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'domains/utilities/EnvironmentConfig.psm1'
      - 'domains/infrastructure/DeploymentArtifacts.psm1'
      - 'config.*.psd1'
      - 'automation-scripts/0001_Configure-Environment.ps1'
      - 'automation-scripts/021*.ps1'
      - 'automation-scripts/022*.ps1'
      - 'automation-scripts/085*.ps1'
      - 'orchestration/playbooks/*.psd1'
      - 'tests/integration/*.Tests.ps1'
  workflow_dispatch:
    inputs:
      test-level:
        description: 'Test level to run'
        required: false
        default: 'full'
        type: choice
        options:
          - quick
          - full
          - comprehensive

env:
  PESTER_VERSION: '5.6.1'
  POWERSHELL_TELEMETRY_OPTOUT: '1'

jobs:
  # ============================================================================
  # Windows Integration Tests
  # ============================================================================
  windows-integration:
    name: Windows Integration Tests
    runs-on: windows-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        profile: [Development, Deployment, AI-Development, Full-Stack]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PowerShell 7
        uses: PowerShell/PowerShell@main
        with:
          pwsh: true

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion $env:PESTER_VERSION -Force -SkipPublisherCheck
          Import-Module Pester

      - name: Bootstrap AitherZero (Windows)
        shell: pwsh
        run: |
          Write-Host "Bootstrapping with profile: ${{ matrix.profile }}"
          ./bootstrap.ps1 -Mode Update -InstallProfile "${{ matrix.profile }}" -NonInteractive
        env:
          CI: true

      - name: Run Environment Configuration Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/domains/utilities/EnvironmentConfig.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Environment configuration tests failed on Windows"
          }

      - name: Run Deployment Artifacts Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/domains/infrastructure/DeploymentArtifacts.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Deployment artifacts tests failed on Windows"
          }

      - name: Run Integration Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/integration/ProfileBasedSetup.Integration.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Integration tests failed on Windows with profile ${{ matrix.profile }}"
          }

      - name: Test Windows-Specific Features
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          # Test Windows long path support detection
          $result = Get-EnvironmentConfiguration -Category Windows
          Write-Host "Windows features detected: $($result.Windows.Features | ConvertTo-Json -Depth 3)"
          
          # Test Unattend.xml generation
          New-WindowsUnattendXml -ConfigPath "./config.windows.psd1" -OutputPath "./test-artifacts"
          if (-not (Test-Path "./test-artifacts/Autounattend.xml")) {
            throw "Failed to generate Autounattend.xml"
          }
          
          # Test Windows Dockerfile generation
          New-Dockerfile -Platform Windows -ConfigPath "./config.windows.psd1" -OutputPath "./test-artifacts"
          if (-not (Test-Path "./test-artifacts/Dockerfile.windows")) {
            throw "Failed to generate Windows Dockerfile"
          }

      - name: Upload Test Artifacts (Windows)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: windows-test-artifacts-${{ matrix.profile }}
          path: |
            test-artifacts/
            logs/

  # ============================================================================
  # Linux Integration Tests
  # ============================================================================
  linux-integration:
    name: Linux Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        profile: [Development, Deployment, AI-Development, Self-Hosted-Runner]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PowerShell 7
        run: |
          # Update package list
          sudo apt-get update
          
          # Install PowerShell
          wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
          sudo dpkg -i packages-microsoft-prod.deb
          sudo apt-get update
          sudo apt-get install -y powershell

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion $env:PESTER_VERSION -Force -SkipPublisherCheck
          Import-Module Pester

      - name: Bootstrap AitherZero (Linux)
        shell: pwsh
        run: |
          Write-Host "Bootstrapping with profile: ${{ matrix.profile }}"
          ./bootstrap.ps1 -Mode Update -InstallProfile "${{ matrix.profile }}" -NonInteractive
        env:
          CI: true

      - name: Run Environment Configuration Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/domains/utilities/EnvironmentConfig.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Environment configuration tests failed on Linux"
          }

      - name: Run Deployment Artifacts Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/domains/infrastructure/DeploymentArtifacts.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Deployment artifacts tests failed on Linux"
          }

      - name: Run Integration Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/integration/ProfileBasedSetup.Integration.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Integration tests failed on Linux with profile ${{ matrix.profile }}"
          }

      - name: Test Linux-Specific Features
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          # Test Linux kernel parameters detection
          $result = Get-EnvironmentConfiguration -Category Unix
          Write-Host "Linux features detected: $($result.Unix | ConvertTo-Json -Depth 3)"
          
          # Test cloud-init generation
          New-LinuxCloudInitConfig -ConfigPath "./config.linux.psd1" -Format YAML -OutputPath "./test-artifacts"
          if (-not (Test-Path "./test-artifacts/cloud-init.yaml")) {
            throw "Failed to generate cloud-init.yaml"
          }
          
          # Test Linux Dockerfile generation
          New-Dockerfile -Platform Linux -ConfigPath "./config.linux.psd1" -OutputPath "./test-artifacts"
          if (-not (Test-Path "./test-artifacts/Dockerfile")) {
            throw "Failed to generate Linux Dockerfile"
          }

      - name: Upload Test Artifacts (Linux)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: linux-test-artifacts-${{ matrix.profile }}
          path: |
            test-artifacts/
            logs/

  # ============================================================================
  # macOS Integration Tests
  # ============================================================================
  macos-integration:
    name: macOS Integration Tests
    runs-on: macos-latest
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        profile: [Development, Deployment, AI-Development]
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup PowerShell 7
        run: |
          brew install --cask powershell

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module -Name Pester -MinimumVersion $env:PESTER_VERSION -Force -SkipPublisherCheck
          Import-Module Pester

      - name: Bootstrap AitherZero (macOS)
        shell: pwsh
        run: |
          Write-Host "Bootstrapping with profile: ${{ matrix.profile }}"
          ./bootstrap.ps1 -Mode Update -InstallProfile "${{ matrix.profile }}" -NonInteractive
        env:
          CI: true

      - name: Run Environment Configuration Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/domains/utilities/EnvironmentConfig.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Environment configuration tests failed on macOS"
          }

      - name: Run Deployment Artifacts Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/domains/infrastructure/DeploymentArtifacts.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Deployment artifacts tests failed on macOS"
          }

      - name: Run Integration Tests
        shell: pwsh
        run: |
          $testResults = Invoke-Pester `
            -Path "./tests/integration/ProfileBasedSetup.Integration.Tests.ps1" `
            -Output Detailed `
            -PassThru
          
          if ($testResults.FailedCount -gt 0) {
            throw "Integration tests failed on macOS with profile ${{ matrix.profile }}"
          }

      - name: Test macOS-Specific Features
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          # Test macOS defaults detection
          $result = Get-EnvironmentConfiguration -Category Unix
          Write-Host "macOS features detected: $($result.Unix | ConvertTo-Json -Depth 3)"
          
          # Test Brewfile generation
          New-MacOSBrewfile -ConfigPath "./config.macos.psd1" -OutputPath "./test-artifacts"
          if (-not (Test-Path "./test-artifacts/Brewfile")) {
            throw "Failed to generate Brewfile"
          }

      - name: Upload Test Artifacts (macOS)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: macos-test-artifacts-${{ matrix.profile }}
          path: |
            test-artifacts/
            logs/

  # ============================================================================
  # Summary Report
  # ============================================================================
  test-summary:
    name: Generate Test Summary
    runs-on: ubuntu-latest
    needs: [windows-integration, linux-integration, macos-integration]
    if: always()
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: all-artifacts

      - name: Generate Summary Report
        shell: pwsh
        run: |
          Write-Host "## Cross-Platform Integration Test Results" -ForegroundColor Cyan
          Write-Host ""
          
          # Count artifacts by platform
          $windowsArtifacts = (Get-ChildItem -Path "all-artifacts" -Filter "windows-*" -Directory).Count
          $linuxArtifacts = (Get-ChildItem -Path "all-artifacts" -Filter "linux-*" -Directory).Count
          $macosArtifacts = (Get-ChildItem -Path "all-artifacts" -Filter "macos-*" -Directory).Count
          
          Write-Host "Platform Test Results:"
          Write-Host "  Windows: $windowsArtifacts profile(s) tested"
          Write-Host "  Linux:   $linuxArtifacts profile(s) tested"
          Write-Host "  macOS:   $macosArtifacts profile(s) tested"
          Write-Host ""
          
          $totalTests = $windowsArtifacts + $linuxArtifacts + $macosArtifacts
          Write-Host "Total Profiles Tested: $totalTests"
          
          # Check for failures
          $windowsStatus = "${{ needs.windows-integration.result }}"
          $linuxStatus = "${{ needs.linux-integration.result }}"
          $macosStatus = "${{ needs.macos-integration.result }}"
          
          Write-Host ""
          Write-Host "Job Status:"
          Write-Host "  Windows: $windowsStatus"
          Write-Host "  Linux:   $linuxStatus"
          Write-Host "  macOS:   $macosStatus"
          
          if ($windowsStatus -ne 'success' -or $linuxStatus -ne 'success' -or $macosStatus -ne 'success') {
            Write-Host ""
            Write-Host "⚠️  Some tests failed. Review artifacts for details." -ForegroundColor Yellow
            exit 1
          }
          
          Write-Host ""
          Write-Host "✅ All cross-platform integration tests passed!" -ForegroundColor Green
