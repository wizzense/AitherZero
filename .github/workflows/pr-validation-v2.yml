---
name: âœ… PR Validation (v2 - CLI)

# Fast, essential PR validation using new CLI cmdlets and playbooks
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: write
  checks: write

concurrency:
  group: pr-validation-v2-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true
  AITHERZERO_SUPPRESS_BANNER: true

jobs:
  pr-validation:
    name: ğŸš€ Fast PR Validation
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'pull_request' && 
      !github.event.pull_request.draft && 
      github.event.pull_request.head.repo.full_name == github.repository &&
      github.actor != 'github-actions[bot]'
    timeout-minutes: 5

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Bootstrap Environment
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Bootstrapping AitherZero..." -ForegroundColor Cyan
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal

      - name: ğŸ“¦ Load AitherZero Module
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Loading AitherZero module..." -ForegroundColor Cyan
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "âœ… Module loaded successfully" -ForegroundColor Green
          Write-Host "Available cmdlets:" -ForegroundColor Cyan
          Get-Command -Module AitherZero | Where-Object Name -like '*-Aither*' | Format-Table Name, Source

      - name: âš¡ Execute PR Validation Playbook
        id: validation
        shell: pwsh
        run: |
          Write-Host "âš¡ Running PR validation playbook..." -ForegroundColor Cyan
          
          # Import module
          Import-Module ./AitherZero.psd1 -Force
          
          try {
            # Execute pr-validation-fast playbook using new CLI
            # The cmdlet sets $LASTEXITCODE based on failures
            Invoke-AitherPlaybook -Name pr-validation-fast -Parallel -GenerateSummary
            
            $exitCode = if ($null -eq $LASTEXITCODE) { 0 } else { $LASTEXITCODE }
            Write-Host "Exit code: $exitCode" -ForegroundColor $(if ($exitCode -eq 0) { 'Green' } else { 'Red' })
            
            echo "success=$($exitCode -eq 0)" >> $env:GITHUB_OUTPUT
            echo "exit-code=$exitCode" >> $env:GITHUB_OUTPUT
            
            # Exit with the appropriate code
            exit $exitCode
          }
          catch {
            Write-Host "âŒ Playbook execution failed: $_" -ForegroundColor Red
            Write-Host "Error details: $($_.Exception.Message)" -ForegroundColor Red
            echo "success=false" >> $env:GITHUB_OUTPUT
            echo "exit-code=1" >> $env:GITHUB_OUTPUT
            exit 1
          }

      - name: ğŸ“Š Upload Execution Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: pr-validation-summary
          path: |
            docs/reports/*.md
            docs/reports/*.json
            logs/*.log
          retention-days: 7

      - name: ğŸ’¬ Post Results Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const success = '${{ steps.validation.outputs.success }}' === 'true';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const statusIcon = success ? 'âœ…' : 'âŒ';
            const statusText = success ? '**PASSED**' : '**FAILED**';
            const statusColor = success ? 'ğŸŸ¢' : 'ğŸ”´';
            
            let comment = `## ${statusIcon} PR Validation Results (v2)\n\n`;
            comment += `### ${statusColor} Status: ${statusText}\n\n`;
            comment += `**Playbook:** \`pr-validation-fast\`\n`;
            comment += `**Mode:** Parallel execution with new CLI\n\n`;
            
            if (success) {
              comment += `### âœ… All Checks Passed!\n\n`;
              comment += `Your PR has passed fast validation checks:\n`;
              comment += `- âœ… Syntax validation\n`;
              comment += `- âœ… Config manifest validation\n`;
              comment += `- âœ… Essential quality checks\n\n`;
              comment += `**Next Steps:**\n`;
              comment += `1. ğŸ”„ Comprehensive CI will run automatically\n`;
              comment += `2. ğŸ“Š Quality validation will provide detailed feedback\n`;
              comment += `3. ğŸ‰ Once all checks pass, you're ready to merge!\n\n`;
            } else {
              comment += `### âŒ Validation Failed\n\n`;
              comment += `Some checks did not pass. Please review the errors above and:\n\n`;
              comment += `1. ğŸ“ Review the failure details\n`;
              comment += `2. ğŸ”§ Fix the issues locally\n`;
              comment += `3. ğŸ§ª Test using: \`Invoke-AitherPlaybook pr-validation-fast\`\n`;
              comment += `4. ğŸš€ Push changes to re-trigger validation\n\n`;
            }
            
            comment += `### ğŸ”— Links\n`;
            comment += `- ğŸ“Š [View Workflow Run](${runUrl})\n`;
            comment += `- ğŸ“ [Download Artifacts](${runUrl})\n`;
            comment += `- ğŸ“– [CLI Documentation](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/docs/CLI-UNIFICATION-PLAN.md)\n\n`;
            
            comment += `---\n`;
            comment += `*ğŸ¤– Automated by AitherZeroCLI â€¢ Using playbook orchestration*`;
            
            // Update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('PR Validation Results (v2)')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

      - name: âœ… Validation Complete
        if: always()
        shell: pwsh
        run: |
          $success = "${{ steps.validation.outputs.success }}" -eq "true"
          
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘           PR VALIDATION COMPLETE (v2 - CLI)                  â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          
          if ($success) {
            Write-Host "`nâœ… All checks PASSED - PR is ready for review!" -ForegroundColor Green
          } else {
            Write-Host "`nâŒ Validation FAILED - Please address the issues above" -ForegroundColor Red
          }
          
          Write-Host "`nPowered by AitherZeroCLI and OrchestrationEngine" -ForegroundColor DarkCyan
