---
name: üöÄ PR Ecosystem (Integrated Build & Deploy)

# Integrated PR workflow that consumes test results from master-test-orchestration
# This workflow focuses on build, packaging, and deployment
# Test execution is centralized in master-test-orchestration.yml

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: write
  pull-requests: write
  packages: write
  pages: write
  id-token: write
  actions: read

concurrency:
  group: pr-ecosystem-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  PR_NUMBER: ${{ github.event.pull_request.number }}
  GITHUB_BASE_REF: ${{ github.event.pull_request.base.ref }}
  GITHUB_HEAD_REF: ${{ github.event.pull_request.head.ref }}
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true

jobs:
  # Phase 1: Build (runs playbook for package creation)
  build:
    name: üî® Build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      build-status: ${{ steps.build.outcome }}
      build-result: ${{ steps.build.outputs.result }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üí¨ Post Build Start Status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üî® **Build Phase Started**\n\nCreating release packages...\n\n*Test results will be consumed from Master Test Orchestration*'
            });

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üî® Run Build Playbook
        id: build
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üî® Running PR Ecosystem Build Playbook" -ForegroundColor Cyan
          
          $result = Invoke-OrchestrationSequence -LoadPlaybook pr-ecosystem-build
          
          $exitCode = if ($null -eq $LASTEXITCODE) { 0 } else { $LASTEXITCODE }
          echo "result=$exitCode" >> $env:GITHUB_OUTPUT
          
          # Don't fail on build issues
          exit 0

      - name: üì¶ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-build
          path: |
            library/reports/build-*.json
            library/reports/build-*.md
            AitherZero-*-runtime.zip
            AitherZero-*-runtime.tar.gz
            AitherZero-*-full.zip
            AitherZero-*-full.tar.gz
          retention-days: 30
          if-no-files-found: warn

      - name: üí¨ Post Build Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.build.outcome }}';
            const result = '${{ steps.build.outputs.result }}';
            const icon = status === 'success' && result === '0' ? '‚úÖ' : '‚ö†Ô∏è';
            const statusText = result === '0' ? 'PASSED' : 'COMPLETED WITH ISSUES';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Build Phase ${statusText}**\n\nExit Code: ${result}\n\n[View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });

  # Phase 2: Analysis (runs playbook, but doesn't duplicate tests)
  analyze:
    name: üîç Analyze
    needs: build
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      analysis-status: ${{ steps.analyze.outcome }}
      analysis-result: ${{ steps.analyze.outputs.result }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üí¨ Post Analysis Start Status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üîç **Analysis Phase Started**\n\nRunning code analysis (not tests - those run in Master Test Orchestration)...'
            });

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üîç Run Analysis Playbook
        id: analyze
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üîç Running PR Ecosystem Analysis Playbook" -ForegroundColor Cyan
          
          $result = Invoke-OrchestrationSequence -LoadPlaybook pr-ecosystem-analyze
          
          $exitCode = if ($null -eq $LASTEXITCODE) { 0 } else { $LASTEXITCODE }
          echo "result=$exitCode" >> $env:GITHUB_OUTPUT
          
          # Don't fail on analysis issues
          exit 0

      - name: üìä Upload Analysis Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-analysis
          path: |
            library/reports/analysis-*.json
            library/reports/analysis-*.md
            library/reports/diff-*.json
            library/reports/quality-*.json
            library/reports/security-*.json
          retention-days: 30
          if-no-files-found: warn

      - name: üí¨ Post Analysis Status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.analyze.outcome }}';
            const result = '${{ steps.analyze.outputs.result }}';
            const icon = status === 'success' && result === '0' ? '‚úÖ' : '‚ÑπÔ∏è';
            const statusText = result === '0' ? 'PASSED' : 'COMPLETED WITH FINDINGS';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Analysis Phase ${statusText}**\n\nExit Code: ${result}\n\n[View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });

  # Phase 3: Report & Deploy (consumes artifacts from this workflow AND master-test-orchestration)
  report:
    name: üìä Report & Deploy
    needs: [build, analyze]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: always()

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üí¨ Post Report Start Status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üìä **Dashboard Generation Started**\n\nConsolidating results from all phases:\n- Build artifacts\n- Analysis results\n- Test results (from Master Test Orchestration)\n- Quality metrics'
            });

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üì• Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: pr-${{ env.PR_NUMBER }}-build
          path: ./artifacts/build
        continue-on-error: true

      - name: üì• Download Analysis Artifacts
        uses: actions/download-artifact@v4
        with:
          name: pr-${{ env.PR_NUMBER }}-analysis
          path: ./artifacts/analysis
        continue-on-error: true

      - name: üì• Download Test Results from Master Orchestration
        uses: actions/download-artifact@v4
        with:
          name: test-results
          path: ./artifacts/tests
        continue-on-error: true

      - name: üì• Download Validation Results from Master Orchestration
        uses: actions/download-artifact@v4
        with:
          name: validation-results
          path: ./artifacts/validation
        continue-on-error: true

      - name: üì• Download Quality Results from Master Orchestration
        uses: actions/download-artifact@v4
        with:
          name: quality-results
          path: ./artifacts/quality
        continue-on-error: true

      - name: üì• Download Dashboard from Master Orchestration
        uses: actions/download-artifact@v4
        with:
          name: dashboard-summary
          path: ./artifacts/dashboard
        continue-on-error: true

      - name: üîç Check Artifact Availability
        shell: pwsh
        run: |
          Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
          Write-Host "‚ïë  ARTIFACT CONSOLIDATION STATUS                ‚ïë" -ForegroundColor Cyan
          Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
          Write-Host ""
          
          $artifacts = @{
            "Build" = Test-Path "./artifacts/build"
            "Analysis" = Test-Path "./artifacts/analysis"
            "Tests" = Test-Path "./artifacts/tests"
            "Validation" = Test-Path "./artifacts/validation"
            "Quality" = Test-Path "./artifacts/quality"
            "Dashboard" = Test-Path "./artifacts/dashboard"
          }
          
          foreach ($artifact in $artifacts.GetEnumerator()) {
            $status = if ($artifact.Value) { "‚úÖ Available" } else { "‚ö†Ô∏è Not Found" }
            $color = if ($artifact.Value) { 'Green' } else { 'Yellow' }
            Write-Host "  $($artifact.Key): $status" -ForegroundColor $color
          }
          
          Write-Host ""
          $availableCount = ($artifacts.Values | Where-Object { $_ }).Count
          Write-Host "Total artifacts available: $availableCount / $($artifacts.Count)" -ForegroundColor $(if ($availableCount -gt 3) { 'Green' } else { 'Yellow' })

      - name: üìä Run Report Playbook (Consolidated Dashboard)
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üìä Generating Consolidated PR Dashboard" -ForegroundColor Cyan
          
          Invoke-OrchestrationSequence -LoadPlaybook pr-ecosystem-report

      - name: üìÅ Organize Reports for GitHub Pages
        shell: pwsh
        run: |
          $prDir = "./library/reports/pr-$env:PR_NUMBER"
          Write-Host "Creating PR-specific directory: $prDir" -ForegroundColor Cyan
          
          # Create PR directory
          New-Item -ItemType Directory -Path $prDir -Force | Out-Null
          
          # Copy library/reports content
          $sourceDir = "./library/reports"
          if (Test-Path $sourceDir) {
            Get-ChildItem -Path $sourceDir -Recurse -Exclude "pr-*" | ForEach-Object {
              $targetPath = $_.FullName.Replace($sourceDir, $prDir)
              
              if ($_.PSIsContainer) {
                if (-not (Test-Path $targetPath)) {
                  New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
                }
              } else {
                $targetDir = Split-Path $targetPath -Parent
                if (-not (Test-Path $targetDir)) {
                  New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
                }
                Copy-Item -Path $_.FullName -Destination $targetPath -Force
              }
            }
          }
          
          # Copy consolidated artifacts
          if (Test-Path "./artifacts") {
            $artifactsTarget = Join-Path $prDir "artifacts"
            Copy-Item -Path "./artifacts" -Destination $artifactsTarget -Recurse -Force
          }
          
          # Verify files were organized
          $copiedFiles = Get-ChildItem -Path $prDir -Recurse -File
          Write-Host "‚úÖ Organized $($copiedFiles.Count) files for deployment" -ForegroundColor Green

      - name: üìä Upload Complete PR Ecosystem Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-complete-report
          path: library/reports/pr-${{ env.PR_NUMBER }}/**
          retention-days: 30
          if-no-files-found: warn

      - name: üåê Deploy to GitHub Pages
        if: hashFiles('./library/reports/pr-${{ env.PR_NUMBER }}/**') != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./library/reports/pr-${{ env.PR_NUMBER }}
          destination_dir: pr-${{ env.PR_NUMBER }}
          keep_files: true
          enable_jekyll: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy PR #${{ env.PR_NUMBER }} ecosystem reports'

      - name: üí¨ Post Final Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const buildStatus = '${{ needs.build.outputs.build-status }}';
            const analyzeStatus = '${{ needs.analyze.outputs.analysis-status }}';
            
            const buildResult = '${{ needs.build.outputs.build-result }}';
            const analyzeResult = '${{ needs.analyze.outputs.analysis-result }}';
            
            const buildIcon = buildStatus === 'success' && buildResult === '0' ? '‚úÖ' : '‚ö†Ô∏è';
            const analyzeIcon = analyzeStatus === 'success' && analyzeResult === '0' ? '‚úÖ' : '‚ÑπÔ∏è';
            
            const pagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/pr-${context.issue.number}/`;
            
            const summary = `## üöÄ PR Ecosystem Complete
            
            ### Phase Results
            
            | Phase | Status | Result |
            |-------|--------|--------|
            | ${buildIcon} **Build** | ${buildStatus} | Exit Code: ${buildResult} |
            | ${analyzeIcon} **Analysis** | ${analyzeStatus} | Exit Code: ${analyzeResult} |
            
            ### Integration with Master Test Orchestration
            
            This workflow integrates with [Master Test Orchestration](../../actions/workflows/master-test-orchestration.yml) for:
            - ‚úÖ Comprehensive Validation
            - üß™ Test Execution
            - üîç Quality Analysis
            
            All test results are consolidated in the dashboard.
            
            ### üìä Dashboard & Reports
            
            **GitHub Pages:** [View PR Dashboard](${pagesUrl})
            
            ### Artifacts Available
            
            - üî® Build artifacts
            - üîç Analysis results
            - üß™ Test results (from Master Orchestration)
            - ‚úÖ Validation results (from Master Orchestration)
            - üìä Complete dashboard
            
            [View Full Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ---
            *PR Ecosystem integrated with centralized test execution*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });

      - name: üìù Create Job Summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          # üöÄ PR Ecosystem Summary
          
          ## Integration Status
          
          This workflow integrates with Master Test Orchestration for centralized test execution.
          
          ## Phase Results
          
          - üî® **Build**: ${{ needs.build.outputs.build-status }} (Exit: ${{ needs.build.outputs.build-result }})
          - üîç **Analysis**: ${{ needs.analyze.outputs.analysis-status }} (Exit: ${{ needs.analyze.outputs.analysis-result }})
          
          ## Consolidated Artifacts
          
          - Build artifacts (this workflow)
          - Analysis results (this workflow)
          - Test results (from Master Test Orchestration)
          - Validation results (from Master Test Orchestration)
          - Quality metrics (from Master Test Orchestration)
          - Complete dashboard (consolidated)
          
          ## Benefits
          
          ‚úÖ Single test execution (no duplicates)
          ‚úÖ Centralized result storage
          ‚úÖ Comprehensive dashboard generation
          ‚úÖ All workflows use playbooks
          "@
          
          $summary | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append

            library/reports/quality-*.json
            library/reports/security-*.json
            library/tests/results/**
            library/tests/coverage/**
          retention-days: 30
          if-no-files-found: warn

  report:
    name: üìä Report & Deploy
    needs: [build, analyze]
    runs-on: ubuntu-latest
    timeout-minutes: 10
    if: always()

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üì• Download Build Artifacts
        uses: actions/download-artifact@v4
        with:
          name: pr-${{ env.PR_NUMBER }}-build
          path: ./artifacts/build
        continue-on-error: true

      - name: üì• Download Analysis Artifacts
        uses: actions/download-artifact@v4
        with:
          name: pr-${{ env.PR_NUMBER }}-analysis
          path: ./artifacts/analysis
        continue-on-error: true

      - name: üîç Check Artifact Availability
        shell: pwsh
        run: |
          Write-Host "Checking artifact availability..." -ForegroundColor Cyan
          
          $buildAvailable = Test-Path "./artifacts/build"
          $analysisAvailable = Test-Path "./artifacts/analysis"
          
          Write-Host "Build artifacts: $buildAvailable" -ForegroundColor $(if ($buildAvailable) { 'Green' } else { 'Yellow' })
          Write-Host "Analysis artifacts: $analysisAvailable" -ForegroundColor $(if ($analysisAvailable) { 'Green' } else { 'Yellow' })
          
          # Set environment variables for report generation
          "BUILD_ARTIFACTS_AVAILABLE=$buildAvailable" | Out-File -FilePath $env:GITHUB_ENV -Append
          "ANALYSIS_ARTIFACTS_AVAILABLE=$analysisAvailable" | Out-File -FilePath $env:GITHUB_ENV -Append
          
          if (-not $buildAvailable -and -not $analysisAvailable) {
            Write-Host "‚ö†Ô∏è No artifacts available. Report will be generated with limited data." -ForegroundColor Yellow
          }

      - name: üìä Run Report Playbook
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          Invoke-OrchestrationSequence -LoadPlaybook pr-ecosystem-report

      - name: üìÅ Organize Reports for GitHub Pages
        shell: pwsh
        run: |
          $prDir = "./library/reports/pr-$env:PR_NUMBER"
          Write-Host "Creating PR-specific directory: $prDir" -ForegroundColor Cyan
          
          # Create PR directory
          New-Item -ItemType Directory -Path $prDir -Force | Out-Null
          
          # Copy all files and subdirectories from library/reports to PR directory
          # This ensures subdirectories like metrics-history/ and tech-debt/ are included
          $sourceDir = "./library/reports"
          
          # Get all files and directories, excluding the PR directories themselves
          Get-ChildItem -Path $sourceDir -Recurse -Exclude "pr-*" | ForEach-Object {
            $targetPath = $_.FullName.Replace($sourceDir, $prDir)
            
            if ($_.PSIsContainer) {
              # Create directory
              if (-not (Test-Path $targetPath)) {
                New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              }
            } else {
              # Copy file
              $targetDir = Split-Path $targetPath -Parent
              if (-not (Test-Path $targetDir)) {
                New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
              }
              Copy-Item -Path $_.FullName -Destination $targetPath -Force
            }
          }
          
          # Verify files were copied
          $copiedFiles = Get-ChildItem -Path $prDir -Recurse -File
          Write-Host "‚úì Organized $($copiedFiles.Count) files for GitHub Pages deployment" -ForegroundColor Green

      - name: üåê Deploy to GitHub Pages
        if: hashFiles('./library/reports/pr-${{ env.PR_NUMBER }}/**') != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./library/reports/pr-${{ env.PR_NUMBER }}
          destination_dir: pr-${{ env.PR_NUMBER }}
          keep_files: false

      - name: üí¨ Post PR Comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const commentPath = './library/reports/pr-comment.md';
            
            if (!fs.existsSync(commentPath)) {
              console.log('No PR comment generated');
              return;
            }
            
            const comment = fs.readFileSync(commentPath, 'utf8');
            
            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('üöÄ PR Ecosystem Status')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }

  container:
    name: üê≥ Build Container
    needs: [build, analyze]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: always()

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîê Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üèóÔ∏è Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üî§ Set Lowercase Repository Name
        id: repo-name
        run: |
          # Convert repository name to lowercase for Docker compatibility
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo-lower=${REPO_LOWER}" >> $GITHUB_OUTPUT
          echo "Using lowercase repository name: ${REPO_LOWER}"

      - name: üê≥ Build and Push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:pr-${{ env.PR_NUMBER }}-latest
            ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:pr-${{ env.PR_NUMBER }}-${{ github.sha }}
          platforms: linux/amd64,linux/arm64
          cache-from: type=gha
          cache-to: type=gha,mode=max
