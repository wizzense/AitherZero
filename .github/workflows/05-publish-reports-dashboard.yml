---
name: ðŸ“Š Publish Test Reports & Dashboard to GitHub Pages

# Publish comprehensive test reports, dashboards, and PR-specific status to GitHub Pages
# Integrates with test-execution.yml and generates navigable reports for each PR
on:
  workflow_run:
    workflows: ["ðŸ§ª Test Execution (Complete Suite)", "âœ… PR Validation (v2 - CLI)", "ðŸ” Quality Validation (v2 - CLI)", "ðŸš€ PR Complete Workflow"]
    types: [completed]
  push:
    branches: [main, dev, develop, dev-staging, ring-0, ring-0-integrations, ring-1, ring-1-integrations, ring-2]
    paths:
      - 'library/reports/**'
      - 'library/tests/results/**'
      - 'library/tests/coverage/**'
  # DO NOT add pull_request trigger here - it causes premature execution before tests run
  # This workflow should ONLY run after test-execution.yml completes via workflow_run trigger
  workflow_dispatch:
    inputs:
      force_publish:
        description: 'Force publish even if no changes detected'
        type: boolean
        default: true
      pr_number:
        description: 'PR number for PR-specific publishing (leave empty for main)'
        type: string
        required: false

permissions:
  contents: write
  pages: write
  id-token: write
  actions: read

concurrency:
  group: "pages-publish"
  cancel-in-progress: false

jobs:
  collect-reports:
    name: ðŸ“¥ Collect Test Reports and Generate Dashboard
    runs-on: ubuntu-latest
    timeout-minutes: 8

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.event.repository.default_branch }}
          fetch-depth: 0

      - name: ðŸ”§ Bootstrap Environment
        shell: pwsh
        run: |
          Write-Host "ðŸš€ Bootstrapping AitherZero environment..." -ForegroundColor Cyan
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal

      - name: ðŸ“Š Download Test Artifacts from test-execution.yml
        if: github.event.workflow_run
        uses: dawidd6/action-download-artifact@v6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          run_id: ${{ github.event.workflow_run.id }}
          path: ./downloaded-artifacts
          workflow: test-execution.yml
        continue-on-error: true

      - name: ðŸ“¦ Organize Test Results
        shell: pwsh
        run: |
          Write-Host "ðŸ“¦ Organizing test results from new test structure..." -ForegroundColor Cyan
          
          # Ensure directories exist
          New-Item -ItemType Directory -Path "library/tests/results" -Force | Out-Null
          New-Item -ItemType Directory -Path "library/tests/coverage" -Force | Out-Null
          New-Item -ItemType Directory -Path "library/reports" -Force | Out-Null
          
          # Copy downloaded artifacts to test results
          if (Test-Path "./downloaded-artifacts") {
            Write-Host "Copying test artifacts from test-execution.yml..." -ForegroundColor Yellow
            
            Get-ChildItem "./downloaded-artifacts" -Recurse -Filter "*.xml" | ForEach-Object {
              $destPath = Join-Path "library/tests/results" $_.Name
              Copy-Item $_.FullName -Destination $destPath -Force
              Write-Host "  âœ“ Test Result: $($_.Name)" -ForegroundColor Green
            }
            
            Get-ChildItem "./downloaded-artifacts" -Recurse -Filter "*.json" | ForEach-Object {
              $destPath = Join-Path "library/tests/results" $_.Name
              Copy-Item $_.FullName -Destination $destPath -Force
              Write-Host "  âœ“ Test Data: $($_.Name)" -ForegroundColor Green
            }
            
            # Copy coverage data
            Get-ChildItem "./downloaded-artifacts" -Recurse -Include "coverage*" | ForEach-Object {
              if ($_.PSIsContainer) {
                Copy-Item $_.FullName -Destination "library/tests/coverage" -Recurse -Force
              } else {
                Copy-Item $_.FullName -Destination "library/tests/coverage" -Force
              }
              Write-Host "  âœ“ Coverage: $($_.Name)" -ForegroundColor Green
            }
          }
          
          Write-Host "âœ… Test results organized" -ForegroundColor Green

      - name: ðŸ“Š Generate Dashboard with Modular Playbook
        shell: pwsh
        run: |
          Write-Host "ðŸ“Š Generating dashboard using modular playbook..." -ForegroundColor Cyan
          
          # Import AitherZero module
          Import-Module ./AitherZero.psd1 -Force -ErrorAction Stop
          
          # Use new modular dashboard generation playbook
          # This runs 5 metrics collectors in parallel, then generates HTML
          Invoke-AitherPlaybook -Name dashboard-generation-complete -ErrorAction Continue
          
          Write-Host "âœ… Dashboard generated successfully" -ForegroundColor Green

      - name: ðŸ·ï¸ Generate PR-Specific Dashboard with Container Info
        if: github.event.pull_request
        shell: pwsh
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BRANCH: ${{ github.event.pull_request.head.ref }}
          PR_BASE: ${{ github.event.pull_request.base.ref }}
          PR_STATE: ${{ github.event.pull_request.state }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        run: |
          Write-Host "ðŸ·ï¸ Generating PR-specific dashboard for PR #$env:PR_NUMBER..." -ForegroundColor Cyan
          
          $prDir = "library/reports/pr-$env:PR_NUMBER"
          New-Item -ItemType Directory -Path $prDir -Force | Out-Null
          
          # Copy main dashboard to PR-specific location
          if (Test-Path "library/reports/dashboard.html") {
            Copy-Item "library/reports/dashboard.html" "$prDir/dashboard.html" -Force
            Copy-Item "library/reports/dashboard.json" "$prDir/dashboard.json" -Force -ErrorAction SilentlyContinue
          }
          
          # Calculate Docker container info
          $dynamicPort = 8080 + ([int]$env:PR_NUMBER % 100)
          $imageNameLower = "$env:GITHUB_REPOSITORY".ToLower()
          $packageUrl = "https://github.com/$env:GITHUB_REPOSITORY/pkgs/container/aitherzero"
          $containerName = "aitherzero-pr-$env:PR_NUMBER"
          
          # Create PR-specific index with Docker container information using template
          $dynamicPort = 8080 + ([int]$env:PR_NUMBER % 100)
          $imageNameLower = "$env:GITHUB_REPOSITORY".ToLower()
          $packageUrl = "https://github.com/$env:GITHUB_REPOSITORY/pkgs/container/aitherzero"
          $containerName = "aitherzero-pr-$env:PR_NUMBER"
          
          # Load template and replace placeholders
          $templatePath = "./library/_templates/pr-dashboard-index.md"
          if (Test-Path $templatePath) {
            $prIndexContent = Get-Content $templatePath -Raw
            $replacements = @{
              '{{PR_NUMBER}}' = $env:PR_NUMBER
              '{{PR_TITLE}}' = $env:PR_TITLE
              '{{PR_BRANCH}}' = $env:PR_BRANCH
              '{{PR_BASE}}' = $env:PR_BASE
              '{{PR_STATE}}' = $env:PR_STATE
              '{{TIMESTAMP}}' = (Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
              '{{PACKAGE_URL}}' = $packageUrl
              '{{IMAGE_NAME_LOWER}}' = $imageNameLower
              '{{CONTAINER_NAME}}' = $containerName
              '{{DYNAMIC_PORT}}' = $dynamicPort
              '{{SERVER_URL}}' = $env:GITHUB_SERVER_URL
              '{{REPOSITORY}}' = $env:GITHUB_REPOSITORY
              '{{RUN_ID}}' = $env:GITHUB_RUN_ID
            }
            foreach ($key in $replacements.Keys) {
              $prIndexContent = $prIndexContent -replace [regex]::Escape($key), $replacements[$key]
            }
          } else {
            Write-Host "Template not found, using minimal content" -ForegroundColor Yellow
            $prIndexContent = "# PR Dashboard`n`nSee workflow run for details."
          }
          
          # Add test result summary if available
          $testResults = Get-ChildItem "library/tests/results" -Filter "*.xml" -ErrorAction SilentlyContinue | Sort-Object LastWriteTime -Descending | Select-Object -First 1
          if ($testResults) {
            try {
              [xml]$testXml = Get-Content $testResults.FullName
              $total = [int]$testXml.'test-results'.total
              $failures = [int]$testXml.'test-results'.failures
              $errors = [int]$testXml.'test-results'.errors
              $passed = $total - $failures - $errors
              $successRate = [math]::Round(($passed / $total) * 100, 1)
              
              $testSummary = "`n### Test Summary`n"
              $testSummary += "- âœ… **Passed:** $passed`n"
              $testSummary += "- âŒ **Failed:** $($failures + $errors)`n"
              $testSummary += "- ðŸ“Š **Total:** $total`n"
              $testSummary += "- ðŸŽ¯ **Success Rate:** $successRate%`n`n"
              $prIndexContent += $testSummary
            } catch {
              Write-Host "Could not parse test results" -ForegroundColor Yellow
            }
          }
          
          # Add deployment status section
          $deploymentSection = "`n---`n`n## ðŸš€ Deployment Status`n`n"
          $deploymentSection += "Check the [GitHub Actions workflow runs]($env:GITHUB_SERVER_URL/$env:GITHUB_REPOSITORY/actions) for:`n"
          $deploymentSection += "- âœ… **Container Build**: View build logs and container publishing status`n"
          $deploymentSection += "- âœ… **Test Execution**: See all test results and coverage`n"
          $deploymentSection += "- âœ… **Quality Validation**: Code quality and linting results`n`n"
          $deploymentSection += "### How to Test This PR`n`n"
          $deploymentSection += "1. **Pull the Docker image** (see commands above)`n"
          $deploymentSection += "2. **Run the container** with the provided command`n"
          $deploymentSection += "3. **Access the environment** at ``http://localhost:$dynamicPort```n"
          $deploymentSection += "4. **Review the dashboard** for metrics and test results`n`n"
          $deploymentSection += "---`n`n*ðŸ¤– Auto-generated dashboard for PR #$env:PR_NUMBER*`n"
          $prIndexContent += $deploymentSection
          
          $prIndexContent | Out-File -FilePath "$prDir/index.md" -Encoding UTF8
          
          Write-Host "âœ… PR #$env:PR_NUMBER dashboard created at $prDir" -ForegroundColor Green
          Write-Host "  - Container: $containerName" -ForegroundColor Cyan
          Write-Host "  - Port: $dynamicPort" -ForegroundColor Cyan
          Write-Host "  - Package: $packageUrl" -ForegroundColor Cyan

      - name: ðŸ“‘ Create Main Navigation Index
        shell: pwsh
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
        run: |
          Write-Host "ðŸ“‘ Creating main navigation index..." -ForegroundColor Cyan
          
          $timestamp = Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC'
          
          # Get all PR dashboards
          $prDirs = Get-ChildItem "library/reports" -Directory -Filter "pr-*" -ErrorAction SilentlyContinue | Sort-Object Name -Descending
          
          # Get latest release info from GitHub API or local VERSION file
          $latestRelease = "Unknown"
          $releaseUrl = "$env:GITHUB_SERVER_URL/$env:GITHUB_REPOSITORY/releases/latest"
          if (Test-Path "./VERSION") {
            $latestRelease = Get-Content "./VERSION" -Raw -ErrorAction SilentlyContinue
            if ($latestRelease) {
              $latestRelease = $latestRelease.Trim()
            }
          }
          
          # Calculate Docker container info
          $imageNameLower = "$env:GITHUB_REPOSITORY".ToLower()
          $packageUrl = "https://github.com/$env:GITHUB_REPOSITORY/pkgs/container/aitherzero"
          
          # Build main dashboard content without here-strings
          $indexContent = "# ðŸŽ¯ AitherZero Project Dashboard`n`n"
          $indexContent += "**Last Updated:** $timestamp`n`n"
          $indexContent += "## ðŸš€ Main Dashboard`n`n"
          $indexContent += "ðŸ“Š [**View Comprehensive Dashboard**](library/reports/dashboard.html) - Real-time project metrics, test results, and code quality`n`n"
          $indexContent += "---`n`n"
          $indexContent += "## ðŸ“¦ Latest Release`n`n"
          $indexContent += "- **Version:** $latestRelease`n"
          $indexContent += "- **Release Page:** [$releaseUrl]($releaseUrl)`n"
          $indexContent += "- **Packages:** [GitHub Releases]($env:GITHUB_SERVER_URL/$env:GITHUB_REPOSITORY/releases)`n`n"
          $indexContent += "### ðŸ³ Docker Images`n`n"
          $indexContent += "- **Latest Release:** ``ghcr.io/$imageNameLower:latest```n"
          $indexContent += "- **Version Tag:** ``ghcr.io/$imageNameLower:$latestRelease```n"
          $indexContent += "- **Package Registry:** [$packageUrl]($packageUrl)`n`n"
          $indexContent += "### ðŸ“¥ Quick Install`n`n"
          $indexContent += "````powershell`n"
          $indexContent += "# One-line install (PowerShell)`n"
          $indexContent += "iwr -useb https://raw.githubusercontent.com/$env:GITHUB_REPOSITORY/main/bootstrap.ps1 | iex`n`n"
          $indexContent += "# Docker`n"
          $indexContent += "docker pull ghcr.io/$imageNameLower:latest`n"
          $indexContent += "docker run -it --rm ghcr.io/$imageNameLower:latest`n"
          $indexContent += "```````n`n"
          $indexContent += "---`n`n"
          $indexContent += "## ðŸ“‹ Pull Request Dashboards`n`n"
          
          if ($prDirs.Count -gt 0) {
            foreach ($prDir in $prDirs) {
              $prNum = $prDir.Name -replace 'pr-', ''
              $prIndexPath = Join-Path $prDir.FullName "index.md"
              
              if (Test-Path $prIndexPath) {
                $prContent = Get-Content $prIndexPath -Raw
                if ($prContent -match 'Title:\*\* (.+)') {
                  $prTitle = $matches[1].Trim()
                } else {
                  $prTitle = "PR #$prNum"
                }
              } else {
                $prTitle = "PR #$prNum"
              }
              
              # Include Docker container info for each PR
              $prDynamicPort = 8080 + ([int]$prNum % 100)
              $indexContent += "- [PR #$prNum - $prTitle](library/reports/$($prDir.Name)/) ðŸ³ ``ghcr.io/$imageNameLower:pr-$prNum-latest`` (port: $prDynamicPort)`n"
            }
          } else {
            $indexContent += "*No open PRs with dashboards*`n"
          }
          
          # Add resources section without here-strings
          $indexContent += "`n---`n`n"
          $indexContent += "## ðŸ“š Additional Resources`n`n"
          $indexContent += "- [Test Reports](library/tests/results/) - Raw test execution data`n"
          $indexContent += "- [Coverage Reports](library/tests/coverage/) - Code coverage analysis`n"
          $indexContent += "- [Quality Metrics](library/reports/psscriptanalyzer-fast-results.json) - PSScriptAnalyzer results`n"
          $indexContent += "- [Project Reports](library/reports/) - All generated reports`n`n"
          $indexContent += "### ðŸ³ Container Registry`n`n"
          $indexContent += "All Docker containers are published to GitHub Container Registry:`n"
          $indexContent += "- **Main Package:** [$packageUrl]($packageUrl)`n"
          $indexContent += "- **Latest Release:** ``ghcr.io/$imageNameLower:latest```n"
          $indexContent += "- **PR Containers:** ``ghcr.io/$imageNameLower:pr-{number}-latest```n"
          $indexContent += "- **Version Tags:** ``ghcr.io/$imageNameLower:{version}```n`n"
          $indexContent += "### ðŸ“¦ Release Artifacts`n`n"
          $indexContent += "Each release includes:`n"
          $indexContent += "- âœ… **Platform Package** - AitherZero-v{version}.zip/tar.gz`n"
          $indexContent += "- âœ… **MCP Server** - @aitherzero/mcp-server@{version}`n"
          $indexContent += "- âœ… **Docker Images** - Multi-platform (amd64, arm64)`n"
          $indexContent += "- âœ… **Build Info** - Complete build metadata`n`n"
          $indexContent += "---`n`n"
          $indexContent += "## ðŸŽ“ Dashboard Guide`n`n"
          $indexContent += "### Health Scores`n"
          $indexContent += "- ðŸŸ¢ **90-100**: Excellent`n"
          $indexContent += "- ðŸŸ¡ **70-89**: Good`n"
          $indexContent += "- ðŸŸ  **50-69**: Needs Work`n"
          $indexContent += "- ðŸ”´ **0-49**: Urgent`n`n"
          $indexContent += "### Priority Actions`n"
          $indexContent += "1. Fix Critical/Error items`n"
          $indexContent += "2. Address failing tests`n"
          $indexContent += "3. Review warnings`n"
          $indexContent += "4. Plan new features`n`n"
          $indexContent += "---`n`n"
          $indexContent += "*Generated: $timestamp*`n"
          
          $indexContent | Out-File -FilePath "index.md" -Encoding UTF8
          
          Write-Host "âœ… Navigation index created" -ForegroundColor Green
          Write-Host "  - PRs tracked: $($prDirs.Count)" -ForegroundColor Cyan
          Write-Host "  - Latest release: $latestRelease" -ForegroundColor Cyan
          Write-Host "  - Container registry: $packageUrl" -ForegroundColor Cyan

      - name: ðŸ’¾ Commit Updated Reports
        if: github.event_name != 'pull_request'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Add reports and dashboards
          git add library/reports/dashboard.* library/reports/psscriptanalyzer-fast-results.json
          git add library/reports/pr-*/
          git add library/reports/README.md library/reports/index.md
          git add library/reports/metrics-history/*.json
          git add index.md
          
          # Commit if there are changes
          if ! git diff --staged --quiet; then
            git commit -m "chore: update dashboards and reports - $(date -u +"%Y-%m-%d %H:%M UTC") [skip ci]"
            git push origin HEAD:${{ github.ref_name }}
            echo "âœ… Reports committed and pushed"
          else
            echo "â„¹ï¸ No changes to reports"
          fi

      - name: ðŸ“¤ Upload Combined Reports
        uses: actions/upload-artifact@v4
        with:
          name: combined-reports
          path: |
            library/reports/
            library/tests/results/
            library/tests/coverage/
            index.md
            _config.yml
          retention-days: 30

  publish-to-pages:
    name: ðŸš€ Publish to GitHub Pages
    runs-on: ubuntu-latest
    needs: collect-reports
    timeout-minutes: 10

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ðŸ“Š Download Combined Reports
        uses: actions/download-artifact@v4
        with:
          name: combined-reports
          path: ./

      - name: ðŸ”§ Setup Pages
        uses: actions/configure-pages@v5

      - name: ðŸ—ï¸ Build with Jekyll
        uses: actions/jekyll-build-pages@v1
        with:
          source: ./
          destination: ./_site

      - name: ðŸ“¤ Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

      - name: ðŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: ðŸ“‹ Report Deployment
        shell: pwsh
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          Write-Host "âœ… Successfully deployed to GitHub Pages!" -ForegroundColor Green
          Write-Host "ðŸ”— Main URL: $env:PAGE_URL" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ðŸ“Š Available Dashboards:" -ForegroundColor Yellow
          Write-Host "  - Main Dashboard: ${env:PAGE_URL}library/reports/dashboard.html"
          Write-Host "  - Navigation Index: ${env:PAGE_URL}index.html"
          
          if ($env:PR_NUMBER) {
            Write-Host "  - PR #$env:PR_NUMBER Dashboard: ${env:PAGE_URL}library/reports/pr-$env:PR_NUMBER/"
          }
          
          Write-Host ""
          Write-Host "ðŸ“‚ All Reports: ${env:PAGE_URL}library/reports/"
          Write-Host "ðŸ§ª Test Results: ${env:PAGE_URL}library/tests/results/"
          Write-Host "ðŸ“ˆ Coverage: ${env:PAGE_URL}library/tests/coverage/"

      - name: ðŸ’¬ Comment on PR with Dashboard Link
        if: github.event.pull_request
        uses: actions/github-script@v7
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPOSITORY: ${{ github.repository }}
        with:
          script: |
            const fs = require('fs');
            const pageUrl = process.env.PAGE_URL;
            const prNumber = process.env.PR_NUMBER;
            const repository = process.env.REPOSITORY;
            
            // Calculate Docker container info
            const dynamicPort = 8080 + (parseInt(prNumber) % 100);
            const imageNameLower = repository.toLowerCase();
            const packageUrl = `https://github.com/${repository}/pkgs/container/aitherzero`;
            const containerName = `aitherzero-pr-${prNumber}`;
            
            // Load comment template and replace placeholders
            let comment = '';
            const templatePath = './library/_templates/pr-dashboard-comment.md';
            try {
              comment = fs.readFileSync(templatePath, 'utf8');
              const replacements = {
                '{{PAGE_URL}}': pageUrl,
                '{{PR_NUMBER}}': prNumber,
                '{{PACKAGE_URL}}': packageUrl,
                '{{IMAGE_NAME_LOWER}}': imageNameLower,
                '{{CONTAINER_NAME}}': containerName,
                '{{DYNAMIC_PORT}}': dynamicPort
              };
              for (const [key, value] of Object.entries(replacements)) {
                comment = comment.replaceAll(key, value);
              }
            } catch (error) {
              console.log('Template not found, using fallback');
              comment = `## Dashboard Published\n\nView your PR dashboard at: ${pageUrl}library/reports/pr-${prNumber}/`;
            }
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              c.body.includes('Dashboard & Container Published')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }
