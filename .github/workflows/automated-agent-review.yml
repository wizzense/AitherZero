---
name: ğŸ¤– Automated Agent Review

# Automatically review commits with custom agents and provide proactive feedback
on:
  push:
    branches:
      - '**'  # All branches
  pull_request:
    types: [synchronize]  # When new commits are pushed to a PR

permissions:
  contents: read
  pull-requests: write
  issues: write

concurrency:
  group: agent-review-${{ github.ref }}-${{ github.sha }}
  cancel-in-progress: false  # Let reviews complete

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true

jobs:
  # Check if this push is part of a PR
  check-pr-context:
    name: ğŸ” Check PR Context
    runs-on: ubuntu-latest
    outputs:
      is-pr: ${{ steps.check.outputs.is-pr }}
      pr-number: ${{ steps.check.outputs.pr-number }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: ğŸ” Check if Push is Part of PR
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');
            const sha = context.sha;
            
            console.log(`Checking if branch '${branch}' has an open PR...`);
            
            try {
              // Find PRs for this branch
              const { data: prs } = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                head: `${context.repo.owner}:${branch}`
              });
              
              if (prs.length > 0) {
                const pr = prs[0];
                console.log(`âœ… Found PR #${pr.number} for branch '${branch}'`);
                core.setOutput('is-pr', 'true');
                core.setOutput('pr-number', pr.number.toString());
                return pr.number;
              } else {
                console.log(`â„¹ï¸ No open PR found for branch '${branch}'`);
                core.setOutput('is-pr', 'false');
                core.setOutput('pr-number', '');
                return null;
              }
            } catch (error) {
              console.log(`âš ï¸ Error checking PR: ${error.message}`);
              core.setOutput('is-pr', 'false');
              core.setOutput('pr-number', '');
              return null;
            }

  # Analyze changes and determine which agents should review
  analyze-changes:
    name: ğŸ“Š Analyze Changes
    runs-on: ubuntu-latest
    needs: check-pr-context
    if: needs.check-pr-context.outputs.is-pr == 'true'
    outputs:
      agents-to-review: ${{ steps.analyze.outputs.agents-to-review }}
      change-summary: ${{ steps.analyze.outputs.change-summary }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need parent commit for diff
          
      - name: ğŸ“Š Analyze Changed Files
        id: analyze
        shell: pwsh
        run: |
          Write-Host "ğŸ“Š Analyzing changed files in commit..." -ForegroundColor Cyan
          
          # Get changed files in this commit
          $changedFiles = @(git diff --name-only HEAD~1 HEAD 2>/dev/null)
          
          if ($changedFiles.Count -eq 0) {
            Write-Host "No files changed in this commit" -ForegroundColor Yellow
            echo "agents-to-review=[]" >> $env:GITHUB_OUTPUT
            echo "change-summary=No files changed" >> $env:GITHUB_OUTPUT
            exit 0
          }
          
          Write-Host "Changed files: $($changedFiles.Count)" -ForegroundColor Cyan
          $changedFiles | ForEach-Object { Write-Host "  - $_" -ForegroundColor Gray }
          
          # Analyze file patterns and assign agents
          $agentScores = @{
            maya = 0        # Infrastructure
            sarah = 0       # Security
            jessica = 0     # Testing
            emma = 0        # UI/UX
            marcus = 0      # Backend
            olivia = 0      # Documentation
            rachel = 0      # PowerShell
            david = 0       # Project Management
          }
          
          $categoryFiles = @{
            Infrastructure = @()
            Security = @()
            Testing = @()
            UI = @()
            Backend = @()
            Documentation = @()
            PowerShell = @()
            ProjectMgmt = @()
          }
          
          foreach ($file in $changedFiles) {
            # Infrastructure
            if ($file -match 'infrastructure/|automation-scripts/01[0-9][0-9]|.*vm.*\.ps1|.*network.*\.ps1|.*hyperv.*\.ps1|\.(tf|tfvars)$') {
              $agentScores.maya += 3
              $categoryFiles.Infrastructure += $file
            }
            
            # Security
            if ($file -match 'domains/security/|.*security.*\.ps1|.*certificate.*\.ps1|.*credential.*\.ps1|.*secret.*\.ps1') {
              $agentScores.sarah += 3
              $categoryFiles.Security += $file
            }
            
            # Testing
            if ($file -match 'tests/|\.Tests\.ps1$|automation-scripts/04[0-9][0-9]') {
              $agentScores.jessica += 3
              $categoryFiles.Testing += $file
            }
            
            # UI
            if ($file -match 'domains/experience/|.*ui.*\.ps1|.*menu.*\.ps1|.*interface.*\.ps1|.*wizard.*\.ps1') {
              $agentScores.emma += 3
              $categoryFiles.UI += $file
            }
            
            # Backend
            if ($file -match 'domains/.*\.psm1$|automation-scripts/02[0-9][0-9]|.*api.*\.ps1|.*module.*\.ps1') {
              $agentScores.marcus += 3
              $categoryFiles.Backend += $file
            }
            
            # Documentation
            if ($file -match '\.md$|^docs/|automation-scripts/05[0-9][0-9]') {
              $agentScores.olivia += 3
              $categoryFiles.Documentation += $file
            }
            
            # PowerShell (applies to most .ps1/.psm1 files)
            if ($file -match '\.(ps1|psm1|psd1)$|orchestration/|automation-scripts/(00[0-9][0-9]|07[0-9][0-9]|9[0-9][0-9][0-9])') {
              $agentScores.rachel += 2
              $categoryFiles.PowerShell += $file
            }
            
            # Project Management
            if ($file -match '\.github/workflows/|roadmap\.md$|planning\.md$') {
              $agentScores.david += 3
              $categoryFiles.ProjectMgmt += $file
            }
          }
          
          # Select agents with score > 0, prioritize top scorers
          $selectedAgents = $agentScores.GetEnumerator() |
            Where-Object { $_.Value -gt 0 } |
            Sort-Object -Property Value -Descending |
            Select-Object -First 3 |
            Select-Object -ExpandProperty Key
          
          $agentsJson = $selectedAgents | ConvertTo-Json -Compress
          if ($null -eq $agentsJson) { $agentsJson = '[]' }
          
          Write-Host "Selected agents for review: $agentsJson" -ForegroundColor Green
          
          # Create change summary
          $summary = @()
          foreach ($category in $categoryFiles.Keys) {
            $files = $categoryFiles[$category]
            if ($files.Count -gt 0) {
              $summary += "${category}: $($files.Count) files"
            }
          }
          $summaryText = $summary -join ', '
          
          echo "agents-to-review=$agentsJson" >> $env:GITHUB_OUTPUT
          echo "change-summary=$summaryText" >> $env:GITHUB_OUTPUT
          
          Write-Host "Change summary: $summaryText" -ForegroundColor Cyan

  # Perform automated review with selected agents
  agent-review:
    name: ğŸ¤– Agent Review - ${{ matrix.agent }}
    runs-on: ubuntu-latest
    needs: [check-pr-context, analyze-changes]
    if: needs.analyze-changes.outputs.agents-to-review != '[]'
    strategy:
      matrix:
        agent: ${{ fromJson(needs.analyze-changes.outputs.agents-to-review) }}
      max-parallel: 3
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2
          
      - name: ğŸ”§ Bootstrap Environment
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Bootstrapping minimal environment..." -ForegroundColor Cyan
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal
          
      - name: ğŸ“¦ Install Analysis Tools
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing analysis tools..." -ForegroundColor Cyan
          if (-not (Get-Module -ListAvailable PSScriptAnalyzer)) {
            Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck -Scope CurrentUser
          }
          
      - name: ğŸ¤– Load Agent Profile
        id: load-agent
        shell: pwsh
        run: |
          $agentId = "${{ matrix.agent }}"
          Write-Host "ğŸ¤– Loading agent profile: $agentId" -ForegroundColor Cyan
          
          $agentInfo = switch ($agentId) {
            'maya' { @{ Name = 'Maya Infrastructure'; Role = 'Infrastructure & DevOps'; Icon = 'ğŸ—ï¸'; Focus = 'Infrastructure, VM management, networking, OpenTofu/Terraform' } }
            'sarah' { @{ Name = 'Sarah Security'; Role = 'Security & Compliance'; Icon = 'ğŸ”’'; Focus = 'Security, certificates, credentials, vulnerabilities' } }
            'jessica' { @{ Name = 'Jessica Testing'; Role = 'Testing & QA'; Icon = 'ğŸ§ª'; Focus = 'Test coverage, Pester tests, quality validation' } }
            'emma' { @{ Name = 'Emma Frontend'; Role = 'Frontend & UX'; Icon = 'ğŸ¨'; Focus = 'Console UI/UX, menus, accessibility' } }
            'marcus' { @{ Name = 'Marcus Backend'; Role = 'Backend & API'; Icon = 'âš™ï¸'; Focus = 'PowerShell modules, APIs, performance' } }
            'olivia' { @{ Name = 'Olivia Documentation'; Role = 'Documentation'; Icon = 'ğŸ“š'; Focus = 'Documentation, READMEs, guides' } }
            'rachel' { @{ Name = 'Rachel PowerShell'; Role = 'PowerShell Expert'; Icon = 'âš¡'; Focus = 'PowerShell best practices, automation, cross-platform' } }
            'david' { @{ Name = 'David ProjectManager'; Role = 'Project Management'; Icon = 'ğŸ“‹'; Focus = 'Planning, coordination, workflows' } }
          }
          
          echo "agent-name=$($agentInfo.Name)" >> $env:GITHUB_OUTPUT
          echo "agent-role=$($agentInfo.Role)" >> $env:GITHUB_OUTPUT
          echo "agent-icon=$($agentInfo.Icon)" >> $env:GITHUB_OUTPUT
          echo "agent-focus=$($agentInfo.Focus)" >> $env:GITHUB_OUTPUT
          
      - name: ğŸ” Perform Automated Review
        id: review
        shell: pwsh
        run: |
          $agentId = "${{ matrix.agent }}"
          Write-Host "ğŸ” Performing automated review as $agentId..." -ForegroundColor Cyan
          
          # Get changed files
          $changedFiles = @(git diff --name-only HEAD~1 HEAD)
          $relevantFiles = @()
          $issues = @()
          
          # Filter files relevant to this agent
          foreach ($file in $changedFiles) {
            $isRelevant = $false
            
            switch ($agentId) {
              'maya' {
                if ($file -match 'infrastructure/|automation-scripts/01[0-9][0-9]|.*vm.*\.ps1|.*network.*\.ps1|.*hyperv.*\.ps1|\.(tf|tfvars)$') {
                  $isRelevant = $true
                }
              }
              'sarah' {
                if ($file -match 'domains/security/|.*security.*\.ps1|.*certificate.*\.ps1|.*credential.*\.ps1|.*secret.*\.ps1') {
                  $isRelevant = $true
                }
              }
              'jessica' {
                if ($file -match 'tests/|\.Tests\.ps1$|automation-scripts/04[0-9][0-9]') {
                  $isRelevant = $true
                }
              }
              'emma' {
                if ($file -match 'domains/experience/|.*ui.*\.ps1|.*menu.*\.ps1|.*interface.*\.ps1|.*wizard.*\.ps1') {
                  $isRelevant = $true
                }
              }
              'marcus' {
                if ($file -match 'domains/.*\.psm1$|automation-scripts/02[0-9][0-9]|.*api.*\.ps1|.*module.*\.ps1') {
                  $isRelevant = $true
                }
              }
              'olivia' {
                if ($file -match '\.md$|^docs/|automation-scripts/05[0-9][0-9]') {
                  $isRelevant = $true
                }
              }
              'rachel' {
                if ($file -match '\.(ps1|psm1|psd1)$') {
                  $isRelevant = $true
                }
              }
              'david' {
                if ($file -match '\.github/workflows/|roadmap\.md$|planning\.md$') {
                  $isRelevant = $true
                }
              }
            }
            
            if ($isRelevant) {
              $relevantFiles += $file
            }
          }
          
          Write-Host "Relevant files for $agentId: $($relevantFiles.Count)" -ForegroundColor Cyan
          
          if ($relevantFiles.Count -eq 0) {
            Write-Host "No relevant files for this agent to review" -ForegroundColor Yellow
            echo "has-issues=false" >> $env:GITHUB_OUTPUT
            echo "issue-count=0" >> $env:GITHUB_OUTPUT
            exit 0
          }
          
          # Perform agent-specific checks
          foreach ($file in $relevantFiles) {
            if (-not (Test-Path $file)) {
              Write-Host "File deleted: $file" -ForegroundColor Yellow
              continue
            }
            
            # PowerShell-specific checks
            if ($file -match '\.(ps1|psm1)$') {
              # Run PSScriptAnalyzer
              try {
                $results = Invoke-ScriptAnalyzer -Path $file -Severity Warning,Error -ErrorAction SilentlyContinue
                
                foreach ($result in $results) {
                  $issues += @{
                    File = $file
                    Line = $result.Line
                    Severity = $result.Severity
                    Message = $result.Message
                    RuleName = $result.RuleName
                  }
                }
              } catch {
                Write-Host "Could not analyze $file : $_" -ForegroundColor Yellow
              }
              
              # Agent-specific checks
              $content = Get-Content $file -Raw -ErrorAction SilentlyContinue
              if ($content) {
                # Rachel - PowerShell best practices
                if ($agentId -eq 'rachel') {
                  if ($content -match 'Write-Host' -and $content -notmatch 'Write-CustomLog|Write-UIText') {
                    $issues += @{
                      File = $file
                      Line = 0
                      Severity = 'Information'
                      Message = 'Consider using Write-CustomLog or Write-UIText instead of Write-Host for better logging'
                      RuleName = 'CustomRule-PreferCustomLogging'
                    }
                  }
                  
                  if ($content -notmatch '#Requires -Version') {
                    $issues += @{
                      File = $file
                      Line = 1
                      Severity = 'Information'
                      Message = 'Consider adding #Requires -Version 7.0 to specify PowerShell version'
                      RuleName = 'CustomRule-RequiresVersion'
                    }
                  }
                }
                
                # Sarah - Security checks
                if ($agentId -eq 'sarah') {
                  if ($content -match 'ConvertTo-SecureString.*-AsPlainText') {
                    $issues += @{
                      File = $file
                      Line = 0
                      Severity = 'Warning'
                      Message = 'Avoid using -AsPlainText with ConvertTo-SecureString in production code. Use secure credential storage.'
                      RuleName = 'CustomRule-AvoidPlainTextSecureString'
                    }
                  }
                  
                  if ($content -match '\$env:.*password|\$env:.*secret|\$env:.*token' -and $content -notmatch 'GITHUB_TOKEN') {
                    $issues += @{
                      File = $file
                      Line = 0
                      Severity = 'Warning'
                      Message = 'Potential sensitive data in environment variables. Ensure proper secret management.'
                      RuleName = 'CustomRule-SensitiveEnvVars'
                    }
                  }
                }
                
                # Jessica - Testing checks
                if ($agentId -eq 'jessica') {
                  if ($file -match '\.ps1$' -and $file -notmatch '\.Tests\.ps1$' -and $file -match 'automation-scripts/') {
                    $testFile = $file -replace '\.ps1$', '.Tests.ps1'
                    if (-not (Test-Path "tests/**/$([System.IO.Path]::GetFileName($testFile))" -PathType Leaf)) {
                      $issues += @{
                        File = $file
                        Line = 0
                        Severity = 'Information'
                        Message = "Consider adding tests for this script. Auto-generate with: ./automation-scripts/0950_Generate-AllTests.ps1"
                        RuleName = 'CustomRule-MissingTests'
                      }
                    }
                  }
                }
                
                # Olivia - Documentation checks
                if ($agentId -eq 'olivia') {
                  if ($file -match '\.(ps1|psm1)$' -and $content -notmatch '\.SYNOPSIS|\.DESCRIPTION') {
                    $issues += @{
                      File = $file
                      Line = 1
                      Severity = 'Information'
                      Message = 'Add comment-based help (.SYNOPSIS, .DESCRIPTION, .PARAMETER, .EXAMPLE) for better documentation'
                      RuleName = 'CustomRule-MissingCommentHelp'
                    }
                  }
                }
              }
            }
            
            # Documentation checks
            if ($agentId -eq 'olivia' -and $file -match '\.md$') {
              $content = Get-Content $file -Raw -ErrorAction SilentlyContinue
              if ($content) {
                # Check for broken links
                $links = [regex]::Matches($content, '\[([^\]]+)\]\(([^\)]+)\)')
                foreach ($link in $links) {
                  $linkPath = $link.Groups[2].Value
                  if ($linkPath -notmatch '^https?://' -and $linkPath -notmatch '^#') {
                    # Relative link - check if file exists
                    $fullPath = Join-Path (Split-Path $file -Parent) $linkPath
                    if (-not (Test-Path $fullPath)) {
                      $issues += @{
                        File = $file
                        Line = 0
                        Severity = 'Warning'
                        Message = "Potential broken link: $linkPath"
                        RuleName = 'CustomRule-BrokenLink'
                      }
                    }
                  }
                }
              }
            }
          }
          
          Write-Host "Found $($issues.Count) issues" -ForegroundColor $(if ($issues.Count -eq 0) { 'Green' } else { 'Yellow' })
          
          # Save issues to file
          $issues | ConvertTo-Json -Depth 5 | Set-Content "./agent-review-$agentId.json"
          
          echo "has-issues=$($issues.Count -gt 0)" >> $env:GITHUB_OUTPUT
          echo "issue-count=$($issues.Count)" >> $env:GITHUB_OUTPUT
          echo "file-count=$($relevantFiles.Count)" >> $env:GITHUB_OUTPUT
          
      - name: ğŸ’¬ Post Review Comment
        if: steps.review.outputs.has-issues == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const agentId = '${{ matrix.agent }}';
            const agentName = '${{ steps.load-agent.outputs.agent-name }}';
            const agentRole = '${{ steps.load-agent.outputs.agent-role }}';
            const agentIcon = '${{ steps.load-agent.outputs.agent-icon }}';
            const agentFocus = '${{ steps.load-agent.outputs.agent-focus }}';
            const issueCount = '${{ steps.review.outputs.issue-count }}';
            const fileCount = '${{ steps.review.outputs.file-count }}';
            const commitSha = context.sha.substring(0, 7);
            const prNumber = ${{ needs.check-pr-context.outputs.pr-number }};
            
            // Load issues
            let issues = [];
            try {
              const issuesData = fs.readFileSync(`./agent-review-${agentId}.json`, 'utf8');
              issues = JSON.parse(issuesData);
            } catch (e) {
              console.log('No issues file found or error reading:', e);
            }
            
            if (issues.length === 0) {
              console.log('No issues to report');
              return;
            }
            
            // Build review comment
            let comment = `## ${agentIcon} Automated Review: ${agentName}\n\n`;
            comment += `**Commit:** \`${commitSha}\` â€¢ **Files Reviewed:** ${fileCount} â€¢ **Issues Found:** ${issueCount}\n\n`;
            comment += `**Focus Area:** ${agentFocus}\n\n`;
            comment += `---\n\n`;
            
            // Group issues by file
            const issuesByFile = {};
            for (const issue of issues) {
              if (!issuesByFile[issue.File]) {
                issuesByFile[issue.File] = [];
              }
              issuesByFile[issue.File].push(issue);
            }
            
            // Format issues by severity
            const criticalIssues = issues.filter(i => i.Severity === 'Error');
            const warnings = issues.filter(i => i.Severity === 'Warning');
            const suggestions = issues.filter(i => i.Severity === 'Information');
            
            if (criticalIssues.length > 0) {
              comment += `### ğŸš¨ Critical Issues (${criticalIssues.length})\n\n`;
              for (const issue of criticalIssues.slice(0, 5)) {
                comment += `- **\`${issue.File}\`** ${issue.Line > 0 ? `(Line ${issue.Line})` : ''}\n`;
                comment += `  - ${issue.Message}\n`;
                comment += `  - Rule: \`${issue.RuleName}\`\n\n`;
              }
              if (criticalIssues.length > 5) {
                comment += `*... and ${criticalIssues.length - 5} more critical issues*\n\n`;
              }
            }
            
            if (warnings.length > 0) {
              comment += `### âš ï¸ Warnings (${warnings.length})\n\n`;
              for (const issue of warnings.slice(0, 5)) {
                comment += `- **\`${issue.File}\`** ${issue.Line > 0 ? `(Line ${issue.Line})` : ''}\n`;
                comment += `  - ${issue.Message}\n`;
                comment += `  - Rule: \`${issue.RuleName}\`\n\n`;
              }
              if (warnings.length > 5) {
                comment += `*... and ${warnings.length - 5} more warnings*\n\n`;
              }
            }
            
            if (suggestions.length > 0) {
              comment += `### ğŸ’¡ Suggestions (${suggestions.length})\n\n`;
              for (const issue of suggestions.slice(0, 5)) {
                comment += `- **\`${issue.File}\`** ${issue.Line > 0 ? `(Line ${issue.Line})` : ''}\n`;
                comment += `  - ${issue.Message}\n`;
                comment += `  - Rule: \`${issue.RuleName}\`\n\n`;
              }
              if (suggestions.length > 5) {
                comment += `*... and ${suggestions.length - 5} more suggestions*\n\n`;
              }
            }
            
            comment += `---\n\n`;
            comment += `### ğŸ“‹ Next Steps\n\n`;
            comment += `1. **Review** the issues identified above\n`;
            comment += `2. **Address** critical issues and warnings\n`;
            comment += `3. **Consider** the suggestions for code quality improvements\n`;
            comment += `4. **Re-commit** - This review will run again automatically\n\n`;
            comment += `**Need help?** Tag me with \`@${agentId}\` in a comment for specific guidance on these issues.\n\n`;
            comment += `---\n`;
            comment += `*ğŸ¤– Automated review by ${agentName} â€¢ Powered by AitherZero agent system*\n`;
            
            // Post comment
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log(`âœ… Posted review comment for ${agentName}`);
            } catch (error) {
              console.log(`âŒ Error posting comment: ${error.message}`);
            }
            
      - name: âœ… Post Success Comment
        if: steps.review.outputs.has-issues == 'false' && steps.review.outputs.file-count != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const agentName = '${{ steps.load-agent.outputs.agent-name }}';
            const agentIcon = '${{ steps.load-agent.outputs.agent-icon }}';
            const fileCount = '${{ steps.review.outputs.file-count }}';
            const commitSha = context.sha.substring(0, 7);
            const prNumber = ${{ needs.check-pr-context.outputs.pr-number }};
            
            const comment = `## ${agentIcon} Automated Review: ${agentName}\n\n` +
              `**Commit:** \`${commitSha}\` â€¢ **Files Reviewed:** ${fileCount}\n\n` +
              `âœ… **No issues found!** The changes look good from my perspective.\n\n` +
              `---\n` +
              `*ğŸ¤– Automated review by ${agentName}*\n`;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log(`âœ… Posted success comment for ${agentName}`);
            } catch (error) {
              console.log(`âš ï¸ Error posting comment: ${error.message}`);
            }

  # Summary of all agent reviews
  review-summary:
    name: ğŸ“Š Review Summary
    runs-on: ubuntu-latest
    needs: [check-pr-context, analyze-changes, agent-review]
    if: always() && needs.check-pr-context.outputs.is-pr == 'true'
    
    steps:
      - name: ğŸ“Š Post Review Summary
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ needs.check-pr-context.outputs.pr-number }};
            const agentList = ${{ needs.analyze-changes.outputs.agents-to-review }};
            const changeSummary = '${{ needs.analyze-changes.outputs.change-summary }}';
            const commitSha = context.sha.substring(0, 7);
            
            if (!agentList || agentList.length === 0) {
              console.log('No agents performed reviews');
              return;
            }
            
            const agentNames = {
              maya: 'ğŸ—ï¸ Maya Infrastructure',
              sarah: 'ğŸ”’ Sarah Security',
              jessica: 'ğŸ§ª Jessica Testing',
              emma: 'ğŸ¨ Emma Frontend',
              marcus: 'âš™ï¸ Marcus Backend',
              olivia: 'ğŸ“š Olivia Documentation',
              rachel: 'âš¡ Rachel PowerShell',
              david: 'ğŸ“‹ David ProjectManager'
            };
            
            let comment = `## ğŸ“Š Automated Agent Review Summary\n\n`;
            comment += `**Commit:** \`${commitSha}\`\n\n`;
            comment += `**Changes:** ${changeSummary}\n\n`;
            comment += `**Agents Reviewed:**\n\n`;
            
            for (const agent of agentList) {
              comment += `- ${agentNames[agent] || agent}\n`;
            }
            
            comment += `\n---\n\n`;
            comment += `### ğŸ¯ How to Use This Feedback\n\n`;
            comment += `1. **Check individual agent comments** above for specific issues\n`;
            comment += `2. **Address critical issues** before merging\n`;
            comment += `3. **Consider suggestions** to improve code quality\n`;
            comment += `4. **Ask questions** by tagging agents (e.g., \`@maya\`, \`@sarah\`)\n\n`;
            comment += `**ğŸ’¡ Tip:** Agents will re-review automatically when you push new commits!\n\n`;
            comment += `---\n`;
            comment += `*ğŸ¤– Powered by AitherZero automated agent review system â€¢ [Learn more](.github/agents/README.md)*\n`;
            
            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
              console.log('âœ… Posted review summary');
            } catch (error) {
              console.log(`âš ï¸ Error posting summary: ${error.message}`);
            }
