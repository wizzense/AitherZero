---
name: ðŸš€ Deploy (Consolidated)

# Branch deployment workflow for main, dev, dev-staging, and ring branches
# Triggers on push events and builds complete deployment ecosystem:
#
# 1. Docker Image Build & Push (this workflow)
#    - Builds multi-platform images (amd64, arm64)
#    - Pushes to GitHub Container Registry (ghcr.io)
#    - Tags with branch name and commit SHA
#
# 2. Test Execution (03-test-execution.yml - triggers in parallel)
#    - Runs comprehensive test suite
#    - Generates test reports and coverage
#    - Validates code quality
#
# 3. Dashboard Publishing (05-publish-reports-dashboard.yml - after tests)
#    - Collects test results and metrics
#    - Generates interactive dashboard
#    - Publishes to branch-specific GitHub Pages path
#
# 4. GitHub Pages Deployment (09-jekyll-gh-pages.yml - on paths)
#    - Builds Jekyll site
#    - Deploys to branch-specific subdirectory
#    - Provides navigation and documentation
#
# Result: Every push gets Docker image, tests, reports, and GitHub Pages!

'on':
  push:
    branches:
      - main
      - dev
      - develop
      - dev-staging
      - ring-0
      - ring-0-integrations
      - ring-1
      - ring-1-integrations
      - ring-2

permissions:
  contents: write
  packages: write
  pages: write
  id-token: write
  deployments: write

# Branch-specific concurrency (NOT global lock)
concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: true

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true
  AITHERZERO_SUPPRESS_BANNER: true
  CONTAINER_REGISTRY: ghcr.io

jobs:
  # ============================================================================
  # BUILD-AND-PUSH-DOCKER: Build and push Docker images
  # ============================================================================
  build-and-push-docker:
    name: ðŸ³ Build & Push Docker
    runs-on: ubuntu-latest
    timeout-minutes: 30
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.CONTAINER_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”¤ Set Lowercase Repository Name
        id: repo-name
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo-lower=${REPO_LOWER}" >> $GITHUB_OUTPUT

      - name: ðŸ“‹ Extract Docker Metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.CONTAINER_REGISTRY }}/${{ steps.repo-name.outputs.repo-lower }}
          tags: |
            type=ref,event=branch
            type=sha,prefix=sha-
            type=raw,value=${{ github.ref_name }}
          labels: |
            org.opencontainers.image.title=AitherZero
            org.opencontainers.image.description=Enterprise infrastructure automation platform
            org.opencontainers.image.vendor=Aitherium Organization
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.revision=${{ github.sha }}

      - name: ðŸ”§ Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: ðŸ”§ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”¨ Build and Push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=0.0.0.0
            COMMIT_SHA=${{ github.sha }}

  # ============================================================================
  # DEPLOY-TO-STAGING: Deploy to real staging environment (if dev-staging)
  # ============================================================================
  deploy-to-staging:
    name: ðŸŽ¯ Deploy to Staging
    needs: build-and-push-docker
    if: github.ref == 'refs/heads/dev-staging'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    environment:
      name: staging
      url: https://staging.aitherzero.example.com

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy to Staging
        run: |
          echo "ðŸš€ Deploying to staging environment..."
          echo "Image: ${{ needs.build-and-push-docker.outputs.image-tag }}"
          echo "Digest: ${{ needs.build-and-push-docker.outputs.image-digest }}"
          
          # TODO: Add real deployment logic here (e.g., ECS, k8s, etc.)
          # For now, just verify the image exists
          docker pull $(echo "${{ needs.build-and-push-docker.outputs.image-tag }}" | head -n 1)
          
          echo "âœ… Staging deployment complete"

  # ============================================================================
  # PUBLISH-DASHBOARD: Dashboard publishing is handled by 09-jekyll-gh-pages.yml
  # This job is disabled to avoid GitHub Pages deployment conflicts
  # ============================================================================
  # NOTE: Dashboard generation and publishing moved to 09-jekyll-gh-pages.yml
  # to avoid conflicts with Jekyll-based GitHub Pages deployment

  # ============================================================================
  # SUMMARY: Deployment summary
  # ============================================================================
  summary:
    name: ðŸ“‹ Summary
    needs: [build-and-push-docker, deploy-to-staging]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine branch path for GitHub Pages
          BRANCH_PATH=""
          if [ "${{ github.ref_name }}" != "main" ]; then
            BRANCH_PATH="${{ github.ref_name }}/"
          fi
          
          echo "### ðŸ“¦ Docker Image" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.build-and-push-docker.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** \`$(echo "${{ needs.build-and-push-docker.outputs.image-tag }}" | head -n 1)\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Registry:** [GitHub Container Registry](https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ github.repository }} | cut -d/ -f2 | tr '[:upper:]' '[:lower:]'))" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ§ª Tests & Validation" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Execution:** Running in parallel workflow" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** [Test Execution (Complete Suite)](https://github.com/${{ github.repository }}/actions/workflows/03-test-execution.yml)" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Check workflow runs for latest results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ“Š Dashboard & Reports" >> $GITHUB_STEP_SUMMARY
          echo "- **Dashboard URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${BRANCH_PATH}" >> $GITHUB_STEP_SUMMARY
          echo "- **Reports URL:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${BRANCH_PATH}library/reports/" >> $GITHUB_STEP_SUMMARY
          echo "- **Publishing:** Handled by Jekyll workflow after test completion" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** [Jekyll GitHub Pages](https://github.com/${{ github.repository }}/actions/workflows/09-jekyll-gh-pages.yml)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸŽ¯ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ needs.deploy-to-staging.result || 'skipped (only for dev-staging branch)' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ”— Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Docker Registry](https://github.com/${{ github.repository }}/pkgs/container/$(echo ${{ github.repository }} | cut -d/ -f2 | tr '[:upper:]' '[:lower:]'))" >> $GITHUB_STEP_SUMMARY
          echo "- [GitHub Pages Dashboard](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${BRANCH_PATH})" >> $GITHUB_STEP_SUMMARY
          echo "- [All Workflow Runs](https://github.com/${{ github.repository }}/actions)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Complete build ecosystem includes: Docker image, test execution, reports dashboard, and GitHub Pages deployment.*" >> $GITHUB_STEP_SUMMARY
