name: üß† Intelligent CI/CD Pipeline
run-name: üîÑ CI/CD - ${{ github.event_name }} on ${{ github.ref_name }} by @${{ github.actor }}

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      force_full_run:
        description: 'Force full pipeline execution'
        required: false
        default: 'false'
        type: boolean

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1

jobs:
  change-detection:
    name: üîç Detect Changes
    runs-on: ubuntu-latest
    outputs:
      code-changed: ${{ steps.changes.outputs.code }}
      tests-changed: ${{ steps.changes.outputs.tests }}
      docs-changed: ${{ steps.changes.outputs.docs }}
      config-changed: ${{ steps.changes.outputs.config }}
      security-changed: ${{ steps.changes.outputs.security }}
      force-full: ${{ github.event.inputs.force_full_run == 'true' }}
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Analyze File Changes
        uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            code:
              - '**/*.ps1'
              - '**/*.psm1'
              - '**/*.psd1'
              - 'aither-core/**'
              - 'Start-AitherZero.ps1'
              - 'scripts/**'
            tests:
              - 'tests/**'
              - '**/*.Tests.ps1'
            docs:
              - '**/*.md'
              - 'docs/**'
            config:
              - 'configs/**'
              - '.github/workflows/**'
              - '*.json'
              - 'VERSION'
            security:
              - 'aither-core/modules/SecureCredentials/**'
              - 'aither-core/modules/RemoteConnection/**'
              - 'aither-core/modules/AIToolsIntegration/**'

  setup-environment:
    name: üõ†Ô∏è Setup Environment
    needs: change-detection
    if: needs.change-detection.outputs.code-changed == 'true' || needs.change-detection.outputs.config-changed == 'true' || needs.change-detection.outputs.force-full == 'true' || github.event_name == 'pull_request'
    
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
      fail-fast: false
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Install PowerShell 7 (Linux)
        if: runner.os == 'Linux'
        run: |
          # Download and install PowerShell 7
          wget -q https://github.com/PowerShell/PowerShell/releases/download/v7.4.1/powershell_7.4.1-1.deb_amd64.deb
          sudo dpkg -i powershell_7.4.1-1.deb_amd64.deb
          sudo apt-get install -f -y
        
      - name: Install PowerShell 7 (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install --cask powershell
        
      - name: Verify PowerShell Installation
        shell: pwsh
        run: |
          Write-Host "PowerShell Version Information:" -ForegroundColor Green
          $PSVersionTable | Format-Table -AutoSize
          
          if ($PSVersionTable.PSVersion.Major -lt 7) {
            throw "PowerShell 7 is required but version $($PSVersionTable.PSVersion) was found"
          }
          
          Write-Host "‚úÖ PowerShell 7+ confirmed on $($PSVersionTable.Platform)" -ForegroundColor Green
        
      - name: Cache PowerShell Modules
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/powershell/Modules
            ~/Documents/PowerShell/Modules
            /Users/runner/.local/share/powershell/Modules
          key: ps-modules-${{ runner.os }}-${{ hashFiles('**/*.psd1') }}
          restore-keys: |
            ps-modules-${{ runner.os }}-
        
      - name: Install Required PowerShell Modules
        shell: pwsh
        run: |
          Write-Host "Installing required PowerShell modules..." -ForegroundColor Yellow
          
          $modules = @('Pester', 'PSScriptAnalyzer')
          foreach ($module in $modules) {
            try {
              Write-Host "Installing $module..." -ForegroundColor Cyan
              Install-Module $module -Force -Scope CurrentUser -ErrorAction Stop
              Write-Host "‚úÖ $module installed successfully" -ForegroundColor Green
            } catch {
              Write-Error "‚ùå Failed to install $module : $_"
              throw
            }
          }

  security-analysis:
    name: üîí Security Analysis
    needs: [change-detection, setup-environment]
    if: needs.change-detection.outputs.code-changed == 'true' || needs.change-detection.outputs.security-changed == 'true' || needs.change-detection.outputs.force-full == 'true' || github.event_name == 'pull_request'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: PowerShell Script Analysis
        shell: pwsh
        run: |
          Write-Host "üîç Starting PowerShell Security Analysis..." -ForegroundColor Yellow
          
          # Install PSScriptAnalyzer
          Install-Module PSScriptAnalyzer -Force -Scope CurrentUser
          
          # Run comprehensive analysis
          $analysisResults = Invoke-ScriptAnalyzer -Path . -Recurse -ReportSummary -Settings PSGallery
          
          # Export results for summary
          $analysisResults | Export-Clixml -Path "security-analysis-results.xml"
          
          # Display summary
          Write-Host "`nüìä Analysis Summary:" -ForegroundColor Cyan
          $grouped = $analysisResults | Group-Object Severity
          foreach ($group in $grouped) {
            $color = switch ($group.Name) {
              'Error' { 'Red' }
              'Warning' { 'Yellow' }
              'Information' { 'Green' }
              default { 'White' }
            }
            Write-Host "  $($group.Name): $($group.Count) issues" -ForegroundColor $color
          }
          
          # Check for critical issues
          $criticalIssues = $analysisResults | Where-Object Severity -eq 'Error'
          if ($criticalIssues) {
            Write-Host "`n‚ùå Critical security issues found:" -ForegroundColor Red
            $criticalIssues | ForEach-Object {
              Write-Host "  ‚Ä¢ $($_.ScriptName):$($_.Line) - $($_.Message)" -ForegroundColor Red
            }
            Write-Error "Build failed due to critical security issues"
            exit 1
          } else {
            Write-Host "‚úÖ No critical security issues found" -ForegroundColor Green
          }
        
      - name: Upload Security Analysis Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-analysis-results-${{ github.run_number }}
          path: |
            security-analysis-results.xml
          retention-days: 30

  cross-platform-tests:
    name: üß™ Cross-Platform Tests
    needs: [change-detection, setup-environment]
    if: needs.change-detection.outputs.code-changed == 'true' || needs.change-detection.outputs.tests-changed == 'true' || needs.change-detection.outputs.force-full == 'true' || github.event_name == 'pull_request'
    
    strategy:
      matrix:
        os: [windows-latest, ubuntu-latest, macos-latest]
      fail-fast: false
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Setup PowerShell Modules Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.local/share/powershell/Modules
            ~/Documents/PowerShell/Modules
            /Users/runner/.local/share/powershell/Modules
          key: ps-modules-${{ runner.os }}-${{ hashFiles('**/*.psd1') }}
        
      - name: Run Enhanced Parallel Test Suite
        shell: pwsh
        run: |
          Write-Host "üöÄ Starting Enhanced Parallel Test Suite on $($PSVersionTable.Platform)..." -ForegroundColor Yellow
          
          # Set error handling
          $ErrorActionPreference = 'Stop'
          
          try {
            # Create platform-specific test results directory
            $testResultsDir = "TestResults-$($PSVersionTable.Platform.ToString().Replace(' ', ''))"
            New-Item -ItemType Directory -Path $testResultsDir -Force | Out-Null
            
            # Run enhanced production test suite with parallel execution
            ./tests/Run-ProductionTests.ps1 `
              -TestSuite Critical `
              -ReportLevel Detailed `
              -CI `
              -CreateIssues `
              -GenerateHTML `
              -ShowCoverage `
              -UploadArtifacts `
              -EnableParallel `
              -UseIntelligentThrottling `
              -OutputPath $testResultsDir
              
            Write-Host "‚úÖ Enhanced parallel test suite completed successfully on $($PSVersionTable.Platform)" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Enhanced parallel test suite failed on $($PSVersionTable.Platform): $_" -ForegroundColor Red
            
            # Even if tests fail, try to create an issue about the test execution failure
            try {
              Write-Host "Creating issue for test execution failure..." -ForegroundColor Yellow
              ./tests/Run-ProductionTests.ps1 `
                -TestSuite Critical `
                -CreateIssues `
                -OutputPath $testResultsDir `
                -DryRun:$false
            } catch {
              Write-Host "Failed to create test failure issue: $_" -ForegroundColor Red
            }
            
            throw
          }
        
      - name: Run Platform-Specific Tests
        shell: pwsh
        run: |
          Write-Host "üîß Running platform-specific tests..." -ForegroundColor Yellow
          
          # Create platform-specific test results directory
          $testResultsDir = "TestResults-$($PSVersionTable.Platform.ToString().Replace(' ', ''))"
          New-Item -ItemType Directory -Path $testResultsDir -Force | Out-Null
          
          try {
            if ($IsWindows) {
              Write-Host "Running Windows-specific tests..." -ForegroundColor Cyan
              # Test Windows-specific features like scheduled tasks, services
              ./tests/Test-WindowsFeatures.ps1 -OutputPath $testResultsDir
            } elseif ($IsLinux) {
              Write-Host "Running Linux-specific tests..." -ForegroundColor Cyan  
              # Test Linux-specific features like systemd, package managers
              ./tests/Test-LinuxFeatures.ps1 -OutputPath $testResultsDir
            } elseif ($IsMacOS) {
              Write-Host "Running macOS-specific tests..." -ForegroundColor Cyan
              # Test macOS-specific features like launchd, homebrew
              ./tests/Test-MacOSFeatures.ps1 -OutputPath $testResultsDir
            }
            
            Write-Host "‚úÖ Platform-specific tests completed" -ForegroundColor Green
          } catch {
            Write-Host "‚ö†Ô∏è Platform-specific tests encountered issues: $_" -ForegroundColor Yellow
            # Don't fail the build for platform-specific test issues
          }
        
      - name: Upload Test Results and Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}-${{ github.run_number }}
          path: |
            TestResults-*/*.xml
            TestResults-*/*.json
            TestResults-*/*.html
            TestResults-*/*.log
            TestResults-*/artifacts-*
          retention-days: 30
          
      - name: Generate Test Summary for PR
        if: github.event_name == 'pull_request'
        shell: pwsh
        run: |
          Write-Host "üìä Generating test summary for PR..." -ForegroundColor Yellow
          
          # Find the latest JSON report
          $testResultsDir = "TestResults-$($PSVersionTable.Platform.ToString().Replace(' ', ''))"
          $jsonReports = Get-ChildItem -Path $testResultsDir -Filter "*.json" | Sort-Object LastWriteTime -Descending
          
          if ($jsonReports.Count -gt 0) {
            $latestReport = $jsonReports[0]
            $reportData = Get-Content $latestReport.FullName | ConvertFrom-Json
            
            $summary = @"
          ## üß™ Test Results - $($PSVersionTable.Platform)
          
          | Metric | Value |
          |--------|--------|
          | Total Tests | $($reportData.Summary.TotalTests) |
          | Passed | $($reportData.Summary.PassedTests) ‚úÖ |
          | Failed | $($reportData.Summary.FailedTests) ‚ùå |
          | Pass Rate | $($reportData.Summary.PassRate)% |
          | Duration | $($reportData.Summary.Duration.Formatted) |
          
          $(if ($reportData.Summary.FailedTests -gt 0) {
            "### ‚ùå Failed Tests`n" + (($reportData.Failures | ForEach-Object { "- $($_.Name) ($($_.File):$($_.Line))" }) -join "`n") + "`n`n### üêõ GitHub Issues Created`n" + (($reportData.IssuesCreated | ForEach-Object { "- [Issue #$($_.IssueNumber)]($($_.IssueUrl)): $($_.Title)" }) -join "`n")
          } else {
            "### ‚úÖ All tests passed!"
          })
          
          [View detailed report](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          "@
            
            # Save summary for comment
            $summary | Out-File -FilePath "test-summary-$($PSVersionTable.Platform.ToString().Replace(' ', '')).md" -Encoding UTF8
          }

  performance-validation:
    name: ‚ö° Performance Validation
    needs: [change-detection, cross-platform-tests]
    if: needs.change-detection.outputs.code-changed == 'true' || needs.change-detection.outputs.force-full == 'true' || github.event_name == 'pull_request'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*-${{ github.run_number }}
          merge-multiple: true
        
      - name: Validate Parallel Execution Performance
        shell: pwsh
        run: |
          Write-Host "‚ö° Validating parallel execution performance improvements..." -ForegroundColor Yellow
          
          try {
            # Run performance validation
            ./tests/Validate-CompleteTestingInfrastructure.ps1 -ValidationScope Standard -TestParallelOptimization -GenerateReport
            
            # Extract performance metrics from test results
            $testResults = Get-ChildItem -Path "TestResults-*" -Filter "*.json" | ForEach-Object {
              Get-Content $_.FullName | ConvertFrom-Json
            }
            
            $performanceSummary = @()
            foreach ($result in $testResults) {
              if ($result.Summary.ParallelExecutionEnabled) {
                $performanceSummary += [PSCustomObject]@{
                  Platform = $result.Platform
                  TotalDuration = $result.Summary.Duration.TotalSeconds
                  ParallelThreadsUsed = $result.Summary.ParallelThreadsUsed
                  PerformanceImprovement = $result.Summary.PerformanceImprovement
                  ResourceUtilization = $result.Summary.ResourceUtilization
                }
              }
            }
            
            if ($performanceSummary.Count -gt 0) {
              Write-Host "`nüìä Parallel Execution Performance Summary:" -ForegroundColor Cyan
              $performanceSummary | Format-Table -AutoSize
              
              # Generate performance report
              $performanceReport = @"
              ## ‚ö° Parallel Execution Performance Report
              
              | Platform | Duration | Threads | Improvement | Resource Usage |
              |----------|----------|---------|-------------|----------------|
              $($performanceSummary | ForEach-Object {
                "| $($_.Platform) | $($_.TotalDuration)s | $($_.ParallelThreadsUsed) | $($_.PerformanceImprovement)% | $($_.ResourceUtilization)% |"
              } | Join-String -Separator "`n")
              
              ### üéØ Performance Targets Met:
              - ‚úÖ Target 60-80% improvement: $(if (($performanceSummary | Measure-Object -Property PerformanceImprovement -Average).Average -ge 60) { 'ACHIEVED' } else { 'NEEDS IMPROVEMENT' })
              - ‚úÖ Resource efficiency: $(if (($performanceSummary | Measure-Object -Property ResourceUtilization -Average).Average -le 80) { 'OPTIMAL' } else { 'HIGH USAGE' })
              "@
              
              $performanceReport | Out-File -FilePath "performance-summary.md" -Encoding UTF8
              Write-Host "‚úÖ Performance validation completed successfully" -ForegroundColor Green
            } else {
              Write-Host "‚ö†Ô∏è No parallel execution performance data found" -ForegroundColor Yellow
            }
          } catch {
            Write-Host "‚ùå Performance validation failed: $_" -ForegroundColor Red
            # Don't fail the build for performance validation issues
          }
        
      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report-${{ github.run_number }}
          path: |
            performance-summary.md
            tests/TestResults/validation-report.html
          retention-days: 30

  code-coverage-analysis:
    name: üìä Code Coverage Analysis  
    needs: [change-detection, cross-platform-tests, performance-validation]
    if: needs.change-detection.outputs.code-changed == 'true' || needs.change-detection.outputs.force-full == 'true' || github.event_name == 'pull_request'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*-${{ github.run_number }}
          merge-multiple: true
        
      - name: Generate Comprehensive Coverage Report
        shell: pwsh
        run: |
          Write-Host "üìà Generating comprehensive code coverage report..." -ForegroundColor Yellow
          
          # Install required modules
          Install-Module Pester -Force -Scope CurrentUser
          
          try {
            # Run code coverage analysis
            ./tests/Run-CodeCoverage.ps1 -GenerateReport -Platform All
            
            Write-Host "‚úÖ Code coverage analysis completed" -ForegroundColor Green
            
            # Display coverage summary if available
            if (Test-Path "coverage-summary.txt") {
              Write-Host "`nüìä Coverage Summary:" -ForegroundColor Cyan
              Get-Content "coverage-summary.txt"
            }
          } catch {
            Write-Host "‚ö†Ô∏è Code coverage analysis encountered issues: $_" -ForegroundColor Yellow
            # Create minimal coverage report
            Write-Output "Coverage analysis failed: $($_.Exception.Message)" | Out-File "coverage-error.txt"
          }
        
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report-${{ github.run_number }}
          path: |
            coverage*.xml
            coverage*.html
            coverage*.txt
          retention-days: 30
        
      - name: Upload to Codecov
        uses: codecov/codecov-action@v4
        if: hashFiles('coverage.xml') != ''
        continue-on-error: true
        with:
          file: ./coverage.xml
          flags: unittests
          name: aitherzero-coverage

  build-validation:
    name: üî® Build Validation
    needs: [change-detection, security-analysis]
    if: needs.change-detection.outputs.code-changed == 'true' || needs.change-detection.outputs.force-full == 'true' || github.event_name == 'pull_request'
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository  
        uses: actions/checkout@v4
        
      - name: Validate Module Manifests
        shell: pwsh
        run: |
          Write-Host "üîç Validating PowerShell module manifests..." -ForegroundColor Yellow
          
          $manifestErrors = @()
          $manifestFiles = Get-ChildItem -Path "aither-core/modules" -Filter "*.psd1" -Recurse
          
          foreach ($manifest in $manifestFiles) {
            try {
              Write-Host "Validating $($manifest.Name)..." -ForegroundColor Cyan
              $null = Test-ModuleManifest -Path $manifest.FullName -ErrorAction Stop
              Write-Host "  ‚úÖ Valid" -ForegroundColor Green
            } catch {
              $error = "‚ùå $($manifest.Name): $($_.Exception.Message)"
              $manifestErrors += $error
              Write-Host "  $error" -ForegroundColor Red
            }
          }
          
          if ($manifestErrors.Count -gt 0) {
            Write-Host "`n‚ùå Module manifest validation failed:" -ForegroundColor Red
            $manifestErrors | ForEach-Object { Write-Host "  $_" -ForegroundColor Red }
            throw "Module manifest validation failed"
          } else {
            Write-Host "‚úÖ All module manifests are valid" -ForegroundColor Green
          }
        
      - name: Quick Package Integrity Test
        shell: pwsh
        run: |
          Write-Host "üì¶ Testing package integrity..." -ForegroundColor Yellow
          
          try {
            # Test minimal profile package creation
            if (Test-Path "./scripts/Test-PackageIntegrity.ps1") {
              ./scripts/Test-PackageIntegrity.ps1 -Profile minimal
            } else {
              Write-Host "Package integrity test script not found, performing basic checks..." -ForegroundColor Yellow
              
              # Basic integrity checks
              $coreFiles = @(
                "Start-AitherZero.ps1",
                "aither-core/aither-core.ps1",
                "aither-core/shared/Find-ProjectRoot.ps1"
              )
              
              foreach ($file in $coreFiles) {
                if (-not (Test-Path $file)) {
                  throw "Critical file missing: $file"
                }
                Write-Host "  ‚úÖ $file" -ForegroundColor Green
              }
            }
            
            Write-Host "‚úÖ Package integrity validation completed" -ForegroundColor Green
          } catch {
            Write-Host "‚ùå Package integrity test failed: $_" -ForegroundColor Red
            throw
          }

  failure-summary:
    name: üìã Failure Summary
    needs: [change-detection, setup-environment, security-analysis, cross-platform-tests, performance-validation, code-coverage-analysis, build-validation]
    if: always()
    
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      - name: Collect Job Status Information
        run: |
          # Collect all job statuses
          cat << EOF >> job_status.txt
          Workflow Run: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Actor: ${{ github.actor }}
          Event: ${{ github.event_name }}
          
          Job Results:
          - Change Detection: ${{ needs.change-detection.result }}
          - Setup Environment: ${{ needs.setup-environment.result }}
          - Security Analysis: ${{ needs.security-analysis.result }}
          - Cross-Platform Tests: ${{ needs.cross-platform-tests.result }}
          - Performance Validation: ${{ needs.performance-validation.result }}
          - Code Coverage: ${{ needs.code-coverage-analysis.result }}
          - Build Validation: ${{ needs.build-validation.result }}
          
          Change Detection Results:
          - Code Changes: ${{ needs.change-detection.outputs.code-changed }}
          - Test Changes: ${{ needs.change-detection.outputs.tests-changed }}
          - Config Changes: ${{ needs.change-detection.outputs.config-changed }}
          - Security Changes: ${{ needs.change-detection.outputs.security-changed }}
          - Force Full: ${{ needs.change-detection.outputs.force-full }}
          EOF
          
          # Check for actual failures (not skipped jobs)
          if [[ "${{ contains(needs.*.result, 'failure') }}" == "true" ]]; then
            echo "WORKFLOW_FAILED=true" >> $GITHUB_ENV
            echo "FAILURE_REASON=job_failure" >> $GITHUB_ENV
          elif [[ "${{ needs.setup-environment.result }}" == "skipped" && "${{ needs.security-analysis.result }}" == "skipped" && "${{ needs.cross-platform-tests.result }}" == "skipped" ]]; then
            echo "WORKFLOW_SKIPPED=true" >> $GITHUB_ENV
            echo "SKIP_REASON=no_relevant_changes" >> $GITHUB_ENV
          else
            echo "WORKFLOW_SUCCESS=true" >> $GITHUB_ENV
          fi
        
      - name: Create Failure Summary Issue
        if: env.WORKFLOW_FAILED == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const failureDetails = fs.readFileSync('failure_details.txt', 'utf8');
            
            const title = `üö® CI/CD Pipeline Failure - Run #${context.runNumber}`;
            const body = `
            ## üö® Pipeline Failure Summary
            
            **Workflow**: ${context.workflow}  
            **Run Number**: #${context.runNumber}
            **Commit**: [\`${context.sha.substring(0, 7)}\`](${context.payload.repository.html_url}/commit/${context.sha})
            **Branch**: \`${context.ref.replace('refs/heads/', '')}\`
            **Triggered By**: @${context.actor}
            **Event**: ${context.eventName}
            
            ### üìä Job Results
            \`\`\`
            ${failureDetails}
            \`\`\`
            
            ### üîó Quick Actions
            - [View Workflow Run](${context.payload.repository.html_url}/actions/runs/${context.runId})
            - [View Failed Jobs](${context.payload.repository.html_url}/actions/runs/${context.runId}#summary)
            - [View Commit Details](${context.payload.repository.html_url}/commit/${context.sha})
            
            ### üõ†Ô∏è Troubleshooting Tips
            - Check the individual job logs for detailed error messages
            - Verify PowerShell 7 compatibility if setup-environment failed
            - Review security analysis results if security checks failed
            - Check test results artifacts for specific test failures
            
            ---
            *ü§ñ This issue was automatically created by the Intelligent CI/CD Pipeline*
            *Created: ${new Date().toISOString()}*
            `;
            
            // Check for existing open failure issues to avoid spam
            const existingIssues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'ci-failure,automated',
              per_page: 10
            });
            
            // Only create new issue if no recent failure issues exist
            const recentFailures = existingIssues.data.filter(issue => {
              const createdAt = new Date(issue.created_at);
              const dayAgo = new Date(Date.now() - 24 * 60 * 60 * 1000);
              return createdAt > dayAgo;
            });
            
            if (recentFailures.length === 0) {
              // Create new failure issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['ci-failure', 'automated', 'high-priority']
              });
              
              console.log('‚úÖ New failure summary issue created');
            } else {
              // Add comment to most recent failure issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentFailures[0].number,
                body: `## üîÑ Additional Failure - Run #${context.runNumber}\n\n${body}`
              });
              
              console.log('‚úÖ Updated existing failure issue with new failure details');
            }
        
      - name: Pipeline Summary
        run: |
          echo "üìä CI/CD Pipeline Summary"
          echo "========================="
          
          if [[ "$WORKFLOW_FAILED" == "true" ]]; then
            echo "‚ùå Pipeline completed with failures"
            echo "üìã Check the failure summary issue for details"
          elif [[ "$WORKFLOW_SKIPPED" == "true" ]]; then
            echo "‚è≠Ô∏è Pipeline jobs skipped due to no relevant changes detected"
            echo "üìä Smart change detection working correctly"
            echo "üìã Change Detection Results:"
            echo "  - Code Changes: ${{ needs.change-detection.outputs.code-changed }}"
            echo "  - Test Changes: ${{ needs.change-detection.outputs.tests-changed }}"
            echo "  - Config Changes: ${{ needs.change-detection.outputs.config-changed }}"
            echo "  - Security Changes: ${{ needs.change-detection.outputs.security-changed }}"
          elif [[ "$WORKFLOW_SUCCESS" == "true" ]]; then
            echo "‚úÖ All CI/CD pipeline jobs completed successfully!"
            echo "üìä Pipeline Statistics:"
            echo "  - Workflow: ${{ github.workflow }}"
            echo "  - Run: #${{ github.run_number }}"
            echo "  - Platform Coverage: Windows, Linux, macOS"
            echo "  - Security: ‚úÖ Passed"
            echo "  - Tests: ‚úÖ Passed"
            echo "  - Build: ‚úÖ Validated"
          fi