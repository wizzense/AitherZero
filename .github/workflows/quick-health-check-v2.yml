---
name: âš¡ Quick Health Check (v2 - CLI)

# Fast validation using CLI cmdlets - immediate feedback on all PRs
on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  checks: write

concurrency:
  group: quick-health-v2-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true
  AITHERZERO_SUPPRESS_BANNER: true

jobs:
  quick-check:
    name: âš¡ Quick Health Check
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Bootstrap Environment
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Bootstrapping AitherZero (minimal)..." -ForegroundColor Cyan
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal

      - name: ğŸ“¦ Load Module
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          Write-Host "âœ… AitherZero module loaded" -ForegroundColor Green

      - name: ğŸ” Detect Changed Files
        id: changes
        shell: pwsh
        run: |
          Write-Host "ğŸ” Detecting changed files..." -ForegroundColor Cyan
          
          # Get changed files
          $base = "${{ github.event.pull_request.base.sha || 'HEAD~1' }}"
          $head = "HEAD"
          
          $changedFiles = git diff --name-only $base...$head
          
          $psFiles = $changedFiles | Where-Object { $_ -match '\.(ps1|psm1|psd1)$' }
          $yamlFiles = $changedFiles | Where-Object { $_ -match '\.ya?ml$' }
          
          $hasPowerShell = $psFiles.Count -gt 0
          $hasYAML = $yamlFiles.Count -gt 0
          
          Write-Host "PowerShell files: $($psFiles.Count)" -ForegroundColor $(if ($hasPowerShell) { 'Yellow' } else { 'Gray' })
          Write-Host "YAML files: $($yamlFiles.Count)" -ForegroundColor $(if ($hasYAML) { 'Yellow' } else { 'Gray' })
          
          echo "has-powershell=$hasPowerShell" >> $env:GITHUB_OUTPUT
          echo "has-yaml=$hasYAML" >> $env:GITHUB_OUTPUT
          echo "ps-count=$($psFiles.Count)" >> $env:GITHUB_OUTPUT

      - name: âš¡ Syntax Validation (PowerShell)
        if: steps.changes.outputs.has-powershell == 'True'
        shell: pwsh
        run: |
          Write-Host "âš¡ Running syntax validation..." -ForegroundColor Cyan
          
          Import-Module ./AitherZero.psd1 -Force
          
          # Use Invoke-AitherScript cmdlet
          Invoke-AitherScript -Number 0407 -Variables @{ All = $true }
          
          $exitCode = if ($null -eq $LASTEXITCODE) { 0 } else { $LASTEXITCODE }
          if ($exitCode -ne 0) {
            Write-Host "âŒ Syntax validation failed" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "âœ… Syntax validation passed" -ForegroundColor Green

      - name: âš¡ YAML Validation
        if: steps.changes.outputs.has-yaml == 'True'
        shell: bash
        run: |
          echo "âš¡ Validating YAML files..."
          pip install -q yamllint pyyaml
          
          # Find changed YAML files
          for file in $(git diff --name-only ${{ github.event.pull_request.base.sha }}...HEAD | grep -E '\.ya?ml$'); do
            if [ -f "$file" ]; then
              echo "  Checking: $file"
              python3 -c "import yaml; yaml.safe_load(open('$file'))" || exit 1
            fi
          done
          
          echo "âœ… All YAML files valid"

      - name: ğŸ“Š Health Check Summary
        if: always()
        shell: pwsh
        run: |
          $hasPowerShell = "${{ steps.changes.outputs.has-powershell }}" -eq "True"
          $hasYAML = "${{ steps.changes.outputs.has-yaml }}" -eq "True"
          
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘              QUICK HEALTH CHECK COMPLETE (v2)                â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Checks performed:" -ForegroundColor White
          if ($hasPowerShell) {
            Write-Host "  âœ… PowerShell syntax validation" -ForegroundColor Green
          } else {
            Write-Host "  â­ï¸  PowerShell (no files changed)" -ForegroundColor Gray
          }
          if ($hasYAML) {
            Write-Host "  âœ… YAML syntax validation" -ForegroundColor Green
          } else {
            Write-Host "  â­ï¸  YAML (no files changed)" -ForegroundColor Gray
          }
          Write-Host ""
          Write-Host "Powered by AitherZeroCLI" -ForegroundColor DarkCyan
