---
name: ðŸŽ¯ PR Ecosystem Check (Consolidated)

'on':
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, dev, develop, dev-staging, ring-0, ring-0-integrations, ring-1, ring-1-integrations, ring-2]

permissions:
  contents: write
  checks: write
  pull-requests: write
  deployments: write
  packages: write
  id-token: write
  pages: write

concurrency:
  group: pr-ecosystem-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true
  AITHERZERO_SUPPRESS_BANNER: true

jobs:
  pr-ecosystem-check:
    name: ðŸš€ PR Ecosystem (Build, Analyze, Report)
    runs-on: ubuntu-latest
    timeout-minutes: 45

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          # Fetch depth 0 is required for changelog and diff analysis
          fetch-depth: 0

      - name: ðŸ”§ Bootstrap Environment
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal

      - name: ðŸš€ Run PR Ecosystem Playbook
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          # Define variables to pass to the playbook
          $playbookVars = @{
              PR_NUMBER = "${{ github.event.pull_request.number }}"
              GITHUB_BASE_REF = "${{ github.base_ref }}"
              GITHUB_HEAD_REF = "${{ github.head_ref }}"
              GITHUB_REPOSITORY = "${{ github.repository }}"
              GITHUB_SHA = "${{ github.sha }}"
              GITHUB_RUN_NUMBER = "${{ github.run_number }}"
              DOCKER_REGISTRY = "ghcr.io"
              DOCKER_IMAGE_TAG = "pr-${{ github.event.pull_request.number }}"
              PAGES_URL = "https://wizzense.github.io/AitherZero/"
          }
          
          # Execute the master playbook
          # This single command runs all phases: Build, Analyze, and Report
          Invoke-AitherPlaybook -Name pr-ecosystem-complete -Variables $playbookVars -ThrowOnError

      - name: ðŸ“Š Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            library/tests/results/**/*.xml
          check_name: 'Test Results (from Playbook)'
          comment_mode: off # The playbook generates its own comment

      - name: ðŸš€ Trigger Jekyll Deployment
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: '09-jekyll-gh-pages.yml',
              ref: '${{ github.head_ref }}',
              inputs: {
                triggered_by: 'pr-ecosystem-check',
                pr_number: '${{ github.event.pull_request.number }}',
                reports_run_id: context.runId.toString()
              }
            });
            console.log('[OK] Jekyll deployment workflow triggered successfully!');

      - name: ðŸ’¬ Post Summary Comment
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const prNumber = ${{ github.event.pull_request.number }};
            
            // Read the comment content generated by the playbook
            const commentPath = './library/reports/pr-comment.md';
            let commentBody;
            
            if (fs.existsSync(commentPath)) {
              commentBody = fs.readFileSync(commentPath, 'utf8');
            } else {
              commentBody = `## âŒ PR Ecosystem Check Failed
              
              The workflow failed to generate a summary comment.
              Please check the [workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId}) for details.
              
              **Status:** ${{ job.status }}
              `;
            }
            
            // Find and update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const botComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('<!-- PR_ECOSYSTEM_CHECK -->')
            );
            
            // Add a hidden marker to the comment
            commentBody += '\n<!-- PR_ECOSYSTEM_CHECK -->';
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: commentBody
              });
            }
