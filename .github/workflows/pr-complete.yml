---
name: üöÄ PR Complete Workflow

# Complete PR workflow that orchestrates all validation, testing, building, and reporting
# Triggers directly on PR events AND can be called by master-ci-cd.yml orchestrator

on:
  # Direct PR triggers for immediate execution
  pull_request:
    branches: [main, dev, dev-staging]
    types: [opened, synchronize, reopened, ready_for_review]
  
  # Reusable workflow call (for orchestration)
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull Request number'
        required: false
        type: string
    secrets:
      inherit

permissions:
  contents: write
  pull-requests: write
  packages: write
  pages: write
  id-token: write
  checks: write
  statuses: write
  actions: read

concurrency:
  group: pr-complete-${{ inputs.pr_number || github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
  AITHERZERO_SUPPRESS_BANNER: true

jobs:
  # ============================================================================
  # PHASE 1: Quick Validation (Fast Feedback)
  # ============================================================================
  
  quick-validation:
    name: ‚ö° Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      status: ${{ steps.validate.outcome }}
      
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üí¨ Post Start Status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'üöÄ **PR Complete Workflow Started**\n\n**Phase 1:** ‚ö° Quick Validation\n- Syntax check\n- Config validation\n- Manifest validation'
            });

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: ‚ö° Quick Validation (Syntax + Config + Manifests)
        id: validate
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "‚ö° Running Quick Validation" -ForegroundColor Cyan
          
          # Run critical validation scripts
          $scripts = @('0407', '0413', '0405')
          $failed = @()
          
          foreach ($script in $scripts) {
            Write-Host "`nRunning $script..." -ForegroundColor Yellow
            $result = & "./library/automation-scripts/${script}*.ps1"
            if ($LASTEXITCODE -ne 0) {
              $failed += $script
            }
          }
          
          if ($failed.Count -gt 0) {
            Write-Host "‚ùå Quick validation failed: $($failed -join ', ')" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "‚úÖ Quick validation passed" -ForegroundColor Green

      - name: üí¨ Post Validation Result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.validate.outcome }}';
            const icon = status === 'success' ? '‚úÖ' : '‚ùå';
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Quick Validation ${status === 'success' ? 'PASSED' : 'FAILED'}**`
            });

  # ============================================================================
  # PHASE 2: Comprehensive Testing (Matrix-Based)
  # ============================================================================
  
  test-matrix-prepare:
    name: üéØ Prepare Test Matrix
    needs: quick-validation
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      unit-ranges: ${{ steps.matrix.outputs.unit-ranges }}
      domain-modules: ${{ steps.matrix.outputs.domain-modules }}
      integration-suites: ${{ steps.matrix.outputs.integration-suites }}
      should-run-unit: ${{ steps.matrix.outputs.should-run-unit }}
      should-run-domain: ${{ steps.matrix.outputs.should-run-domain }}
      should-run-integration: ${{ steps.matrix.outputs.should-run-integration }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üí¨ Post Test Prep Status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Phase 2:** üß™ Comprehensive Testing Started\n\nPreparing test matrix for parallel execution...'
            });

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üéØ Generate Test Matrix
        id: matrix
        shell: pwsh
        run: |
          Write-Host "üéØ Generating comprehensive test matrix" -ForegroundColor Cyan
          
          $unitRanges = @(
            '0000-0099', '0100-0199', '0200-0299', '0300-0399',
            '0400-0499', '0500-0599', '0700-0799', '0800-0899', '0900-0999'
          )
          
          $domainModules = @(
            'configuration', 'documentation', 'infrastructure',
            'security', 'testing', 'utilities'
          )
          
          $integrationSuites = @(
            'automation-scripts', 'orchestration', 'bootstrap', 'modules'
          )
          
          "unit-ranges=$($unitRanges | ConvertTo-Json -Compress)" >> $env:GITHUB_OUTPUT
          "domain-modules=$($domainModules | ConvertTo-Json -Compress)" >> $env:GITHUB_OUTPUT
          "integration-suites=$($integrationSuites | ConvertTo-Json -Compress)" >> $env:GITHUB_OUTPUT
          "should-run-unit=True" >> $env:GITHUB_OUTPUT
          "should-run-domain=True" >> $env:GITHUB_OUTPUT
          "should-run-integration=True" >> $env:GITHUB_OUTPUT
          
          Write-Host "‚úÖ Matrix generated: $($unitRanges.Count) unit ranges, $($domainModules.Count) domains, $($integrationSuites.Count) integration suites" -ForegroundColor Green

  unit-tests:
    name: üß™ Unit [${{ matrix.range }}]
    needs: test-matrix-prepare
    if: needs.test-matrix-prepare.outputs.should-run-unit == 'True'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 9
      matrix:
        range: ${{ fromJson(needs.test-matrix-prepare.outputs.unit-ranges) }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üß™ Run Unit Tests [${{ matrix.range }}]
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üß™ Running unit tests for range: ${{ matrix.range }}" -ForegroundColor Cyan
          
          $testsPath = "library/tests/unit/automation-scripts/${{ matrix.range }}"
          if (Test-Path $testsPath) {
            Invoke-Pester -Path $testsPath -Output Detailed -CI
          } else {
            Write-Host "‚ö†Ô∏è No tests found for range ${{ matrix.range }}" -ForegroundColor Yellow
          }

      - name: üìä Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-${{ matrix.range }}
          path: library/tests/results/**
          retention-days: 30
          if-no-files-found: warn

  domain-tests:
    name: üîß Domain [${{ matrix.module }}]
    needs: test-matrix-prepare
    if: needs.test-matrix-prepare.outputs.should-run-domain == 'True'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 6
      matrix:
        module: ${{ fromJson(needs.test-matrix-prepare.outputs.domain-modules) }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üîß Run Domain Tests [${{ matrix.module }}]
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üîß Running domain tests for: ${{ matrix.module }}" -ForegroundColor Cyan
          
          $testsPath = "library/tests/aithercore/${{ matrix.module }}"
          if (Test-Path $testsPath) {
            Invoke-Pester -Path $testsPath -Output Detailed -CI
          } else {
            Write-Host "‚ö†Ô∏è No tests found for domain ${{ matrix.module }}" -ForegroundColor Yellow
          }

      - name: üìä Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: domain-test-results-${{ matrix.module }}
          path: library/tests/results/**
          retention-days: 30
          if-no-files-found: warn

  integration-tests:
    name: üîó Integration [${{ matrix.suite }}]
    needs: test-matrix-prepare
    if: needs.test-matrix-prepare.outputs.should-run-integration == 'True'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    continue-on-error: true

    strategy:
      fail-fast: false
      max-parallel: 4
      matrix:
        suite: ${{ fromJson(needs.test-matrix-prepare.outputs.integration-suites) }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üîó Run Integration Tests [${{ matrix.suite }}]
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üîó Running integration tests for: ${{ matrix.suite }}" -ForegroundColor Cyan
          
          $testsPath = "library/tests/integration/${{ matrix.suite }}"
          if (Test-Path $testsPath) {
            Invoke-Pester -Path $testsPath -Output Detailed -CI
          } else {
            Write-Host "‚ö†Ô∏è No tests found for suite ${{ matrix.suite }}" -ForegroundColor Yellow
          }

      - name: üìä Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-results-${{ matrix.suite }}
          path: library/tests/results/**
          retention-days: 30
          if-no-files-found: warn

  test-summary:
    name: üìä Test Summary
    needs: [unit-tests, domain-tests, integration-tests]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: üí¨ Post Test Summary
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '‚úÖ **Comprehensive Testing Complete**\n\n- Unit tests: Completed\n- Domain tests: Completed\n- Integration tests: Completed\n\n*All test results uploaded as artifacts*'
            });

  # ============================================================================
  # PHASE 3: Build & Package
  # ============================================================================
  
  build:
    name: üî® Build & Package
    needs: test-summary
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.build.outcome }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üí¨ Post Build Start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Phase 3:** üî® Build & Package Started'
            });

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üî® Run Build Playbook
        id: build
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          Invoke-AitherPlaybook -Name pr-ecosystem-build

      - name: üì¶ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-build
          path: |
            library/reports/build-*.json
            library/reports/build-*.md
            AitherZero-*.zip
            AitherZero-*.tar.gz
          retention-days: 30
          if-no-files-found: warn

      - name: üí¨ Post Build Result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.build.outcome }}';
            const icon = status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Build & Package ${status === 'success' ? 'PASSED' : 'COMPLETED WITH ISSUES'}**`
            });

  # ============================================================================
  # PHASE 3B: Docker Container Build (Parallel with Quality Analysis)
  # ============================================================================
  
  build-docker-image:
    name: üê≥ Build PR Docker Image
    needs: build
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      status: ${{ steps.docker-build.outcome }}
      image-tag: ${{ steps.docker-meta.outputs.tags }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üí¨ Post Docker Build Start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Phase 3B:** üê≥ Docker Container Build Started'
            });

      - name: üê≥ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üîê Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: üî§ Set Lowercase Repository Name
        id: repo-name
        run: |
          REPO_LOWER=$(echo "${{ github.repository }}" | tr '[:upper:]' '[:lower:]')
          echo "repo-lower=${REPO_LOWER}" >> $GITHUB_OUTPUT
          echo "Using lowercase repository name: ${REPO_LOWER}"

      - name: üìã Extract Docker Metadata
        id: docker-meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ steps.repo-name.outputs.repo-lower }}
          tags: |
            type=raw,value=pr-${{ env.PR_NUMBER }}
            type=raw,value=pr-${{ env.PR_NUMBER }}-${{ github.sha }}
            type=ref,event=pr
          labels: |
            org.opencontainers.image.title=AitherZero (PR #${{ env.PR_NUMBER }})
            org.opencontainers.image.description=Enterprise infrastructure automation platform with AI-powered orchestration. Provides PowerShell-based automation for infrastructure deployment, testing, and management across Windows, Linux, and macOS. (PR build)
            org.opencontainers.image.vendor=Aitherium Organization
            org.opencontainers.image.authors=wizzense
            org.opencontainers.image.url=https://github.com/wizzense/AitherZero
            org.opencontainers.image.documentation=https://github.com/wizzense/AitherZero/blob/main/README.md
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.licenses=MIT
            org.opencontainers.image.revision=${{ github.sha }}
            com.aitherzero.pr.number=${{ env.PR_NUMBER }}
            com.aitherzero.build.type=pr

      - name: üî® Build and Push Docker Image
        id: docker-build
        uses: docker/build-push-action@v5
        continue-on-error: true
        with:
          context: .
          file: ./Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.docker-meta.outputs.tags }}
          labels: ${{ steps.docker-meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            VERSION=pr-${{ env.PR_NUMBER }}
            BUILD_DATE=${{ github.event.repository.updated_at }}
            VCS_REF=${{ github.sha }}

      - name: üß™ Test Docker Image
        if: steps.docker-build.outcome == 'success'
        shell: bash
        run: |
          echo "üß™ Testing Docker image..."
          IMAGE_TAG="ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:pr-${{ env.PR_NUMBER }}"
          
          docker run --rm ${IMAGE_TAG} pwsh -NoProfile -Command "
            Write-Host '‚úÖ Container started' -ForegroundColor Green;
            if (Test-Path /opt/aitherzero/AitherZero.psd1) {
              Write-Host '‚úÖ Module manifest found' -ForegroundColor Green;
            } else {
              Write-Error '‚ùå Module manifest not found';
              exit 1;
            }
          "
          
          echo "‚úÖ Docker image test passed"

      - name: üí¨ Post Docker Build Result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.docker-build.outcome }}';
            const icon = status === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            const imageTag = 'ghcr.io/${{ steps.repo-name.outputs.repo-lower }}:pr-${{ env.PR_NUMBER }}';
            let body = `${icon} **Docker Container Build ${status === 'success' ? 'PASSED' : 'COMPLETED WITH ISSUES'}**\n\n`;
            
            if (status === 'success') {
              body += `**Docker Image:** \`${imageTag}\`\n\n`;
              body += '**Quick Test:**\n';
              body += '```bash\n';
              body += `docker pull ${imageTag}\n`;
              body += `docker run -it --rm ${imageTag}\n`;
              body += '```';
            }
            
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ============================================================================
  # PHASE 4: Quality Analysis
  # ============================================================================
  
  quality-analysis:
    name: üîç Quality Analysis
    needs: quick-validation
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.quality.outcome }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üí¨ Post Quality Start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Phase 4:** üîç Quality Analysis Started\n\n- PSScriptAnalyzer\n- Component Quality\n- Security Scan'
            });

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üîç Run Quality Analysis
        id: quality
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üîç Running PSScriptAnalyzer" -ForegroundColor Cyan
          & "./library/automation-scripts/0404*.ps1" -UseCache
          
          Write-Host "üîç Running Component Quality Check" -ForegroundColor Cyan
          & "./library/automation-scripts/0420*.ps1" -Path "./aithercore" -Recursive

      - name: üìä Upload Quality Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-quality
          path: |
            library/tests/analysis/**
            library/reports/quality-*.json
          retention-days: 30
          if-no-files-found: warn

      - name: üí¨ Post Quality Result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.quality.outcome }}';
            const icon = status === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Quality Analysis ${status === 'success' ? 'PASSED' : 'COMPLETED'}**`
            });

  # ============================================================================
  # PHASE 5: Dashboard Generation & Deployment
  # ============================================================================
  
  dashboard:
    name: üìä Dashboard & Deploy
    needs: [test-summary, build, build-docker-image, quality-analysis]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üí¨ Post Dashboard Start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Phase 5:** üìä Dashboard Generation Started\n\nConsolidating all results...'
            });

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üì• Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
        continue-on-error: true

      - name: üìä Generate Consolidated Dashboard
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üìä Generating Consolidated Dashboard" -ForegroundColor Cyan
          
          # Run report playbook
          Invoke-AitherPlaybook -Name pr-ecosystem-report
          
          # Organize for GitHub Pages
          $prDir = "./library/reports/pr-$env:PR_NUMBER"
          New-Item -ItemType Directory -Path $prDir -Force | Out-Null
          
          # Copy reports
          if (Test-Path "./library/reports") {
            Get-ChildItem -Path "./library/reports" -Recurse -Exclude "pr-*" | ForEach-Object {
              $targetPath = $_.FullName.Replace("./library/reports", $prDir)
              if ($_.PSIsContainer) {
                New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              } else {
                $targetDir = Split-Path $targetPath -Parent
                New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
                Copy-Item -Path $_.FullName -Destination $targetPath -Force
              }
            }
          }
          
          # Copy artifacts
          if (Test-Path "./artifacts") {
            Copy-Item -Path "./artifacts" -Destination "$prDir/artifacts" -Recurse -Force
          }
          
          Write-Host "‚úÖ Dashboard generated" -ForegroundColor Green

      - name: üì¶ Upload Dashboard
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-dashboard
          path: library/reports/pr-${{ env.PR_NUMBER }}/**
          retention-days: 30
          if-no-files-found: warn

      - name: üåê Deploy to GitHub Pages
        if: hashFiles('./library/reports/pr-${{ env.PR_NUMBER }}/**') != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./library/reports/pr-${{ env.PR_NUMBER }}
          destination_dir: pr-${{ env.PR_NUMBER }}
          keep_files: true
          enable_jekyll: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy PR #${{ env.PR_NUMBER }} dashboard'

      - name: üí¨ Post Final Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const validationStatus = '${{ needs.quick-validation.outputs.status }}';
            const buildStatus = '${{ needs.build.outputs.status }}';
            const dockerStatus = '${{ needs.build-docker-image.outputs.status }}';
            const qualityStatus = '${{ needs.quality-analysis.outputs.status }}';
            
            const validationIcon = validationStatus === 'success' ? '‚úÖ' : '‚ùå';
            const buildIcon = buildStatus === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            const dockerIcon = dockerStatus === 'success' ? '‚úÖ' : '‚ö†Ô∏è';
            const qualityIcon = qualityStatus === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
            
            const pagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/pr-${process.env.PR_NUMBER}/`;
            const dockerImageTag = `ghcr.io/${context.repo.owner}/${context.repo.repo}:pr-${process.env.PR_NUMBER}`.toLowerCase();
            
            const summary = `## üöÄ PR Complete Workflow - FINISHED
            
            ### Phase Results
            
            | Phase | Status |
            |-------|--------|
            | ${validationIcon} **Quick Validation** | ${validationStatus} |
            | üß™ **Comprehensive Testing** | Matrix Complete |
            | ${buildIcon} **Build & Package** | ${buildStatus} |
            | ${dockerIcon} **Docker Container** | ${dockerStatus} |
            | ${qualityIcon} **Quality Analysis** | ${qualityStatus} |
            | üìä **Dashboard** | Generated |
            
            ### üìä Dashboard
            
            **GitHub Pages:** [View PR Dashboard](${pagesUrl})
            
            ### üê≥ Docker Image
            
            ${dockerStatus === 'success' ? `**Image:** \`${dockerImageTag}\`
            
            **Quick Test:**
            \`\`\`bash
            docker pull ${dockerImageTag}
            docker run -it --rm ${dockerImageTag}
            \`\`\`` : '*Docker build failed or was skipped*'}
            
            ### üì¶ Artifacts
            
            - Unit test results (9 ranges)
            - Domain test results (6 modules)
            - Integration test results (4 suites)
            - Build packages (ZIP, TAR.GZ)
            - Docker container image${dockerStatus === 'success' ? '' : ' (failed)'}
            - Quality analysis results
            - Complete dashboard
            
            [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ---
            *Complete PR workflow - all phases executed including Docker container build*`;
            
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
