---
name: ğŸš€ PR Ecosystem - Complete Validation & Build

# Complete PR workflow that orchestrates all validation, testing, building, and reporting
# This workflow runs automatically when PRs are opened, updated, or moved out of draft

on:
  # Direct PR triggers - THIS MAKES THE WORKFLOW RUN!
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    branches: [main, dev, develop, dev-staging, ring-0, ring-0-integrations, ring-1, ring-1-integrations, ring-2]
  
  # Reusable workflow call (for orchestration if needed)
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull Request number'
        required: false
        type: string

concurrency:
  group: pr-ecosystem-${{ github.event.pull_request.number || inputs.pr_number || github.run_id }}
  cancel-in-progress: true

permissions:
  contents: write
  pull-requests: write
  packages: write
  pages: write
  id-token: write
  checks: write
  statuses: write
  actions: read
  deployments: write

env:
  PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
  AITHERZERO_SUPPRESS_BANNER: true
  CONTAINER_REGISTRY: ghcr.io

jobs:
  # ============================================================================
  # PHASE 1: Quick Validation (Fast Feedback)
  # ============================================================================
  
  quick-validation:
    name: âš¡ Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      status: ${{ steps.validate.outcome }}
      
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ’¬ Post Start Status
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ğŸš€ **PR Complete Workflow Started**\n\n**Phase 1:** âš¡ Quick Validation\n- Syntax check\n- Config validation\n- Manifest validation'
            });

      - name: ğŸ”§ Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: âš¡ Quick Validation (Syntax + Config + Manifests)
        id: validate
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "âš¡ Running Quick Validation" -ForegroundColor Cyan
          
          # Run critical validation scripts
          $scripts = @('0407', '0413', '0405')
          $failed = @()
          
          foreach ($script in $scripts) {
            Write-Host "`nRunning $script..." -ForegroundColor Yellow
            $result = & "./library/automation-scripts/${script}*.ps1"
            if ($LASTEXITCODE -ne 0) {
              $failed += $script
            }
          }
          
          if ($failed.Count -gt 0) {
            Write-Host "âŒ Quick validation failed: $($failed -join ', ')" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "âœ… Quick validation passed" -ForegroundColor Green

      - name: ğŸ’¬ Post Validation Result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.validate.outcome }}';
            const icon = status === 'success' ? 'âœ…' : 'âŒ';
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Quick Validation ${status === 'success' ? 'PASSED' : 'FAILED'}**`
            });

  # ============================================================================
  # PHASE 2: Build & Package (TESTS REMOVED - handled by other workflows)
  # ============================================================================
  
  build:
    name: ğŸ”¨ Build & Package
    needs: quick-validation
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.build.outcome }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ’¬ Post Build Start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Phase 2:** ğŸ”¨ Build & Package Started (Tests handled by separate workflows)'
            });

      - name: ğŸ”§ Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: ğŸ”¨ Run Build Playbook (Skipping Tests)
        id: build
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          # Run build without self-deployment test
          # Self-deployment test (0900) runs ALL tests and is redundant
          # Tests are handled by separate dedicated test workflows
          
          # Call individual build scripts instead of full playbook
          Write-Host "ğŸ”§ Running syntax validation..." -ForegroundColor Cyan
          & "./library/automation-scripts/0407*.ps1" -All
          
          Write-Host "ğŸ“Š Generating build metadata..." -ForegroundColor Cyan
          & "./library/automation-scripts/0515*.ps1" -OutputPath "library/reports/build-metadata.json" -IncludePRInfo -IncludeGitInfo -IncludeEnvironmentInfo
          
          Write-Host "ğŸ“¦ Creating release package..." -ForegroundColor Cyan
          & "./library/automation-scripts/0902*.ps1" -PackageFormat Both -OnlyRuntime
          
          Write-Host "âœ… Build complete (tests skipped - handled elsewhere)" -ForegroundColor Green

      - name: ğŸ“¦ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-build
          path: |
            library/reports/build-*.json
            library/reports/build-*.md
            AitherZero-*.zip
            AitherZero-*.tar.gz
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ’¬ Post Build Result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.build.outcome }}';
            const icon = status === 'success' ? 'âœ…' : 'âš ï¸';
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Build & Package ${status === 'success' ? 'PASSED' : 'COMPLETED WITH ISSUES'}**`
            });

  # ============================================================================
  # PHASE 2B: Quality Analysis
  # ============================================================================
  
  quality-analysis:
    name: ğŸ” Quality Analysis
    needs: quick-validation
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.quality.outcome }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ’¬ Post Quality Start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Phase 4:** ğŸ” Quality Analysis Started\n\n- PSScriptAnalyzer\n- Component Quality\n- Security Scan'
            });

      - name: ğŸ”§ Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: ğŸ” Run Quality Analysis
        id: quality
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "ğŸ” Running PSScriptAnalyzer" -ForegroundColor Cyan
          & "./library/automation-scripts/0404*.ps1" -UseCache
          
          Write-Host "ğŸ” Running Component Quality Check" -ForegroundColor Cyan
          & "./library/automation-scripts/0420*.ps1" -Path "./aithercore" -Recursive

      - name: ğŸ“Š Upload Quality Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-quality
          path: |
            library/tests/analysis/**
            library/reports/quality-*.json
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸ’¬ Post Quality Result
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.quality.outcome }}';
            const icon = status === 'success' ? 'âœ…' : 'â„¹ï¸';
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `${icon} **Quality Analysis ${status === 'success' ? 'PASSED' : 'COMPLETED'}**`
            });

  # ============================================================================
  # PHASE 3: Dashboard Generation & Deployment
  # ============================================================================
  
  dashboard:
    name: ğŸ“Š Dashboard & Deploy
    needs: [build, quality-analysis]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ’¬ Post Dashboard Start
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: '**Phase 3:** ğŸ“Š Dashboard Generation Started\n\nConsolidating build and quality results...\n\n> **Note:** Docker images built by deploy-pr-environment workflow'
            });

      - name: ğŸ”§ Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: ğŸ“¥ Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
        continue-on-error: true

      - name: ğŸ“Š Generate Consolidated Dashboard
        shell: pwsh
        continue-on-error: true
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "ğŸ“Š Generating Modular Dashboard (5 parallel collectors + HTML generation)" -ForegroundColor Cyan
          
          # Use new modular dashboard generation playbook
          Invoke-AitherPlaybook -Name dashboard-generation-complete
          
          # Run report playbook
          Invoke-AitherPlaybook -Name pr-ecosystem-report
          
          # Organize for GitHub Pages
          $prDir = "./library/reports/pr-$env:PR_NUMBER"
          New-Item -ItemType Directory -Path $prDir -Force | Out-Null
          
          # Copy dashboard output
          if (Test-Path "./reports/dashboard") {
            Copy-Item -Path "./reports/dashboard" -Destination "$prDir/dashboard" -Recurse -Force
            Write-Host "âœ… Copied modern dashboard" -ForegroundColor Green
          }
          
          # Copy metrics
          if (Test-Path "./reports/metrics") {
            Copy-Item -Path "./reports/metrics" -Destination "$prDir/metrics" -Recurse -Force
            Write-Host "âœ… Copied metrics JSONs" -ForegroundColor Green
          }
          
          # Copy legacy reports
          if (Test-Path "./library/reports") {
            Get-ChildItem -Path "./library/reports" -Recurse -Exclude "pr-*" | ForEach-Object {
              $targetPath = $_.FullName.Replace("./library/reports", $prDir)
              if ($_.PSIsContainer) {
                New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              } else {
                $targetDir = Split-Path $targetPath -Parent
                New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
                Copy-Item -Path $_.FullName -Destination $targetPath -Force
              }
            }
          }
          
          # Copy artifacts
          if (Test-Path "./artifacts") {
            Copy-Item -Path "./artifacts" -Destination "$prDir/artifacts" -Recurse -Force
          }
          
          Write-Host "âœ… Complete dashboard generated with modern modular architecture" -ForegroundColor Green

      - name: ğŸ“¦ Upload Dashboard
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-dashboard
          path: library/reports/pr-${{ env.PR_NUMBER }}/**
          retention-days: 30
          if-no-files-found: warn

      - name: ğŸŒ Deploy to GitHub Pages
        if: hashFiles('./library/reports/pr-${{ env.PR_NUMBER }}/**') != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./library/reports/pr-${{ env.PR_NUMBER }}
          destination_dir: pr-${{ env.PR_NUMBER }}
          keep_files: true
          enable_jekyll: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy PR #${{ env.PR_NUMBER }} dashboard'

      - name: ğŸ’¬ Post Final Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const validationStatus = '${{ needs.quick-validation.outputs.status }}';
            const buildStatus = '${{ needs.build.outputs.status }}';
            const qualityStatus = '${{ needs.quality-analysis.outputs.status }}';
            
            const validationIcon = validationStatus === 'success' ? 'âœ…' : 'âŒ';
            const buildIcon = buildStatus === 'success' ? 'âœ…' : 'âš ï¸';
            const qualityIcon = qualityStatus === 'success' ? 'âœ…' : 'â„¹ï¸';
            
            const pagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/pr-${process.env.PR_NUMBER}/`;
            const dockerImageTag = `ghcr.io/${context.repo.owner}/${context.repo.repo}:pr-${process.env.PR_NUMBER}`.toLowerCase();
            
            const summary = `## ğŸš€ PR Complete Workflow - FINISHED
            
            ### Phase Results
            
            | Phase | Status |
            |-------|--------|
            | ${validationIcon} **Quick Validation** | ${validationStatus} |
            | ${buildIcon} **Build & Package** | ${buildStatus} |
            | ${qualityIcon} **Quality Analysis** | ${qualityStatus} |
            | ğŸ“Š **Dashboard** | Generated |
            
            > **Note:** Tests handled by dedicated test workflows  
            > **Note:** Docker images built by deploy-pr-environment workflow
            
            ### ğŸ“Š Dashboard
            
            **GitHub Pages:** [View PR Dashboard](${pagesUrl})
            
            ### ğŸ³ Docker Image
            
            Docker images are built by the **deploy-pr-environment** workflow.
            
            **Expected Image Tag:** \`${dockerImageTag}\`
            
            **Quick Test:**
            \`\`\`bash
            docker pull ${dockerImageTag}
            docker run -it --rm ${dockerImageTag}
            \`\`\`
            
            ### ğŸ“¦ Artifacts
            
            - Build packages (ZIP, TAR.GZ)
            - Quality analysis results
            - Complete dashboard
            - Docker images (from deploy-pr-environment workflow)
            
            [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ---
            *Streamlined PR workflow - Build, Quality, and Dashboard (Tests and Docker handled by dedicated workflows)*`;
            
            github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
