name: Diagnose CI Failures

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Specific workflow run ID to diagnose (optional)'
        required: false
        type: string
      workflow_name:
        description: 'Workflow name to diagnose (optional)'
        required: false
        type: string
  workflow_run:
    workflows: ["*"]
    types: [completed]
    branches: [dev, main]

permissions:
  contents: read
  actions: read
  checks: read

jobs:
  diagnose-failures:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'failure' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch || github.ref }}

      - name: Setup PowerShell
        shell: bash
        run: |
          if ! command -v pwsh &> /dev/null; then
            wget -q https://packages.microsoft.com/config/ubuntu/$(lsb_release -rs)/packages-microsoft-prod.deb
            sudo dpkg -i packages-microsoft-prod.deb
            sudo apt-get update
            sudo apt-get install -y powershell
          fi

      - name: Bootstrap AitherZero
        shell: pwsh
        run: |
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal
        env:
          AITHERZERO_NONINTERACTIVE: "1"

      - name: Diagnose Workflow Failures
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          $runId = "${{ github.event.workflow_run.id || inputs.run_id }}"
          $workflowName = "${{ inputs.workflow_name }}"
          
          Write-Host "ðŸ” Diagnosing CI Failures..." -ForegroundColor Cyan
          
          # Get the script
          $script = "./automation-scripts/0530_Get-WorkflowRunReport.ps1"
          
          if (-not (Test-Path $script)) {
            Write-Host "âŒ Diagnostic script not found: $script" -ForegroundColor Red
            exit 1
          }
          
          # Run diagnostic based on input
          if ($runId) {
            Write-Host "ðŸ“Š Analyzing run ID: $runId" -ForegroundColor Yellow
            & $script -RunId $runId -Detailed -OutputFormat Both
          } elseif ($workflowName) {
            Write-Host "ðŸ“Š Analyzing workflow: $workflowName" -ForegroundColor Yellow
            & $script -WorkflowName $workflowName -Status failure -Limit 5
          } else {
            Write-Host "ðŸ“Š Analyzing recent failures" -ForegroundColor Yellow
            & $script -List -Status failure -Limit 10
          }

      - name: Upload Diagnostic Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ci-failure-diagnostic-${{ github.run_id }}
          path: |
            **/*workflow-report*.json
            **/*workflow-report*.txt
          retention-days: 30

      - name: Comment on PR with Diagnosis
        if: github.event.workflow_run.event == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const reportFiles = [
              'workflow-report.txt',
              'workflow-report-summary.txt'
            ];
            
            let reportContent = '## ðŸ” CI Failure Diagnostic Report\n\n';
            reportContent += `**Workflow**: ${context.payload.workflow_run.name}\n`;
            reportContent += `**Run ID**: ${context.payload.workflow_run.id}\n`;
            reportContent += `**Status**: ${context.payload.workflow_run.conclusion}\n\n`;
            
            for (const file of reportFiles) {
              if (fs.existsSync(file)) {
                reportContent += fs.readFileSync(file, 'utf8');
                break;
              }
            }
            
            if (context.payload.workflow_run.pull_requests.length > 0) {
              const pr = context.payload.workflow_run.pull_requests[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: reportContent
              });
            }
