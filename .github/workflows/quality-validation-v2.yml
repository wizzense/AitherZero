---
name: ğŸ” Quality Validation (v2 - CLI)

# Quality checks using CLI cmdlets and code-quality playbooks
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  workflow_dispatch:
    inputs:
      mode:
        description: 'Quality check mode'
        required: false
        default: 'fast'
        type: choice
        options:
          - fast
          - full

permissions:
  contents: read
  pull-requests: write
  checks: write
  issues: write

concurrency:
  group: quality-v2-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true
  AITHERZERO_SUPPRESS_BANNER: true

jobs:
  quality-check:
    name: ğŸ” Quality Validation
    runs-on: ubuntu-latest
    if: github.actor != 'github-actions[bot]'
    timeout-minutes: 10

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: ğŸ”§ Bootstrap Environment
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Bootstrapping AitherZero..." -ForegroundColor Cyan
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal

      - name: ğŸ“¦ Install Quality Tools
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing PSScriptAnalyzer..." -ForegroundColor Cyan
          if (-not (Get-Module -ListAvailable PSScriptAnalyzer)) {
            Install-Module -Name PSScriptAnalyzer -Force -SkipPublisherCheck -Scope CurrentUser
          }
          Write-Host "âœ… Quality tools ready" -ForegroundColor Green

      - name: ğŸ” Run Quality Playbook
        id: quality
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Write-Host "ğŸ” Running quality validation playbook..." -ForegroundColor Cyan
          
          Import-Module ./AitherZero.psd1 -Force
          
          # Determine playbook based on mode
          $mode = "${{ github.event.inputs.mode || 'fast' }}"
          $playbook = if ($mode -eq 'full') { 'code-quality-full' } else { 'code-quality-fast' }
          
          Write-Host "Executing playbook: $playbook" -ForegroundColor Yellow
          
          try {
            # Execute quality playbook with CLI
            Invoke-AitherPlaybook -Name $playbook `
              -Parallel `
              -UseCache `
              -GenerateSummary `
              -ContinueOnError
            
            $exitCode = if ($null -eq $LASTEXITCODE) { 0 } else { $LASTEXITCODE }
            $success = $exitCode -eq 0
            
            echo "success=$success" >> $env:GITHUB_OUTPUT
            echo "exit-code=$exitCode" >> $env:GITHUB_OUTPUT
            echo "playbook=$playbook" >> $env:GITHUB_OUTPUT
            
            if (-not $success) {
              Write-Host "âš ï¸  Quality checks found issues (non-blocking)" -ForegroundColor Yellow
            }
            
            exit 0  # Non-blocking
          }
          catch {
            Write-Host "âŒ Quality playbook failed: $_" -ForegroundColor Red
            echo "success=false" >> $env:GITHUB_OUTPUT
            echo "exit-code=1" >> $env:GITHUB_OUTPUT
            echo "playbook=$playbook" >> $env:GITHUB_OUTPUT
            exit 0  # Non-blocking
          }

      - name: ğŸ“Š Upload Quality Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: quality-reports-${{ github.run_number }}
          path: |
            library/reports/quality/**/*
            library/reports/**/*.md
            library/reports/**/*.json
            library/tests/analysis/**/*
          retention-days: 30

      - name: ğŸ’¬ Post Quality Results
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            const prNumber = context.payload.pull_request.number;
            const success = '${{ steps.quality.outputs.success }}' === 'true';
            const playbook = '${{ steps.quality.outputs.playbook }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const statusIcon = success ? 'âœ…' : 'âš ï¸';
            const statusText = success ? '**PASSED**' : '**ISSUES FOUND**';
            const statusColor = success ? 'ğŸŸ¢' : 'ğŸŸ¡';
            
            let comment = `## ${statusIcon} Quality Validation Results (v2)\n\n`;
            comment += `### ${statusColor} Status: ${statusText}\n\n`;
            comment += `**Playbook:** \`${playbook}\`\n`;
            comment += `**Mode:** ${playbook.includes('full') ? 'Comprehensive' : 'Fast'}\n\n`;
            
            // Try to read quality summary
            try {
              const reportsDir = './library/reports/quality';
              if (fs.existsSync(reportsDir)) {
                const summaryFiles = fs.readdirSync(reportsDir).filter(f => f.includes('summary'));
                if (summaryFiles.length > 0) {
                  const summaryPath = path.join(reportsDir, summaryFiles[0]);
                  if (summaryPath.endsWith('.json')) {
                    const summary = JSON.parse(fs.readFileSync(summaryPath, 'utf8'));
                    
                    comment += `### ğŸ“Š Quality Metrics\n\n`;
                    comment += `| Metric | Value |\n`;
                    comment += `|--------|-------|\n`;
                    comment += `| ğŸ“Š Average Score | ${summary.AverageScore || 'N/A'}% |\n`;
                    comment += `| ğŸ“ Files Checked | ${summary.FilesValidated || 0} |\n`;
                    comment += `| âœ… Passed | ${summary.Passed || 0} |\n`;
                    comment += `| âš ï¸  Warnings | ${summary.Warnings || 0} |\n`;
                    comment += `| âŒ Failed | ${summary.Failed || 0} |\n\n`;
                  }
                }
              }
            } catch (e) {
              console.log('Could not read quality summary:', e.message);
            }
            
            if (success) {
              comment += `### âœ… Quality Standards Met!\n\n`;
              comment += `Your code meets our quality standards:\n`;
              comment += `- âœ… Error handling patterns\n`;
              comment += `- âœ… Logging implementation\n`;
              comment += `- âœ… Test coverage\n`;
              comment += `- âœ… PSScriptAnalyzer compliance\n\n`;
            } else {
              comment += `### âš ï¸  Quality Issues Found (Non-Blocking)\n\n`;
              comment += `Some quality checks found issues. These are **informational** and don't block merging.\n\n`;
              comment += `**Recommended Actions:**\n`;
              comment += `1. ğŸ“¥ Download [quality reports](${runUrl}) from artifacts\n`;
              comment += `2. ğŸ” Review findings and recommendations\n`;
              comment += `3. ğŸ”§ Address high-priority issues\n`;
              comment += `4. ğŸ§ª Test locally: \`Invoke-AitherPlaybook ${playbook}\`\n\n`;
            }
            
            comment += `### ğŸš€ Quality Tools\n\n`;
            comment += `Run quality checks locally:\n`;
            comment += `\`\`\`powershell\n`;
            comment += `# Fast quality check\n`;
            comment += `Invoke-AitherPlaybook code-quality-fast\n\n`;
            comment += `# Comprehensive analysis\n`;
            comment += `Invoke-AitherPlaybook code-quality-full\n\n`;
            comment += `# Check specific file\n`;
            comment += `Invoke-AitherScript 0420 -Variables @{Path='./path/to/file.ps1'}\n`;
            comment += `\`\`\`\n\n`;
            
            comment += `### ğŸ”— Links\n`;
            comment += `- ğŸ“Š [Workflow Run](${runUrl})\n`;
            comment += `- ğŸ“ [Quality Reports](${runUrl})\n`;
            comment += `- ğŸ“– [Quality Standards](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/blob/main/library/QUALITY-QUICK-REFERENCE.md)\n\n`;
            
            comment += `---\n`;
            comment += `*ğŸ¤– Automated by AitherZeroCLI â€¢ Quality validation is non-blocking*`;
            
            // Update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Quality Validation Results (v2)')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

      - name: âœ… Quality Check Complete
        if: always()
        shell: pwsh
        run: |
          $success = "${{ steps.quality.outputs.success }}" -eq "true"
          $playbook = "${{ steps.quality.outputs.playbook }}"
          
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘           QUALITY VALIDATION COMPLETE (v2)                   â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Playbook: $playbook" -ForegroundColor White
          
          if ($success) {
            Write-Host "Status: âœ… QUALITY STANDARDS MET" -ForegroundColor Green
          } else {
            Write-Host "Status: âš ï¸  ISSUES FOUND (non-blocking)" -ForegroundColor Yellow
          }
          
          Write-Host ""
          Write-Host "Powered by AitherZeroCLI and OrchestrationEngine" -ForegroundColor DarkCyan
