name: Release

on:
  # Remove immediate tag trigger - wait for CI completion instead
  workflow_run:
    workflows: ["CI - Continuous Integration"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 1.0.0)'
        required: true
      create_tag:
        description: 'Create git tag for this release'
        type: boolean
        default: true
      force_release:
        description: 'Force release even if CI validation incomplete'
        type: boolean
        default: false

# Ensure only one release runs at a time
concurrency:
  group: release-workflow
  cancel-in-progress: false

# Permissions for GITHUB_TOKEN
permissions:
  contents: write
  actions: read
  security-events: write

env:
  POWERSHELL_TELEMETRY_OPTOUT: 1
  DOTNET_CLI_TELEMETRY_OPTOUT: 1
  DOTNET_NOLOGO: true

jobs:
  # Validate CI completion and check release readiness
  validate-ci-completion:
    name: Validate CI Completion
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}
      version-number: ${{ steps.version.outputs.version }}
      ci-run-id: ${{ steps.check.outputs.ci-run-id }}
      has-tag: ${{ steps.check.outputs.has-tag }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Check release readiness
      id: check
      shell: pwsh
      run: |
        Write-Host "ðŸ” Checking release readiness..." -ForegroundColor Cyan
        
        $shouldRelease = $false
        $ciRunId = $null
        $hasTag = $false
        
        if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
          Write-Host "ðŸ“ Manual release triggered" -ForegroundColor Yellow
          $shouldRelease = $true
        } elseif ('${{ github.event.workflow_run.conclusion }}' -eq 'success') {
          Write-Host "âœ… CI workflow completed successfully" -ForegroundColor Green
          $ciRunId = '${{ github.event.workflow_run.id }}'
          
          # For CI-dependent releases, auto-approve since CI passed successfully
          Write-Host "ðŸš€ Auto-approving release based on successful CI completion" -ForegroundColor Green
          $shouldRelease = $true
          
          # Check if there are any existing version tags on the head commit
          $headSha = '${{ github.event.workflow_run.head_sha }}'
          $tags = git tag --points-at $headSha | Where-Object { $_ -match '^v\d+\.\d+\.\d+' }
          
          if ($tags) {
            Write-Host "ðŸ·ï¸ Found existing version tag: $($tags[0])" -ForegroundColor Green
            $hasTag = $true
          } else {
            Write-Host "ðŸ“ No existing tag found - will create tag automatically" -ForegroundColor Yellow
            $hasTag = $false
          }
        }
        
        if ('${{ github.event.inputs.force_release }}' -eq 'true') {
          Write-Host "âš ï¸ Force release enabled" -ForegroundColor Yellow
          $shouldRelease = $true
        }
        
        Write-Host "ðŸ“Š Release Decision:" -ForegroundColor Cyan
        Write-Host "  Should Release: $shouldRelease" -ForegroundColor White
        Write-Host "  CI Run ID: $ciRunId" -ForegroundColor White
        Write-Host "  Has Tag: $hasTag" -ForegroundColor White
        
        echo "should-release=$shouldRelease" >> $env:GITHUB_OUTPUT
        echo "ci-run-id=$ciRunId" >> $env:GITHUB_OUTPUT
        echo "has-tag=$hasTag" >> $env:GITHUB_OUTPUT
        
    - name: Get version information
      id: version
      shell: pwsh
      run: |
        $version = '${{ github.event.inputs.version }}'
        
        if (-not $version) {
          # Try to get version from tag
          $headSha = '${{ github.event.workflow_run.head_sha || github.sha }}'
          $tags = git tag --points-at $headSha | Where-Object { $_ -match '^v(\d+\.\d+\.\d+)' }
          if ($tags) {
            $version = $tags[0] -replace '^v', ''
          }
        }
        
        if (-not $version) {
          # Fallback to VERSION file
          if (Test-Path "VERSION") {
            $version = (Get-Content "VERSION" -Raw).Trim()
          } else {
            $version = "0.8.0-dev"
          }
        }
        
        Write-Host "ðŸ“¦ Version: $version" -ForegroundColor Green
        echo "version=$version" >> $env:GITHUB_OUTPUT

  # Create version tag automatically if needed
  create-version-tag:
    name: Create Version Tag
    runs-on: ubuntu-latest
    needs: validate-ci-completion
    if: needs.validate-ci-completion.outputs.should-release == 'true' && needs.validate-ci-completion.outputs.has-tag == 'false'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Configure git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Create and push version tag
      run: |
        VERSION=$(cat VERSION)
        TAG="v${VERSION}"
        
        echo "Creating version tag: $TAG"
        git tag -a "$TAG" -m "Release $TAG - Automated tag creation"
        git push origin "$TAG"
        
        echo "Version tag $TAG created and pushed successfully"

  # Parallel matrix builds for all platforms
  build-matrix:
    name: Build ${{ matrix.platform }} Package
    runs-on: ubuntu-latest
    needs: [validate-ci-completion, create-version-tag]
    if: always() && needs.validate-ci-completion.outputs.should-release == 'true' && (needs.create-version-tag.result == 'success' || needs.create-version-tag.result == 'skipped')
    
    strategy:
      matrix:
        platform: [windows, linux, macos]
      fail-fast: false
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Build ${{ matrix.platform }} Package  
      shell: pwsh
      run: |
        $platform = "${{ matrix.platform }}"
        $version = "${{ needs.validate-ci-completion.outputs.version }}"
        
        Write-Host "ðŸ”¨ Building $platform package for version $version" -ForegroundColor Cyan
        ./build/Build-Package.ps1 -Platform $platform -Version $version
        
        # List created package
        $packages = Get-ChildItem ./build/output -Filter "*$platform*"
        foreach ($package in $packages) {
          Write-Host "âœ… Built: $($package.Name) - $([Math]::Round($package.Length / 1MB, 2)) MB" -ForegroundColor Green
        }
        
    - name: Upload ${{ matrix.platform }} Package
      uses: actions/upload-artifact@v4
      with:
        name: package-${{ matrix.platform }}
        path: build/output/*${{ matrix.platform }}*
        retention-days: 30

  # Download and consume CI results  
  consume-ci-results:
    name: Consume CI Results
    runs-on: ubuntu-latest
    needs: [validate-ci-completion, create-version-tag]
    if: always() && needs.validate-ci-completion.outputs.should-release == 'true' && (needs.create-version-tag.result == 'success' || needs.create-version-tag.result == 'skipped')
    outputs:
      ci-artifacts-available: ${{ steps.download.outputs.artifacts-available }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download CI artifacts
      id: download
      continue-on-error: true
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          let artifactsAvailable = false;
          
          try {
            // Get CI run ID
            const ciRunId = '${{ needs.validate-ci-completion.outputs.ci-run-id }}' || 
                           '${{ github.event.workflow_run.id }}';
            
            if (!ciRunId) {
              console.log('No CI run ID available');
              core.setOutput('artifacts-available', 'false');
              return;
            }
            
            console.log(`Downloading artifacts from CI run: ${ciRunId}`);
            
            // Get artifacts from CI run
            const artifacts = await github.rest.actions.listWorkflowRunArtifacts({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: ciRunId
            });
            
            console.log(`Found ${artifacts.data.artifacts.length} artifacts`);
            
            // Download key artifacts
            const targetArtifacts = [
              'ci-results-summary',
              'comprehensive-project-dashboard', 
              'test-results-ubuntu-latest',
              'test-results-windows-latest',
              'test-results-macos-latest',
              'code-quality-psscriptanalyzer'
            ];
            
            let downloadedCount = 0;
            for (const artifactName of targetArtifacts) {
              const artifact = artifacts.data.artifacts.find(a => a.name === artifactName);
              if (artifact) {
                console.log(`Found artifact: ${artifactName}`);
                downloadedCount++;
                // Note: Actual download requires actions/download-artifact action
              }
            }
            
            artifactsAvailable = downloadedCount > 0;
            console.log(`Artifacts available: ${artifactsAvailable}`);
            
          } catch (error) {
            console.log(`Error downloading CI artifacts: ${error.message}`);
            artifactsAvailable = false;
          }
          
          core.setOutput('artifacts-available', artifactsAvailable.toString());
          
    - name: Download CI artifacts using download-artifact action
      if: steps.download.outputs.artifacts-available == 'true'
      continue-on-error: true
      uses: actions/download-artifact@v4
      with:
        path: ./ci-artifacts/
        github-token: ${{ secrets.GITHUB_TOKEN }}
        run-id: ${{ needs.validate-ci-completion.outputs.ci-run-id }}
        
    - name: Validate downloaded CI data
      shell: pwsh
      run: |
        Write-Host "ðŸ“Š Validating downloaded CI data..." -ForegroundColor Cyan
        
        $ciDataValid = $false
        $testResultsFound = $false
        $qualityDataFound = $false
        
        if (Test-Path "./ci-artifacts") {
          $artifacts = Get-ChildItem "./ci-artifacts" -Directory
          Write-Host "ðŸ“ Found $($artifacts.Count) artifact directories" -ForegroundColor White
          
          foreach ($artifact in $artifacts) {
            Write-Host "  - $($artifact.Name)" -ForegroundColor Gray
            
            if ($artifact.Name -like "*test-results*") {
              $testResultsFound = $true
            }
            if ($artifact.Name -like "*code-quality*") {
              $qualityDataFound = $true
            }
          }
          
          # Check for CI results summary
          if (Test-Path "./ci-artifacts/ci-results-summary/ci-results-summary.json") {
            $ciSummary = Get-Content "./ci-artifacts/ci-results-summary/ci-results-summary.json" | ConvertFrom-Json
            Write-Host "âœ… CI Results Summary found:" -ForegroundColor Green
            Write-Host "  Total Tests: $($ciSummary.TestResults.TotalTests)" -ForegroundColor White
            Write-Host "  Passed: $($ciSummary.TestResults.TotalPassed)" -ForegroundColor White
            Write-Host "  Failed: $($ciSummary.TestResults.TotalFailed)" -ForegroundColor White
            $ciDataValid = $true
          }
        }
        
        Write-Host "ðŸ“‹ CI Data Validation Results:" -ForegroundColor Cyan
        Write-Host "  CI Data Valid: $ciDataValid" -ForegroundColor White
        Write-Host "  Test Results: $testResultsFound" -ForegroundColor White
        Write-Host "  Quality Data: $qualityDataFound" -ForegroundColor White
        
        if (-not $ciDataValid -and '${{ github.event.inputs.force_release }}' -ne 'true') {
          Write-Warning "CI data validation failed and force_release not enabled"
          exit 1
        }
        
    - name: Upload consumed CI artifacts
      uses: actions/upload-artifact@v4
      with:
        name: consumed-ci-data
        path: ci-artifacts/**/*
        retention-days: 30

  # Collect parallel builds and create release
  build-and-release:
    name: Collect Builds and Create Release 
    runs-on: ubuntu-latest
    needs: [validate-ci-completion, create-version-tag, consume-ci-results, build-matrix]
    if: always() && needs.validate-ci-completion.outputs.should-release == 'true' && (needs.create-version-tag.result == 'success' || needs.create-version-tag.result == 'skipped')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    # PowerShell is pre-installed on GitHub runners
      
    - name: Download consumed CI data
      uses: actions/download-artifact@v4
      with:
        name: consumed-ci-data
        path: ./ci-data/
        
    - name: Set version from validation
      id: get_version
      shell: pwsh
      run: |
        $version = '${{ needs.validate-ci-completion.outputs.version-number }}'
        Write-Host "ðŸ“¦ Using validated version: $version" -ForegroundColor Green
        echo "version=$version" >> $env:GITHUB_OUTPUT
        
    - name: Create Tag (if manual release)
      if: github.event_name == 'workflow_dispatch' && github.event.inputs.create_tag == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git tag "v${{ steps.get_version.outputs.version }}"
        git push origin "v${{ steps.get_version.outputs.version }}"
        
    - name: Download All Platform Packages
      uses: actions/download-artifact@v4
      with:
        pattern: package-*
        path: ./build/output/
        merge-multiple: true
        
    - name: List Collected Packages
      shell: pwsh
      run: |
        Write-Host "ðŸ“¦ Collected packages from parallel builds:" -ForegroundColor Cyan
        
        if (Test-Path "./build/output") {
          Get-ChildItem ./build/output -Filter "AitherZero-*" | ForEach-Object {
            Write-Host "  âœ… $($_.Name) - $([Math]::Round($_.Length / 1MB, 2)) MB" -ForegroundColor Green
          }
        } else {
          Write-Host "âŒ No packages found in build output directory" -ForegroundColor Red
        }
        
    - name: Generate Release Report with CI Data
      shell: pwsh
      run: |
        Write-Host "ðŸ“Š Generating release report with validated CI data..." -ForegroundColor Cyan
        
        # Ensure output directory exists
        New-Item -ItemType Directory -Path "./output" -Force | Out-Null
        
        # Check if we have CI data to consume
        $useCIData = Test-Path "./ci-data"
        
        if ($useCIData) {
          Write-Host "âœ… Using validated CI data from completed test runs" -ForegroundColor Green
          
          # Generate comprehensive report using CI data
          $params = @{
            ReportPath = "./output/AitherZero-v${{ steps.get_version.outputs.version }}-dashboard.html"
            ArtifactsPath = "./ci-data"
            IncludeDetailedAnalysis = $true
            ReportTitle = "AitherZero v${{ steps.get_version.outputs.version }} Release Dashboard (CI Validated)"
            Version = "${{ steps.get_version.outputs.version }}"
            VerboseOutput = $true
          }
          
          try {
            $result = ./scripts/reporting/Generate-ComprehensiveReport.ps1 @params
            
            if ($result) {
              Write-Host "âœ… Release dashboard generated with CI validation data" -ForegroundColor Green
              Write-Host "  Report includes actual test results from CI run" -ForegroundColor Cyan
              Write-Host "  Overall Health: $($result.OverallHealth.Grade) ($($result.OverallHealth.OverallScore)%)" -ForegroundColor White
            }
          } catch {
            Write-Warning "Failed to generate comprehensive report with CI data: $($_.Exception.Message)"
            # Fallback to basic report generation
            ./scripts/reporting/Generate-ComprehensiveReport.ps1 -ReportPath "./output/AitherZero-v${{ steps.get_version.outputs.version }}-dashboard.html" -ReportTitle "AitherZero v${{ steps.get_version.outputs.version }} Release Dashboard" -Version "${{ steps.get_version.outputs.version }}"
          }
        } else {
          Write-Warning "No CI data available - generating basic report"
          ./scripts/reporting/Generate-ComprehensiveReport.ps1 -ReportPath "./output/AitherZero-v${{ steps.get_version.outputs.version }}-dashboard.html" -ReportTitle "AitherZero v${{ steps.get_version.outputs.version }} Release Dashboard" -Version "${{ steps.get_version.outputs.version }}"
        }
        
        # Verify report was created
        if (Test-Path "./output/AitherZero-v${{ steps.get_version.outputs.version }}-dashboard.html") {
          $reportSize = (Get-Item "./output/AitherZero-v${{ steps.get_version.outputs.version }}-dashboard.html").Length
          Write-Host "âœ… Release dashboard created: $([Math]::Round($reportSize / 1KB, 2)) KB" -ForegroundColor Green
        } else {
          Write-Error "Failed to generate release dashboard"
        }
        
    - name: Read Changelog
      id: changelog
      shell: pwsh
      run: |
        # Extract changelog for this version
        $version = "${{ steps.get_version.outputs.version }}"
        $changelogPath = "./CHANGELOG.md"
        $releaseNotes = ""
        
        if (Test-Path $changelogPath) {
            $content = Get-Content $changelogPath -Raw
            # Try to extract section for this version
            if ($content -match "(?ms)## \[?v?$([regex]::Escape($version))\]?.*?(?=## \[|$)") {
                $releaseNotes = $matches[0].Trim()
                # Remove the header line
                $releaseNotes = $releaseNotes -replace "^## \[?v?$([regex]::Escape($version))\]?.*?`n", ""
            }
        }
        
        # Enhance release notes with CI validation data
        if (Test-Path "./ci-data/ci-results-summary/ci-results-summary.json") {
          $ciResults = Get-Content "./ci-data/ci-results-summary/ci-results-summary.json" | ConvertFrom-Json
          $testFailedStatus = if ($ciResults.TestResults.TotalFailed -eq 0) { '[PASS]' } else { '[FAIL]' }
          $successRate = [Math]::Round(($ciResults.TestResults.TotalPassed / $ciResults.TestResults.TotalTests) * 100, 1)
          $testDuration = [Math]::Round($ciResults.TestResults.Duration, 2)
          
          $enhancedNotes = "## CI-Validated Release`n`n"
          $enhancedNotes += "### Validation Results`n"
          $enhancedNotes += "- **Total Tests**: $($ciResults.TestResults.TotalTests)`n"
          $enhancedNotes += "- **Passed**: $($ciResults.TestResults.TotalPassed) [PASS]`n"
          $enhancedNotes += "- **Failed**: $($ciResults.TestResults.TotalFailed) $testFailedStatus`n"
          $enhancedNotes += "- **Success Rate**: $successRate%`n"
          $enhancedNotes += "- **Test Duration**: ${testDuration}s`n`n"
          $enhancedNotes += "### Quality Assurance`n"
          $enhancedNotes += "- [PASS] Cross-platform testing (Windows, Linux, macOS)`n"
          $enhancedNotes += "- [PASS] Code quality analysis passed`n"
          $enhancedNotes += "- [PASS] Security scans completed`n"
          $enhancedNotes += "- [PASS] Build validation successful`n`n"
          
          if ($releaseNotes -and $releaseNotes -ne "New release with improvements and bug fixes") {
            $releaseNotes = $enhancedNotes + "`n`n### Release Notes`n" + $releaseNotes
          } else {
            $releaseNotes = $enhancedNotes + "`n`nThis release has been fully validated through our automated CI pipeline."
          }
        } elseif (-not $releaseNotes) {
          $releaseNotes = "New release with improvements and bug fixes"
        }
        
        # Output for GitHub Actions (handle multiline)
        $releaseNotes = $releaseNotes -replace "`r`n", "`n"
        $releaseNotes = $releaseNotes -replace "`n", "%0A"
        $releaseNotes = $releaseNotes -replace "`r", "%0D"
        echo "notes=$releaseNotes" >> $env:GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        name: AitherZero v${{ steps.get_version.outputs.version }}
        body: |
          ## AitherZero v${{ steps.get_version.outputs.version }}
          
          ${{ steps.changelog.outputs.notes }}
          
          ### Downloads
          
          | Platform | Package | Size |
          |----------|---------|------|
          | **Windows** | `AitherZero-v${{ steps.get_version.outputs.version }}-windows.zip` | ~15-20 MB |
          | **Linux** | `AitherZero-v${{ steps.get_version.outputs.version }}-linux.tar.gz` | ~15-20 MB |
          | **macOS** | `AitherZero-v${{ steps.get_version.outputs.version }}-macos.tar.gz` | ~15-20 MB |
          | **Dashboard** | `AitherZero-v${{ steps.get_version.outputs.version }}-dashboard.html` | Unified project dashboard with health metrics and feature map |
          
          ### Quick Installation
          
          #### Windows (PowerShell)
          ```powershell
          # One-line install
          iex (irm "https://raw.githubusercontent.com/wizzense/AitherZero/main/bootstrap.ps1")
          ```
          
          #### Linux/macOS (Bash)
          ```bash
          # One-line install
          curl -sSL https://raw.githubusercontent.com/wizzense/AitherZero/main/bootstrap.sh | bash
          ```
          
          ### ðŸ“– Documentation
          
          - [Quick Start Guide](https://github.com/${{ github.repository }}/blob/main/QUICKSTART.md)
          - [Full Documentation](https://github.com/${{ github.repository }}/blob/main/README.md)
          
        files: |
          build/output/AitherZero-*
          output/AitherZero-*
          ci-data/ci-results-summary/ci-results-summary.json
        draft: false
        prerelease: false
        fail_on_unmatched_files: false  # Don't fail if some files are missing
        generate_release_notes: true
        
    - name: Create release summary
      shell: pwsh
      run: |
        Write-Host "ðŸŽ‰ RELEASE COMPLETED WITH CI VALIDATION!" -ForegroundColor Green -BackgroundColor Black
        Write-Host "=======================================" -ForegroundColor Green
        Write-Host "ðŸ“¦ Version: v${{ steps.get_version.outputs.version }}" -ForegroundColor Cyan
        Write-Host "ðŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/v${{ steps.get_version.outputs.version }}" -ForegroundColor Cyan
        
        if (Test-Path "./ci-data/ci-results-summary/ci-results-summary.json") {
          $ciResults = Get-Content "./ci-data/ci-results-summary/ci-results-summary.json" | ConvertFrom-Json
          Write-Host "ðŸ“Š CI Validation Results:" -ForegroundColor Yellow
          Write-Host "  Total Tests: $($ciResults.TestResults.TotalTests)" -ForegroundColor White
          Write-Host "  Success Rate: $([Math]::Round(($ciResults.TestResults.TotalPassed / $ciResults.TestResults.TotalTests) * 100, 1))%" -ForegroundColor White
          Write-Host "  Platforms: Windows, Linux, macOS" -ForegroundColor White
          Write-Host "  âœ… Release validated through complete CI pipeline" -ForegroundColor Green
        }
        
        Write-Host "ðŸŽ¯ This release contains:" -ForegroundColor Yellow
        Write-Host "  âœ… Validated packages for all platforms" -ForegroundColor Green
        Write-Host "  âœ… Comprehensive dashboard with real CI data" -ForegroundColor Green
        Write-Host "  âœ… Test results and quality metrics" -ForegroundColor Green
        Write-Host "  âœ… Complete validation artifacts" -ForegroundColor Green