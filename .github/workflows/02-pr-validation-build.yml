---
name: üöÄ PR Ecosystem - Complete Validation & Build

# Complete PR workflow that orchestrates all validation, testing, building, and reporting
# This workflow runs automatically when PRs are opened, updated, or moved out of draft

'on':
  # This workflow is called by 01-master-orchestrator.yml via workflow_call
  # Direct PR triggers removed to prevent duplicate runs and cancellations
  # The orchestrator handles all PR events and calls this workflow as needed
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull Request number'
        required: false
        type: string

# No concurrency group needed - controlled by master orchestrator (01-master-orchestrator.yml)
# The orchestrator's concurrency group ensures only one PR ecosystem workflow runs at a time

permissions:
  contents: write
  pull-requests: write
  packages: write
  pages: write
  id-token: write
  checks: write
  statuses: write
  actions: read
  deployments: write

env:
  PR_NUMBER: ${{ inputs.pr_number || github.event.pull_request.number }}
  AITHERZERO_SUPPRESS_BANNER: true
  CONTAINER_REGISTRY: ghcr.io

jobs:
  # ============================================================================
  # PHASE 1: Quick Validation (Fast Feedback)
  # ============================================================================
  
  quick-validation:
    name: ‚ö° Quick Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      status: ${{ steps.validate.outcome }}
      
    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üí¨ Create Workflow Status Comment
        id: create_comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = await github.rest.issues.createComment({
              issue_number: process.env.PR_NUMBER,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üöÄ PR Validation & Build Workflow

            **Workflow:** \`02-pr-validation-build.yml\`  
            **Run ID:** ${context.runId}  
            **Commit:** \`${context.sha.substring(0, 7)}\`  
            **Started:** ${new Date().toISOString()}

            ---

            ### üìä Progress

            | Phase | Status | Details |
            |-------|--------|---------|
            | ‚ö° Quick Validation | üîÑ Running | Syntax, Config, Manifests |
            | üî® Build & Package | ‚è≥ Pending | Runtime packages |
            | üîç Quality Analysis | ‚è≥ Pending | PSScriptAnalyzer, Component quality |
            | üìä Dashboard | ‚è≥ Pending | Metrics & reports |

            ---
            _Last updated: ${new Date().toISOString()}_
            <!-- WORKFLOW_STATUS_COMMENT:pr-validation-build -->`
            });
            return comment.data.id;

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: ‚ö° Quick Validation (Syntax + Config + Manifests)
        id: validate
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "‚ö° Running Quick Validation" -ForegroundColor Cyan
          
          # Run critical validation scripts
          $scripts = @('0407', '0413', '0405')
          $failed = @()
          
          foreach ($script in $scripts) {
            Write-Host "`nRunning $script..." -ForegroundColor Yellow
            # Script 0407 requires -All switch to validate all files
            if ($script -eq '0407') {
              $result = & "./library/automation-scripts/${script}*.ps1" -All
            } else {
              $result = & "./library/automation-scripts/${script}*.ps1"
            }
            if ($LASTEXITCODE -ne 0) {
              $failed += $script
            }
          }
          
          if ($failed.Count -gt 0) {
            Write-Host "‚ùå Quick validation failed: $($failed -join ', ')" -ForegroundColor Red
            exit 1
          }
          
          Write-Host "‚úÖ Quick validation passed" -ForegroundColor Green

      - name: üí¨ Update Status - Validation Complete
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.validate.outcome }}';
            const icon = status === 'success' ? '‚úÖ' : '‚ùå';
            const statusText = status === 'success' ? 'PASSED' : 'FAILED';
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: process.env.PR_NUMBER
            });
            
            const trackingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('WORKFLOW_STATUS_COMMENT:pr-validation-build')
            );
            
            if (trackingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: trackingComment.id,
                body: `## üöÄ PR Validation & Build Workflow

            **Workflow:** \`02-pr-validation-build.yml\`  
            **Run ID:** ${context.runId}  
            **Commit:** \`${context.sha.substring(0, 7)}\`  
            **Started:** ${trackingComment.created_at}

            ---

            ### üìä Progress

            | Phase | Status | Details |
            |-------|--------|---------|
            | ${icon} Quick Validation | **${statusText}** | Completed at ${new Date().toISOString()} |
            | üî® Build & Package | üîÑ Running | Runtime packages |
            | üîç Quality Analysis | ‚è≥ Pending | PSScriptAnalyzer, Component quality |
            | üìä Dashboard | ‚è≥ Pending | Metrics & reports |

            ---
            _Last updated: ${new Date().toISOString()}_
            <!-- WORKFLOW_STATUS_COMMENT:pr-validation-build -->`
              });
            }

  # ============================================================================
  # PHASE 1.5: Module Architecture Validation & Performance
  # ============================================================================

  validate-module-architecture:
    name: üèóÔ∏è Validate Module Architecture
    needs: quick-validation
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      status: ${{ steps.validate.outputs.status }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üîç Validate Automation Scripts
        id: validate
        shell: pwsh
        run: |
          Write-Host "üîç Validating all automation scripts..." -ForegroundColor Cyan
          & ./library/automation-scripts/0950_Validate-AllAutomationScripts.ps1 -Fast
          echo "status=$(if ($LASTEXITCODE -eq 0) { 'success' } else { 'failure' })" >> $env:GITHUB_OUTPUT

      - name: üì§ Upload Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-results
          path: reports/validation-results.json

  profile-module-performance:
    name: ‚ö° Profile Module Performance
    needs: quick-validation
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      status: ${{ steps.profile.outputs.status }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: ‚ö° Profile Performance
        id: profile
        shell: pwsh
        run: |
          Write-Host "‚ö° Profiling module performance..." -ForegroundColor Cyan
          & ./library/automation-scripts/0529_Profile-ModulePerformance.ps1 -Detailed -Optimize
          echo "status=$(if ($LASTEXITCODE -eq 0 -or $LASTEXITCODE -eq 1) { 'success' } else { 'failure' })" >> $env:GITHUB_OUTPUT

      - name: üì§ Upload Metrics
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: performance-metrics
          path: |
            reports/performance-metrics.json
            reports/performance-dashboard.json

  # ============================================================================
  # PHASE 2: Build & Package (TESTS REMOVED - handled by other workflows)
  # ============================================================================
  
  build:
    name: üî® Build & Package
    needs: [quick-validation, validate-module-architecture, profile-module-performance]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.build.outcome }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üî® Run Build Playbook (Skipping Tests)
        id: build
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          # Run build without self-deployment test
          # Self-deployment test (0900) runs ALL tests and is redundant
          # Tests are handled by separate dedicated test workflows
          
          # Track failures but continue to collect all results
          $failedSteps = @()
          $ErrorActionPreference = 'Continue'
          
          # Call individual build scripts instead of full playbook
          Write-Host "üîß Running syntax validation..." -ForegroundColor Cyan
          & "./library/automation-scripts/0407*.ps1" -All
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è Syntax validation failed with exit code $LASTEXITCODE" -ForegroundColor Yellow
            $failedSteps += "Syntax validation (0407)"
          }
          
          Write-Host "`nüìä Generating build metadata..." -ForegroundColor Cyan
          & "./library/automation-scripts/0515*.ps1" -OutputPath "library/reports/build-metadata.json" -IncludePRInfo -IncludeGitInfo -IncludeEnvironmentInfo
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è Build metadata generation failed with exit code $LASTEXITCODE" -ForegroundColor Yellow
            $failedSteps += "Build metadata (0515)"
          }
          
          Write-Host "`nüì¶ Creating release package..." -ForegroundColor Cyan
          & "./library/automation-scripts/0902*.ps1" -PackageFormat Both -OnlyRuntime
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è Release package creation failed with exit code $LASTEXITCODE" -ForegroundColor Yellow
            $failedSteps += "Release package (0902)"
          }
          
          # Report final status
          if ($failedSteps.Count -gt 0) {
            Write-Host "`n‚ùå Build completed with failures:" -ForegroundColor Red
            foreach ($step in $failedSteps) {
              Write-Host "  - $step" -ForegroundColor Red
            }
            exit 1
          } else {
            Write-Host "`n‚úÖ Build complete (tests skipped - handled elsewhere)" -ForegroundColor Green
            exit 0
          }

      - name: üì¶ Upload Build Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-build
          path: |
            library/reports/build-*.json
            library/reports/build-*.md
            AitherZero-*.zip
            AitherZero-*.tar.gz
          retention-days: 30
          if-no-files-found: warn

      - name: üí¨ Update Status - Build Complete
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const validationStatus = '${{ needs.quick-validation.result }}';
            const buildStatus = '${{ steps.build.outcome }}';
            
            const validationIcon = validationStatus === 'success' ? '‚úÖ' : '‚ùå';
            const buildIcon = buildStatus === 'success' ? '‚úÖ' : '‚ùå';
            
            const validationText = validationStatus === 'success' ? 'PASSED' : 'FAILED';
            const buildText = buildStatus === 'success' ? 'PASSED' : 'FAILED';
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: process.env.PR_NUMBER
            });
            
            const trackingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('WORKFLOW_STATUS_COMMENT:pr-validation-build')
            );
            
            if (trackingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: trackingComment.id,
                body: `## üöÄ PR Validation & Build Workflow

            **Workflow:** \`02-pr-validation-build.yml\`  
            **Run ID:** ${context.runId}  
            **Commit:** \`${context.sha.substring(0, 7)}\`  
            **Started:** ${trackingComment.created_at}

            ---

            ### üìä Progress

            | Phase | Status | Details |
            |-------|--------|---------|
            | ${validationIcon} Quick Validation | **${validationText}** | Syntax, Config, Manifests |
            | ${buildIcon} Build & Package | **${buildText}** | Completed at ${new Date().toISOString()} |
            | üîç Quality Analysis | üîÑ Running | PSScriptAnalyzer, Component quality |
            | üìä Dashboard | ‚è≥ Pending | Metrics & reports |

            ---
            _Last updated: ${new Date().toISOString()}_
            <!-- WORKFLOW_STATUS_COMMENT:pr-validation-build -->`
              });
            }

  # ============================================================================
  # PHASE 2B: Quality Analysis
  # ============================================================================
  
  quality-analysis:
    name: üîç Quality Analysis
    needs: quick-validation
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15
    outputs:
      status: ${{ steps.quality.outcome }}

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üîç Run Quality Analysis
        id: quality
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          # Track failures but continue to collect all results
          $failedSteps = @()
          $ErrorActionPreference = 'Continue'
          
          Write-Host "üîç Running PSScriptAnalyzer" -ForegroundColor Cyan
          & "./library/automation-scripts/0404*.ps1" -UseCache
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è PSScriptAnalyzer failed with exit code $LASTEXITCODE" -ForegroundColor Yellow
            $failedSteps += "PSScriptAnalyzer (0404)"
          }
          
          Write-Host "`nüîç Running Component Quality Check" -ForegroundColor Cyan
          & "./library/automation-scripts/0420*.ps1" -Path "./aithercore" -Recursive
          if ($LASTEXITCODE -ne 0) {
            Write-Host "‚ö†Ô∏è Component quality check failed with exit code $LASTEXITCODE" -ForegroundColor Yellow
            $failedSteps += "Component quality (0420)"
          }
          
          # Report final status
          if ($failedSteps.Count -gt 0) {
            Write-Host "`n‚ùå Quality analysis completed with failures:" -ForegroundColor Red
            foreach ($step in $failedSteps) {
              Write-Host "  - $step" -ForegroundColor Red
            }
            exit 1
          } else {
            Write-Host "`n‚úÖ Quality analysis passed" -ForegroundColor Green
            exit 0
          }

      - name: üìä Upload Quality Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-quality
          path: |
            library/tests/analysis/**
            library/reports/quality/**
            library/reports/quality-*.json
          retention-days: 30
          if-no-files-found: warn

      - name: üí¨ Update Status - Quality Complete
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const validationStatus = '${{ needs.quick-validation.result }}';
            const buildStatus = '${{ needs.build.result }}';
            const qualityStatus = '${{ steps.quality.outcome }}';
            
            const validationIcon = validationStatus === 'success' ? '‚úÖ' : '‚ùå';
            const buildIcon = buildStatus === 'success' ? '‚úÖ' : '‚ùå';
            const qualityIcon = qualityStatus === 'success' ? '‚úÖ' : '‚ùå';
            
            const validationText = validationStatus === 'success' ? 'PASSED' : 'FAILED';
            const buildText = buildStatus === 'success' ? 'PASSED' : 'FAILED';
            const qualityText = qualityStatus === 'success' ? 'PASSED' : 'FAILED';
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: process.env.PR_NUMBER
            });
            
            const trackingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('WORKFLOW_STATUS_COMMENT:pr-validation-build')
            );
            
            if (trackingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: trackingComment.id,
                body: `## üöÄ PR Validation & Build Workflow

            **Workflow:** \`02-pr-validation-build.yml\`  
            **Run ID:** ${context.runId}  
            **Commit:** \`${context.sha.substring(0, 7)}\`  
            **Started:** ${trackingComment.created_at}

            ---

            ### üìä Progress

            | Phase | Status | Details |
            |-------|--------|---------|
            | ${validationIcon} Quick Validation | **${validationText}** | Syntax, Config, Manifests |
            | ${buildIcon} Build & Package | **${buildText}** | Runtime packages |
            | ${qualityIcon} Quality Analysis | **${qualityText}** | Completed at ${new Date().toISOString()} |
            | üìä Dashboard | üîÑ Running | Metrics & reports |

            ---
            _Last updated: ${new Date().toISOString()}_
            <!-- WORKFLOW_STATUS_COMMENT:pr-validation-build -->`
              });
            }

  # ============================================================================
  # PHASE 3: Dashboard Generation & Deployment
  # ============================================================================
  
  dashboard:
    name: üìä Dashboard & Deploy
    needs: [build, quality-analysis]
    if: always()
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: üì• Checkout
        uses: actions/checkout@v4

      - name: üîß Bootstrap
        shell: pwsh
        run: ./bootstrap.ps1 -Mode New -InstallProfile Minimal -NonInteractive

      - name: üì• Download All Artifacts
        id: download-artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts
        continue-on-error: true

      - name: üìä Generate Consolidated Dashboard
        id: dashboard
        shell: pwsh
        run: |
          Import-Module ./AitherZero.psd1 -Force
          
          Write-Host "üìä Generating Modular Dashboard (5 parallel collectors + HTML generation)" -ForegroundColor Cyan
          
          # Track failures but continue to generate what we can
          $failedSteps = @()
          $ErrorActionPreference = 'Continue'
          
          # Use new modular dashboard generation playbook
          try {
            Invoke-AitherPlaybook -Name dashboard-generation-complete
            Write-Host "‚úÖ Dashboard generation playbook completed" -ForegroundColor Green
          } catch {
            Write-Host "‚ö†Ô∏è Dashboard generation playbook failed: $_" -ForegroundColor Yellow
            $failedSteps += "Dashboard generation playbook"
          }
          
          # Run report playbook
          try {
            Invoke-AitherPlaybook -Name pr-ecosystem-report
            Write-Host "‚úÖ PR ecosystem report completed" -ForegroundColor Green
          } catch {
            Write-Host "‚ö†Ô∏è PR ecosystem report failed: $_" -ForegroundColor Yellow
            $failedSteps += "PR ecosystem report"
          }
          
          # Organize for GitHub Pages
          $prDir = "./library/reports/pr-$env:PR_NUMBER"
          New-Item -ItemType Directory -Path $prDir -Force | Out-Null
          
          # Copy dashboard output from library/reports/dashboard/ (modular dashboard)
          if (Test-Path "./library/reports/dashboard") {
            Copy-Item -Path "./library/reports/dashboard" -Destination "$prDir/dashboard" -Recurse -Force
            Write-Host "‚úÖ Copied modular dashboard (library/reports/dashboard/)" -ForegroundColor Green
          } else {
            Write-Host "‚ö†Ô∏è Modular dashboard not found at library/reports/dashboard/" -ForegroundColor Yellow
            $failedSteps += "Modular dashboard copy"
          }
          
          # Copy individual dashboard files from library/reports/ (comprehensive dashboard)
          $dashboardFiles = @('dashboard.html', 'dashboard.json', 'dashboard.md')
          foreach ($file in $dashboardFiles) {
            $sourcePath = "./library/reports/$file"
            if (Test-Path $sourcePath) {
              Copy-Item -Path $sourcePath -Destination $prDir -Force
              Write-Host "‚úÖ Copied $file from library/reports/" -ForegroundColor Green
            }
          }
          
          # Copy metrics
          if (Test-Path "./library/reports/metrics") {
            Copy-Item -Path "./library/reports/metrics" -Destination "$prDir/metrics" -Recurse -Force
            Write-Host "‚úÖ Copied metrics JSONs" -ForegroundColor Green
          } else {
            Write-Host "‚ö†Ô∏è Metrics output not found at library/reports/metrics/" -ForegroundColor Yellow
          }
          
          # Copy legacy reports
          if (Test-Path "./library/reports") {
            Get-ChildItem -Path "./library/reports" -Recurse -Exclude "pr-*" | ForEach-Object {
              $targetPath = $_.FullName.Replace("./library/reports", $prDir)
              if ($_.PSIsContainer) {
                New-Item -ItemType Directory -Path $targetPath -Force | Out-Null
              } else {
                $targetDir = Split-Path $targetPath -Parent
                New-Item -ItemType Directory -Path $targetDir -Force | Out-Null
                Copy-Item -Path $_.FullName -Destination $targetPath -Force
              }
            }
          }
          
          # Copy artifacts
          if (Test-Path "./artifacts") {
            Copy-Item -Path "./artifacts" -Destination "$prDir/artifacts" -Recurse -Force
            Write-Host "‚úÖ Copied artifacts" -ForegroundColor Green
          }
          
          # Report final status (warn but don't fail - dashboard is best-effort)
          if ($failedSteps.Count -gt 0) {
            Write-Host "`n‚ö†Ô∏è Dashboard generation completed with warnings:" -ForegroundColor Yellow
            foreach ($step in $failedSteps) {
              Write-Host "  - $step" -ForegroundColor Yellow
            }
            Write-Host "`n‚úÖ Partial dashboard generated" -ForegroundColor Green
            exit 0  # Don't fail - we want partial dashboard deployed
          } else {
            Write-Host "`n‚úÖ Complete dashboard generated with modern modular architecture" -ForegroundColor Green
            exit 0
          }

      - name: üì¶ Upload Dashboard
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: pr-${{ env.PR_NUMBER }}-dashboard
          path: library/reports/pr-${{ env.PR_NUMBER }}/**
          retention-days: 30
          if-no-files-found: warn

      - name: üåê Deploy to GitHub Pages
        if: hashFiles('./library/reports/pr-${{ env.PR_NUMBER }}/**') != ''
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./library/reports/pr-${{ env.PR_NUMBER }}
          destination_dir: pr-${{ env.PR_NUMBER }}
          keep_files: true
          enable_jekyll: true
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy PR #${{ env.PR_NUMBER }} dashboard'

      - name: üí¨ Post Final Summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            // Use needs.<job>.result instead of outputs.status for reliable status checking
            // .result is always available even when jobs fail, while outputs may be undefined
            const validationStatus = '${{ needs.quick-validation.result }}';
            const buildStatus = '${{ needs.build.result }}';
            const qualityStatus = '${{ needs.quality-analysis.result }}';
            
            const validationIcon = validationStatus === 'success' ? '‚úÖ' : '‚ùå';
            const buildIcon = buildStatus === 'success' ? '‚úÖ' : '‚ùå';
            const qualityIcon = qualityStatus === 'success' ? '‚úÖ' : '‚ùå';
            
            const pagesUrl = `https://${context.repo.owner}.github.io/${context.repo.repo}/pr-${process.env.PR_NUMBER}/`;
            const dockerImageTag = `ghcr.io/${context.repo.owner}/${context.repo.repo}:pr-${process.env.PR_NUMBER}`.toLowerCase();
            const workflowUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            
            // Convert result status to user-friendly text
            const statusText = (result) => {
              switch(result) {
                case 'success': return 'PASSED';
                case 'failure': return 'FAILED';
                case 'cancelled': return 'CANCELLED';
                case 'skipped': return 'SKIPPED';
                default: return result.toUpperCase();
              }
            };
            
            const summary = `## üöÄ PR Validation & Build - COMPLETE
            
            ### üìã Phase Results
            
            | Phase | Status | Details |
            |-------|--------|---------|
            | ${validationIcon} **Quick Validation** | ${statusText(validationStatus)} | Syntax, Config, Manifests |
            | ${buildIcon} **Build & Package** | ${statusText(buildStatus)} | Runtime packages created |
            | ${qualityIcon} **Quality Analysis** | ${statusText(qualityStatus)} | PSScriptAnalyzer, Component quality |
            | üìä **Dashboard** | Generated | Comprehensive metrics dashboard |
            
            ### üîó Key Links
            
            - üìä **Dashboard**: [View PR Dashboard](${pagesUrl})
            - üß™ **Tests**: See [Test Execution workflow](${context.payload.repository.html_url}/actions/workflows/03-test-execution.yml) for comprehensive test results
            - üê≥ **Docker**: See [Deploy PR Environment workflow](${context.payload.repository.html_url}/actions/workflows/04-deploy-pr-environment.yml) for container deployment
            - üì¶ **Artifacts**: [Download from this run](${workflowUrl})
            
            ### üê≥ Docker Image
            
            **Expected Image Tag:** \`${dockerImageTag}\`
            
            **Quick Test:**
            \`\`\`bash
            # Pull and run the PR container
            docker pull ${dockerImageTag}
            docker run -it --rm ${dockerImageTag}
            \`\`\`
            
            ### üì¶ Available Artifacts
            
            - ‚úÖ Build packages (ZIP, TAR.GZ)
            - ‚úÖ Build metadata (JSON)
            - ‚úÖ Quality analysis results (PSScriptAnalyzer, Component quality)
            - ‚úÖ Comprehensive dashboard (HTML, JSON, Markdown)
            - üê≥ Docker image (from deploy-pr-environment workflow)
            - üß™ Test results (from test-execution workflow)
            
            ### üéØ Next Steps
            
            1. **Review Dashboard**: [View comprehensive metrics](${pagesUrl})
            2. **Check Tests**: Review test execution results in separate workflow
            3. **Test Docker Image**: Pull and test the container image
            4. **Review Quality**: Check PSScriptAnalyzer and quality metrics
            
            ---
            *‚ö° Powered by AitherZero PR Ecosystem - Validation ‚Üí Build ‚Üí Quality ‚Üí Dashboard*
            
            [View Workflow Run](${workflowUrl})`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: process.env.PR_NUMBER
            });
            
            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('PR Validation & Build - COMPLETE')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: summary
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: process.env.PR_NUMBER,
                body: summary
              });
            }
