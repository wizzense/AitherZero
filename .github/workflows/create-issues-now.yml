---
name: ğŸš¨ Create Issues Now

on:
  workflow_dispatch:
    inputs:
      analysis_type:
        description: 'Type of analysis to run'
        type: choice
        options: ['all', 'security-only', 'code-quality-only']
        default: 'all'
      create_actual_issues:
        description: 'Create actual GitHub issues (not dry run)'
        type: boolean
        default: true

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  create-issues:
    name: ğŸ¤– Create Issues from Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ§ª Run Tests and Check for Failures
        shell: pwsh
        run: |
          Write-Host "ğŸ§ª Running tests to detect current failures..." -ForegroundColor Cyan
          
          # Run unit tests and capture results
          try {
            ./automation-scripts/0402_Run-UnitTests.ps1 -OutputPath "./test-results" -ContinueOnError
          } catch {
            Write-Warning "Some tests may have failed - this is expected for issue detection"
          }
          
          # Run PSScriptAnalyzer
          try {
            ./automation-scripts/0404_Run-PSScriptAnalyzer.ps1 -OutputPath "./reports/psscriptanalyzer-results.json"
          } catch {
            Write-Warning "PSScriptAnalyzer analysis completed with findings"
          }
          
          Write-Host "âœ… Test execution completed" -ForegroundColor Green

      - name: ğŸ” Run Issue Analysis and Creation
        shell: pwsh
        run: |
          Write-Host "ğŸš¨ Creating GitHub Issues from Analysis Findings..." -ForegroundColor Red
          Write-Host "Analysis Type: ${{ github.event.inputs.analysis_type }}" -ForegroundColor Cyan
          Write-Host "Create Issues: ${{ github.event.inputs.create_actual_issues }}" -ForegroundColor Cyan
          Write-Host ""
          
          # Ensure the script exists
          if (-not (Test-Path "./automation-scripts/0815_Setup-IssueManagement.ps1")) {
            Write-Error "Issue management script not found!"
            exit 1
          }
          
          # Run the enhanced issue management script (now includes tests and bugs)
          if ("${{ github.event.inputs.create_actual_issues }}" -eq "true") {
            Write-Host "ğŸ”¥ CREATING ACTUAL GITHUB ISSUES..." -ForegroundColor Red
            ./automation-scripts/0815_Setup-IssueManagement.ps1 -CreateIssues -AnalysisPath "./reports"
          } else {
            Write-Host "ğŸ§ª DRY RUN - Previewing issues that would be created..." -ForegroundColor Yellow  
            ./automation-scripts/0815_Setup-IssueManagement.ps1 -DryRun -AnalysisPath "./reports"
          }
          
          Write-Host ""
          Write-Host "âœ… Issue creation workflow completed!" -ForegroundColor Green

      - name: ğŸ“Š Report Results
        if: always()
        shell: pwsh
        run: |
          Write-Host "ğŸ“‹ Issue Creation Summary" -ForegroundColor Cyan
          Write-Host "=====================" 
          
          if ("${{ github.event.inputs.create_actual_issues }}" -eq "true") {
            Write-Host "âœ… Issues have been created in the repository" -ForegroundColor Green
            Write-Host "ğŸ”— Check: https://github.com/${{ github.repository }}/issues?q=is:issue+is:open+label:automated-issue" -ForegroundColor Cyan
          } else {
            Write-Host "ğŸ§ª This was a dry run - no actual issues were created" -ForegroundColor Yellow
            Write-Host "ğŸ’¡ Set 'Create actual GitHub issues' to true to create real issues" -ForegroundColor Blue
          }
          
          Write-Host ""
          Write-Host "ğŸ¯ Expected issue types:" -ForegroundColor White
          Write-Host "â€¢ ğŸš¨ Critical Security Vulnerabilities" -ForegroundColor Red
          Write-Host "â€¢ ğŸ” Exposed Credentials" -ForegroundColor Red  
          Write-Host "â€¢ ğŸŒ Insecure Protocol Usage" -ForegroundColor Yellow
          Write-Host "â€¢ ğŸ§ª Test Failures" -ForegroundColor Red
          Write-Host "â€¢ ğŸ”´ Pester Unit Test Failures" -ForegroundColor Red
          Write-Host "â€¢ ğŸ› System Errors and Bugs" -ForegroundColor Yellow
          Write-Host "â€¢ âŒ PSScriptAnalyzer Errors" -ForegroundColor Yellow
          Write-Host "â€¢ âš ï¸ Code Quality Warnings" -ForegroundColor Gray