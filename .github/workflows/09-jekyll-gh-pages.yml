# Jekyll site to GitHub Pages - Enhanced with Reports
# Coordinated deployment: only runs after tests complete and reports are generated
# Flow: Push â†’ Tests â†’ Dashboard â†’ Jekyll â†’ GitHub Pages
name: Deploy Jekyll with GitHub Pages dependencies preinstalled

'on':
  # NOTE: Push trigger removed - Jekyll now ONLY runs when triggered by dashboard workflow
  # This ensures Jekyll deployment happens AFTER tests run and reports are generated
  # The complete flow is: Push â†’ 03-test-execution â†’ 05-publish-reports-dashboard â†’ 09-jekyll-gh-pages
  #
  # Previous behavior: Jekyll ran on every push, potentially before tests completed
  # New behavior: Jekyll runs only after dashboard workflow triggers it (after tests complete)
  #
  # Benefits:
  # - Dashboard always includes latest test results
  # - No race conditions between test execution and deployment
  # - Single coordinated workflow chain

  # Triggered by 05-publish-reports-dashboard.yml after reports are generated
  workflow_dispatch:
    inputs:
      triggered_by:
        description: 'Workflow that triggered this deployment'
        required: false
        default: 'manual'
        type: string
      pr_number:
        description: 'PR number if triggered from PR workflow'
        required: false
        type: string
      reports_run_id:
        description: 'Run ID of the workflow that generated reports'
        required: false
        type: string

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write
  actions: read  # Required to download artifacts from other workflows

# Branch-specific concurrency to allow parallel deployments
concurrency:
  group: jekyll-pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Determine deployment configuration based on branch
  setup:
    name: Setup Deployment Configuration
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ steps.config.outputs.branch-name }}
      destination-dir: ${{ steps.config.outputs.destination-dir }}
      base-url: ${{ steps.config.outputs.base-url }}
      deployment-url: ${{ steps.config.outputs.deployment-url }}
    steps:
      - name: Configure Branch-Specific Deployment
        id: config
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "branch-name=${BRANCH}" >> $GITHUB_OUTPUT
          
          # Determine destination directory and base URL based on branch
          case "${BRANCH}" in
            "main")
              echo "destination-dir=." >> $GITHUB_OUTPUT
              echo "base-url=" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT
              ;;
            "dev")
              echo "destination-dir=dev" >> $GITHUB_OUTPUT
              echo "base-url=/dev" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/" >> $GITHUB_OUTPUT
              ;;
            "dev-staging")
              echo "destination-dir=dev-staging" >> $GITHUB_OUTPUT
              echo "base-url=/dev-staging" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev-staging/" >> $GITHUB_OUTPUT
              ;;
            "develop")
              echo "destination-dir=develop" >> $GITHUB_OUTPUT
              echo "base-url=/develop" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/develop/" >> $GITHUB_OUTPUT
              ;;
            *)
              # For ring branches, use branch name as-is
              BRANCH_SLUG=$(echo "${BRANCH}" | sed 's/[^a-zA-Z0-9-]/-/g')
              echo "destination-dir=${BRANCH_SLUG}" >> $GITHUB_OUTPUT
              echo "base-url=/${BRANCH_SLUG}" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${BRANCH_SLUG}/" >> $GITHUB_OUTPUT
              ;;
          esac
          
          echo "[OK] Branch: ${BRANCH}"
          echo "[Files] Destination: $(cat $GITHUB_OUTPUT | grep destination-dir | cut -d= -f2)"
          echo "[Link] Base URL: $(cat $GITHUB_OUTPUT | grep base-url | cut -d= -f2)"

  # Build job
  build:
    name: Build Jekyll Site
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: [Dashboard] Download Reports (if available)
        if: github.event.inputs.reports_run_id != ''
        uses: actions/download-artifact@v4
        continue-on-error: true
        with:
          name: combined-reports
          run-id: ${{ github.event.inputs.reports_run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: ./

      - name: [Report] Report Context
        run: |
          echo "ðŸ” Deployment Context:"
          echo "  - Triggered by: ${{ github.event.inputs.triggered_by || 'push' }}"
          echo "  - Branch: ${{ needs.setup.outputs.branch-name }}"
          if [ -n "${{ github.event.inputs.pr_number }}" ]; then
            echo "  - PR: #${{ github.event.inputs.pr_number }}"
          fi
          if [ -n "${{ github.event.inputs.reports_run_id }}" ]; then
            echo "  - Reports from run: ${{ github.event.inputs.reports_run_id }}"
          fi
          echo ""
          
          # Check if reports were downloaded
          if [ -d "./library/reports" ]; then
            echo "[OK] Reports found:"
            ls -la ./library/reports/ | head -10
          else
            echo "[Info]  No reports artifact (this is normal for documentation-only changes)"
          fi

      - name: Create Branch-Specific Config
        run: |
          BRANCH="${{ needs.setup.outputs.branch-name }}"
          BASE_URL="${{ needs.setup.outputs.base-url }}"
          
          echo "[Edit] Creating branch-specific Jekyll configuration..."
          
          # Create a branch-specific config override
          cat > _config_branch.yml <<EOF
          # Branch-specific configuration for ${BRANCH}
          baseurl: "${BASE_URL}"
          branch: "${BRANCH}"
          deployment_time: "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          EOF
          
          echo "[OK] Created _config_branch.yml:"
          cat _config_branch.yml

      - name: Copy MCP Server Documentation
        run: |
          echo "[Doc] Copying MCP server documentation to docs..."
          mkdir -p ./library/mcp-server
          if [ -f "./mcp-server/README.md" ]; then
            cp ./mcp-server/README.md ./library/mcp-server/index.md
            echo "[OK] Copied MCP server README"
          fi
          if [ -f "./mcp-server/QUICKSTART.md" ]; then
            cp ./mcp-server/QUICKSTART.md ./library/mcp-server/quickstart.md
            echo "[OK] Copied MCP server quickstart"
          fi
          if [ -f "./mcp-server/IMPLEMENTATION-SUMMARY.md" ]; then
            cp ./mcp-server/IMPLEMENTATION-SUMMARY.md ./library/mcp-server/implementation.md
            echo "[OK] Copied MCP server implementation summary"
          fi

      - name: Create Branch Info Page
        run: |
          BRANCH="${{ needs.setup.outputs.branch-name }}"
          DEPLOYMENT_URL="${{ needs.setup.outputs.deployment-url }}"
          
          echo "[Doc] Creating branch information page..."
          
          cat > branch-info.md <<EOF
          ---
          layout: default
          title: Branch Information - ${BRANCH}
          ---
          
          # [Branch] Branch: ${BRANCH}
          
          **Deployment Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Commit:** \`${{ github.sha }}\`  
          **Deployment URL:** [${DEPLOYMENT_URL}](${DEPLOYMENT_URL})
          
          ## [Dashboard] Available Resources
          
          - [Dashboard](${BASE_URL}/library/reports/dashboard.html)
          - [Test Reports](${BASE_URL}/library/reports/)
          - [Documentation](${BASE_URL}/docs/)
          - [Main Site](../)
          
          ## [Process] Other Branches
          
          - [Main Branch](../) - Production deployment
          - [Dev Branch](../dev/) - Development testing
          - [Dev-Staging Branch](../dev-staging/) - Staging environment
          
          ---
          *This is a branch-specific deployment. Test results and reports are specific to the ${BRANCH} branch.*
          EOF
          
          echo "[OK] Created branch-info.md"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: Install Jekyll and Dependencies
        run: |
          gem install jekyll bundler
          bundle install || bundle init && bundle add jekyll

      - name: Build with Jekyll
        run: |
          echo "ðŸ”¨ Building Jekyll site with branch-specific configuration..."
          
          # Build with both base config and branch override
          bundle exec jekyll build \
            --config _config.yml,_config_branch.yml \
            --destination ./_site \
            --verbose
          
          echo "[OK] Jekyll build completed"
          
          # Show what was built
          echo "[Files] Build output:"
          ls -la ./_site/

      - name: [Files] Stage Build for Branch-Specific Deployment
        run: |
          DEST_DIR="${{ needs.setup.outputs.destination-dir }}"
          BRANCH="${{ needs.setup.outputs.branch-name }}"
          
          echo "[Files] Staging build for branch-specific deployment..."
          echo "  - Branch: ${BRANCH}"
          echo "  - Destination directory: ${DEST_DIR}"
          
          # For non-root deployments, reorganize the site structure
          if [ "${DEST_DIR}" != "." ] && [ -n "${DEST_DIR}" ]; then
            # Validate DEST_DIR doesn't contain path traversal sequences
            if [[ "${DEST_DIR}" =~ \.\. ]] || [[ "${DEST_DIR}" =~ ^/ ]]; then
              echo "[Error] Invalid destination directory: ${DEST_DIR}"
              exit 1
            fi
            
            # Verify Jekyll build produced content
            if [ ! "$(ls -A ./_site)" ]; then
              echo "[Error] Error: Jekyll build produced empty _site directory"
              exit 1
            fi
            
            echo "[Process] Reorganizing site for branch-specific path: /${DEST_DIR}/"
            
            # Create temporary staging directory
            mkdir -p ./_site_staged
            
            # Move built site to the branch-specific subdirectory
            mkdir -p "./_site_staged/${DEST_DIR}"
            
            # Move regular files and directories if any exist
            if ls ./_site/* >/dev/null 2>&1; then
              mv ./_site/* "./_site_staged/${DEST_DIR}/"
            fi
            
            # Move hidden files (dotfiles), excluding . and ..
            shopt -s dotglob nullglob
            for item in ./_site/.*; do
              if [[ "$(basename "$item")" != "." ]] && [[ "$(basename "$item")" != ".." ]]; then
                mv "$item" "./_site_staged/${DEST_DIR}/"
              fi
            done
            shopt -u dotglob nullglob
            
            # Replace _site with staged version
            rm -rf ./_site
            mv ./_site_staged ./_site
            
            echo "[OK] Site staged under /${DEST_DIR}/"
            echo "[Files] Final structure:"
            ls -la ./_site/
            if [ -d "./_site/${DEST_DIR}" ]; then
              echo "[Files] Branch directory contents:"
              ls -la "./_site/${DEST_DIR}/"
            fi
          else
            echo "[Info]  Main branch - deploying to root (no reorganization needed)"
            echo "[Files] Site structure:"
            ls -la ./_site/
          fi

      - name: [Upload] Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./_site

  # Deployment job using actions/deploy-pages (unified with dashboard workflow)
  deploy:
    name: [Deploy] Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [setup, build]
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: [Setup] Setup Pages
        uses: actions/configure-pages@v5

      - name: [Deploy] Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: [Report] Report Deployment
        shell: pwsh
        env:
          BRANCH: ${{ needs.setup.outputs.branch-name }}
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          BASE_URL: ${{ needs.setup.outputs.base-url }}
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
        run: |
          Write-Host "[OK] Successfully deployed to GitHub Pages!" -ForegroundColor Green
          Write-Host "[Branch] Branch: $env:BRANCH" -ForegroundColor Cyan
          Write-Host "[Link] Deployment URL: $env:PAGE_URL" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "[Dashboard] Available Pages:" -ForegroundColor Yellow
          Write-Host "  - Main Dashboard: ${env:PAGE_URL}library/reports/dashboard.html"
          Write-Host "  - Branch Info: ${env:PAGE_URL}branch-info.html"
          Write-Host "  - All Reports: ${env:PAGE_URL}library/reports/"
          
          if ($env:PR_NUMBER) {
            Write-Host "  - PR #$env:PR_NUMBER Dashboard: ${env:PAGE_URL}library/reports/pr-$env:PR_NUMBER/" -ForegroundColor Green
          }
          
          Write-Host ""
          Write-Host "[Time] Deployment complete! Pages will be available in ~1-2 minutes." -ForegroundColor Cyan

      - name: [Comment] Update PR Comment (if from PR)
        if: github.event.inputs.pr_number != ''
        uses: actions/github-script@v7
        env:
          PAGE_URL: ${{ steps.deployment.outputs.page_url }}
          PR_NUMBER: ${{ github.event.inputs.pr_number }}
          REPOSITORY: ${{ github.repository }}
        with:
          script: |
            const pageUrl = process.env.PAGE_URL;
            const prNumber = process.env.PR_NUMBER;
            const repository = process.env.REPOSITORY;
            
            const dashboardUrl = `${pageUrl}library/reports/dashboard.html`;
            const prDashboardUrl = `${pageUrl}library/reports/pr-${prNumber}/`;
            
            const imageNameLower = repository.toLowerCase();
            const dynamicPort = 8080 + (parseInt(prNumber) % 100);
            const packageUrl = `https://github.com/${repository}/pkgs/container/aitherzero`;
            const containerName = `aitherzero-pr-${prNumber}`;
            
            const comment = `## [Dashboard] Dashboard & Container Published

[OK] **Deployment complete!** Your PR dashboard is now live.

### ðŸ“ Live URLs

- [Main] **Main Dashboard:** [${dashboardUrl}](${dashboardUrl})
- [Dashboard] **PR #${prNumber} Dashboard:** [${prDashboardUrl}](${prDashboardUrl})
- [Reports] **All Reports:** [${pageUrl}library/reports/](${pageUrl}library/reports/)

### [Docker] Docker Container

\`\`\`bash
# Pull and run this PR's container
docker pull ghcr.io/${imageNameLower}:pr-${prNumber}-latest
docker run -it -p ${dynamicPort}:8080 ghcr.io/${imageNameLower}:pr-${prNumber}-latest
\`\`\`

- **Container Name:** \`${containerName}\`
- **Port:** \`${dynamicPort}\`
- **Registry:** [${packageUrl}](${packageUrl})

---
*Deployed:* ${new Date().toUTCString()}`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(c => 
              c.user.login === 'github-actions[bot]' && 
              (c.body.includes('Dashboard & Reports Prepared') || c.body.includes('Dashboard & Container Published'))
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
              console.log('[OK] Updated PR comment with deployment URLs');
            }

      - name: [Error] Diagnose Deployment Failure
        if: failure()
        run: |
          echo "::error::[Error] GitHub Pages deployment failed!"
          echo "::error::"
          echo "::error::Common causes:"
          echo "::error::  1. GitHub Pages not enabled in repository settings"
          echo "::error::  2. GitHub Pages source not set to 'GitHub Actions'"
          echo "::error::  3. Workflow permissions insufficient"
          echo "::error::"
          echo "::error::Resolution steps:"
          echo "::error::  â€¢ Settings â†’ Pages â†’ Source â†’ 'GitHub Actions'"
          echo "::error::  â€¢ Settings â†’ Actions â†’ General â†’ 'Read and write permissions'"
          echo "::error::"
          echo "::error::Current deployment method: actions/deploy-pages@v4"
          echo "::error::Requires GitHub Pages source to be set to 'GitHub Actions'"
