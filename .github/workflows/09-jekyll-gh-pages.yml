# Jekyll site to GitHub Pages - Enhanced with Reports
# Branch-specific deployments: main â†’ /, dev â†’ /dev, dev-staging â†’ /dev-staging
name: Deploy Jekyll with GitHub Pages dependencies preinstalled

'on':
  # Runs on pushes targeting the default branch and ring branches
  push:
    branches:
      [
        "main",
        "dev",
        "develop",
        "dev-staging",
        "ring-0",
        "ring-0-integrations",
        "ring-1",
        "ring-1-integrations",
        "ring-2",
      ]
    paths:
      - "library/reports/**"
      - "library/**"
      - "index.md"
      - "_config.yml"
      - "integrations/mcp-server/README.md"
      - "integrations/mcp-server/QUICKSTART.md"

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write  # Required for peaceiris/actions-gh-pages
  pages: write
  id-token: write

# Branch-specific concurrency to allow parallel deployments
concurrency:
  group: "pages-${{ github.ref_name }}"
  cancel-in-progress: false

jobs:
  # Determine deployment configuration based on branch
  setup:
    name: Setup Deployment Configuration
    runs-on: ubuntu-latest
    outputs:
      branch-name: ${{ steps.config.outputs.branch-name }}
      destination-dir: ${{ steps.config.outputs.destination-dir }}
      base-url: ${{ steps.config.outputs.base-url }}
      deployment-url: ${{ steps.config.outputs.deployment-url }}
    steps:
      - name: Configure Branch-Specific Deployment
        id: config
        run: |
          BRANCH="${{ github.ref_name }}"
          echo "branch-name=${BRANCH}" >> $GITHUB_OUTPUT
          
          # Determine destination directory and base URL based on branch
          case "${BRANCH}" in
            "main")
              echo "destination-dir=." >> $GITHUB_OUTPUT
              echo "base-url=" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT
              ;;
            "dev")
              echo "destination-dir=dev" >> $GITHUB_OUTPUT
              echo "base-url=/dev" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/" >> $GITHUB_OUTPUT
              ;;
            "dev-staging")
              echo "destination-dir=dev-staging" >> $GITHUB_OUTPUT
              echo "base-url=/dev-staging" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev-staging/" >> $GITHUB_OUTPUT
              ;;
            "develop")
              echo "destination-dir=develop" >> $GITHUB_OUTPUT
              echo "base-url=/develop" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/develop/" >> $GITHUB_OUTPUT
              ;;
            *)
              # For ring branches, use branch name as-is
              BRANCH_SLUG=$(echo "${BRANCH}" | sed 's/[^a-zA-Z0-9-]/-/g')
              echo "destination-dir=${BRANCH_SLUG}" >> $GITHUB_OUTPUT
              echo "base-url=/${BRANCH_SLUG}" >> $GITHUB_OUTPUT
              echo "deployment-url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/${BRANCH_SLUG}/" >> $GITHUB_OUTPUT
              ;;
          esac
          
          echo "âœ… Branch: ${BRANCH}"
          echo "ðŸ“‚ Destination: $(cat $GITHUB_OUTPUT | grep destination-dir | cut -d= -f2)"
          echo "ðŸ”— Base URL: $(cat $GITHUB_OUTPUT | grep base-url | cut -d= -f2)"

  # Build job
  build:
    name: Build Jekyll Site
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create Branch-Specific Config
        run: |
          BRANCH="${{ needs.setup.outputs.branch-name }}"
          BASE_URL="${{ needs.setup.outputs.base-url }}"
          
          echo "ðŸ“ Creating branch-specific Jekyll configuration..."
          
          # Create a branch-specific config override
          cat > _config_branch.yml <<EOF
          # Branch-specific configuration for ${BRANCH}
          baseurl: "${BASE_URL}"
          branch: "${BRANCH}"
          deployment_time: "$(date -u +"%Y-%m-%d %H:%M:%S UTC")"
          EOF
          
          echo "âœ… Created _config_branch.yml:"
          cat _config_branch.yml

      - name: Copy MCP Server Documentation
        run: |
          echo "ðŸ“„ Copying MCP server documentation to docs..."
          mkdir -p ./library/mcp-server
          if [ -f "./mcp-server/README.md" ]; then
            cp ./mcp-server/README.md ./library/mcp-server/index.md
            echo "âœ… Copied MCP server README"
          fi
          if [ -f "./mcp-server/QUICKSTART.md" ]; then
            cp ./mcp-server/QUICKSTART.md ./library/mcp-server/quickstart.md
            echo "âœ… Copied MCP server quickstart"
          fi
          if [ -f "./mcp-server/IMPLEMENTATION-SUMMARY.md" ]; then
            cp ./mcp-server/IMPLEMENTATION-SUMMARY.md ./library/mcp-server/implementation.md
            echo "âœ… Copied MCP server implementation summary"
          fi

      - name: Create Branch Info Page
        run: |
          BRANCH="${{ needs.setup.outputs.branch-name }}"
          DEPLOYMENT_URL="${{ needs.setup.outputs.deployment-url }}"
          
          echo "ðŸ“„ Creating branch information page..."
          
          cat > branch-info.md <<EOF
          ---
          layout: default
          title: Branch Information - ${BRANCH}
          ---
          
          # ðŸŒ¿ Branch: ${BRANCH}
          
          **Deployment Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Commit:** \`${{ github.sha }}\`  
          **Deployment URL:** [${DEPLOYMENT_URL}](${DEPLOYMENT_URL})
          
          ## ðŸ“Š Available Resources
          
          - [Dashboard](${BASE_URL}/library/reports/dashboard.html)
          - [Test Reports](${BASE_URL}/library/reports/)
          - [Documentation](${BASE_URL}/docs/)
          - [Main Site](../)
          
          ## ðŸ”„ Other Branches
          
          - [Main Branch](../) - Production deployment
          - [Dev Branch](../dev/) - Development testing
          - [Dev-Staging Branch](../dev-staging/) - Staging environment
          
          ---
          *This is a branch-specific deployment. Test results and reports are specific to the ${BRANCH} branch.*
          EOF
          
          echo "âœ… Created branch-info.md"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'
          bundler-cache: false

      - name: Install Jekyll and Dependencies
        run: |
          gem install jekyll bundler
          bundle install || bundle init && bundle add jekyll

      - name: Build with Jekyll
        run: |
          echo "ðŸ”¨ Building Jekyll site with branch-specific configuration..."
          
          # Build with both base config and branch override
          bundle exec jekyll build \
            --config _config.yml,_config_branch.yml \
            --destination ./_site \
            --verbose
          
          echo "âœ… Jekyll build completed"
          
          # Show what was built
          echo "ðŸ“‚ Build output:"
          ls -la ./_site/

      - name: Upload Build Artifact
        uses: actions/upload-artifact@v4
        with:
          name: jekyll-site-${{ needs.setup.outputs.branch-name }}
          path: ./_site/
          retention-days: 7

  # Deployment job using peaceiris/actions-gh-pages for branch-specific deployments
  deploy:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: [setup, build]
    steps:
      - name: Download Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: jekyll-site-${{ needs.setup.outputs.branch-name }}
          path: ./_site

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./_site
          destination_dir: ${{ needs.setup.outputs.destination-dir }}
          keep_files: true
          enable_jekyll: false  # Already built
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
          commit_message: 'Deploy ${{ needs.setup.outputs.branch-name }} branch to GitHub Pages'

      - name: Report Deployment
        shell: pwsh
        env:
          BRANCH: ${{ needs.setup.outputs.branch-name }}
          DEPLOYMENT_URL: ${{ needs.setup.outputs.deployment-url }}
          BASE_URL: ${{ needs.setup.outputs.base-url }}
        run: |
          Write-Host "âœ… Successfully deployed to GitHub Pages!" -ForegroundColor Green
          Write-Host "ðŸŒ¿ Branch: $env:BRANCH" -ForegroundColor Cyan
          Write-Host "ðŸ”— Deployment URL: $env:DEPLOYMENT_URL" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "ðŸ“Š Available Pages:" -ForegroundColor Yellow
          Write-Host "  - Branch Info: ${env:DEPLOYMENT_URL}branch-info.html"
          Write-Host "  - Dashboard: ${env:DEPLOYMENT_URL}library/reports/dashboard.html"
          Write-Host "  - Reports: ${env:DEPLOYMENT_URL}library/reports/"
          Write-Host "  - Docs: ${env:DEPLOYMENT_URL}docs/"
          Write-Host ""
          Write-Host "ðŸ”„ Other Deployments:" -ForegroundColor Yellow
          Write-Host "  - Main: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          Write-Host "  - Dev: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev/"
          Write-Host "  - Dev-Staging: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/dev-staging/"
          Write-Host ""
          Write-Host "â±ï¸ Deployment Duration: <5 minutes is normal" -ForegroundColor Cyan

      - name: Diagnose Deployment Failure
        if: failure()
        run: |
          echo "::error::âŒ GitHub Pages deployment failed!"
          echo "::error::"
          echo "::error::Common causes:"
          echo "::error::  1. GitHub Pages not enabled in repository settings"
          echo "::error::  2. Workflow permissions insufficient (need write access)"
          echo "::error::  3. Pages source not set to 'GitHub Actions' or 'gh-pages branch'"
          echo "::error::"
          echo "::error::Resolution steps:"
          echo "::error::  â€¢ Settings â†’ Pages â†’ Source â†’ 'gh-pages branch' (for peaceiris/actions-gh-pages)"
          echo "::error::  â€¢ Settings â†’ Actions â†’ General â†’ 'Read and write permissions'"
          echo "::error::"
          echo "::error::See DEPLOYMENT-DIAGNOSIS.md for detailed troubleshooting"
