name: 🗂️ Project Index Automation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'domains/**'
      - 'automation-scripts/**'
      - 'infrastructure/**'
      - 'tests/**'
      - 'orchestration/**'
      - 'docs/**'
      - '**/*.md'
      - '**/*.ps1'
      - '**/*.psm1'
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [ main, develop ]
    paths:
      - 'domains/**'
      - 'automation-scripts/**'
      - 'infrastructure/**'
      - 'tests/**'
      - 'orchestration/**'
      - 'docs/**'
      - '**/*.md'
      - '**/*.ps1'
      - '**/*.psm1'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Index generation mode'
        required: true
        default: 'Incremental'
        type: choice
        options:
        - Full
        - Incremental
        - Verify

jobs:
  cleanup-legacy-branches:
    name: 🧹 Cleanup Legacy Auto-Index Branches
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: 🔍 Find and Delete Legacy Auto-Index Branches
      uses: actions/github-script@v7
      with:
        script: |
          const prNumber = context.issue.number;
          const autoBranchName = `auto-index/${prNumber}`;
          const repo = context.repo;
          
          core.info(`PR #${prNumber} was closed, checking for legacy auto-index branches...`);
          
          // Try to delete the auto-index branch if it exists
          try {
            await github.rest.git.getRef({
              owner: repo.owner,
              repo: repo.repo,
              ref: `heads/${autoBranchName}`
            });
            
            core.info(`Found legacy branch ${autoBranchName}, deleting it...`);
            await github.rest.git.deleteRef({
              owner: repo.owner,
              repo: repo.repo,
              ref: `heads/${autoBranchName}`
            });
            core.info(`✅ Deleted legacy branch ${autoBranchName}`);
          } catch (error) {
            if (error.status === 404) {
              core.info(`No legacy branch ${autoBranchName} found (this is expected for new PRs)`);
            } else {
              core.warning(`Failed to delete branch ${autoBranchName}: ${error.message}`);
            }
          }

  generate-indexes:
    name: 🔄 Generate Project Indexes
    if: github.event.action != 'closed'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ⚡ Setup PowerShell
      shell: pwsh
      run: |
        Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)" -ForegroundColor Green
        Write-Host "OS: $($PSVersionTable.OS)" -ForegroundColor Green
          
    - name: 🏗️ Initialize AitherZero
      shell: pwsh
      run: |
        Write-Host "Initializing AitherZero environment..." -ForegroundColor Cyan
        
        # Import the main module
        Import-Module ./AitherZero.psd1 -Force
        Get-Module AitherZero
        
        Write-Host "AitherZero initialized successfully" -ForegroundColor Green
        
    - name: 🗂️ Generate Project Indexes
      shell: pwsh
      run: |
        Write-Host "Starting automated index generation..." -ForegroundColor Cyan
        
        # Set parameters based on trigger
        $mode = if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
          '${{ github.event.inputs.mode }}'
        } elseif ('${{ github.event_name }}' -eq 'pull_request') {
          'Incremental'
        } elseif ('${{ github.event_name }}' -eq 'push' -and ('${{ github.ref }}' -eq 'refs/heads/main' -or '${{ github.ref }}' -eq 'refs/heads/develop')) {
          # Use Full mode on main/develop to regenerate all indexes after merge
          # This resolves any conflicts from feature branch merges
          'Full'
        } else {
          'Incremental'
        }
        
        Write-Host "Mode: $mode" -ForegroundColor White
        Write-Host "Event: ${{ github.event_name }}" -ForegroundColor White
        Write-Host "Ref: ${{ github.ref }}" -ForegroundColor White
        
        # Run index generation with Force flag on main/develop pushes
        try {
          if ($mode -eq 'Full') {
            ./automation-scripts/0745_Generate-ProjectIndexes.ps1 -Mode $mode -Force
            Write-Host "Full index regeneration completed (post-merge)" -ForegroundColor Green
          } else {
            ./automation-scripts/0745_Generate-ProjectIndexes.ps1 -Mode $mode
            Write-Host "Index generation completed successfully" -ForegroundColor Green
          }
        } catch {
          Write-Error "Index generation failed: $_"
          exit 1
        }
        
    - name: 📊 Generate Index Report
      shell: pwsh
      run: |
        Write-Host "Parsing index report..." -ForegroundColor Cyan
        
        # Read the JSON report generated by the script
        $reportPath = ".aitherzero-index-report.json"
        if (Test-Path $reportPath) {
          $report = Get-Content $reportPath | ConvertFrom-Json
          
          Write-Host "Index Report Summary:" -ForegroundColor White
          Write-Host "  Mode: $($report.Mode)" -ForegroundColor White
          Write-Host "  Duration: $($report.Duration.TotalSeconds)s" -ForegroundColor White
          Write-Host "  Total Directories: $($report.Statistics.TotalDirectories)" -ForegroundColor White
          Write-Host "  Updated: $($report.Statistics.UpdatedIndexes)" -ForegroundColor Green
          Write-Host "  Skipped: $($report.Statistics.SkippedIndexes)" -ForegroundColor Gray
          Write-Host "  Failed: $($report.Statistics.FailedIndexes)" -ForegroundColor $(if ($report.Statistics.FailedIndexes -gt 0) { 'Red' } else { 'Gray' })
          
          # Export data for PR comment
          echo "INDEX_MODE=$($report.Mode)" >> $env:GITHUB_ENV
          echo "TOTAL_DIRS=$($report.Statistics.TotalDirectories)" >> $env:GITHUB_ENV
          echo "UPDATED_INDEXES=$($report.Statistics.UpdatedIndexes)" >> $env:GITHUB_ENV
          echo "SKIPPED_INDEXES=$($report.Statistics.SkippedIndexes)" >> $env:GITHUB_ENV
          echo "FAILED_INDEXES=$($report.Statistics.FailedIndexes)" >> $env:GITHUB_ENV
          echo "UPDATE_RATE=$($report.Statistics.UpdateRate)" >> $env:GITHUB_ENV
          echo "DURATION=$($report.Duration.TotalSeconds)" >> $env:GITHUB_ENV
          
          # Export updated paths as a multiline string
          $updatedPaths = $report.UpdatedPaths -join "`n"
          $delimiter = "EOF_PATHS_$(Get-Random)"
          echo "UPDATED_PATHS<<$delimiter" >> $env:GITHUB_ENV
          echo $updatedPaths >> $env:GITHUB_ENV
          echo $delimiter >> $env:GITHUB_ENV
        } else {
          Write-Host "Warning: Index report not found at $reportPath" -ForegroundColor Yellow
          # Set defaults
          echo "INDEX_MODE=Unknown" >> $env:GITHUB_ENV
          echo "TOTAL_DIRS=0" >> $env:GITHUB_ENV
          echo "UPDATED_INDEXES=0" >> $env:GITHUB_ENV
          echo "SKIPPED_INDEXES=0" >> $env:GITHUB_ENV
          echo "FAILED_INDEXES=0" >> $env:GITHUB_ENV
          echo "UPDATE_RATE=0" >> $env:GITHUB_ENV
          echo "DURATION=0" >> $env:GITHUB_ENV
          echo "UPDATED_PATHS=" >> $env:GITHUB_ENV
        }
        
    - name: ✅ Validate Index Updates (Main/Develop Branch)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
      shell: pwsh
      run: |
        Write-Host "Validating index updates..." -ForegroundColor Cyan
        
        # Check if there are uncommitted changes after generation
        $changes = git status --porcelain
        if ($changes) {
          Write-Warning "⚠️ Index files are out of date and need to be regenerated"
          Write-Host "The following index files need updates:" -ForegroundColor Yellow
          git status --porcelain | ForEach-Object { Write-Host "  $_" -ForegroundColor Yellow }
          
          Write-Host "`n💡 To fix this, contributors should:" -ForegroundColor Cyan
          Write-Host "  1. Run: ./automation-scripts/0745_Generate-ProjectIndexes.ps1 -Mode Full" -ForegroundColor White
          Write-Host "  2. Commit the updated index.md files to their PR" -ForegroundColor White
          Write-Host "  3. Push the changes before merging" -ForegroundColor White
          
          # Don't fail the workflow, just warn
          # Index updates should be part of the PR, not post-merge
          Write-Host "`nℹ️ Index validation complete (changes detected but not committed)" -ForegroundColor Cyan
        } else {
          Write-Host "✅ All index files are up to date" -ForegroundColor Green
        }
        
    - name: 🔍 Check for Uncommitted Index Changes (PR)
      if: github.event_name == 'pull_request'
      id: check-changes
      shell: pwsh
      run: |
        Write-Host "Checking for uncommitted index changes..." -ForegroundColor Cyan
        
        # Check if there are uncommitted changes after generation
        $changes = git status --porcelain | Where-Object { $_ -match '/index\.md$' }
        $hasUncommittedChanges = @($changes).Count -gt 0
        
        if ($hasUncommittedChanges) {
          Write-Host "✅ Index files were regenerated and need to be committed" -ForegroundColor Green
          Write-Host "Updated index files:" -ForegroundColor Cyan
          $changes | ForEach-Object { Write-Host "  $_" -ForegroundColor Cyan }
          
          # Set environment variable for PR comment
          echo "HAS_UNCOMMITTED_INDEXES=true" >> $env:GITHUB_ENV
          echo "UNCOMMITTED_COUNT=$($changes.Count)" >> $env:GITHUB_ENV
          echo "has_changes=true" >> $env:GITHUB_OUTPUT
        } else {
          Write-Host "✅ All index changes are already committed" -ForegroundColor Green
          echo "HAS_UNCOMMITTED_INDEXES=false" >> $env:GITHUB_ENV
          echo "UNCOMMITTED_COUNT=0" >> $env:GITHUB_ENV
          echo "has_changes=false" >> $env:GITHUB_OUTPUT
        }
        
    - name: 🔍 Check if PR is from Fork
      if: github.event_name == 'pull_request'
      id: check-fork
      shell: bash
      env:
        PR_HEAD_REPO: ${{ github.event.pull_request.head.repo.full_name }}
        BASE_REPO: ${{ github.repository }}
      run: |
        # Check if the PR is from a forked repository
        if [ "$PR_HEAD_REPO" != "$BASE_REPO" ]; then
          echo "is_fork=true" >> "$GITHUB_OUTPUT"
          echo "⚠️ PR is from a forked repository"
        else
          echo "is_fork=false" >> "$GITHUB_OUTPUT"
          echo "✅ PR is from the same repository"
        fi
        
    - name: 💾 Commit and Push Index Updates
      if: github.event_name == 'pull_request' && steps.check-changes.outputs.has_changes == 'true' && steps.check-fork.outputs.is_fork == 'false'
      shell: bash
      env:
        PR_BRANCH: ${{ github.event.pull_request.head.ref }}
        PR_NUMBER: ${{ github.event.pull_request.number }}
        UPDATED_COUNT: ${{ env.UNCOMMITTED_COUNT }}
        INDEX_MODE: ${{ env.INDEX_MODE }}
      run: |
        # Configure git
        git config user.name "github-actions[bot]"
        git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
        echo "Committing index changes to branch: $PR_BRANCH"
        
        # Checkout the PR branch
        git fetch origin "$PR_BRANCH" 2>&1 || { echo "Failed to fetch branch"; exit 1; }
        git checkout "$PR_BRANCH" 2>&1 || { echo "Failed to checkout branch"; exit 1; }
        
        # Add and commit index changes
        git add **/index.md .aitherzero-index-cache.json .aitherzero-index-report.json
        
        # Create commit message with details
        git commit -m "docs: update project indexes [auto-generated]" \
          -m "Automated index generation for PR #${PR_NUMBER}" \
          -m "" \
          -m "Updated: ${UPDATED_COUNT} index files" \
          -m "Mode: ${INDEX_MODE}" \
          -m "" \
          -m "This commit was automatically generated by the index automation workflow." \
          -m "It updates index.md files to reflect changes in the project structure."
        
        # Push directly to the PR branch
        git push origin "$PR_BRANCH" 2>&1 || { echo "Failed to push changes"; exit 1; }
        
        echo "✅ Committed and pushed index updates to $PR_BRANCH"
        
    - name: 💬 Comment on PR (Fork - Manual Update Required)
      if: github.event_name == 'pull_request' && steps.check-changes.outputs.has_changes == 'true' && steps.check-fork.outputs.is_fork == 'true'
      uses: actions/github-script@v7
      with:
        script: |
          const updatedCount = process.env.UPDATED_INDEXES || '0';
          const mode = process.env.INDEX_MODE || 'Unknown';
          
          const comment = `## 🔄 Index Update Required (Fork PR)
          
          **Index files need to be updated, but this PR is from a forked repository.**
          
          ### Summary
          - **Updated Indexes**: ${updatedCount} files
          - **Generation Mode**: ${mode}
          
          ### Action Required
          Since this PR is from a fork, the workflow cannot automatically commit the changes. Please run the following command locally and push the changes:
          
          \`\`\`bash
          ./automation-scripts/0745_Generate-ProjectIndexes.ps1 -Mode Incremental
          git add **/index.md
          git commit -m "docs: update project indexes [auto-generated]"
          git push
          \`\`\`
          
          ---
          *Generated by AitherZero Index Automation*`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
        
    - name: 💬 Comment on PR (Changes Committed)
      if: github.event_name == 'pull_request' && steps.check-changes.outputs.has_changes == 'true' && steps.check-fork.outputs.is_fork == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const updatedCount = process.env.UPDATED_INDEXES || '0';
          const mode = process.env.INDEX_MODE || 'Unknown';
          const duration = process.env.DURATION || '0';
          
          const comment = `## 🔄 Index Update Report
          
          **Project indexes have been automatically updated!**
          
          ### Summary
          - **Updated Indexes**: ${updatedCount} files
          - **Generation Mode**: ${mode}
          - **Duration**: ${duration}s
          
          ### Result
          The index files have been committed directly to this PR branch. No additional action is required.
          
          ---
          *Generated by AitherZero Index Automation*`;

          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
        
    - name: 💬 Comment on PR (Summary Only)
      if: github.event_name == 'pull_request' && steps.check-changes.outputs.has_changes == 'false'
      uses: actions/github-script@v7
      with:
        script: |
          const mode = process.env.INDEX_MODE || 'Unknown';
          const totalDirs = process.env.TOTAL_DIRS || '0';
          const updated = process.env.UPDATED_INDEXES || '0';
          const skipped = process.env.SKIPPED_INDEXES || '0';
          const failed = process.env.FAILED_INDEXES || '0';
          const updateRate = process.env.UPDATE_RATE || '0';
          const duration = process.env.DURATION || '0';
          const updatedPaths = process.env.UPDATED_PATHS || '';
          const hasUncommitted = process.env.HAS_UNCOMMITTED_INDEXES === 'true';
          const uncommittedCount = process.env.UNCOMMITTED_COUNT || '0';
          
          // Parse updated paths
          const pathList = updatedPaths.trim().split('\n').filter(p => p.trim().length > 0);
          const maxPathsToShow = 20;
          const hasMorePaths = pathList.length > maxPathsToShow;
          const displayPaths = pathList.slice(0, maxPathsToShow);
          
          // Build changed files section
          let changedFilesSection = '';
          if (parseInt(updated) > 0) {
            changedFilesSection = `
          ### 📝 Updated Index Files
          
          ${displayPaths.map(p => `- \`${p}\``).join('\n')}
          ${hasMorePaths ? `\n_...and ${pathList.length - maxPathsToShow} more directories_` : ''}
          `;
          } else {
            changedFilesSection = `
          ### ℹ️ No Changes Needed
          
          All index files are already up to date. No directories required regeneration.
          `;
          
          // Build status emoji
          const statusEmoji = parseInt(failed) > 0 ? '⚠️' : 'ℹ️';
          
          // Calculate percentages for skipped and failed
          const skippedPercent = totalDirs > 0 ? Math.round((skipped / totalDirs) * 100) : 0;
          const failedPercent = totalDirs > 0 ? Math.round((failed / totalDirs) * 100) : 0;
          
          const comment = `## ${statusEmoji} Project Index Update Report
          
          **Mode:** ${mode} | **Duration:** ${duration}s
          
          ### 📊 Statistics
          
          | Metric | Count | Percentage |
          |--------|-------|------------|
          | 📁 Total Directories Scanned | ${totalDirs} | 100% |
          | ✅ Indexes Updated | ${updated} | ${updateRate}% |
          | ⏭️ Skipped (No Changes) | ${skipped} | ${skippedPercent}% |
          | ❌ Failed | ${failed} | ${failedPercent}% |
          
          ${changedFilesSection}
          
          ### 🎯 Result
          
          ✓ All index files are current - no regeneration needed. The change detection system verified that no directory content has changed since the last index generation.
          
          ${parseInt(failed) > 0 ? `
          ### ⚠️ Generation Errors
          
          **${failed} directories failed** to generate indexes. Please review the workflow logs for details.
          ` : ''}
          
          ---
          <details>
          <summary>💡 About Project Index Automation</summary>
          
          This workflow automatically generates \`index.md\` files for all project directories, creating a fully navigable documentation structure on GitHub. The system uses content hashing to detect changes and only regenerates indexes when directory contents have been modified.
          
          **Features:**
          - ✨ Smart change detection - only updates when needed
          - 📊 Comprehensive directory analysis
          - 🔗 Hierarchical navigation throughout the project
          - 🚀 Optimized for GitHub's native browsing experience
          - 🤖 Automatic PR creation for index updates
          </details>
          
          *Generated by AitherZero Project Index Automation*`;
          
          github.rest.issues.createComment({
            issue_number: context.payload.pull_request.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: 📤 Upload Index Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: project-indexes
        path: |
          **/index.md
          .aitherzero-index-cache.json
          .aitherzero-index-report.json
        retention-days: 30
        
    - name: ✅ Workflow Complete
      shell: pwsh
      run: |
        Write-Host "Project index automation completed successfully!" -ForegroundColor Green
