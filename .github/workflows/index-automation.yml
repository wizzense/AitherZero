name: 🗂️ Project Index Automation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'domains/**'
      - 'automation-scripts/**'
      - 'infrastructure/**'
      - 'tests/**'
      - 'orchestration/**'
      - 'docs/**'
      - '**/*.md'
      - '**/*.ps1'
      - '**/*.psm1'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'domains/**'
      - 'automation-scripts/**'
      - 'infrastructure/**'
      - 'tests/**'
      - 'orchestration/**'
      - 'docs/**'
      - '**/*.md'
      - '**/*.ps1'
      - '**/*.psm1'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Index generation mode'
        required: true
        default: 'Incremental'
        type: choice
        options:
        - Full
        - Incremental
        - Verify

jobs:
  generate-indexes:
    name: 🔄 Generate Project Indexes
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: write
      
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ⚡ Setup PowerShell
      shell: pwsh
      run: |
        Write-Host "PowerShell Version: $($PSVersionTable.PSVersion)" -ForegroundColor Green
        Write-Host "OS: $($PSVersionTable.OS)" -ForegroundColor Green
          
    - name: 🏗️ Initialize AitherZero
      shell: pwsh
      run: |
        Write-Host "Initializing AitherZero environment..." -ForegroundColor Cyan
        
        # Import the main module
        Import-Module ./AitherZero.psd1 -Force
        Get-Module AitherZero
        
        Write-Host "AitherZero initialized successfully" -ForegroundColor Green
        
    - name: 🗂️ Generate Project Indexes
      shell: pwsh
      run: |
        Write-Host "Starting automated index generation..." -ForegroundColor Cyan
        
        # Set parameters based on trigger
        $mode = if ('${{ github.event_name }}' -eq 'workflow_dispatch') {
          '${{ github.event.inputs.mode }}'
        } elseif ('${{ github.event_name }}' -eq 'pull_request') {
          'Incremental'
        } else {
          'Incremental'
        }
        
        Write-Host "Mode: $mode" -ForegroundColor White
        
        # Run index generation
        try {
          ./automation-scripts/0745_Generate-ProjectIndexes.ps1 -Mode $mode
          Write-Host "Index generation completed successfully" -ForegroundColor Green
        } catch {
          Write-Error "Index generation failed: $_"
          exit 1
        }
        
    - name: 📊 Generate Index Report
      shell: pwsh
      run: |
        Write-Host "Generating index report..." -ForegroundColor Cyan
        
        # Count generated index files
        $indexFiles = @(Get-ChildItem -Path . -Filter "index.md" -Recurse -ErrorAction SilentlyContinue)
        $totalIndexes = $indexFiles.Count
        
        Write-Host "Total Index Files: $totalIndexes" -ForegroundColor White
        
        # Set output for later steps
        echo "TOTAL_INDEXES=$totalIndexes" >> $env:GITHUB_ENV
        
    - name: 📤 Commit Index Updates (Main/Develop Branch)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
      shell: pwsh
      run: |
        Write-Host "Committing index updates..." -ForegroundColor Cyan
        
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        
        # Check if there are changes to commit
        $changes = git status --porcelain
        if ($changes) {
          # Add index files
          git add **/index.md
          
          # Commit
          git commit -m "docs: auto-update project indexes [skip ci]" -m "Automatically generated by Project Index Automation workflow"
          
          # Push
          git push origin ${{ github.ref_name }}
          
          Write-Host "Index updates committed and pushed" -ForegroundColor Green
        } else {
          Write-Host "No index changes to commit" -ForegroundColor Yellow
        }
        
    - name: 💬 Comment on PR
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const totalIndexes = process.env.TOTAL_INDEXES || '0';
          
          const comment = `## 🗂️ Project Index Update Report
          
          **Index generation completed successfully!**
          
          ### Statistics
          - 📁 Total index files: ${totalIndexes}
          - ✅ Navigation structure validated
          - ✅ Breadcrumb navigation generated
          
          ### Features
          - ✨ Hierarchical navigation (parent ← current → children)
          - 🔍 Change detection - only updated directories
          - 📊 Automatic content analysis
          - 🔗 Bidirectional directory links
          
          All directories now have navigable index.md files for easy GitHub browsing!
          
          ---
          *Generated by AitherZero Project Index Automation*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
    - name: 📤 Upload Index Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: project-indexes
        path: |
          **/index.md
          .aitherzero-index-cache.json
        retention-days: 30
        
    - name: ✅ Workflow Complete
      shell: pwsh
      run: |
        Write-Host "Project index automation completed successfully!" -ForegroundColor Green
