---
name: ğŸ§ª Comprehensive Tests (v2 - CLI)

# Complete test suite using playbooks and CLI cmdlets
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      playbook:
        description: 'Playbook to execute'
        required: false
        default: 'test-orchestration'
        type: choice
        options:
          - test-orchestration
          - code-quality-fast
          - code-quality-full
          - pr-validation-full
          - project-health-check

permissions:
  contents: read
  pull-requests: write
  checks: write
  issues: write

concurrency:
  group: comprehensive-tests-v2-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  AITHERZERO_CI: true
  AITHERZERO_NONINTERACTIVE: true
  AITHERZERO_SUPPRESS_BANNER: true

jobs:
  test-suite:
    name: ğŸ§ª Execute Test Playbook
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Bootstrap Environment
        shell: pwsh
        run: |
          Write-Host "ğŸš€ Bootstrapping AitherZero environment..." -ForegroundColor Cyan
          ./bootstrap.ps1 -Mode New -InstallProfile Minimal

      - name: ğŸ“¦ Install Testing Dependencies
        shell: pwsh
        run: |
          Write-Host "ğŸ“¦ Installing testing tools..." -ForegroundColor Cyan
          
          # Use CLI cmdlet to run installation script
          Import-Module ./AitherZero.psd1 -Force
          Invoke-AitherScript -Number 0400 -Variables @{ Force = $true }

      - name: ğŸ’¾ Cache Test Results
        uses: actions/cache@v4
        with:
          path: |
            library/tests/results
            library/tests/coverage
          key: ${{ runner.os }}-test-results-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-test-results-

      - name: ğŸ§ª Execute Test Playbook
        id: tests
        shell: pwsh
        run: |
          Write-Host "ğŸ§ª Running comprehensive test playbook..." -ForegroundColor Cyan
          
          Import-Module ./AitherZero.psd1 -Force
          
          # Determine which playbook to run
          $playbook = "${{ github.event.inputs.playbook || 'test-orchestration' }}"
          
          Write-Host "Executing playbook: $playbook" -ForegroundColor Yellow
          
          try {
            # Execute playbook with caching and summary generation
            Invoke-AitherPlaybook -Name $playbook `
              -Parallel `
              -MaxParallel 8 `
              -UseCache `
              -GenerateSummary `
              -ContinueOnError
            
            $exitCode = if ($null -eq $LASTEXITCODE) { 0 } else { $LASTEXITCODE }
            $success = $exitCode -eq 0
            
            Write-Host "Playbook execution completed with exit code: $exitCode" -ForegroundColor $(if ($success) { 'Green' } else { 'Yellow' })
            
            echo "success=$success" >> $env:GITHUB_OUTPUT
            echo "exit-code=$exitCode" >> $env:GITHUB_OUTPUT
            echo "playbook=$playbook" >> $env:GITHUB_OUTPUT
            
            # Continue even if tests fail to upload results
            exit 0
          }
          catch {
            Write-Host "âŒ Playbook execution failed: $_" -ForegroundColor Red
            echo "success=false" >> $env:GITHUB_OUTPUT
            echo "exit-code=1" >> $env:GITHUB_OUTPUT
            echo "playbook=$playbook" >> $env:GITHUB_OUTPUT
            exit 0
          }

      - name: ğŸ“Š Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.run_number }}
          path: |
            library/tests/results/**/*.xml
            library/tests/results/**/*.json
            library/tests/coverage/**/*
            library/reports/**/*.md
            library/reports/**/*.json
            library/reports/**/*.html
          retention-days: 30

      - name: ğŸ“ˆ Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: |
            library/tests/results/**/*.xml
          check_name: 'Test Results (v2)'
          comment_mode: always

      - name: ğŸ’¬ Post Test Summary
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const prNumber = context.payload.pull_request.number;
            const success = '${{ steps.tests.outputs.success }}' === 'true';
            const playbook = '${{ steps.tests.outputs.playbook }}';
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            const statusIcon = success ? 'âœ…' : 'âš ï¸';
            const statusText = success ? '**ALL PASSED**' : '**SOME FAILED**';
            const statusColor = success ? 'ğŸŸ¢' : 'ğŸŸ¡';
            
            let comment = `## ${statusIcon} Comprehensive Test Results (v2)\n\n`;
            comment += `### ${statusColor} Status: ${statusText}\n\n`;
            comment += `**Playbook:** \`${playbook}\`\n`;
            comment += `**Execution Mode:** Parallel (max 8 concurrent)\n`;
            comment += `**Caching:** Enabled\n\n`;
            
            // Try to read summary if available
            try {
              if (fs.existsSync('library/reports/execution-summary.md')) {
                const summary = fs.readFileSync('library/reports/execution-summary.md', 'utf8');
                comment += `### ğŸ“Š Execution Summary\n\n`;
                comment += summary + '\n\n';
              }
            } catch (e) {
              console.log('Could not read execution summary');
            }
            
            if (success) {
              comment += `### âœ… All Tests Passed!\n\n`;
              comment += `Great work! All test suites completed successfully.\n\n`;
            } else {
              comment += `### âš ï¸ Some Tests Failed\n\n`;
              comment += `Some tests did not pass. This is tracked but **non-blocking**.\n\n`;
              comment += `**Next Steps:**\n`;
              comment += `1. ğŸ“¥ Download [test results](${runUrl}) from artifacts\n`;
              comment += `2. ğŸ” Review failed test details\n`;
              comment += `3. ğŸ”§ Fix issues and re-run: \`Invoke-AitherPlaybook ${playbook}\`\n`;
              comment += `4. ğŸš€ Push changes to re-trigger tests\n\n`;
            }
            
            comment += `### ğŸ”— Quick Links\n`;
            comment += `- ğŸ“Š [Workflow Run](${runUrl})\n`;
            comment += `- ğŸ“ [Test Artifacts](${runUrl})\n`;
            comment += `- ğŸ§ª [View Test History](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/workflows/comprehensive-tests-v2.yml)\n\n`;
            
            comment += `### ğŸš€ Available Playbooks\n`;
            comment += `Run locally or via workflow_dispatch:\n`;
            comment += `- \`test-orchestration\` - Core test suite\n`;
            comment += `- \`code-quality-fast\` - Quick quality checks\n`;
            comment += `- \`code-quality-full\` - Comprehensive quality analysis\n`;
            comment += `- \`pr-validation-full\` - Complete PR validation\n`;
            comment += `- \`project-health-check\` - Overall health assessment\n\n`;
            
            comment += `---\n`;
            comment += `*ğŸ¤– Automated by AitherZeroCLI â€¢ Playbook orchestration with parallel execution*`;
            
            // Update or create comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            
            const existingComment = comments.find(c =>
              c.user.login === 'github-actions[bot]' &&
              c.body.includes('Comprehensive Test Results (v2)')
            );
            
            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: comment
              });
            }

      - name: âœ… Test Suite Complete
        if: always()
        shell: pwsh
        run: |
          $success = "${{ steps.tests.outputs.success }}" -eq "true"
          $playbook = "${{ steps.tests.outputs.playbook }}"
          
          Write-Host "`nâ•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—" -ForegroundColor Cyan
          Write-Host "â•‘         COMPREHENSIVE TEST SUITE COMPLETE (v2)               â•‘" -ForegroundColor Cyan
          Write-Host "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•" -ForegroundColor Cyan
          Write-Host ""
          Write-Host "Playbook: $playbook" -ForegroundColor White
          
          if ($success) {
            Write-Host "Status: âœ… ALL TESTS PASSED" -ForegroundColor Green
          } else {
            Write-Host "Status: âš ï¸  SOME TESTS FAILED (non-blocking)" -ForegroundColor Yellow
          }
          
          Write-Host ""
          Write-Host "Powered by AitherZeroCLI and OrchestrationEngine" -ForegroundColor DarkCyan
          Write-Host "Parallel execution with caching enabled" -ForegroundColor DarkGray
