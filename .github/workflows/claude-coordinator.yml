---
name: ğŸ¤ Claude Coordination - CLI + GitHub App

# This workflow coordinates between:
# 1. Claude for GitHub (the GitHub App)
# 2. Claude Code (custom workflows)
# 3. GitHub Copilot
# 4. AitherZero validation

on:
  # Trigger after Claude for GitHub app responds
  issue_comment:
    types: [created]

  pull_request_review_comment:
    types: [created]

  # Trigger on specific labels
  pull_request:
    types: [labeled]

permissions:
  contents: read
  issues: write
  pull-requests: write
  checks: write

jobs:
  detect-claude-activity:
    name: ğŸ” Detect Claude for GitHub Activity
    runs-on: ubuntu-latest
    outputs:
      claude-app-active: ${{ steps.check.outputs.claude-active }}
      needs-coordination: ${{ steps.check.outputs.needs-coordination }}

    steps:
      - name: ğŸ” Check for Claude for GitHub App Activity
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const eventName = context.eventName;
            let claudeActive = false;
            let needsCoordination = false;

            // Check if comment is from Claude for GitHub app
            if (eventName === 'issue_comment' || eventName === 'pull_request_review_comment') {
              const comment = context.payload.comment;
              const author = comment.user.login;
              const body = comment.body;

              console.log(`Comment from: ${author}`);

              // Check if it's from Claude for GitHub app
              // The app typically has a specific username
              if (author.includes('claude') || author.includes('anthropic')) {
                claudeActive = true;
                console.log('âœ… Claude for GitHub app is active');

                // Check if coordination is needed
                // Look for keywords that suggest we should coordinate
                const coordinationKeywords = [
                  'recommend', 'suggest', 'should', 'could', 'consider',
                  'improve', 'refactor', 'optimize', 'security', 'performance'
                ];

                const needsWork = coordinationKeywords.some(keyword =>
                  body.toLowerCase().includes(keyword)
                );

                if (needsWork) {
                  needsCoordination = true;
                  console.log('ğŸ¤ Coordination needed - Claude suggested improvements');
                }
              }
            }

            // Check if PR has coordination label
            if (eventName === 'pull_request' && context.payload.action === 'labeled') {
              const label = context.payload.label.name;
              if (label === 'multi-agent' || label === 'claude-coordination') {
                needsCoordination = true;
                console.log('ğŸ·ï¸ Coordination label detected');
              }
            }

            core.setOutput('claude-active', claudeActive);
            core.setOutput('needs-coordination', needsCoordination);

  coordinate-with-copilot:
    name: ğŸ¤ Coordinate Claude â†’ Copilot
    needs: detect-claude-activity
    runs-on: ubuntu-latest
    if: needs.detect-claude-activity.outputs.needs-coordination == 'true'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ’¬ Bridge Claude's Suggestions to Copilot
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue?.number || context.payload.pull_request?.number;

            if (!issue_number) {
              console.log('No issue/PR number found');
              return;
            }

            // Get recent comments to find Claude's suggestions
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              per_page: 10,
              sort: 'created',
              direction: 'desc'
            });

            // Find Claude for GitHub app's comment
            const claudeComment = comments.find(c =>
              c.user.login.toLowerCase().includes('claude') ||
              c.user.login.toLowerCase().includes('anthropic')
            );

            if (claudeComment) {
              console.log('Found Claude comment:', claudeComment.id);

              // Create coordination comment for Copilot
              const coordinationComment = `## ğŸ¤ Multi-Agent Coordination

**Claude for GitHub has provided feedback above** â˜ï¸

### ğŸ¯ Action Items

@copilot Please review Claude's suggestions and:
1. Analyze the feasibility of implementing these recommendations
2. Create commits addressing the key points
3. Run local validation before pushing

### ğŸ” AitherZero Validation

After implementation, the following checks will run automatically:
- âœ… PSScriptAnalyzer (code quality)
- âœ… Pester tests (functionality)
- âœ… Security validation
- âœ… Syntax checks

### ğŸ“‹ Workflow

\`\`\`
Claude Review â†’ Copilot Implementation â†’ AitherZero Validation â†’ Human Approval
\`\`\`

---
*ğŸ¤– Multi-agent coordination powered by AitherZero*`;

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue_number,
                body: coordinationComment
              });

              console.log('âœ… Posted coordination comment');
            } else {
              console.log('No Claude comment found to coordinate');
            }

  run-aitherezero-validation:
    name: ğŸ”§ Run AitherZero Validation
    needs: detect-claude-activity
    runs-on: ubuntu-latest
    if: needs.detect-claude-activity.outputs.claude-active == 'true'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup PowerShell
        shell: pwsh
        run: |
          Write-Host "ğŸ”§ Setting up AitherZero environment..." -ForegroundColor Cyan

          # Install required modules
          Install-Module PSScriptAnalyzer -Force -AllowClobber -Scope CurrentUser -ErrorAction SilentlyContinue

          if (Test-Path "./AitherZero.psd1") {
            Import-Module "./AitherZero.psd1" -Force -ErrorAction SilentlyContinue
          }

          Write-Host "âœ… Environment ready" -ForegroundColor Green

      - name: ğŸ” Quick Validation
        shell: pwsh
        continue-on-error: true
        run: |
          Write-Host "ğŸ” Running quick validation after Claude review..." -ForegroundColor Yellow

          $results = @{
            PSScriptAnalyzer = $null
            Syntax = $null
            Tests = $null
          }

          # Quick PSScriptAnalyzer check
          try {
            Write-Host "ğŸ“Š PSScriptAnalyzer check..." -ForegroundColor Cyan
            if (Test-Path "./automation-scripts/0404_Run-PSScriptAnalyzer.ps1") {
              $results.PSScriptAnalyzer = "Available"
            }
          } catch {
            $results.PSScriptAnalyzer = "Failed: $_"
          }

          # Syntax validation
          try {
            Write-Host "ğŸ“ Syntax validation..." -ForegroundColor Cyan
            if (Test-Path "./automation-scripts/0407_Validate-Syntax.ps1") {
              $results.Syntax = "Available"
            }
          } catch {
            $results.Syntax = "Failed: $_"
          }

          # Test availability
          try {
            Write-Host "ğŸ§ª Test check..." -ForegroundColor Cyan
            if (Test-Path "./automation-scripts/0402_Run-UnitTests.ps1") {
              $results.Tests = "Available"
            }
          } catch {
            $results.Tests = "Failed: $_"
          }

          Write-Host ""
          Write-Host "ğŸ“Š Validation Tools Status:" -ForegroundColor Green
          Write-Host "  PSScriptAnalyzer: $($results.PSScriptAnalyzer)" -ForegroundColor White
          Write-Host "  Syntax: $($results.Syntax)" -ForegroundColor White
          Write-Host "  Tests: $($results.Tests)" -ForegroundColor White

      - name: ğŸ’¬ Post Validation Status
        uses: actions/github-script@v7
        with:
          script: |
            const issue_number = context.issue?.number || context.payload.pull_request?.number;

            if (!issue_number) return;

            const comment = `## âœ… AitherZero Validation Ready

After implementing Claude's suggestions, run these validations:

\`\`\`powershell
# Local validation commands
./az.ps1 0404  # PSScriptAnalyzer
./az.ps1 0402  # Unit tests
./az.ps1 0407  # Syntax validation
\`\`\`

Or trigger comprehensive validation:
- Actions > AI Agent Coordinator > Run workflow
- Agent Type: multi-agent
- Priority: normal

---
*Validation will run automatically on PR updates*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue_number,
              body: comment
            });

  summary:
    name: ğŸ“Š Coordination Summary
    needs: [detect-claude-activity, coordinate-with-copilot, run-aitherezero-validation]
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ğŸ“Š Generate Summary
        run: |
          echo "# ğŸ¤ Claude Coordination Summary"
          echo ""
          echo "**Claude for GitHub App:** ${{ needs.detect-claude-activity.outputs.claude-active }}"
          echo "**Coordination Needed:** ${{ needs.detect-claude-activity.outputs.needs-coordination }}"
          echo ""

          if [[ "${{ needs.detect-claude-activity.outputs.needs-coordination }}" == "true" ]]; then
            echo "âœ… Multi-agent coordination activated"
            echo "ğŸ“‹ Copilot notified of Claude's suggestions"
            echo "ğŸ”§ AitherZero validation ready"
          else
            echo "â„¹ï¸  No coordination needed at this time"
          fi

          echo ""
          echo "## ğŸ¯ Multi-Agent Workflow"
          echo "1. Claude for GitHub â†’ Reviews and suggests"
          echo "2. This workflow â†’ Coordinates between agents"
          echo "3. Copilot â†’ Implements changes"
          echo "4. AitherZero â†’ Validates quality"
          echo "5. Human â†’ Approves and merges"
