{
  "requirements": {
    "minimumPowerShellVersion": "7.0",
    "platforms": [
      "Linux"
    ],
    "requiredModules": [],
    "requiredTools": []
  },
  "orchestration": {
    "jobs": {
      "pr-analysis": {
        "outputs": {
          "has-workflows": "${{ steps.analyze.outputs.has-workflows }}",
          "change-summary": "${{ steps.analyze.outputs.change-summary }}",
          "has-powershell": "${{ steps.analyze.outputs.has-powershell }}"
        },
        "name": "ğŸ” Analyze PR Changes",
        "if": "github.event_name == 'pull_request' && !github.event.pull_request.draft && github.event.pull_request.head.repo.full_name == github.repository",
        "steps": [
          {
            "with": {
              "ref": "${{ github.event.pull_request.base.ref }}",
              "fetch-depth": 0
            },
            "name": "ğŸ“¥ Checkout Base Branch (Safe)",
            "script": "Write-Host \"Repository already available locally\"",
            "uses": "actions/checkout@v4"
          },
          {
            "id": "analyze",
            "script": "Write-Host \"ğŸ” Analyzing PR changes...\" -ForegroundColor Cyan\n\n# Get changed files using GitHub API (safe for forks)\n$prNumber = \"${{ github.event.pull_request.number }}\"\n$apiUrl = \"https://api.github.com/repos/AitherZero/pulls/$prNumber/files\"\n\ntry {\n  $response = Invoke-RestMethod -Uri $apiUrl -Headers @{ 'Accept' = 'application/vnd.github.v3+json' }\n  $changedFiles = $response | ForEach-Object { $_.filename }\n} catch {\n  Write-Host \"âš ï¸ Could not fetch PR files via API, using local diff\" -ForegroundColor Yellow\n  $changedFiles = @()  # Empty array for safety\n}\n\n# Categorize files\n$psFiles = $changedFiles | Where-Object { $_ -match '\\.(ps1|psm1|psd1)$' }\n$yamlFiles = $changedFiles | Where-Object { $_ -match '\\.github/workflows/.*\\.(yml|yaml)$' }\n$testFiles = $changedFiles | Where-Object { $_ -match '\\.Tests\\.ps1$' }\n$configFiles = $changedFiles | Where-Object { $_ -match '\\.(json|psd1)$' -and $_ -notmatch '\\.Tests\\.' }\n\n# Create analysis\n$analysis = @{\n  TotalFiles = $changedFiles.Count\n  PowerShellFiles = $psFiles.Count\n  WorkflowFiles = $yamlFiles.Count\n  TestFiles = $testFiles.Count\n  ConfigFiles = $configFiles.Count\n  ChangedFiles = $changedFiles\n  Recommendations = @()\n}\n\n# Generate recommendations\nif ($psFiles.Count -gt 0 -and $testFiles.Count -eq 0) {\n  $analysis.Recommendations += \"âš ï¸ PowerShell files changed but no test files updated\"\n}\n\nif ($yamlFiles.Count -gt 0) {\n  $analysis.Recommendations += \"ğŸ” Workflow files changed - ensure YAML validation passes\"\n}\n\nif ($analysis.TotalFiles -gt 15) {\n  $analysis.Recommendations += \"ğŸ“‹ Large PR ($($analysis.TotalFiles) files) - consider smaller increments\"\n}\n\nif ($psFiles.Count -gt 0) {\n  $analysis.Recommendations += \"ğŸ§ª Run local tests: ./az.ps1 0402\"\n}\n\n# Set outputs\necho \"has-powershell=$($psFiles.Count -gt 0)\" >> $env:GITHUB_OUTPUT\necho \"has-workflows=$($yamlFiles.Count -gt 0)\" >> $env:GITHUB_OUTPUT\necho \"change-summary=$($analysis.TotalFiles) files: PS=$($psFiles.Count), Workflows=$($yamlFiles.Count), Tests=$($testFiles.Count)\" >> $env:GITHUB_OUTPUT\n\n# Save for comment\n$analysis | ConvertTo-Json -Depth 3 | Set-Content \"./pr-analysis.json\"\n\nWrite-Host \"ğŸ“Š Analysis complete:\" -ForegroundColor Green\nWrite-Host \"   Total files: $($analysis.TotalFiles)\" -ForegroundColor White\nWrite-Host \"   PowerShell files: $($psFiles.Count)\" -ForegroundColor White\nWrite-Host \"   Workflow files: $($yamlFiles.Count)\" -ForegroundColor White\n",
            "name": "ğŸ” Analyze Changes"
          },
          {
            "script": "Write-Host \"ğŸ” Running quick validation for PowerShell changes...\" -ForegroundColor Yellow\n\n# Security check\nif (\"${{ github.event.pull_request.head.repo.full_name }}\" -ne \"AitherZero\") {\n  Write-Host \"âš ï¸ Skipping validation for fork PR for security\" -ForegroundColor Yellow\n  echo \"SYNTAX_STATUS=â­ï¸ SKIPPED (Fork PR)\" >> $env:GITHUB_ENV\n  exit 0\n}\n\n# Minimal bootstrap for validation\n./bootstrap.ps1 -Mode New -InstallProfile Minimal\n\n# Test syntax with -All switch to validate all PowerShell files\ntry {\n  Write-Host \"Running syntax validation on all PowerShell files...\" -ForegroundColor Cyan\n  $output = & \"./automation-scripts/0407_Validate-Syntax.ps1\" -All 2>&1\n\n  if ($LASTEXITCODE -eq 0) {\n    Write-Host \"âœ… Syntax validation passed\" -ForegroundColor Green\n    echo \"SYNTAX_STATUS=âœ… PASSED\" >> $env:GITHUB_ENV\n    echo \"SYNTAX_DETAILS<<EOF\" >> $env:GITHUB_ENV\n    echo \"$output\" >> $env:GITHUB_ENV\n    echo \"EOF\" >> $env:GITHUB_ENV\n  } else {\n    Write-Host \"âŒ Syntax validation failed\" -ForegroundColor Red\n    Write-Host \"$output\" -ForegroundColor Yellow\n    echo \"SYNTAX_STATUS=âŒ FAILED\" >> $env:GITHUB_ENV\n    echo \"SYNTAX_ERROR<<EOF\" >> $env:GITHUB_ENV\n    echo \"$output\" >> $env:GITHUB_ENV\n    echo \"EOF\" >> $env:GITHUB_ENV\n  }\n} catch {\n  Write-Host \"âš ï¸ Error running syntax validation: $_\" -ForegroundColor Red\n  echo \"SYNTAX_STATUS=âŒ FAILED\" >> $env:GITHUB_ENV\n  echo \"SYNTAX_ERROR<<EOF\" >> $env:GITHUB_ENV\n  echo \"Error executing syntax validation script: $_\" >> $env:GITHUB_ENV\n  echo \"EOF\" >> $env:GITHUB_ENV\n}\n",
            "if": "steps.analyze.outputs.has-powershell == 'true' && github.event.pull_request.head.repo.full_name == github.repository",
            "name": "ğŸ” Quick Validation (Trusted PRs Only)"
          },
          {
            "with": {
              "script": "const fs = require('fs');\n\n// Read analysis\nlet analysis = { Recommendations: [], TotalFiles: 0, PowerShellFiles: 0, WorkflowFiles: 0, TestFiles: 0 };\ntry {\n  analysis = JSON.parse(fs.readFileSync('./pr-analysis.json', 'utf8'));\n} catch (e) {\n  console.log('No analysis file found');\n}\n\nconst syntaxStatus = process.env.SYNTAX_STATUS || 'Not checked';\nconst syntaxError = process.env.SYNTAX_ERROR || '';\nconst syntaxDetails = process.env.SYNTAX_DETAILS || '';\nconst changeSummary = \"${{ steps.analyze.outputs.change-summary }}\";\n\nconst prNumber = context.payload.pull_request.number;\nconst prTitle = context.payload.pull_request.title;\nconst prAuthor = context.payload.pull_request.user.login;\n\n// Status indicators\nconst statusIcon = syntaxStatus.includes('PASSED') ? 'âœ…' : syntaxStatus.includes('FAILED') ? 'âŒ' : 'â­ï¸';\nconst statusBadge = syntaxStatus.includes('PASSED') ? 'ğŸŸ¢ READY' : syntaxStatus.includes('FAILED') ? 'ğŸ”´ NEEDS FIX' : 'ğŸŸ¡ PENDING';\n\nlet comment = `## âœ… PR Validation Results\\n\\n`;\ncomment += `### ${statusIcon} Quick Validation: ${statusBadge}\\n\\n`;\ncomment += `**PR #${prNumber}:** ${prTitle}\\n`;\ncomment += `**Author:** @${prAuthor}\\n`;\ncomment += `**Changes:** ${changeSummary}\\n\\n`;\n\ncomment += `### ğŸ“Š File Analysis\\n\\n`;\ncomment += `| Type | Count | Visual |\\n`;\ncomment += `|------|-------|--------|\\n`;\ncomment += `| Total Files | ${analysis.TotalFiles} | ${'ğŸ“„'.repeat(Math.min(analysis.TotalFiles, 10))} |\\n`;\ncomment += `| PowerShell | ${analysis.PowerShellFiles} | ${'âš¡'.repeat(Math.min(analysis.PowerShellFiles, 10))} |\\n`;\ncomment += `| Workflows | ${analysis.WorkflowFiles} | ${'ğŸ”„'.repeat(Math.min(analysis.WorkflowFiles, 5))} |\\n`;\ncomment += `| Tests | ${analysis.TestFiles} | ${'ğŸ§ª'.repeat(Math.min(analysis.TestFiles, 10))} |\\n\\n`;\n\ncomment += `### ğŸ” Validation Checks\\n\\n`;\ncomment += `| Check | Status | Next Step |\\n`;\ncomment += `|-------|--------|------------|\\n`;\ncomment += `| âœ… Syntax Check | ${syntaxStatus} | ${syntaxStatus.includes('PASSED') ? 'Complete' : 'Review errors below'} |\\n`;\ncomment += `| ğŸ§ª Main CI Tests | â³ Queued | Will run automatically |\\n`;\ncomment += `| ğŸ“Š Quality Check | â³ Queued | Runs with main CI |\\n\\n`;\n\nif (syntaxError) {\n  comment += `### âŒ Action Required: Fix Syntax Errors\\n\\n`;\n  comment += `PowerShell syntax errors were detected. Please fix them before merging.\\n\\n`;\n  comment += `<details>\\n`;\n  comment += `<summary>ğŸ“‹ View Error Details</summary>\\n\\n`;\n  comment += `\\`\\`\\`\\n${syntaxError}\\n\\`\\`\\`\\n\\n`;\n  comment += `</details>\\n\\n`;\n  comment += `#### ğŸ”§ How to Fix\\n\\n`;\n  comment += `1. ğŸ“ Review the error messages above\\n`;\n  comment += `2. ğŸ” Identify and fix syntax errors in the affected files\\n`;\n  comment += `3. ğŸ§ª Test locally: \\`./automation-scripts/0407_Validate-Syntax.ps1 -All\\`\\n`;\n  comment += `4. ğŸš€ Push changes to trigger re-validation\\n\\n`;\n} else if (syntaxDetails && syntaxStatus.includes('PASSED')) {\n  comment += `### âœ… All Syntax Checks Passed!\\n\\n`;\n  comment += `Great work! All PowerShell files have valid syntax. ğŸ‰\\n\\n`;\n  if (syntaxDetails.length > 0 && syntaxDetails.length < 500) {\n    comment += `<details>\\n`;\n    comment += `<summary>ğŸ“‹ View Validation Details</summary>\\n\\n`;\n    comment += `\\`\\`\\`\\n${syntaxDetails}\\n\\`\\`\\`\\n\\n`;\n    comment += `</details>\\n\\n`;\n  }\n}\n\nif (analysis.Recommendations && analysis.Recommendations.length > 0) {\n  comment += `### ğŸ’¡ Recommendations\\n\\n`;\n  for (const rec of analysis.Recommendations) {\n    comment += `- ${rec}\\n`;\n  }\n  comment += `\\n`;\n}\n\ncomment += `### ğŸš€ What Happens Next?\\n\\n`;\nif (syntaxStatus.includes('FAILED')) {\n  comment += `1. â— **Fix the syntax errors** listed above\\n`;\n  comment += `2. ğŸ§ª **Test locally** using: \\`./automation-scripts/0407_Validate-Syntax.ps1 -All\\`\\n`;\n  comment += `3. ğŸš€ **Push your changes** - validation will re-run automatically\\n`;\n  comment += `4. âœ… Once validation passes, **comprehensive CI tests** will run\\n`;\n} else {\n  comment += `1. âœ… **Quick validation passed** - syntax is good!\\n`;\n  comment += `2. ğŸ”„ **Comprehensive CI is running** - check the [workflows](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions)\\n`;\n  comment += `3. ğŸ“Š **Quality checks** will provide detailed feedback\\n`;\n  comment += `4. ğŸ‰ Once all checks pass, you're **ready to merge**!\\n\\n`;\n  comment += `#### ğŸ§ª Optional: Test Locally\\n\\n`;\n  comment += `\\`\\`\\`bash\\n`;\n  comment += `# Run syntax validation\\n`;\n  comment += `./automation-scripts/0407_Validate-Syntax.ps1 -All\\n\\n`;\n  comment += `# Run unit tests\\n`;\n  comment += `./automation-scripts/0402_Run-UnitTests.ps1\\n\\n`;\n  comment += `# Full test suite\\n`;\n  comment += `./Start-AitherZero.ps1 -Mode Orchestrate -Playbook \"test-orchestrated\" -PlaybookProfile quick\\n`;\n  comment += `\\`\\`\\`\\n`;\n}\n\ncomment += `\\n---\\n`;\ncomment += `*ğŸ¤– Automated PR Validation â€¢ Fast syntax check before main CI â€¢ [View Workflow](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;\n\n// Find and update existing comment or create new\nconst { data: comments } = await github.rest.issues.listComments({\n  owner: context.repo.owner,\n  repo: context.repo.repo,\n  issue_number: prNumber\n});\n\nconst existingComment = comments.find(c =>\n  c.user.login === 'github-actions[bot]' &&\n  c.body.includes('âœ… PR Validation Results')\n);\n\nif (existingComment) {\n  await github.rest.issues.updateComment({\n    owner: context.repo.owner,\n    repo: context.repo.repo,\n    comment_id: existingComment.id,\n    body: comment\n  });\n} else {\n  await github.rest.issues.createComment({\n    owner: context.repo.owner,\n    repo: context.repo.repo,\n    issue_number: prNumber,\n    body: comment\n  });\n}\n"
            },
            "name": "ğŸ’¬ Post Modern PR Validation Comment",
            "script": "# Action not implemented: actions/github-script@v7",
            "uses": "actions/github-script@v7"
          }
        ]
      },
      "fork-pr-analysis": {
        "name": "ğŸ”’ Fork PR Analysis",
        "if": "github.event_name == 'pull_request' && !github.event.pull_request.draft && github.event.pull_request.head.repo.full_name != github.repository",
        "steps": [
          {
            "with": {
              "script": "const prNumber = context.payload.pull_request.number;\nconst prAuthor = context.payload.pull_request.user.login;\nconst forkRepo = context.payload.pull_request.head.repo.full_name;\n\nconst comment = `## ğŸ”’ Fork PR Security Notice\n\n**PR #${prNumber} from Fork Repository** â€¢ **Author:** @${prAuthor} â€¢ **Fork:** \\`${forkRepo}\\`\n\n### ğŸ›¡ï¸ Security Policy\n\nFor security reasons, automated validation is **limited** for fork PRs:\n\n| Check | Status | Reason |\n|-------|--------|--------|\n| ğŸ“ Static Analysis | âœ… Enabled | Safe to run without code execution |\n| ğŸ” Change Review | âœ… Enabled | Analyzes diff without running code |\n| ğŸ§ª Test Execution | âŒ Disabled | Requires maintainer approval |\n| ğŸš€ Full CI Pipeline | â¸ï¸ Waiting | Runs after maintainer review |\n\n### ğŸš€ Next Steps\n\n1. ğŸ‘€ **Maintainer Review** - A maintainer will review your changes\n2. âœ… **Approval** - If approved, full CI will run automatically\n3. ğŸ”’ **Security Check** - All changes reviewed for security concerns\n4. ğŸ‰ **Merge** - Once all checks pass, your PR can be merged!\n\n### ğŸ“‹ While You Wait\n\n- ğŸ“– Review [Contributing Guidelines](https://github.com/${context.repo.owner}/${context.repo.repo}/blob/main/CONTRIBUTING.md)\n- âœ… Ensure your changes follow project standards\n- ğŸ§ª Add tests for new functionality\n- ğŸ“ Update documentation if needed\n\n---\n*ğŸ¤– Automated security notice for fork contributions â€¢ This helps keep the project secure!*\n`;\n\nawait github.rest.issues.createComment({\n  owner: context.repo.owner,\n  repo: context.repo.repo,\n  issue_number: prNumber,\n  body: comment\n});\n"
            },
            "name": "ğŸ”’ Post Fork PR Security Notice",
            "script": "# Action not implemented: actions/github-script@v7",
            "uses": "actions/github-script@v7"
          }
        ]
      }
    },
    "defaultVariables": {},
    "concurrency": {
      "cancelInProgress": true,
      "group": "pr-validation-${{ github.event.pull_request.number || github.run_id }}"
    },
    "env": {
      "AITHERZERO_CI": "True",
      "AITHERZERO_NONINTERACTIVE": "True"
    }
  },
  "metadata": {
    "category": "operations",
    "version": "1.0.0",
    "githubWorkflow": "pr-validation.yml",
    "tags": [
      "github-actions",
      "converted",
      "workflow"
    ],
    "convertedFrom": ".github/workflows/pr-validation.yml",
    "convertedAt": "2025-11-05T16:50:50.2186075+00:00",
    "estimatedDuration": "Variable",
    "name": "-pr-validation",
    "description": "Converted from GitHub Actions workflow: âœ… PR Validation"
  }
}
