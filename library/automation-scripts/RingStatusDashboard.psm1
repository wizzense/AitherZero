#Requires -Version 7.0

function New-RingStatusHTML {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory)]
        [PSCustomObject]$Data
    )
    
    # Load CSS template
    $cssPath = "./library/_templates/ring-status-css.css"
    $css = if (Test-Path $cssPath) { Get-Content $cssPath -Raw } else { "" }
    
    # Build HTML structure without here-strings
    $html = New-Object System.Text.StringBuilder
    
    # HTML header
    [void]$html.AppendLine('<!DOCTYPE html>')
    [void]$html.AppendLine('<html lang="en">')
    [void]$html.AppendLine('<head>')
    [void]$html.AppendLine('    <meta charset="UTF-8">')
    [void]$html.AppendLine('    <meta name="viewport" content="width=device-width, initial-scale=1.0">')
    [void]$html.AppendLine('    <title>AitherZero - Ring Status Dashboard</title>')
    [void]$html.AppendLine('    <style>')
    [void]$html.AppendLine($css)
    [void]$html.AppendLine('    </style>')
    [void]$html.AppendLine('</head>')
    [void]$html.AppendLine('<body>')
    
    # Header
    [void]$html.AppendLine('    <header>')
    [void]$html.AppendLine('        <h1>ðŸ”„ Ring Status Dashboard</h1>')
    [void]$html.AppendLine('        <p class="subtitle">AitherZero Development Rings - Real-time Status</p>')
    [void]$html.AppendLine("        <p class=`"timestamp`">Last Updated: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')</p>")
    [void]$html.AppendLine('    </header>')
    
    # Main content
    [void]$html.AppendLine('    <main>')
    
    # Process each ring
    foreach ($ring in $Data.rings) {
        $ringStatus = if ($ring.health -ge 90) { 'healthy' } 
                     elseif ($ring.health -ge 70) { 'warning' } 
                     else { 'error' }
        
        [void]$html.AppendLine("        <section class=`"ring-section ring-$ringStatus`">")
        [void]$html.AppendLine("            <h2>$($ring.name)</h2>")
        [void]$html.AppendLine('            <div class="ring-info">')
        [void]$html.AppendLine('                <div class="stat">')
        [void]$html.AppendLine('                    <span class="label">Branch:</span>')
        [void]$html.AppendLine("                    <span class=`"value`"><code>$($ring.branch)</code></span>")
        [void]$html.AppendLine('                </div>')
        [void]$html.AppendLine('                <div class="stat">')
        [void]$html.AppendLine('                    <span class="label">Status:</span>')
        [void]$html.AppendLine("                    <span class=`"value status-$ringStatus`">$($ring.status)</span>")
        [void]$html.AppendLine('                </div>')
        [void]$html.AppendLine('                <div class="stat">')
        [void]$html.AppendLine('                    <span class="label">Last Commit:</span>')
        [void]$html.AppendLine("                    <span class=`"value`">$($ring.lastCommit)</span>")
        [void]$html.AppendLine('                </div>')
        [void]$html.AppendLine('                <div class="stat">')
        [void]$html.AppendLine('                    <span class="label">Open PRs:</span>')
        [void]$html.AppendLine("                    <span class=`"value`">$($ring.openPRs)</span>")
        [void]$html.AppendLine('                </div>')
        [void]$html.AppendLine('            </div>')
        
        # Add PR details if available
        if ($ring.prs -and $ring.prs.Count -gt 0) {
            foreach ($pr in $ring.prs) {
                $prStatus = if ($pr.state -eq 'open') { 'open' } else { 'closed' }
                [void]$html.AppendLine("            <div class=`"pr-card pr-$prStatus`">")
                [void]$html.AppendLine("                <h4><a href=`"$($pr.url)`">#$($pr.number): $($pr.title)</a></h4>")
                [void]$html.AppendLine('                <div class="pr-meta">')
                [void]$html.AppendLine("                    <span>$($pr.author)</span> â€¢")
                [void]$html.AppendLine("                    <span>$($pr.createdAt)</span> â€¢")
                [void]$html.AppendLine("                    <span class=`"status-$prStatus`">$($pr.state)</span>")
                [void]$html.AppendLine('                </div>')
                [void]$html.AppendLine('            </div>')
            }
        }
        
        [void]$html.AppendLine('        </section>')
    }
    
    [void]$html.AppendLine('    </main>')
    
    # Footer
    [void]$html.AppendLine('    <footer>')
    [void]$html.AppendLine('        <p>Generated by AitherZero Ring Status Dashboard</p>')
    [void]$html.AppendLine('        <p><a href="./ring-status-data.json">View Raw Data (JSON)</a></p>')
    [void]$html.AppendLine('    </footer>')
    
    # Auto-refresh script
    [void]$html.AppendLine('    <script>')
    [void]$html.AppendLine('        // Auto-refresh every 5 minutes')
    [void]$html.AppendLine('        setTimeout(() => location.reload(), 300000);')
    [void]$html.AppendLine('    </script>')
    
    [void]$html.AppendLine('</body>')
    [void]$html.AppendLine('</html>')
    
    return $html.ToString()
}

Export-ModuleMember -Function New-RingStatusHTML
