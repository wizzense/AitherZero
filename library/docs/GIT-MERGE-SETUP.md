# Git Merge Configuration for AitherZero

## Problem

The AitherZero repository contains many auto-generated `index.md` files that frequently change (mostly just timestamps). When merging branches, these files often create merge conflicts even though the changes are trivial and the files will be regenerated anyway.

## Solution

We use Git's custom merge drivers to automatically resolve conflicts in `index.md` files by always keeping "our" version (the version in the branch you're merging into).

## Setup Instructions

### For Local Development

After cloning the repository, run this command once:

```bash
git config --local include.path ../.gitconfig.local
```

This will include the `.gitconfig.local` file which configures the `merge=ours` driver.

### For CI/CD Workflows

GitHub Actions workflows should include this setup step before any merge operations:

```yaml
- name: Configure Git merge strategy for index.md files
  run: |
    git config --local merge.ours.name "Always use our version for auto-generated files"
    git config --local merge.ours.driver true
```

Alternatively, use the provided setup script:

```bash
./tools/setup-git-merge.sh
```

### Verification

Check that the configuration is applied:

```bash
# Verify the merge driver is configured
git config merge.ours.driver
# Should output: true

# Verify the attribute is applied to index.md files
git check-attr merge library/automation-scripts/index.md
# Should output: library/automation-scripts/index.md: merge: ours
```

## How It Works

1. **`.gitattributes`** file contains:
   ```
   **/index.md merge=ours
   ```
   This tells Git to use the `ours` merge strategy for all `index.md` files.

2. **`.gitconfig.local`** file contains:
   ```ini
   [merge "ours"]
       name = Always use our version for auto-generated files
       driver = true
   ```
   This defines what the `ours` strategy means: always use the current branch's version (`driver = true` is a special value meaning "keep ours").

3. When Git encounters a merge conflict in an `index.md` file, it automatically:
   - Uses the version from the branch you're merging INTO
   - Ignores the version from the branch you're merging FROM
   - Marks the file as resolved
   - Continues with the merge

## Why This Works

Auto-generated `index.md` files are:
- **Regenerated automatically** after merges by workflows
- **Timestamp-based** (primary change is usually just update time)
- **Non-critical** for the merge decision (keeping either version is fine)

Since these files will be regenerated anyway, there's no risk in automatically preferring one version over another during merges.

## Troubleshooting

### Merge conflicts still occur

If you still see conflicts in `index.md` files:

1. Check the merge driver is configured:
   ```bash
   git config merge.ours.driver
   ```

2. If empty, run the setup again:
   ```bash
   git config --local merge.ours.name "Always use our version for auto-generated files"
   git config --local merge.ours.driver true
   ```

3. Verify `.gitattributes` exists and contains the rule:
   ```bash
   cat .gitattributes | grep "index.md"
   ```

### Manual resolution needed

If you must manually resolve an `index.md` conflict:

```bash
# Keep the current branch version
git checkout --ours path/to/index.md
git add path/to/index.md

# Or keep the incoming branch version
git checkout --theirs path/to/index.md
git add path/to/index.md
```

Remember: the file will be regenerated by the index update workflow anyway.

## References

- [Git Attributes Documentation](https://git-scm.com/docs/gitattributes)
- [Git Merge Drivers](https://git-scm.com/docs/gitattributes#_defining_a_custom_merge_driver)
- [AitherZero PR #1694](https://github.com/wizzense/AitherZero/pull/1694) - Initial implementation
