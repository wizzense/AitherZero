#!/usr/bin/env bash
#
# Pre-commit hook for AitherZero
# Validates config.psd1 before allowing commits that modify it
#
# To install this hook:
#   git config core.hooksPath .githooks
#
# To bypass this hook (not recommended):
#   git commit --no-verify

set -e

EXIT_CODE=0

# Check if config.psd1 is being committed
if git diff --cached --name-only | grep -q "^config.psd1$"; then
    echo "üîç Detected changes to config.psd1 - running validation..."
    echo ""
    
    # Run the validation script
    if pwsh -File ./automation-scripts/0413_Validate-ConfigManifest.ps1; then
        echo ""
        echo "‚úÖ Config validation passed"
        echo ""
    else
        echo ""
        echo "‚ùå Config validation failed - commit blocked"
        echo ""
        echo "To fix:"
        echo "  1. Review the validation errors above"
        echo "  2. Update config.psd1 to fix the issues"
        echo "  3. Run: pwsh -File ./automation-scripts/0413_Validate-ConfigManifest.ps1"
        echo "  4. Try committing again"
        echo ""
        EXIT_CODE=1
    fi
fi

# Check if workflow files are being committed
if git diff --cached --name-only | grep -q "^.github/workflows/.*\.yml$"; then
    # Run the workflow validation hook
    if [ -x ".githooks/pre-commit-workflows" ]; then
        if ! ./.githooks/pre-commit-workflows; then
            EXIT_CODE=1
        fi
    else
        echo "‚ö†Ô∏è  Workflow validation hook not found or not executable"
    fi
fi

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "To bypass these checks (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
fi

exit 0
